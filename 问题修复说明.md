# 问题修复说明

## 问题描述

运行 `python test_with_judgment.py` 时遇到以下问题：

1. **JSON解析失败**：子任务0.1返回的内容不是纯JSON格式
2. **请求超时**：子任务0.2的API请求超时（默认2分钟超时时间不够）

## 根本原因

1. **LLM响应格式**：LLM返回的内容可能包含Markdown代码块（```json ... ```）或其他非JSON文本
2. **超时时间太短**：复杂的子任务（如0.2脱敏替换策划）需要更长的处理时间，2分钟不够

## 解决方案

### 方案一：使用改进的测试脚本（推荐）

已为您创建了改进的测试脚本：

```bash
python test_with_judgment_improved.py
```

改进点：
- ✅ 超时时间增加到600秒（10分钟）
- ✅ 改进的JSON解析逻辑（支持多种格式）
- ✅ 交互式确认每个阶段是否继续
- ✅ 更详细的日志输出

### 方案二：更新原始LLM客户端

已为您更新了 `src/utils/llm.py`：
- ✅ 默认超时时间从120秒增加到600秒
- ✅ 添加了timeout参数（可自定义）
- ✅ 改进了错误提示

使用方法：

```python
from src.utils import LLMClient

# 使用默认超时时间（600秒）
llm_client = LLMClient(
    api_key="your-api-key",
    model="deepseek-ai/DeepSeek-V3.2",
    api_base="https://api.siliconflow.cn/v1"
)

# 或自定义超时时间（例如10分钟=600秒）
llm_client = LLMClient(
    api_key="your-api-key",
    model="deepseek-ai/DeepSeek-V3.2",
    api_base="https://api.siliconflow.cn/v1",
    timeout=600.0
)
```

### 方案三：使用改进的LLM客户端（可选）

已为您创建了 `src/utils/llm_improved.py`，包含：
- ✅ 更强的JSON解析能力
- ✅ 支持多种JSON格式（```json ... ```、``` ... ```、纯JSON）
- ✅ 更详细的错误信息

使用方法：

```python
from src.utils.llm_improved import LLMClient

llm_client = LLMClient(
    api_key="your-api-key",
    model="deepseek-ai/DeepSeek-V3.2",
    api_base="https://api.siliconflow.cn/v1",
    timeout=600.0
)

# 生成普通文本
response = llm_client.generate(prompt)

# 生成JSON（自动解析）
result = llm_client.generate_json(prompt)
```

## 快速测试

### 1. 先测试LLM连接

```bash
python test_quick.py
```

如果成功，说明LLM连接正常。

### 2. 运行改进的完整测试

```bash
python test_with_judgment_improved.py
```

按照提示逐步执行每个阶段。

## 其他建议

### 1. 减少API调用时间

如果仍然超时，可以尝试：

```python
# 在llm_client.generate()调用时减少max_tokens
response = llm_client.generate(
    prompt,
    max_tokens=4096  # 减少到4096
)
```

### 2. 使用更快的模型

如果API支持，可以尝试使用更快的模型：

```python
llm_client = LLMClient(
    api_key="your-api-key",
    model="deepseek-ai/DeepSeek-V3",  # 使用更快的版本
    api_base="https://api.siliconflow.cn/v1",
    timeout=600.0
)
```

### 3. 分阶段执行

如果一次性执行所有阶段超时，可以分阶段执行：

```python
# 只执行阶段0
stage0_service = Stage0Service(llm_client=llm_client)
stage0_result = stage0_service.run_all(judgment_text)

# 保存中间结果，稍后再继续
# ...
```

## 常见问题

### Q1: 还是超时怎么办？

**A**: 可以进一步增加超时时间：

```python
llm_client = LLMClient(
    timeout=900.0  # 15分钟
)
```

### Q2: JSON解析还是失败怎么办？

**A**: 查看LLM返回的原始内容：

```python
response = llm_client.generate(prompt)
print("原始响应:")
print(response)
```

然后手动提取JSON部分，或修改提示词要求纯JSON输出。

### Q3: 如何查看详细的生成过程？

**A**: 日志文件保存在 `logs/` 目录：

```bash
# 查看最新日志
tail -f logs/app_2026-01-21.log

# 或查看所有日志
ls -la logs/
```

### Q4: API调用失败怎么办？

**A**: 检查以下几点：

1. API密钥是否正确
2. API Base URL是否正确
3. 网络连接是否正常
4. API额度是否充足

```bash
# 测试API连通性
curl https://api.siliconflow.cn/v1
```

## 下一步

修复后，您可以：

1. ✅ 运行 `test_quick.py` 验证LLM连接
2. ✅ 运行 `test_with_judgment_improved.py` 执行完整流程
3. ✅ 查看 `outputs/` 目录中的生成结果
4. ✅ 参考 `使用手册.md` 了解更多使用方法

## 需要帮助？

如果问题仍未解决，请：
1. 查看完整的错误日志
2. 参考 `使用手册.md` 的故障排查部分
3. 联系技术支持

---

**更新时间**: 2026-01-21
**版本**: v1.0.1-alpha
