# 代码修改规格说明：反脱敏修复

**文档版本**: v1.0  
**创建日期**: 2026-01-26  
**状态**: 待执行  
**说明**: 本文档提供具体的代码修改规格，用于指导反脱敏修复的实施

---

## 一、修改概览

### 1.1 修改目标

在证据生成器（`evidence_file_generator.py`）中添加反脱敏步骤，确保证据文件不包含占位符。

### 1.2 修改文件清单

| 序号 | 文件路径 | 修改类型 | 修改行数 | 说明 |
|------|---------|---------|---------|------|
| 1 | `src/services/evidence_file_generator.py` | 修改 | +50行 | 添加反脱敏步骤 |
| 2 | `src/utils/deanonymizer.py` | 新建 | +80行 | 统一反脱敏工具类 |

---

## 二、文件1：新建 `src/utils/deanonymizer.py`

### 2.1 文件位置

```
src/utils/deanonymizer.py
```

### 2.2 完整代码

```python
"""
统一的反脱敏工具类

提供从阶段0数据加载脱敏映射、将脱敏名称替换为真实名称的功能。
"""
from typing import Dict, Any, Optional
import json


class Deanonymizer:
    """统一的反脱敏工具类"""
    
    def __init__(self, anonymization_map: Optional[Dict[str, str]] = None):
        """
        初始化反脱敏工具类
        
        Args:
            anonymization_map: 脱敏映射表 {placeholder: real_name}
        """
        self.anonymization_map: Dict[str, str] = anonymization_map or {}
    
    def load_from_stage0(self, stage0_data: Dict[str, Any]) -> "Deanonymizer":
        """
        从阶段0数据加载脱敏映射
        
        Args:
            stage0_data: 阶段0完整数据
            
        Returns:
            self: 支持链式调用
        """
        anonymization_plan = stage0_data.get("0.2_anonymization_plan", {})
        anonymization_map: Dict[str, str] = {}
        
        for category in ["companies", "persons", "organizations"]:
            for item in anonymization_plan.get(category, []):
                anonymized = item.get("anonymized")
                real_name = item.get("real_name")
                if anonymized and real_name:
                    anonymization_map[anonymized] = real_name
        
        self.anonymization_map = anonymization_map
        return self
    
    def load_from_file(self, file_path: str) -> "Deanonymizer":
        """
        从JSON文件加载脱敏映射
        
        Args:
            file_path: 脱敏映射文件路径
            
        Returns:
            self: 支持链式调用
        """
        with open(file_path, "r", encoding="utf-8") as f:
            anonymization_plan = json.load(f)
        
        anonymization_map: Dict[str, str] = {}
        
        for category in ["companies", "persons", "organizations"]:
            for item in anonymization_plan.get(category, []):
                anonymized = item.get("anonymized")
                real_name = item.get("real_name")
                if anonymized and real_name:
                    anonymization_map[anonymized] = real_name
        
        self.anonymization_map = anonymization_map
        return self
    
    def deanonymize_text(self, text: str) -> str:
        """
        将脱敏名称替换为真实名称
        
        Args:
            text: 包含脱敏名称的文本
            
        Returns:
            str: 替换后的文本
        """
        deanonymized = text
        for placeholder, real_name in self.anonymization_map.items():
            deanonymized = deanonymized.replace(placeholder, real_name)
        return deanonymized
    
    def deanonymize_dict(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        递归处理字典中的所有字符串值
        
        Args:
            data: 待处理的字典
            
        Returns:
            Dict[str, Any]: 处理后的字典
        """
        result = {}
        for key, value in data.items():
            if isinstance(value, str):
                result[key] = self.deanonymize_text(value)
            elif isinstance(value, dict):
                result[key] = self.deanonymize_dict(value)
            elif isinstance(value, list):
                result[key] = self._deanonymize_list(value)
            else:
                result[key] = value
        return result
    
    def _deanonymize_list(self, data: list) -> list:
        """递归处理列表中的所有字符串值"""
        result = []
        for item in data:
            if isinstance(item, str):
                result.append(self.deanonymize_text(item))
            elif isinstance(item, dict):
                result.append(self.deanonymize_dict(item))
            elif isinstance(item, list):
                result.append(self._deanonymize_list(item))
            else:
                result.append(item)
        return result
    
    def get_map(self) -> Dict[str, str]:
        """
        获取当前脱敏映射表
        
        Returns:
            Dict[str, str]: 脱敏映射表
        """
        return self.anonymization_map.copy()
    
    def is_empty(self) -> bool:
        """
        检查脱敏映射表是否为空
        
        Returns:
            bool: 是否为空
        """
        return len(self.anonymization_map) == 0


def create_deanonymizer_from_stage0(stage0_data: Dict[str, Any]) -> Deanonymizer:
    """
    便捷函数：从阶段0数据创建反脱敏器
    
    Args:
        stage0_data: 阶段0完整数据
        
    Returns:
        Deanonymizer: 配置好的反脱敏器
    """
    return Deanonymizer().load_from_stage0(stage0_data)


def create_deanonymizer_from_file(file_path: str) -> Deanonymizer:
    """
    便捷函数：从文件创建反脱敏器
    
    Args:
        file_path: 脱敏映射文件路径
        
    Returns:
        Deanonymizer: 配置好的反脱敏器
    """
    return Deanonymizer().load_from_file(file_path)
```

---

## 三、文件2：修改 `src/services/evidence_file_generator.py`

### 3.1 文件位置

```
src/services/evidence_file_generator.py
```

### 3.2 修改前代码（第140-160行）

```python
    def _generate_evidence_file(self, evidence, stage0_data, group_dir):
        try:
            # 1. 加载提示词
            prompt_path = self.prompts_dir / "stage1" / "1.2_证据包生成.md"
            prompt = prompt_path.read_text(encoding='utf-8')
            
            # 2. 构建提示词
            profile_lib = stage0_data.get("profile_library", {})
            case_info = stage0_data.get("0.1_structured_extraction", {})
            key_numbers = stage0_data.get("0.4_key_numbers", {})
            
            full_prompt = self._build_prompt(evidence, profile_lib, case_info, key_numbers, prompt)
            
            # 3. 调用LLM
            response = self.llm_client.generate(full_prompt)
            
            # 4. 清理Markdown
            clean_response = self._clean_markdown(response)
            
            # 5. 保存文件
            file_path = group_dir / f"{evidence['id']}_{evidence['name']}.md"
            file_path.write_text(clean_response, encoding='utf-8')
            
            return {
                "success": True,
                "evidence_id": evidence['id'],
                "file_path": str(file_path)
            }
            
        except Exception as e:
            return {
                "success": False,
                "evidence_id": evidence['id'],
                "error": str(e)
            }
```

### 3.3 修改后代码（第140-175行）

```python
    def _generate_evidence_file(self, evidence, stage0_data, group_dir):
        try:
            # 1. 加载提示词
            prompt_path = self.prompts_dir / "stage1" / "1.2_证据包生成.md"
            prompt = prompt_path.read_text(encoding='utf-8')
            
            # 2. 构建提示词
            profile_lib = stage0_data.get("profile_library", {})
            case_info = stage0_data.get("0.1_structured_extraction", {})
            key_numbers = stage0_data.get("0.4_key_numbers", {})
            
            full_prompt = self._build_prompt(evidence, profile_lib, case_info, key_numbers, prompt)
            
            # 3. 调用LLM
            response = self.llm_client.generate(full_prompt)
            
            # 4. 清理Markdown
            clean_response = self._clean_markdown(response)
            
            # 5. 反脱敏（新增）
            deanonymized_response = self._deanonymize_text(clean_response, stage0_data)
            
            # 6. 保存文件
            file_path = group_dir / f"{evidence['id']}_{evidence['name']}.md"
            file_path.write_text(deanonymized_response, encoding='utf-8')
            
            return {
                "success": True,
                "evidence_id": evidence['id'],
                "file_path": str(file_path)
            }
            
        except Exception as e:
            return {
                "success": False,
                "evidence_id": evidence['id'],
                "error": str(e)
            }
    
    def _deanonymize_text(self, text: str, stage0_data: Dict) -> str:
        """
        将脱敏名称替换为真实名称
        
        Args:
            text: 包含脱敏名称的文本
            stage0_data: 阶段0数据（包含脱敏映射）
            
        Returns:
            str: 替换后的文本
        """
        anonymization_plan = stage0_data.get("0.2_anonymization_plan", {})
        
        anonymization_map: Dict[str, str] = {}
        
        # 处理公司名称
        for item in anonymization_plan.get("companies", []):
            anonymized = item.get("anonymized")
            real_name = item.get("real_name")
            if anonymized and real_name:
                anonymization_map[anonymized] = real_name
        
        # 处理人物名称
        for item in anonymization_plan.get("persons", []):
            anonymized = item.get("anonymized")
            real_name = item.get("real_name")
            if anonymized and real_name:
                anonymization_map[anonymized] = real_name
        
        # 处理机构名称
        for item in anonymization_plan.get("organizations", []):
            anonymized = item.get("anonymized")
            real_name = item.get("real_name")
            if anonymized and real_name:
                anonymization_map[anonymized] = real_name
        
        # 执行替换
        deanonymized = text
        for placeholder, real_name in anonymization_map.items():
            deanonymized = deanonymized.replace(placeholder, real_name)
        
        return deanonymized
```

### 3.4 新增方法说明

#### 方法：`_deanonymize_text`

**位置**: `evidence_file_generator.py` 第177-215行

**功能**: 从阶段0数据中提取脱敏映射，并将文本中的占位符替换为真实名称

**实现逻辑**:
1. 从 `stage0_data["0.2_anonymization_plan"]` 获取脱敏映射计划
2. 构建完整的脱敏映射表（公司、人物、机构）
3. 遍历映射表，替换所有占位符

**示例**:
```python
# 输入文本
text = "原告某某公司5与被告某某公司1签订合同..."

# 阶段0数据
stage0_data = {
    "0.2_anonymization_plan": {
        "companies": [
            {"real_name": "上海富隆融资租赁有限公司", "anonymized": "某某公司5"},
            {"real_name": "南昌昌茂商业管理有限公司", "anonymized": "某某公司1"}
        ]
    }
}

# 输出
deanonymized = "原告上海富隆融资租赁有限公司与被告南昌昌茂商业管理有限公司签订合同..."
```

---

## 四、修改验证

### 4.1 验证步骤

#### 步骤1：检查证据文件

```bash
# 查找证据文件中的占位符
grep -r "某某公司" outputs/stage1/evidence_new/evidence/ | wc -l
grep -r "（此处填写" outputs/stage1/evidence_new/evidence/ | wc -l
grep -r "【填写" outputs/stage1/evidence_new/evidence/ | wc -l
```

**预期结果**: 所有搜索结果为0

#### 步骤2：检查PDF文件

```bash
# 重新生成PDF
python main.py --stage 3 --input outputs/stage2/

# 检查占位符
grep -r "某某公司" outputs/完整测试卷宗_简化版.pdf | wc -l
```

**预期结果**: 所有搜索结果为0

#### 步骤3：验证反脱敏映射

```python
# 验证映射表正确加载
from src.services.evidence_file_generator import EvidenceFileGenerator
from src.utils import LLMClient
import json

# 加载阶段0数据
with open("outputs/stage0/stage0_complete.json", "r", encoding="utf-8") as f:
    stage0_data = json.load(f)

# 验证映射
anonymization_plan = stage0_data.get("0.2_anonymization_plan", {})
print(f"公司映射: {len(anonymization_plan.get('companies', []))} 条")
print(f"人物映射: {len(anonymization_plan.get('persons', []))} 条")
print(f"机构映射: {len(anonymization_plan.get('organizations', []))} 条")
```

**预期结果**:
```
公司映射: 10 条
人物映射: 12 条
机构映射: 5 条
```

### 4.2 回归测试清单

| 测试项 | 测试方法 | 预期结果 |
|--------|---------|---------|
| 证据文件不包含占位符 | grep搜索 | 0个匹配 |
| PDF不包含占位符 | grep搜索 | 0个匹配 |
| 公司名称正确显示 | 手动检查 | 真实公司名称 |
| 人物名称正确显示 | 手动检查 | 真实人物名称 |
| 金额格式正确 | 手动检查 | 无"具体金额"占位符 |

---

## 五、风险与回退

### 5.1 潜在风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 占位符未完全替换 | 低 | 高 | 全面测试 |
| 新引入bug | 低 | 中 | 最小改动 |
| 性能下降 | 极低 | 低 | 仅文本替换 |

### 5.2 回退方案

如果修改后出现问题，可通过以下方式回退：

```bash
# 1. 恢复证据生成器
git checkout src/services/evidence_file_generator.py

# 2. 重新生成证据文件
python main.py --stage 1 --input outputs/stage0/

# 3. 重新生成PDF
python main.py --stage 3 --input outputs/stage1/
```

---

## 六、时间评估

| 任务 | 预估时间 | 实际时间 | 备注 |
|------|---------|---------|------|
| 创建deanonymizer.py | - | - | 可选，非必须 |
| 修改evidence_file_generator.py | 1小时 | - | 主要修改 |
| 测试验证 | 2小时 | - | 全面测试 |
| **总计** | **3小时** | - | - |

---

## 七、附录

### A. 相关文件

| 文件 | 路径 | 说明 |
|------|------|------|
| 脱敏映射表 | `outputs/stage0/0.2_anonymization_plan.json` | 完整的脱敏映射 |
| 阶段0数据 | `outputs/stage0/stage0_complete.json` | 完整阶段0数据 |
| 证据生成器 | `src/services/evidence_file_generator.py` | 待修改 |
| PDF生成器 | `src/utils/pdf_generator.py` | 参考实现 |

### B. 占位符统计

| 占位符类型 | 数量 | 示例 |
|-----------|------|------|
| 某某公司X | 10 | 某某公司1-10 |
| 某某人物X | 12 | 周某、左某等 |
| 某某机构X | 5 | 某某律师事务所等 |
| （此处填写） | 6 | （此处填写被告名称） |
| 【填写】 | 9 | 【填写具体金额】 |

### C. 脱敏映射表示例

```json
{
  "companies": [
    {"real_name": "上海富隆融资租赁有限公司", "anonymized": "某某公司5"},
    {"real_name": "南昌昌茂商业管理有限公司", "anonymized": "某某公司1"},
    {"real_name": "深圳中投融资租赁有限公司", "anonymized": "某某公司2"}
  ],
  "persons": [
    {"real_name": "周文斌", "anonymized": "周某"},
    {"real_name": "左明轩", "anonymized": "左某"}
  ],
  "organizations": [
    {"real_name": "上海嘉华律师事务所", "anonymized": "某某律师事务所"},
    {"real_name": "上海中诚公证处", "anonymized": "某某公证处"}
  ]
}
```

---

**文档状态**: 待执行  
**执行顺序**: 1. 阅读本文档 → 2. 实施修改 → 3. 测试验证
