# 证据材料不全问题修复说明

## 问题描述

运行系统后生成的证据材料不全，只有部分证据，且没有答辩状和庭审记录。

## 根本原因

### 1. 证据包生成问题

**问题代码位置**：
- `src/services/stage1/stage1_service.py` 第323行
- `src/services/stage2/stage2_service.py` 第323行

**问题代码**：
```python
# 生成证据包（这里简化为只生成一个证据组）
evidence_package = self.generate_evidence_package(stage0_data, evidence_group_index=1)
```

**问题说明**：
- 代码明确写明"这里简化为只生成一个证据组"
- 只生成了证据组1，其他证据组都没有生成
- 根据您的证据规划表，共有9个证据组，但只生成了1个

### 2. 答辩状和庭审记录未生成

**原因**：
- 您可能只运行了阶段0和阶段1，没有继续执行阶段2和阶段3
- 或者在执行过程中遇到了错误导致提前终止
- 从输出目录看，`outputs/stage2` 目录不存在，说明阶段2没有执行

## 已完成的修复

### ✅ 修复1：阶段1证据包生成（原告）

**文件**：`src/services/stage1/stage1_service.py`

**修复内容**：
```python
# 修复前（只生成一个证据组）
evidence_package = self.generate_evidence_package(stage0_data, evidence_group_index=1)

# 修复后（生成所有证据组）
# 提取所有原告证据并分组
plaintiff_evidence = [
    e for e in evidence_planning["证据归属规划表"]
    if e["应归属方"] == "原告"
]

evidence_groups = {}
for evidence in plaintiff_evidence:
    group_id = evidence.get("证据组", 1)
    if group_id not in evidence_groups:
        evidence_groups[group_id] = []
    evidence_groups[group_id].append(evidence)

# 生成每个证据组
evidence_package_result = {}
for group_id in sorted(evidence_groups.keys()):
    logger.info(f"开始生成证据组{group_id}，包含 {len(evidence_groups[group_id])} 个证据")
    group_result = self.generate_evidence_package(
        stage0_data,
        evidence_group_index=group_id
    )
    evidence_package_result[f"证据组{group_id}"] = group_result
```

**效果**：
- ✅ 自动识别所有原告证据组
- ✅ 循环生成所有证据组
- ✅ 保存所有证据组的结果

### ✅ 修复2：阶段2证据包生成（被告）

**文件**：`src/services/stage2/stage2_service.py`

**修复内容**：
```python
# 修复前（只生成一个证据组）
evidence_package = self.generate_evidence_package(stage0_data, evidence_group_index=1)

# 修复后（生成所有被告证据组）
# 提取所有被告证据并分组
defendant_evidence = [
    e for e in evidence_planning["证据归属规划表"]
    if e["应归属方"] == "被告"
]

if defendant_evidence:
    evidence_groups = {}
    for evidence in defendant_evidence:
        group_id = evidence.get("证据组", 1)
        if group_id not in evidence_groups:
            evidence_groups[group_id] = []
        evidence_groups[group_id].append(evidence)

    # 生成每个证据组
    evidence_package_result = {}
    for group_id in sorted(evidence_groups.keys()):
        logger.info(f"开始生成被告证据组{group_id}，包含 {len(evidence_groups[group_id])} 个证据")
        group_result = self.generate_evidence_package(
            stage0_data,
            evidence_group_index=group_id
        )
        evidence_package_result[f"证据组{group_id}"] = group_result
else:
    logger.info("没有发现被告证据，跳过证据包生成")
    evidence_package_result = {}
```

**效果**：
- ✅ 自动识别所有被告证据组
- ✅ 循环生成所有被告证据组
- ✅ 处理没有被告证据的情况

## 使用修复后的系统

### 方式1：使用改进的测试脚本（推荐）

```bash
python test_with_judgment_improved.py
```

按照提示逐步执行每个阶段。

### 方式2：分阶段手动执行

#### 步骤1：重新运行阶段0（如果需要）
```bash
python -c "
from pathlib import Path
import sys
sys.path.insert(0, str(Path('.') / 'src'))

from src.services import Stage0Service
from src.utils import LLMClient

llm_client = LLMClient(
    api_key='sk-fjephnssumhgkxhakpxlfrqayiuckkyogvwkchqutqolqilk',
    model='deepseek-ai/DeepSeek-V3.2',
    api_base='https://api.siliconflow.cn/v1',
    timeout=600
)

judgment_text = Path('inputs/judgment.txt').read_text(encoding='utf-8')
stage0_service = Stage0Service(llm_client=llm_client)
result = stage0_service.run_all(judgment_text)
print('阶段0完成')
"
```

#### 步骤2：重新运行阶段1（生成所有证据）
```bash
python -c "
from pathlib import Path
import sys
import json
sys.path.insert(0, str(Path('.') / 'src'))

from src.services import Stage1Service
from src.utils import LLMClient

llm_client = LLMClient(
    api_key='sk-fjephnssumhgkxhakpxlfrqayiuckkyogvwkchqutqolqilk',
    model='deepseek-ai/DeepSeek-V3.2',
    api_base='https://api.siliconflow.cn/v1',
    timeout=600
)

# 读取阶段0结果
stage0_data = json.loads(Path('outputs/stage0/analysis_results.json').read_text(encoding='utf-8'))

stage1_service = Stage1Service(llm_client=llm_client)
result = stage1_service.run_all(stage0_data)
print('阶段1完成，共生成证据组数:', len(result['证据包']))
"
```

#### 步骤3：运行阶段2（生成答辩状）
```bash
python -c "
from pathlib import Path
import sys
import json
sys.path.insert(0, str(Path('.') / 'src'))

from src.services import Stage2Service
from src.utils import LLMClient

llm_client = LLMClient(
    api_key='sk-fjephnssumhgkxhakpxlfrqayiuckkyogvwkchqutqolqilk',
    model='deepseek-ai/DeepSeek-V3.2',
    api_base='https://api.siliconflow.cn/v1',
    timeout=600
)

# 读取阶段0结果
stage0_data = json.loads(Path('outputs/stage0/analysis_results.json').read_text(encoding='utf-8'))

stage2_service = Stage2Service(llm_client=llm_client)
result = stage2_service.run_all(stage0_data)
print('阶段2完成')
"
```

#### 步骤4：运行阶段3（生成庭审记录）
```bash
python -c "
from pathlib import Path
import sys
import json
sys.path.insert(0, str(Path('.') / 'src'))

from src.services import Stage3Service
from src.utils import LLMClient

llm_client = LLMClient(
    api_key='sk-fjephnssumhgkxhakpxlfrqayiuckkyogvwkchqutqolqilk',
    model='deepseek-ai/DeepSeek-V3.2',
    api_base='https://api.siliconflow.cn/v1',
    timeout=600
)

# 读取阶段0结果和判决书
stage0_data = json.loads(Path('outputs/stage0/analysis_results.json').read_text(encoding='utf-8'))
judgment_text = Path('inputs/judgment.txt').read_text(encoding='utf-8')

stage3_service = Stage3Service(llm_client=llm_client)
result = stage3_service.run_all(judgment_text, stage0_data)
print('阶段3完成')
"
```

## 检查修复效果

### 1. 检查原告证据包

```bash
ls -la outputs/stage1/
```

**预期输出**：
```
原告证据包_证据组1.txt
原告证据包_证据组2.txt
原告证据包_证据组3.txt
...
原告证据包_证据组9.txt  # 根据实际证据组数量
```

### 2. 检查被告证据包

```bash
ls -la outputs/stage2/
```

**预期输出**：
```
被告证据包_证据组1.txt  # 如果有被告证据
...
民事答辩状.txt
被告程序性文件.txt
```

### 3. 检查庭审记录

```bash
ls -la outputs/stage3/
```

**预期输出**：
```
庭审笔录.txt
判决书脱敏替换.txt
```

## 常见问题

### Q1: 证据组生成不全怎么办？

**A**: 检查以下几点：
1. 证据规划表是否完整：`cat outputs/stage0/0.5_evidence_planning.json`
2. 确认证据组数量：统计 `"证据组"` 字段
3. 查看日志确认每个证据组是否生成

### Q2: 生成时间太长怎么办？

**A**: 可以尝试：
1. 减少max_tokens参数
2. 使用更快的模型
3. 分阶段执行，手动控制

### Q3: 某个证据组生成失败怎么办？

**A**:
1. 查看日志中的错误信息
2. 检查该证据组的数据是否完整
3. 可以单独重新生成该证据组

### Q4: 如何生成完整的卷宗？

**A**: 按顺序执行所有阶段：
1. 阶段0：解析判决书
2. 阶段1：生成原告起诉包
3. 阶段2：生成被告答辩包
4. 阶段3：生成法院审理包

## 进度跟踪

执行过程中，可以通过以下方式跟踪进度：

### 查看实时日志
```bash
tail -f logs/app_2026-01-21.log
```

### 检查已生成的文件
```bash
# 阶段0
ls -la outputs/stage0/

# 阶段1
ls -la outputs/stage1/

# 阶段2
ls -la outputs/stage2/

# 阶段3
ls -la outputs/stage3/
```

### 统计文件数量
```bash
# 统计原告证据组数量
ls outputs/stage1/原告证据包_*.txt | wc -l

# 统计被告证据组数量
ls outputs/stage2/被告证据包_*.txt | wc -l
```

## 总结

### 修复内容

✅ **阶段1证据包生成**：从只生成1个证据组改为生成所有证据组
✅ **阶段2证据包生成**：从只生成1个证据组改为生成所有证据组
✅ **改进日志输出**：显示每个证据组的生成进度

### 下一步

1. **重新运行系统**：使用修复后的代码重新执行
2. **验证完整性**：检查所有证据组是否都生成
3. **继续执行**：确保阶段2和阶段3也正常执行

### 预期结果

运行完成后，您应该获得：

**阶段0（判决书解析）**：
- 结构化提取结果
- Profile库
- 交易结构
- 关键数字清单
- 证据归属规划表

**阶段1（原告起诉包）**：
- 民事起诉状
- 所有原告证据组（根据规划表）
- 原告程序性文件

**阶段2（被告答辩包）**：
- 民事答辩状
- 所有被告证据组（根据规划表）
- 被告程序性文件

**阶段3（法院审理包）**：
- 庭审笔录
- 判决书脱敏替换

---

**修复时间**: 2026-01-21
**版本**: v1.0.2-alpha
**文件更新**:
- src/services/stage1/stage1_service.py
- src/services/stage2/stage2_service.py
