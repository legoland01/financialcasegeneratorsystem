# 反馈给Agent2：Prompt设计问题根因分析

**反馈日期**: 2026-02-03
**反馈人**: Agent1（产品经理）
**问题级别**: 严重（P0）
**影响范围**: 所有阶段1、阶段2证据文件生成

---

## 问题描述

### 现象

LLM生成的证据文件中存在大量占位符，如：
- 地址：`上海市浦东新区某某路某某号`
- 设备：`某某设备`、`某某型号`
- 银行：`中国工商银行某某支行`

### 问题文件示例

`outputs/stage1/证据组1/证据组1_E001_转让合同.txt`:
```
【甲方（转让方）】
名称：华鑫融资租赁有限公司  ← LLM编造
地址：上海市浦东新区某某路某某号  ← 占位符

【乙方（受让方）】
名称：南昌宏昌商业零售有限公司  ← LLM编造
地址：上海市闵行区东川路800号  ← 错误信息
```

---

## 根因分析

### 不是占位符清理机制的问题

我最初误判为"反脱敏机制失效"，但实际检查发现：

| 环节 | 状态 | 说明 |
|------|------|------|
| Profile库 | ✅ 正确 | 某某公司5 -> 上海金信融资租赁有限公司 |
| _build_party_info_section | ✅ 正确 | 输出了真实公司信息 |
| _deanonymize_text | ✅ 正确 | 能替换已知的脱敏标识 |

**结论**：占位符清理机制工作正常，问题出在LLM生成阶段。

### 真正的根因：Prompt设计错误

#### 问题1：Prompt包含了合同模板和XXX占位符

证据文件生成器使用的Prompt模板（`prompts/stage1/1.2_证据包生成.md`）包含：

```markdown
#### 合同类
【甲方（出租人）】
名称：XXX          ← 问题：XXX是占位符
统一社会信用代码：XXX
法定代表人：XXX
地址：XXX
```

#### 问题2：强制要求禁止占位符与XXX模板冲突

Prompt同时要求：
- **禁止使用**：'某某'、'某公司'、'XXX'
- **却又提供**：带XXX的模板格式

这让LLM困惑：到底该不该用XXX？

#### 问题3：某某公司5 是冗余信息

Prompt的当事人信息部分：
```
- 某某公司5（公司）：上海金信融资租赁有限公司
  地址：中国（上海）自由贸易试验区世纪大道100号
```

这里"某某公司5"是脱敏标识，对LLM没有意义。LLM看到"某某公司5"和"上海金信融资租赁有限公司"，不知道该用哪个。

---

## 为什么不能用模板和XXX？

### 核心原则

**LLM会把模板和XXX理解为"可以自行发挥"**

当Prompt同时包含：
1. 真实信息：上海金信融资租赁有限公司
2. 模板格式：名称：XXX

LLM会认为：
- "XXX是模板格式"
- "我应该根据模板生成内容"
- "真实信息是参考，不是必须"

这就导致了：
- LLM看到真实公司名
- 但按照模板格式生成了新内容
- 忽略了"强制要求禁止占位符"的约束

### 设计原则

**Prompt设计原则**：
1. 只给具体信息
2. 不，不给模板格式使用任何占位符（XXX、某某等）
3. 不需要强调"禁止使用占位符"
4. 把LLM当成实习生：告诉他做什么，不告诉他怎么做

---

## 正确的Prompt设计

### 设计方向

**不要给LLM模板**，只告诉它：
1. 生成什么类型的文件
2. 包含哪些具体信息
3. 参考什么格式（用自然语言描述）

### 示例：合同生成Prompt

**错误的方式**：
```markdown
## 合同标准格式
【甲方】
名称：XXX
地址：XXX
...

## 当事人信息
某某公司5：上海金信融资租赁有限公司
地址：中国（上海）自由贸易试验区世纪大道100号

## 🚨 强制要求
禁止使用XXX、某某公司...
```

**正确的方式**：
```markdown
这是一份《设备转让合同》，请根据以下信息生成合同正文。

甲方（转让方）：
- 公司名称：上海金信融资租赁有限公司
- 统一社会信用代码：91310115MA7JY8K123
- 法定代表人：周明远
- 注册地址：中国（上海）自由贸易试验区世纪大道100号

乙方（受让方）：
- 公司名称：江西昌盛商业管理有限公司
- 统一社会信用代码：91360121MA38K9F456
- 法定代表人：吴建国
- 注册地址：江西省南昌市南昌县莲塘镇向阳路188号

转让标的：设备及附属设施（详见附件设备清单）
转让价格：人民币壹亿伍仟万元整（¥150,000,000.00）
合同签订日期：2021年2月24日

要求：生成符合法律规范的合同正文，包含：
- 合同编号
- 当事人信息（已提供）
- 鉴于条款
- 转让标的条款
- 转让价款条款
- 支付方式条款
- 权利义务条款
- 违约责任条款
- 争议解决条款
- 签署栏（包含签订日期）
```

### 关键点

1. **直接列出公司名称**，不要脱敏标识
   ```
   错误：某某公司5：上海金信融资租赁有限公司
   正确：上海金信融资租赁有限公司
   ```

2. **用自然语言描述格式**，不用模板
   ```
   错误：【甲方】名称：XXX
   正确：甲方（转让方）：上海金信融资租赁有限公司
   ```

3. **不提供模板**，让LLM根据合同类型自行组织
   ```
   错误：包含完整的合同模板格式
   正确：描述需要包含的条款类型
   ```

4. **不强调禁止占位符**，因为根本不应该出现
   ```
   错误：🚨 强制要求：禁止使用某某、XXX...
   正确：（不写这段话）
   ```

---

## 需要修改的文件

### 主要修改文件

1. **`prompts/stage1/1.2_证据包生成.md`**
   - 移除所有带XXX的模板格式
   - 改为自然语言描述
   - 移除"强制要求禁止占位符"部分

2. **`src/services/evidence_file_generator.py`**
   - 修改 `_get_default_prompt` 方法
   - 修改 `_build_party_info_section` 方法，移除脱敏标识
   - 移除 "强制要求" 部分的拼接

3. **设计文档**
   - `PDF生成模块重构规划-新架构.md` 第535-636行
   - 更新Prompt设计原则

### 具体修改建议

#### 修改1：`_build_party_info_section` 方法

```python
# 修改前
def _build_party_info_section(self, parties):
    section_lines = ["### 当事人信息"]
    for party in parties:
        role = party.get("role", "当事人")  # 某某公司5
        name = party.get("party_name", "未知")
        # ...
        section_lines.append(f"- {role}（{type_label}）：{name}")
    return "\n".join(section_lines)

# 修改后
def _build_party_info_section(self, parties):
    section_lines = []
    for party in parties:
        name = party.get("party_name", "未知")
        code = party.get("credit_code", "")
        legal = party.get("legal_representative", "")
        address = party.get("address", "")
        # 直接列出公司信息，不加脱敏标识前缀
        section_lines.append(f"{name}")
        if code:
            section_lines.append(f"统一社会信用代码：{code}")
        if legal:
            section_lines.append(f"法定代表人：{legal}")
        if address:
            section_lines.append(f"地址：{address}")
        section_lines.append("")
    return "\n".join(section_lines)
```

#### 修改2：`_assemble_prompt` 方法

```python
# 修改后
def _assemble_prompt(self, base_prompt, party_info, amount_info, date_info, evidence):
    # 不添加"强制要求禁止占位符"部分
    return f"{base_prompt}\n\n{party_info}"
```

---

## 验证方案

### 测试用例

1. 生成《转让合同》，检查是否使用正确公司名
2. 生成《公证书》，检查地址是否正确
3. 生成《付款回单》，检查银行信息是否正确

### 验收标准

- 生成的证据文件中，100%使用真实公司名
- 0个占位符（某某、XXX等）
- 0个LLM编造的公司名

---

## 时间估计

| 任务 | 估计时间 |
|------|----------|
| 修改Prompt模板 | 1小时 |
| 修改代码逻辑 | 2小时 |
| 测试验证 | 1小时 |
| 回归测试 | 1小时 |

**总计**：约5小时

---

## 附加说明

### 为什么这个问题拖了这么久？

1. **误判问题**：最初认为是"占位符清理机制失效"
2. **头痛医头**：尝试增强反脱敏逻辑
3. **脚疼医脚**：增加占位符检测和重试
4. **没有从根本上解决**：Prompt设计问题导致LLM生成错误内容

### 这次修复的期望

通过正确的Prompt设计，从源头杜绝占位符和错误信息生成，实现：
- LLM按真实信息生成
- 不需要复杂的占位符清理
- 不需要重试机制

---

**反馈人**: Agent1（产品经理）
**日期**: 2026-02-03
**确认状态**: 待Agent2确认理解
