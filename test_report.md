# 测试报告

---

## 测试记录 2026-02-01 11:50 (Agent2开发)

**测试类型**: 单元测试 (pytest)
**测试结果**: ✅ 全部通过

### 测试统计

| 指标 | 值 |
|------|-----|
| 测试用例总数 | 50 |
| 通过 | 50 |
| 失败 | 0 |
| 通过率 | 100% |

### 测试用例分布

| 测试套件 | 用例数 | 结果 |
|---------|-------|------|
| tests/functional/ | 11 | ✅ |
| tests/integration/ | 4 | ✅ |
| tests/unit/test_evidence_file_generator.py | 7 | ✅ |
| tests/unit/test_placeholder_checker.py | 18 | ✅ |
| tests/unit/test_retry_handler.py | 10 | ✅ |

### 测试内容

**Prompt构建策略v2测试**：
- `_extract_involved_companies()` - 公司信息提取
- `_extract_amount_info()` - 金额信息提取
- `_extract_date_info()` - 日期信息提取
- `_build_party_info_section()` - 当事人信息section构建
- `_assemble_prompt()` - Prompt组装
- `build_evidence_prompt()` - 完整Prompt构建
- `_convert_to_uppercase()` - 金额转大写

### 待验证

| 项目 | 状态 |
|------|------|
| 单元测试 | ✅ 50/50 通过 |
| 黑盒测试（真实验证） | ⏳ 等待产品经理安排 |

---

## 测试记录 2026-02-01 12:42 (Agent2开发) - v2 Prompt验证

**测试类型**: 单元测试 + 黑盒测试（mock模式）
**测试结果**: ⚠️ Mock模式 - 无法验证真实效果

### 测试发现

| 项目 | 结果 |
|------|------|
| v2 Prompt生成 | ✅ 正常工作 |
| 公司信息提取 | ✅ 正确解析"某某公司5" -> 国信金融租赁股份有限公司 |
| 金额信息提取 | ✅ 正确提取¥150,000,000.00 |
| 日期信息提取 | ✅ 正确提取2021-02-24 |
| 强制要求 | ✅ 已添加到Prompt末尾 |

### 生成的Prompt示例

```markdown
## 【必须使用的具体信息】

### 公司信息
- 某某公司5：国信金融租赁股份有限公司
  统一社会信用代码：91310000123456789X
  法定代表人：周明远
  地址：中国（上海）自由贸易试验区世纪大道100号...

- 某某公司1：江西洪城商业管理有限公司
  统一社会信用代码：91360121MA35T12345
  法定代表人：吴国栋
  地址：江西省南昌市南昌县莲塘镇向阳路88号...

### 金额信息
涉及金额：人民币壹亿伍仟万元（¥150,000,000.00）

### 日期信息
日期：2021-02-24

## 🚨 强制要求
生成内容时必须使用上述具体信息，
**禁止**使用以下占位符：
- '某某公司'、'某公司'
...
```

### 问题分析

**测试运行在Mock模式**（无API密钥），Mock模式生成随机内容，无法验证真实LLM效果。

| 模式 | 生成内容 | 可验证项 |
|------|---------|---------|
| Mock模式 | 随机/固定模板内容 | Prompt结构正确性 ✅ |
| 真实LLM | 基于Prompt生成 | Prompt遵从性、占位符率 |

### 待验证

| 项目 | 状态 | 说明 |
|------|------|------|
| v2 Prompt结构 | ✅ 已验证 | 包含所有必要信息 |
| Mock模式生成 | ⚠️ 随机 | 无法验证真实效果 |
| 真实LLM验证 | ⏳ 待测 | 需要有效API_KEY |

---

## 测试记录 2026-02-01 10:05 (Agent1产品经理) - 真实验证

**测试类型**: 黑盒测试 (run_complete.py完整流程，使用真实OPENAI_API_KEY)
**测试结果**: ❌ 未通过 - LLM持续生成占位符

### 测试结果

| 项目 | 值 |
|------|-----|
| 模式 | 真实LLM调用 |
| 重试机制 | ✅ 工作正常 |
| 占位符检测 | ✅ 工作正常 |
| LLM遵从Prompt | ❌ 无效 |

### 问题分析

**根本原因**: Prompt没有直接列出具体当事人信息，而是传递JSON格式的Profile库，LLM难以正确使用。

### 修复方案（2026-02-01）

**修改文件**: `src/services/evidence_file_generator.py`

**修复内容**: 
1. 新增`_build_party_info_direct`方法，直接列出所有公司名称和完整信息
2. 修改`_build_prompt`方法，在生成每个证据文件时直接列出具体当事人信息
3. 明确指定："甲方：上海锦江贸易有限公司" 而非让LLM从JSON中查找

**修复后的Prompt示例**:
```
【必须使用的具体信息】
【所有公司信息】（生成时必须使用这些具体名称）:
  • 上海锦江贸易有限公司
    统一社会信用代码：91310000MA1XXXXXXX
    法定代表人：张明
    地址：上海市浦东新区陆家嘴环路1000号

生成合同/文书时，必须使用上面列出的**具体公司名称**，
例如：
  • 甲方：上海锦江贸易有限公司（禁止使用'某某公司'）
```

### 待测试验证

修复后需要重新执行真实验证，确认LLM是否能够正确使用具体公司名称。

---

## 测试记录 2026-02-01 02:22 (Agent1产品经理)

**测试类型**: 黑盒测试 (run_complete.py完整流程)
**测试结果**: ❌ 未通过

### 测试统计

| 指标 | 值 |
|------|-----|
| 证据文件 | 76个 |
| PDF大小 | 600KB |
| PDF页数 | 107页 |
| 证据验证通过 | 3/76 (3.9%) |

### 问题

发现Mock模式自动开启（OPENAI_API_KEY未设置），导致占位符检查被绕过。

---

## 测试记录 2026-02-01 01:15 (Agent1产品经理)

**测试类型**: 黑盒测试 (run_complete.py完整流程)
**测试结果**: ❌ 未通过

### 测试统计

| 指标 | 值 |
|------|-----|
| 证据文件 | 61个 |
| PDF大小 | 546KB |
| PDF页数 | 87页 |
| 证据验证通过 | 3/61 (4.9%) |

### 问题分析

**发现**: 占位符清理机制**未正确集成**

| 组件 | 状态 |
|------|------|
| placeholder_checker.py | ✅ 已创建 |
| retry_handler.py | ✅ 已创建 |
| stage1_service.py集成 | ❌ 未生效 |

---

## 测试记录 2026-02-01 00:16 (Agent1产品经理)

**测试类型**: 黑盒测试 (run_complete.py完整流程)
**测试结果**: ⚠️ 部分通过

### 测试统计

| 指标 | 值 |
|------|-----|
| 证据文件 | 20个 (53个变体) |
| PDF大小 | 516KB |
| PDF页数 | 72页 |
| 证据验证通过 | 3/53 (5.7%) |

---

## 测试记录 2026-01-31 23:41 (Agent1产品经理)

**测试类型**: 黑盒测试 (run_complete.py完整流程)
**测试结果**: ⚠️ 部分通过

agent2修复了运行时崩溃问题。新的问题是占位符未清理、脱敏标记残留。

---

## 测试记录 2026-01-31 22:11 (Agent1产品经理)

**测试类型**: 黑盒测试 (run_complete.py完整流程)
**测试结果**: ❌ 失败

### 问题详情

| 问题ID | 严重程度 | 位置 | 描述 |
|--------|---------|------|------|
| BUG-001 | **严重** | stage1_service.py:120 | KeyError: '证据归属规划表' |
| BUG-002 | **中等** | stage0/0.5输出 | JSON解析异常 |

---

## 测试记录 2026-01-31 12:23

**时间**: 2026-01-31 12:23:42
**检查**: 3/3 通过
