# 测试报告：PDF生成与证据文件质量问题

**报告编号**: TR-2026-01-27  
**版本**: v5.0  
**测试日期**: 2026-01-27  
**测试人员**: OpenCode AI  
**文档状态**: 正式发布  
**收件人**: 开发团队

---

## 一、执行摘要

### 1.1 测试目标

验证 `run_full_regeneration.py` 脚本执行后生成的PDF文件和证据文件的质量。

### 1.2 测试环境

| 项目 | 配置 |
|------|------|
| 运行环境 | macOS |
| 测试脚本 | `run_full_regeneration.py` |
| 执行时间 | 2026-01-27 15:07 |
| API配置 | SiliconFlow / DeepSeek-V3.2 / 600秒超时 |

### 1.3 测试结果概览

| 检查项 | 结果 | 严重程度 |
|--------|------|---------|
| PDF文件生成 | ✅ 成功 (414KB, 30页) | - |
| 公司脱敏替换 | ❌ 失败 | 🔴 高 |
| 租赁物清单 | ❌ 未使用已有数据 | 🔴 高 |
| 抵押物清单 | ❌ 未使用已有数据 | 🔴 高 |
| 表格格式 | ❌ 32行Markdown表格未渲染 | 🟡 中 |
| 租金支付计划 | ⚠️ 不完整（仅6期） | 🟡 中 |
| 租金表格 | ❌ 未渲染 | 🟡 中 |

**总体评估**: 🔴 不合格 - 存在多个严重问题

---

## 二、问题清单表格

### 2.1 一览表

| 序号 | 问题ID | 问题分类 | 问题描述 | 严重程度 | 状态 |
|------|--------|---------|---------|---------|------|
| 1 | BUG-001 | 功能缺陷 | 公司脱敏名称未替换（某某公司1/2/5/6） | 🔴 高 | 待修复 |
| 2 | BUG-002 | 数据缺陷 | 租赁物清单：数据已有但未使用 | 🔴 高 | 待修复 |
| 3 | BUG-003 | 数据缺陷 | 抵押物清单：数据已有但未使用 | 🔴 高 | 待修复 |
| 4 | BUG-004 | 格式问题 | Markdown表格未渲染（32行/3个表格） | 🟡 中 | 待修复 |
| 5 | BUG-005 | 数据缺陷 | 租金支付计划不完整（仅6期，应为12期） | 🟡 中 | 待修复 |
| 6 | BUG-006 | 格式问题 | 租金表格未渲染 | 🟡 中 | 待修复 |
| 7 | BUG-006 | 功能缺陷 | 占位符已清理 | ✅ | 已修复 |
| 8 | BUG-007 | 功能缺陷 | 人物脱敏已替换 | ✅ | 已修复 |
| 9 | BUG-008 | 功能缺陷 | 机构脱敏已替换 | ✅ | 已修复 |

### 2.2 详细问题表

#### BUG-001：公司脱敏名称未替换

| 项目 | 内容 |
|------|------|
| 问题描述 | 证据文件和PDF中仍包含脱敏公司名称"某某公司X" |
| 涉及文件 | `src/services/evidence_file_generator.py` |
| 数据统计 | 某某公司1: 22处, 某某公司2: 8处, 某某公司5: 39处, 某某公司6: 12处 |
| 真实名称缺失 | 上海金信融资租赁、南昌红广商业管理等全部缺失 |
| 修复建议 | 确认代码已保存，删除旧证据文件后重新运行 |

#### BUG-002：租赁物清单数据未使用

| 项目 | 内容 |
|------|------|
| 问题描述 | 0.4_key_numbers.json中已有完整的租赁物清单数据，但PDF中只有"（略）" |
| 数据位置 | `0.4_key_numbers.json -> 租赁物清单` |
| **已有数据** | ✅ 5项完整设备清单 |
| **PDF状态** | ❌ 第7页显示"附件一：租赁物清单（略）" |
| 数据示例 | 多联机中央空调系统 VRV VIII代 10套 5000万 |
| **根本原因** | 证据生成器没有从阶段0数据读取并使用租赁物清单 |
| 修复建议 | 1. 在证据提示词中添加引用阶段0数据的指令<br>2. 或在证据生成器中添加租赁物清单生成逻辑 |

#### BUG-003：抵押物清单数据未使用

| 项目 | 内容 |
|------|------|
| 问题描述 | 0.4_key_numbers.json中已有完整的抵押物清单数据，但PDF中只有引用 |
| 数据位置 | `0.4_key_numbers.json -> 抵押物清单` |
| **已有数据** | ✅ 1项完整房产清单 |
| **PDF状态** | ❌ 第16页显示"详见附件一《抵押物清单》"，第33页显示"附件一：抵押物清单" |
| 数据示例 | 南昌市XX广场商业房产 5200㎡ 1.04亿 |
| **根本原因** | 证据生成器没有从阶段0数据读取并使用抵押物清单 |
| 修复建议 | 1. 在证据提示词中添加引用阶段0数据的指令<br>2. 或在证据生成器中添加抵押物清单生成逻辑 |

#### BUG-004：Markdown表格未渲染

| 项目 | 内容 |
|------|------|
| 问题描述 | PDF中包含32行Markdown表格格式文本，未正确渲染为PDF表格 |
| 问题数量 | 32行 / 3个表格 |
| 表格1 | 第26页 - 律师信息表（10行） |
| 表格2 | 第27页 - 保险信息确认表（8行） |
| 表格3 | 第28页 - 保单信息确认表+送达地址确认书（14行） |
| 问题行示例 | `\| 项目 \| 左晓峰律师 \| 蔡雅雯律师 \|` |
| 根本原因 | 证据提示词生成Markdown表格，PDF生成器无法解析 |
| 修复建议 | 1. 修改证据提示词，使用纯文本格式<br>2. 或修改PDF生成器，添加Markdown表格解析 |

#### BUG-005：租金支付计划不完整

| 项目 | 内容 |
|------|------|
| 问题描述 | 租金支付计划只有6期数据，缺少6期 |
| 数据位置 | `0.4_key_numbers.json -> 租金支付计划` |
| 数据状态 | ⚠️ 存在6期数据（应为12期） |
| 现有数据 | 第1-2期: 已付, 第3-6期: 未付 |
| 修复建议 | 在0.4_key_numbers.json中补充完整的12期租金数据 |

#### BUG-006：租金表格未渲染

| 项目 | 内容 |
|------|------|
| 问题描述 | 预期生成的租金支付记录表格未在PDF中正确显示 |
| 预期位置 | 第8页附近 |
| 预期内容 | 12期租金支付记录表格 |
| 当前状态 | 未找到表格内容 |
| 修复建议 | 1. 修改证据提示词，要求生成表格<br>2. 或修改PDF生成器，添加表格解析 |

---

## 三、数据验证

### 3.1 阶段0数据检查

| 节点名称 | 是否存在 | 数据量 | 备注 |
|---------|---------|--------|------|
| 合同基础金额 | ✅ | 3 keys | 正常 |
| 租金安排 | ✅ | 5 keys | 正常 |
| 租赁物清单 | ✅ | 5 items | **数据完整但未使用** |
| 抵押物清单 | ✅ | 1 items | **数据完整但未使用** |
| 租金支付计划 | ⚠️ | 6 items | 不完整（应为12期） |
| 放款明细 | ✅ | 1 items | 正常 |
| 违约相关金额 | ✅ | 5 keys | 正常 |
| 诉讼费用 | ✅ | 4 keys | 正常 |
| 判决金额 | ✅ | 5 keys | 正常 |

### 3.2 已有数据示例

**租赁物清单（5项）**：

| 序号 | 名称 | 规格型号 | 数量 | 评估价值 |
|------|------|---------|------|---------|
| 1 | 多联机中央空调系统 | VRV VIII代 | 10套 | 5000万元 |
| 2 | 电梯设备 | GECS-II | 4台 | 3000万元 |
| 3 | 消防控制系统 | JB-QB-GST200 | 1套 | 800万元 |
| 4 | 配电设备 | KYN28-12 | 2套 | 1200万元 |
| 5 | 给排水设备 | CDL-50 | 3套 | 600万元 |

**抵押物清单（1项）**：

| 名称 | 不动产权证号 | 地址 | 建筑面积 | 评估价值 |
|------|-------------|------|---------|---------|
| 南昌市XX广场商业房产 | 赣（2021）南昌市不动产权第XXXXXX号 | 江西省南昌市红谷滩区XX路XX号 | 5200㎡ | 1.04亿元 |

---

## 四、表格格式问题详细清单

### 4.1 第26页 - 律师信息表（10行）

| 行号 | 内容 |
|------|------|
| 14 | \| 项目 \| 左晓峰律师 \| 蔡雅雯律师 \| |
| 15 | \| :--- \| :--- \| :--- \| |
| 16 | \| 姓名 \| 左晓峰 \| 蔡雅雯 \| |
| 17 | \| 性别 \| 男 \| 女 \| |
| 18 | \| 执业证号 \| 13101202312345678 \| 13101202312345679 \| |
| 19 | \| 执业机构 \| 上海君合律师事务所 \| 上海君合律师事务所 \| |
| 20 | \| 执业类别 \| 专职律师 \| 专职律师 \| |
| 21 | \| 发证机关 \| 上海市司法局 \| 上海市司法局 \| |
| 22 | \| 有效期 \| 长期 \| 长期 \| |
| 23 | \| 年度考核备案 \| 已备案（2023年度） \| 已备案（2023年度） \| |

### 4.2 第27页 - 保险信息确认表（8行）

| 行号 | 内容 |
|------|------|
| 36 | \| 项目 \| 内容 \| |
| 37 | \| :--- \| :--- \| |
| 38 | \| 保险人 \| 中国人民财产保险股份有限公司上海市分公司 \| |
| 39 | \| 投保人/被保险人 \| 上海汇融融资租赁有限公司 \| |
| 40 | \| 保全申请人 \| 上海汇融融资租赁有限公司 \| |
| 41 | \| 保全被申请人 \| 南昌宏昌商业零售有限公司... \| |
| 42 | \| \| （空行） |
| 43 | \| 保险单号 \| PICC202403200001 \| |

### 4.3 第28页 - 保单信息确认表+送达地址确认书（14行）

| 行号 | 内容 |
|------|------|
| 1 | \| 保险金额 \| 人民币145，581，491.97元 \| |
| 2 | \| 保险期间 \| 自保全措施实施之日起... \| |
| 3 | \| 保险责任 \| 如申请人财产保全申请错误... \| |
| 5 | \| 特别约定 \| 本保单为不可撤销保函... \| |
| 12 | \| 案号 \| （2024）沪74民初245号 \| |
| 13 | \| :--- \| :--- \| |
| 14 | \| 案由 \| 融资租赁合同纠纷 \| |
| 15 | \| 当事人/代理人名称 \| 上海汇融融资租赁有限公司（原告） \| |
| 16 | \| 确认送达地址 \| 邮寄地址：... \| |
| 18 | \| 电子送达地址 \| 手机号码：... \| |
| 21 | \| 确认事项 \| 1. 本人/本单位确认... \| |
| 25 | \| \| （空行） |
| 26 | \| 当事人/代理人签收 \| 左晓峰（签名或盖章） \| |
| 27 | \| 填写日期 \| 2024年3月20日 \| |

---

## 五、修复建议

### 5.1 优先级排序

| 优先级 | 问题ID | 问题名称 | 预估修复时间 | 依赖 |
|--------|--------|---------|-------------|------|
| P0 | BUG-001 | 公司脱敏未替换 | 2小时 | 无 |
| P0 | BUG-002 | 租赁物清单未使用 | 4小时 | 阶段0数据已有 |
| P0 | BUG-003 | 抵押物清单未使用 | 4小时 | 阶段0数据已有 |
| P1 | BUG-004 | 表格格式错误 | 6小时 | 证据提示词 |
| P1 | BUG-005 | 租金计划不完整 | 2小时 | 阶段0数据 |
| P2 | BUG-006 | 租金表格未渲染 | 4小时 | 证据提示词 |

### 5.2 修复方案

#### BUG-001 修复：反脱敏

```python
# 确认 src/services/evidence_file_generator.py 第143行
deanonymized_response = self._deanonymize_text(clean_response, stage0_data)
```

#### BUG-002/003 修复：使用阶段0数据生成清单

在证据生成器中添加：

```python
def _generate_rental_list(self, stage0_data: Dict) -> str:
    """生成租赁物清单"""
    rental_list = stage0_data.get("0.4_key_numbers", {}).get("租赁物清单", [])
    
    lines = ["【租赁物清单】", ""]
    lines.append("| 序号 | 名称 | 规格型号 | 数量 | 存放地点 | 评估价值 |")
    lines.append("| :--- | :--- | :--- | :--- | :--- | :--- |")
    
    for item in rental_list:
        line = f"| {item.get('序号', '')} | {item.get('名称', '')} | {item.get('规格型号', '')} | "
        line += f"{item.get('数量', '')} {item.get('单位', '')} | {item.get('存放地点', '')} | "
        line += f"{item.get('评估价值', '')}元 |"
        lines.append(line)
    
    return "\n".join(lines)
```

#### BUG-004 修复：表格格式

修改证据提示词，移除Markdown表格格式，改用纯文本或使用reportlab生成真实表格。

### 5.3 验证命令

```bash
# 1. 检查反脱敏
python3 -c "
import PyPDF2
from pathlib import Path
pdf = PyPDF2.PdfReader('outputs/完整测试卷宗_简化版.pdf')
text = ''.join([p.extract_text() or '' for p in pdf.pages])
for i in range(1, 10):
    count = text.count(f'某某公司{i}')
    print(f'某某公司{i}: {count}处')
"

# 2. 检查数据完整性
python3 -c "
import json
from pathlib import Path
data = json.loads(Path('outputs/stage0/0.4_key_numbers.json').read_text())
print('租赁物清单:', len(data.get('租赁物清单', [])), '项')
print('抵押物清单:', len(data.get('抵押物清单', [])), '项')
print('租金支付计划:', len(data.get('租金支付计划', [])), '期')
"

# 3. 检查表格问题
python3 -c "
import PyPDF2
from pathlib import Path
pdf = PyPDF2.PdfReader('outputs/完整测试卷宗_简化版.pdf')
count = 0
for page in pdf.pages:
    text = page.extract_text() or ''
    if '|' in text and ':---' in text:
        count += 1
print(f'Markdown表格问题: {count}处')
"
```

---

## 六、结论与建议

### 6.1 测试结论

本次测试发现 **6个待修复问题**：

| 状态 | 数量 | 问题 |
|------|------|------|
| 🔴 高优先级 | 3 | 反脱敏、租赁物清单、抵押物清单 |
| 🟡 中优先级 | 3 | 表格格式、租金计划、租金表格 |
| ✅ 已修复 | 3 | 占位符、人物脱敏、机构脱敏 |

### 6.2 关键发现

**重要发现**：阶段0数据中已有完整的租赁物清单（5项）和抵押物清单（1项），但证据生成器没有使用这些数据，导致PDF中只有"（略）"。

### 6.3 建议措施

#### 立即执行（P0）

1. 🔧 修复反脱敏问题
2. 🔧 修改证据生成器，使用阶段0数据生成租赁物清单和抵押物清单

#### 短期执行（P1）

1. 📝 补充完整的12期租金数据
2. 📝 修改证据提示词，移除Markdown表格格式

---

## 七、签发

| 角色 | 姓名 | 日期 |
|------|------|------|
| 测试人员 | OpenCode AI | 2026-01-27 |
| 开发负责人 | 待定 | - |
| 项目负责人 | 待定 | - |

---

**报告结束**

---

## 附录A：问题跟踪表

| 问题ID | 问题名称 | 涉及文件 | 修复负责人 | 预计修复时间 | 状态 | 备注 |
|--------|---------|---------|-----------|-------------|------|------|
| BUG-001 | 公司脱敏未替换 | evidence_file_generator.py | | | 待修复 | |
| BUG-002 | 租赁物清单未使用 | evidence_file_generator.py, 提示词 | | | 待修复 | 数据已有 |
| BUG-003 | 抵押物清单未使用 | evidence_file_generator.py, 提示词 | | | 待修复 | 数据已有 |
| BUG-004 | 表格格式错误 | 证据提示词 | | | 待修复 | 32行 |
| BUG-005 | 租金计划不完整 | 0.4_key_numbers.json | | | 待修复 | 仅6期 |
| BUG-006 | 租金表格未渲染 | 证据提示词 | | | 待修复 | |
| BUG-007 | 占位符清理 | evidence_file_generator.py | | | ✅ 已修复 | |
| BUG-008 | 人物脱敏替换 | evidence_file_generator.py | | | ✅ 已修复 | |
| BUG-009 | 机构脱敏替换 | evidence_file_generator.py | | | ✅ 已修复 | |

## 附录B：测试命令速查

```bash
# 运行完整测试
python3 run_full_regeneration.py --stages 1,3 --no-answer-key

# 检查反脱敏
python3 -c "
import PyPDF2
from pathlib import Path
pdf = PyPDF2.PdfReader('outputs/完整测试卷宗_简化版.pdf')
text = ''.join([p.extract_text() or '' for p in pdf.pages])
for i in range(1, 10):
    count = text.count(f'某某公司{i}')
    print(f'某某公司{i}: {count}处')
"

# 检查数据完整性
python3 -c "
import json
from pathlib import Path
data = json.loads(Path('outputs/stage0/0.4_key_numbers.json').read_text())
print('租赁物清单:', len(data.get('租赁物清单', [])), '项')
print('抵押物清单:', len(data.get('抵押物清单', [])), '项')
print('租金支付计划:', len(data.get('租金支付计划', [])), '期')
"

# 检查表格问题
python3 -c "
import PyPDF2
from pathlib import Path
pdf = PyPDF2.PdfReader('outputs/完整测试卷宗_简化版.pdf')
count = sum(1 for page in pdf.pages if '|' in (page.extract_text() or '') and ':---' in (page.extract_text() or ''))
print(f'Markdown表格: {count}处')
"
```

---

## 附录C：新增问题记录（2026-01-27 16:00）

### 问题 BUG-010：新的脱敏名称不在映射表中

#### 问题描述

发现两种新的脱敏模式，**不在0.2_anonymization_plan.json映射表中**：

| 脱敏名称 | PDF中出现次数 | 映射表状态 |
|---------|--------------|-----------|
| 长江某有限公司 | 32处 | ❌ 不存在 |
| 张伟 (公司2), 张海峰 (公司6) | 16处 | ⚠️ 部分匹配但格式不同 |

#### 问题详情

**1. "长江某有限公司"**

- **出现位置**：第6-24页，多个证据文件中
- **上下文**：作为乙方（受让方）名称
- **示例**：
  ```
  【受让方（乙方）】
  名称：长江某有限公司
  统一社会信用代码：91310115MA1HA12345
  法定代表人：李明
  ```
- **问题**：映射表中没有"长江某有限公司"这个键

**2. "张伟 (公司2), 张海峰 (公司6)"**

- **出现位置**：第6、7、8、9、10、12、13、14、15、16、18、19、20、21、22、24页
- **上下文**：法定代表人
- **示例**：
  ```
  法定代表人：张伟 (公司2), 张海峰 (公司6)
  ```
- **映射表状态**：
  - 有 "张某 -> 张伟"
  - 有 "张某 -> 张海峰"
  - **但格式不匹配**：PDF中是"张伟 (公司2)"，映射表是"张某"

#### 脱敏映射表示例（当前）

```json
{
  "公司Profile库": {
    "某某公司5": "东方国际融资租赁有限公司",
    "某某公司1": "江西昌盛商业管理有限公司",
    "某某公司2": "南昌宏图房地产开发有限公司",
    "某某公司6": "深圳华创科技集团有限公司"
    // ❌ 缺少 "长江某有限公司"
  },
  "人物Profile库": {
    "张某": "张伟",
    "张某": "张海峰"
    // ⚠️ 格式不匹配
  }
}
```

#### 修复建议

**方案1：修复LLM提示词（推荐）**

在证据提示词中添加明确要求：

```markdown
## 脱敏要求
1. 必须使用以下脱敏标识（不可自行创造新的脱敏名称）：
   - 公司：某某公司1、某某公司2、某某公司5、某某公司6
   - 人物：周某、左某、蔡某1、吴某、张某
2. 禁止使用"长江某"、"华鑫某"等自行创造的脱敏名称
3. 如需新增脱敏名称，请在Profile库中查找对应标识
```

**方案2：改进反脱敏逻辑**

增强反脱敏逻辑，支持模糊匹配：

```python
def _deanonymize_text(self, text: str, stage0_data: Dict) -> str:
    # ... 现有代码 ...
    
    # 增强：处理 "张伟 (公司2)" -> "张伟"
    text = re.sub(r'张伟\s*\(公司\d+\)', '张伟', text)
    text = re.sub(r'张海峰\s*\(公司\d+\)', '张海峰', text)
    
    return text
```

#### 验证命令

```bash
python3 -c "
import PyPDF2
from pathlib import Path

pdf = PyPDF2.PdfReader('outputs/完整测试卷宗_简化版.pdf')
text = ''.join([p.extract_text() or '' for p in pdf.pages])

checks = [
    ('长江某有限公司', 0),
    ('张伟 (公司2)', 0),
    ('张海峰 (公司6)', 0),
]

for name, expected in checks:
    count = text.count(name)
    status = '✅' if count == expected else '❌'
    print(f'{status} {name}: {count}处')
"
```

---

**更新时间**: 2026-01-27 16:00  
**更新人员**: OpenCode AI
