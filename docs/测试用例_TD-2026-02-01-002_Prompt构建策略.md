# 测试用例文档：Prompt构建策略（v2.2）

**测试文档编号**: TC-2026-02-01-002
**版本**: v1.0
**日期**: 2026-02-01
**状态**: 待评审

---

## 一、概述

### 1.1 测试目标

验证Prompt构建策略（TD-2026-02-01-002）的实现是否满足验收标准：
- 每个证据的Prompt包含具体公司名称
- 每个证据的Prompt包含具体金额
- 每个证据的Prompt包含具体日期
- 无占位符残留率 ≥95%

### 1.2 测试范围

| 测试类型 | 测试对象 | 覆盖范围 |
|---------|---------|---------|
| 黑盒测试 | Prompt构建器 | 5个核心方法 |
| E2E测试 | 完整证据生成流程 | 判决书→PDF |

---

## 二、黑盒测试用例

### 2.1 测试用例：extract_involved_companies

| 用例编号 | TC-PB-001 |
|---------|-----------|
| 测试方法 | _extract_involved_companies |
| 前置条件 | stage0_data包含公司Profile库 |
| 输入数据 | evidence包含"关键数据提示.涉及方"字段 |
| 预期输出 | 包含完整公司信息的列表 |
| 优先级 | P0 |

**测试步骤**：
1. 准备包含公司Profile库的stage0_data
2. 创建evidence，包含"关键数据提示.涉及方": ["某某公司5", "某某公司1"]
3. 调用_extract_involved_companies
4. 验证返回列表包含2个公司
5. 验证每个公司包含：role, company_name, credit_code, legal_representative, address

**验证标准**：
- 返回列表长度 = 2
- 第一个公司role = "某某公司5"
- 第一个公司company_name = "东方国际融资租赁有限公司"
- 第二个公司role = "某某公司1"
- 第二个公司company_name = "江西昌盛商业管理有限公司"

---

### 2.2 测试用例：extract_amount_info

| 用例编号 | TC-PB-002 |
|---------|-----------|
| 测试方法 | _extract_amount_info |
| 前置条件 | key_numbers包含合同金额信息 |
| 输入数据 | evidence.关键数据提示.涉及金额 |
| 预期输出 | 包含数值和中文大写的字典 |
| 优先级 | P0 |

**测试步骤**：
1. 准备key_numbers，包含"合同基础金额.原合同金额.数值": 150000000
2. 创建evidence，包含"关键数据提示.涉及金额.数值": 150000000
3. 调用_extract_amount_info
4. 验证返回字典包含amount, unit, uppercase
5. 验证uppercase = "壹亿伍仟万元整"

**验证标准**：
- amount = 150000000
- unit = "元"
- uppercase = "壹亿伍仟万元整"

---

### 2.3 测试用例：extract_date_info

| 用例编号 | TC-PB-003 |
|---------|-----------|
| 测试方法 | _extract_date_info |
| 前置条件 | 无 |
| 输入数据 | evidence.关键数据提示.涉及日期 |
| 预期输出 | 格式化日期字符串 |
| 优先级 | P1 |

**测试步骤**：
1. 创建evidence，包含"关键数据提示.涉及日期": "2021年02月24日"
2. 调用_extract_date_info
3. 验证返回值为"2021年02月24日"
4. 创建无日期的evidence
5. 调用_extract_date_info
6. 验证返回值为None

**验证标准**：
- 有日期时返回正确日期字符串
- 无日期时返回None

---

### 2.4 测试用例：build_party_info_section

| 用例编号 | TC-PB-004 |
|---------|-----------|
| 测试方法 | _build_party_info_section |
| 前置条件 | 已有公司信息列表 |
| 输入数据 | companies列表 |
| 预期输出 | 格式化的当事人信息section |
| 优先级 | P0 |

**测试步骤**：
1. 准备companies列表，包含2个公司信息
2. 调用_build_party_info_section
3. 验证输出包含"某某公司5：东方国际融资租赁有限公司"
4. 验证输出包含"统一社会信用代码：91310000MA1FL3L123"
5. 验证输出包含"某某公司1：江西昌盛商业管理有限公司"

**验证标准**：
- 输出包含所有公司名称
- 输出包含所有公司的统一社会信用代码
- 输出格式符合Markdown列表格式

---

### 2.5 测试用例：assemble_prompt

| 用例编号 | TC-PB-005 |
|---------|-----------|
| 测试方法 | _assemble_prompt |
| 前置条件 | 已有基础Prompt、当事人信息、金额信息 |
| 输入数据 | base_prompt, party_info, amount_info, date_info |
| 预期输出 | 完整的Prompt字符串 |
| 优先级 | P0 |

**测试步骤**：
1. 准备基础Prompt（合同生成模板）
2. 准备party_info（当事人信息section）
3. 准备amount_info（金额信息字典）
4. 准备date_info（日期字符串）
5. 调用_assemble_prompt
6. 验证输出包含"【必须使用的具体信息】"
7. 验证输出包含公司名称
8. 验证输出包含金额（大写和数值）
9. 验证输出包含"禁止使用以下占位符"

**验证标准**：
- 输出包含【必须使用的具体信息】section
- 输出包含具体公司名称（无占位符）
- 输出包含具体金额（人民币壹亿伍仟万元整）
- 输出包含禁止占位符的警告

---

### 2.6 测试用例：build_evidence_prompt集成

| 用例编号 | TC-PB-006 |
|---------|-----------|
| 测试方法 | build_evidence_prompt |
| 前置条件 | stage0_data已加载 |
| 输入数据 | evidence（融资租赁合同） |
| 预期输出 | 完整的Prompt字符串 |
| 优先级 | P0 |

**测试步骤**：
1. 准备完整的stage0_data（包含profiles, key_numbers）
2. 创建evidence（融资租赁合同，包含涉及方：某某公司5, 某某公司1）
3. 调用build_evidence_prompt(evidence, "合同")
4. 验证返回的Prompt包含甲方信息
5. 验证返回的Prompt包含乙方信息
6. 验证返回的Prompt包含具体金额
7. 验证返回的Prompt无占位符

**验证标准**：
- Prompt包含"东方国际融资租赁有限公司"
- Prompt包含"江西昌盛商业管理有限公司"
- Prompt包含"人民币壹亿伍仟万元整"
- Prompt不包含"某某公司"、"X4"、"X年月日"

---

## 三、E2E测试用例

### 3.1 测试用例：判决书→Prompt构建→LLM生成

| 用例编号 | TC-E2E-001 |
|---------|-----------|
| 测试场景 | 完整证据生成流程 |
| 前置条件 | 判决书已解析，stage0_data已生成 |
| 测试数据 | (2024)沪74民初721号 |
| 预期输出 | 证据文件无占位符 |
| 优先级 | P0 |

**测试步骤**：
1. 加载判决书(2024)沪74民初721号
2. 执行Stage 0：理解交易结构
3. 验证stage0_data包含公司Profile库
4. 执行Stage 1：生成证据
5. 对于每个证据：
   a. 调用build_evidence_prompt生成Prompt
   b. 验证Prompt包含具体公司名称
   c. 验证Prompt包含具体金额
   d. 调用LLM生成证据内容
   e. 验证生成内容无占位符
6. 生成PDF文件

**验证标准**：
- 10个证据中，至少9个（90%）无占位符
- 所有证据的Prompt都包含具体公司名称
- 所有证据的Prompt都包含具体金额

---

### 3.2 测试用例：多证据类型Prompt构建

| 用例编号 | TC-E2E-002 |
|---------|-----------|
| 测试场景 | 不同证据类型的Prompt构建 |
| 前置条件 | 多种类型证据（合同、文书、凭证） |
| 测试数据 | 包含融资租赁合同、执行证书、银行凭证 |
| 预期输出 | 各类型证据的Prompt都符合规范 |
| 优先级 | P1 |

**测试步骤**：
1. 准备3种类型证据：
   - 证据1：融资租赁合同（合同类型）
   - 证据2：执行证书（文书类型）
   - 证据3：银行付款凭证（凭证类型）
2. 对每个证据调用build_evidence_prompt
3. 验证合同类型Prompt包含当事人双方信息
4. 验证文书类型Prompt包含金额信息
5. 验证凭证类型Prompt包含金额和日期

**验证标准**：
- 合同类型：包含甲方和乙方信息
- 文书类型：包含金额和日期
- 凭证类型：包含金额和日期
- 所有类型Prompt均无占位符

---

### 3.3 测试用例：占位符残留率验证

| 用例编号 | TC-E2E-003 |
|---------|-----------|
| 测试场景 | 验证95%通过率目标 |
| 前置条件 | 完整证据集（33个证据） |
| 测试数据 | 全部33个证据 |
| 预期输出 | 31/33证据无占位符 |
| 优先级 | P0 |

**测试步骤**：
1. 生成完整证据集（33个证据）
2. 对每个证据文件执行占位符检测
3. 统计含占位符的证据数量
4. 计算通过率
5. 生成测试报告

**验证标准**：
- 无占位符证据数 ≥ 31（93.9%，>95%目标）
- 如低于95%，记录失败证据的占位符类型
- 生成详细测试报告

---

## 四、测试数据

### 4.1 测试用stage0_data

```json
{
  "0.2_脱敏替换策划": {
    "公司Profile库": {
      "某某公司5": {
        "原脱敏标识": "某某公司5",
        "公司名称": "东方国际融资租赁有限公司",
        "统一社会信用代码": "91310000MA1FL3L123",
        "法定代表人": "周明远",
        "注册地址": "中国（上海）自由贸易试验区世纪大道100号"
      },
      "某某公司1": {
        "原脱敏标识": "某某公司1",
        "公司名称": "江西昌盛商业管理有限公司",
        "统一社会信用代码": "91360121MA1XXXXXXX",
        "法定代表人": "李明",
        "注册地址": "江西省南昌市红谷滩区XX路XX号"
      }
    }
  },
  "0.4_关键数字清单": {
    "合同基础金额": {
      "原合同金额": {
        "数值": 150000000,
        "单位": "元",
        "大写": "壹亿伍仟万元整"
      }
    }
  }
}
```

### 4.2 测试用evidence

```json
{
  "证据名称": "融资租赁合同",
  "证据组": 1,
  "证据序号": 1,
  "文件类型": "合同",
  "证明目的": "证明融资租赁合同关系成立",
  "关键数据提示": {
    "涉及金额": {
      "数值": 150000000,
      "单位": "元"
    },
    "涉及日期": "2021年02月24日",
    "涉及方": ["某某公司5", "某某公司1"]
  },
  "关联交易节点": 1
}
```

---

## 五、验收标准汇总

| 验收项 | 标准 | 测试用例 |
|--------|------|---------|
| Prompt包含具体公司名称 | 100% | TC-PB-001, TC-PB-004, TC-PB-006 |
| Prompt包含具体金额 | 100% | TC-PB-002, TC-PB-006 |
| Prompt包含具体日期 | 100% | TC-PB-003, TC-PB-006 |
| 无占位符残留 | ≥95% | TC-E2E-001, TC-E2E-002, TC-E2E-003 |
| 单元测试通过率 | 100% | 6/6 |

---

## 六、测试执行记录

| 用例编号 | 执行日期 | 执行人 | 结果 | 备注 |
|---------|---------|-------|------|------|
| TC-PB-001 | - | - | 待执行 | - |
| TC-PB-002 | - | - | 待执行 | - |
| TC-PB-003 | - | - | 待执行 | - |
| TC-PB-004 | - | - | 待执行 | - |
| TC-PB-005 | - | - | 待执行 | - |
| TC-PB-006 | - | - | 待执行 | - |
| TC-E2E-001 | - | - | 待执行 | - |
| TC-E2E-002 | - | - | 待执行 | - |
| TC-E2E-003 | - | - | 待执行 | - |

---

**文档版本**: v1.0
**创建日期**: 2026-02-01
**最后更新**: 2026-02-01
