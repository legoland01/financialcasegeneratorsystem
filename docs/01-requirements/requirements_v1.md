# financial_case_generator_system - 问题修复需求文档

## 版本信息
- **版本**: v1
- **创建日期**: 2026-01-31
- **作者**: Agent 1 (产品经理)

## 1. 项目概述

### 1.1 背景
financial_case_generator_system 是一个金融案件证据集生成系统，从判决书自动生成完整的诉讼材料卷宗。系统开发已基本完成，但需要确保单一命令能够生成全部材料且无已知缺陷。

### 1.2 目标
确保 `python3 run_complete.py` 命令能够：
1. 完整执行 Stage 0 → Stage 1 → PDF 生成
2. 输出所有阶段的文件
3. 修复所有已知的缺陷

## 2. 功能需求

### 2.1 入口脚本功能
| 序号 | 功能名称 | 优先级 | 描述 |
|------|---------|:------:|------|
| F1.1 | 完整流程执行 | P0 | 默认命令执行完整流程（Stage 0 + Stage 1 + PDF） |
| F1.2 | Stage 0 单独执行 | P1 | 支持 `--stage0` 参数仅执行 Stage 0 |
| F1.3 | 数据修复 | P0 | 自动修复 key_numbers.json 和 evidence_index.json |

### 2.2 证据生成功能
| 序号 | 功能名称 | 优先级 | 描述 |
|------|---------|:------:|------|
| F2.1 | 证据目录正确 | P0 | 证据生成到 `outputs/stage1/evidence/证据组X/` |
| F2.2 | 证据索引正确 | P0 | evidence_index.json 路径正确 |

### 2.3 输出验证功能
| 序号 | 功能名称 | 优先级 | 描述 |
|------|---------|:------:|------|
| F3.1 | Stage 0 输出 | P0 | 生成 5 个 JSON 文件（0.1-0.5） |
| F3.2 | Stage 1 输出 | P0 | 生成民事起诉状和证据文件 |
| F3.3 | PDF 输出 | P0 | 生成完整测试卷宗.pdf |

## 3. 已修复问题清单

以下问题已在历史版本中修复，需确认修复有效：

| 序号 | 问题编号 | 问题描述 | 修复状态 | 验证方法 |
|------|---------|---------|---------|---------|
| 1 | BUG-ENTRY-001 | 入口脚本只运行Stage 0，不生成证据 | 已修复 | 运行完整流程 |
| 2 | BUG-EVDIR-001 | 证据目录重复创建 | 已修复 | 检查目录结构 |
| 3 | BUG-EVIDX-001 | 证据索引路径错误 | 已修复 | 检查 evidence_index.json |
| 4 | BUG-FIXKEY-001 | fix_key_numbers 调用时机错误 | 已修复 | 检查金额一致性 |
| 5 | BUG-API-001 | SiliconFlow API 端点错误 | 已修复 | 检查 API 连接 |

## 4. 验收标准

### 4.1 命令执行验收
- [ ] `python3 run_complete.py` 完整执行
- [ ] 所有 Stage 0 文件生成（5个 JSON）
- [ ] 所有 Stage 1 文件生成（起诉状 + 21个证据）
- [ ] PDF 文件生成（outputs_complete/完整测试卷宗.pdf）

### 4.2 数据验证验收
- [ ] 设备总额与合同金额一致
- [ ] 证据索引文件存在且正确
- [ ] 所有证据文件可读

### 4.3 性能验收
- [ ] Stage 0 在合理时间内完成（< 5分钟）
- [ ] Stage 1 在合理时间内完成（< 10分钟）
- [ ] 总执行时间 < 15分钟

## 5. 约束条件

### 5.1 技术约束
- 使用 SiliconFlow API (DeepSeek-V3.2)
- Python 3.8+
- macOS 环境

### 5.2 时间约束
- 问题修复需在 1 个工作日内完成
- 验证测试需在 30 分钟内完成

## 6. 风险评估

| 风险 | 可能性 | 影响 | 应对措施 |
|-----|:------:|:----:|---------|
| LLM API 超时 | 中 | 高 | 增加超时时间，失败重试 |
| 证据生成不完整 | 低 | 高 | 数据修复函数兜底 |
| 金额验证失败 | 低 | 中 | 修复函数自动补充 |

## 7. 待验证事项

根据 docs/API问题排查记录.md，以下问题需要验证：
1. 入口脚本逻辑是否正确
2. 证据目录是否正确
3. 证据索引路径是否正确
4. 数据修复函数是否有效

## 8. 测试方法

```bash
# 完整流程测试
cd /path/to/project
python3 run_complete.py

# 检查输出
ls -la outputs/stage0/
ls -la outputs/stage1/evidence/
ls -la outputs_complete/

# 验证PDF
open outputs_complete/完整测试卷宗.pdf
```
