# 需求评审记录

**日期**: 2026-02-01
**评审人**: Agent2 (开发)
**评审状态**: 已批准

---

## 一、评审需求

**需求来源**: PRODUCT_REQUIREMENTS.md 第七章（Prompt构建策略 v2.2新增）

**需求概述**: 真实验证发现仅靠Prompt指令禁止占位符无效，需在构建阶段直接列出具体信息。

**测试背景**:
- 测试时间: 2026-02-01 10:05
- 测试类型: 黑盒测试（真实LLM调用）
- 测试结果: ❌ 未通过 - LLM持续生成占位符

---

## 二、问题背景

### 根本原因

| 项目 | 内容 |
|------|------|
| 问题 | LLM仍持续生成 `某某公司`、`X4` 等占位符 |
| 根因1 | LLM难以从JSON格式的Profile库中正确提取并使用具体名称 |
| 根因2 | 需要在Prompt构建阶段直接列出所有必须使用的具体信息 |

### 核心原则

**不是** "生成后替换"
**而是** "生成时提供完整上下文"

```
原始数据 → 对象提取 → Prompt构建 → LLM生成
                    ↓
          直接列出具体名称和金额
```

---

## 三、需求内容

### 3.1 Prompt构建流程（6步）

```
Step 1: 分析目标内容类型（合同/文书/凭证）
Step 2: 从证据信息中提取涉及的对象（公司、人、时间、金额）
Step 3: 从Profile库中查找每个对象的完整信息
Step 4: 直接列出具体信息（禁止LLM自行查找）
Step 5: 明确禁止占位符
Step 6: 生成证据
```

### 3.2 核心方法接口

| 方法 | 输入 | 输出 | 说明 |
|------|------|------|------|
| `build_evidence_prompt()` | evidence, evidence_type | str | 构建证据生成的Prompt |
| `_extract_involved_companies()` | evidence, profiles | List[Dict] | 提取涉及的公司 |
| `_extract_amount_info()` | evidence, key_numbers | Dict | 提取金额信息 |
| `_build_party_info_section()` | companies | str | 构建当事人信息部分 |
| `_assemble_prompt()` | base_prompt, party_info, amount, evidence | str | 组装完整Prompt |

### 3.3 Prompt模板结构

```markdown
# 任务：生成[证据类型]

## 🚨 强制要求
生成内容时必须使用以下具体信息，禁止使用任何占位符。

## 【必须使用的具体信息】

### 公司信息
- 甲方（出租人）：[公司名称]
  统一社会信用代码：[代码]
  法定代表人：[姓名]
  地址：[地址]

### 金额信息
涉及金额：人民币[大写金额]（¥[数值]）

### 日期信息
合同签订日期：[YYYY年MM月DD日]

请严格按照上述具体信息生成，禁止使用"某某"、"某公司"、"X"、"人民币X元"等占位符。
```

---

## 四、评审意见

### 4.1 需求合理性评估

| 维度 | 评估 | 说明 |
|------|------|------|
| 问题定位 | ✅ 准确 | 根因分析到位 |
| 核心原则 | ✅ 正确 | "生成时提供完整上下文"而非"生成后替换" |
| 技术方案 | ✅ 清晰 | 6步流程和接口设计合理 |
| 可行性 | ✅ 可行 | 有明确的方法定义和代码示例 |

### 4.2 建议补充

| 项目 | 建议 | 优先级 |
|------|------|--------|
| 异常处理 | 需明确：当公司名称/金额/日期缺失时的兜底策略 | P1 |
| 测试验证 | 需补充：如何验证Prompt包含具体信息（自动化检查） | P2 |
| 实施优先级 | `build_evidence_prompt()` > `_extract_*` > `_assemble_prompt()` | - |

### 4.3 验收标准确认

| 原标准 | 建议调整 | 原因 |
|--------|---------|------|
| Prompt包含具体公司名称：100%覆盖 | **每个证据的Prompt必须包含涉及公司的具体名称** | 可验证、可测试 |
| Prompt包含具体金额：100%覆盖 | **每个证据的Prompt必须包含涉及金额** | 可验证、可测试 |
| Prompt包含具体日期：100%覆盖 | **每个证据的Prompt必须包含涉及日期（如有）** | 可验证、可测试 |
| 无占位符残留：≥95%通过 | **保持 ≥95%通过** | 核心指标 |

---

## 五、时间估算

| 任务 | 预估时间 |
|------|---------|
| `_extract_involved_companies()` 实现 | 30分钟 |
| `_extract_amount_info()` 实现 | 20分钟 |
| `_build_party_info_section()` 实现 | 20分钟 |
| `_assemble_prompt()` 实现 | 30分钟 |
| `build_evidence_prompt()` 集成 | 30分钟 |
| 单元测试 | 30分钟 |
| **总计** | **约2.5小时** |

---

## 六、决策

| 决策项 | 决定 |
|--------|------|
| 需求认可 | ✅ 批准 |
| 开始开发 | 待产品经理确认 |
| 预期完成时间 | 2-3小时 |
| 预期开始时间 | 确认后立即开始 |

---

## 七、影响范围

### 7.1 新增文件

| 文件路径 | 说明 |
|---------|------|
| 无（现有文件扩展） | 需扩展 `src/services/evidence_file_generator.py` |

### 7.2 修改文件

| 文件路径 | 修改内容 |
|---------|---------|
| `src/services/evidence_file_generator.py` | 新增5个方法 |

### 7.3 依赖

| 依赖项 | 说明 |
|--------|------|
| `stage0_data["0.2_脱敏替换策划"]` | 公司Profile库 |
| `stage0_data["0.4_关键数字清单"]` | 金额信息 |
| `evidence["关键数据提示"]` | 涉及方和涉及金额 |

---

**评审人**: Agent2 (开发)
**日期**: 2026-02-01
