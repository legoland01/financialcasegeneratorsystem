# 需求文档：多模态质量检测

**文档编号**: TD-2026-02-01-003
**版本**: v1.0
**日期**: 2026-02-01
**状态**: 待评审

---

## 一、背景

### 1.1 问题描述

PDF生成存在质量问题，需要多模态模型检测：

| 问题类型 | 示例 | 当前检测方法 |
|---------|------|-------------|
| 文本问题 | 某某设备、若干台 | pdftotext + 正则 ✅ |
| **布局问题** | 留白、回车、表格、编号断裂 | **需要多模态** ❌ |

### 1.2 用户反馈的问题（布局相关）

1. 条款后有过长留白
2. 回车没有正确放置
3. 括号后错误添加回车
4. 条款编号断裂（第4条后直接跟1.1）

---

## 二、需求定义

### 2.1 功能需求

| 需求编号 | 功能描述 | 优先级 |
|---------|---------|--------|
| MR-001 | 使用Qwen-VL-Max分析PDF布局 | P0 |
| MR-002 | 检测条款编号连续性 | P0 |
| MR-003 | 检测异常留白 | P1 |
| MR-004 | 检测回车位置正确性 | P1 |
| MR-005 | 检测表格格式 | P1 |

### 2.2 非功能需求

| 需求编号 | 描述 |
|---------|------|
| NFR-001 | 单次分析响应时间 < 30秒 |
| NFR-002 | API成本 < ¥0.05/次 |
| NFR-003 | 支持SiliconFlow API |

---

## 三、技术方案

### 3.1 技术选型

| 组件 | 选择 | 理由 |
|------|------|------|
| 多模态模型 | Qwen-VL-Max | SiliconFlow可用，效果好 |
| PDF处理 | PyMuPDF | 支持PDF转图片 |
| API | SiliconFlow | 用户指定 |

### 3.2 接口设计

```python
class MultimodalQA:
    def __init__(self, api_key: str = None):
        """初始化多模态检测器"""
        
    def analyze_pdf_layout(self, pdf_path: str) -> Dict:
        """
        分析PDF布局质量
        
        Returns:
        {
            "success": True,
            "analysis": {...},
            "issues": [
                {
                    "type": "clause_numbering/layout/whitespace/line_break",
                    "severity": "high/medium/low",
                    "description": "问题描述",
                    "location": "位置"
                }
            ]
        }
        """
```

### 3.3 测试用例

| 用例编号 | 测试场景 | 预期结果 |
|---------|---------|---------|
| TC-MV-001 | 检测条款编号断裂 | 发现并报告问题 |
| TC-MV-002 | 检测异常留白 | 发现并报告问题 |
| TC-MV-003 | 检测回车位置 | 发现并报告问题 |
| TC-MV-004 | 检测表格格式 | 发现并报告问题 |

---

## 四、实现步骤

### 4.1 开发任务

| 步骤 | 任务 | 负责人 |
|------|------|--------|
| 1 | 实现 MultimodalQA 类 | Agent2 |
| 2 | 集成 SiliconFlow API | Agent2 |
| 3 | 添加测试用例 | Agent1 |
| 4 | 端到端测试 | Agent1 |

### 4.2 验收标准

- [ ] 能检测到用户反馈的条款编号断裂问题
- [ ] 能检测到异常留白
- [ ] 能检测到回车位置错误
- [ ] 单次分析 < 30秒
- [ ] API成本 < ¥0.05/次

---

## 五、运行方式

```bash
# 环境变量设置
export SILICONFLOW_API_KEY="your-api-key"
export MULTIMODAL_TEST=1

# 运行多模态测试
python3 -m pytest tests/blackbox/test_pdf_quality.py::TestPDFLayoutQuality -v

# 或直接运行分析
python3 -m src/utils/multimodal_qa.py path/to/pdf.pdf --api-key xxx
```

---

## 六、依赖

| 依赖 | 版本 | 说明 |
|------|------|------|
| PyMuPDF | latest | PDF转图片 |
| requests | latest | HTTP客户端 |
| python-dotenv | latest | 环境变量管理 |

---

## 七、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| API调用失败 | 无法检测 | 降级到文本检测 |
| 成本过高 | 预算超支 | 限制调用频率 |
| 模型效果不佳 | 漏检 | 人工抽检补充 |

---

## 八、评审记录

| 评审人 | 意见 | 日期 |
|--------|------|------|
| Agent1 (产品) | 创建需求文档 | 2026-02-01 |
| 用户 | 批准实现 | 2026-02-01 |

---

**文档版本**: v1.0
**创建日期**: 2026-02-01
