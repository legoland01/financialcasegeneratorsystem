# 详细设计评审报告

**评审文档**: TD-2026-01-27-001 v1.0 (Draft)  
**评审日期**: 2026-01-27  
**评审人**: 产品经理  
**状态**: 待开发确认

---

## 一、评审结论

| 评审项 | 状态 | 说明 |
|--------|------|------|
| 整体架构 | ✅ 通过 | 分层架构清晰，组件划分合理 |
| 缓存机制 | ✅ 通过 | judgment_hash缓存键设计正确 |
| 三层数据结构 | ✅ 通过 | 边界条件+详细数据设计正确 |
| EvidenceRenderer | ✅ 通过 | 合同+表格渲染器设计正确 |
| DynamicPromptBuilder | ✅ 通过 | 上下文注入设计正确 |
| 边界条件来源 | ✅ 已澄清 | 从判决书文本直接解析（LLM结构化提取） |

**总体评价**: 设计准确理解了v2.0需求的核心设计决策，开发已澄清边界条件来源方式，评审通过。

---

## 二、设计亮点

### 2.1 缓存机制设计正确

```
cache/{judgment_hash}.json
```

开发正确理解了"按判决书缓存"的策略：
- 同一判决书 → 相同哈希 → 使用缓存
- 不同判决书 → 不同哈希 → 生成新数据
- 支持 force_refresh 强制刷新

### 2.2 三层数据结构正确

```json
{
  "boundary_conditions": {...},    // Layer 2: 必须来自判决书
  "generated_data": {...},         // Layer 3: 自动生成
  "deanonymization_context": {...} // 反脱敏上下文
}
```

符合RFC-2026-01-27-001定义。

### 2.3 EvidenceRenderer设计正确

实现了需求规定的两个核心渲染器：
- `render_contract()` - 合同格式（标题18号黑体、正文12号宋体）
- `render_table()` - 表格格式（灰底表头、斑马纹）

### 2.4 Prompt构建器设计正确

正确理解了"生成时提供上下文"的设计原则：
- 反脱敏信息在Prompt中一次性提供
- 避免LLM创造新的脱敏模式
- 不是"生成后替换"，而是"生成时注入"

---

## 三、开发确认事项（已回复）

### 3.1 边界条件来源方式

**开发选择**: **A) 从判决书文本直接解析（LLM结构化提取）**

**详细说明**:
```
┌─────────────────────────────────────────────────────────────┐
│ 边界条件提取流程                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  原始判决书文件                                               │
│      ↓                                                       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  BoundaryConditionExtractor                          │    │
│  │                                                     │    │
│  │  使用LLM结构化提取（推荐）:                          │    │
│  │  - Prompt: "请从以下判决书中提取关键数据..."        │    │
│  │  - 输出: JSON格式边界条件                            │    │
│  │                                                     │    │
│  │  备选: 正则表达式解析                                │    │
│  │  - 金额: r'([\d,]+\.?\d*)\s*元'                    │    │
│  │  - 日期: r'(\d{4})年(\d{1,2})月(\d{1,2})日'        │    │
│  └─────────────────────────────────────────────────────┘    │
│      ↓                                                       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  边界条件 (Boundary Conditions)                      │    │
│  │  {                                                    │    │
│  │    "合同金额": 150000000,                            │    │
│  │    "利率": 0.061,                                    │    │
│  │    "签订日期": "2021-02-24",                         │    │
│  │    "当事人": {...},                                  │    │
│  │    "数据来源": "判决书文本"                          │    │
│  │  }                                                    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**为什么选择A而不是B**:
1. **减少依赖**: 不依赖Stage 0输出，直接从原始判决书获取
2. **保证准确性**: 边界条件来自第一手资料
3. **符合设计**: v2.0强调"完全自动化"，边界条件应从判决书直接提取

**边界条件提取器设计**:
```python
class BoundaryConditionExtractor:
    """边界条件提取器 - 从判决书文本直接提取"""
    
    def extract(self, judgment_text: str) -> dict:
        """
        从判决书文本提取边界条件
        
        Args:
            judgment_text: 判决书原始文本
        Returns:
            边界条件字典
        """
        # 使用LLM结构化提取
        prompt = self._build_extraction_prompt(judgment_text)
        response = self._call_llm(prompt)
        
        # 解析JSON响应
        boundary_conditions = json.loads(response)
        
        # 验证必填字段
        self._validate_required_fields(boundary_conditions)
        
        return boundary_conditions
    
    def _build_extraction_prompt(self, judgment_text: str) -> str:
        return """
# 任务：从判决书中提取关键数据

请从以下判决书文本中提取关键数据，以JSON格式输出。

## 提取要求
1. 只提取判决书中**明确列出**的数据
2. 如果某项数据判决书没有提及，标记为null
3. 金额使用数字格式（单位：元）
4. 日期使用YYYY-MM-DD格式

## 提取字段
- contract_amount: 合同金额（数字）
- interest_rate: 年利率（小数，如0.061表示6.1%）
- signing_date: 签订日期（YYYY-MM-DD）
- equipment_count: 设备数量（数字）
- lessor_marker: 出租人脱敏标识（如"某某公司5"）
- lessee_marker: 承租人脱敏标识（如"某某公司1"）
- guarantor_marker: 担保人脱敏标识（如有）

## 判决书文本
{judgment_text}

## 输出格式
```json
{{
  "contract_amount": 150000000,
  "interest_rate": 0.061,
  "signing_date": "2021-02-24",
  "equipment_count": 62,
  "lessor_marker": "某某公司5",
  "lessee_marker": "某某公司1",
  "guarantor_marker": null,
  "data_source": "判决书文本"
}}
```
"""
```

---

### 3.2 边界条件提取流程图（补充）

```
┌─────────────────────────────────────────────────────────────┐
│ 原始判决书文件 (judgment.txt)                               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 边界条件提取                                                 │
│                                                             │
│ 方式1: LLM结构化提取（推荐）                                 │
│   - 使用Prompt要求LLM提取金额、日期、当事人等                │
│   - 输出格式化为JSON                                         │
│                                                             │
│ 方式2: 正则表达式解析                                        │
│   - 金额: r'([\d,]+\.?\d*)\s*元'                            │
│   - 日期: r'(\d{4})年(\d{1,2})月(\d{1,2})日'                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 边界条件 (Boundary Conditions)                              │
│ {                                                           │
│   "合同金额": 150000000,                                    │
│   "利率": 0.061,                                            │
│   "签订日期": "2021-02-24",                                 │
│   ...                                                       │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.3 缓存清理策略（补充）

| 策略 | 说明 | 触发条件 |
|------|------|---------|
| 时间过期 | 保留最近30天的缓存 | 每次运行检查 |
| 数量限制 | 最多保留100个缓存文件 | 达到100个时清理最旧 |
| 手动清理 | 提供清理命令 `python clean_cache.py` | 用户主动触发 |

**清理命令**:
```bash
# 清理所有缓存
python clean_cache.py --all

# 清理指定判决书的缓存
python clean_cache.py --hash a1b2c3...

# 清理过期缓存（30天前）
python clean_cache.py --expired
```

---

### 3.4 测试配置示例（补充）

#### 测试场景1: 合同金额+10%（测试不一致检测）
```json
{
  "test_config": {
    "enabled": true,
    "description": "测试数据不一致检测",
    "errors": [
      {
        "target": "boundary_conditions.合同金额",
        "operation": "multiply",
        "value": 1.1
      }
    ]
  }
}
```

#### 测试场景2: 利率改为8%
```json
{
  "test_config": {
    "enabled": true,
    "description": "测试极端利率",
    "errors": [
      {
        "target": "boundary_conditions.利率",
        "operation": "replace",
        "value": 0.08
      }
    ]
  }
}
```

#### 测试场景3: 设备数量-50%
```json
{
  "test_config": {
    "enabled": true,
    "description": "测试设备数量变化",
    "errors": [
      {
        "target": "boundary_conditions.设备数量",
        "operation": "multiply",
        "value": 0.5
      }
    ]
  }
}
```

---

## 四、开发确认清单

| 序号 | 确认项 | 开发回复 |
|------|--------|---------|
| 1 | 边界条件来源方式 | A) 从判决书文本直接解析（LLM结构化提取） |
| 2 | 补充边界条件提取流程图 | 已补充 |
| 3 | 补充缓存清理策略 | 已补充 |
| 4 | 补充测试配置示例 | 已补充 |

**评审状态**: ✅ **通过**

---

## 五、评审清单（更新）

| 检查项 | 结果 |
|--------|------|
| 缓存键设计（judgment_hash） | ✅ 正确 |
| 缓存失效机制（force_refresh） | ✅ 正确 |
| 三层数据结构 | ✅ 正确 |
| 设备清单生成逻辑 | ✅ 正确 |
| 租金计划计算逻辑 | ✅ 正确 |
| 反脱敏上下文注入 | ✅ 正确 |
| 合同渲染器格式 | ✅ 正确 |
| 表格渲染器格式 | ✅ 正确 |
| 智能分页控制 | ✅ 正确 |
| 边界条件来源 | ✅ 已澄清（A: LLM结构化提取） |

---

## 六、后续行动

| 行动项 | 负责人 | 状态 |
|--------|--------|------|
| 更新详细设计文档（TD-2026-01-27-001） | 开发 | 待执行 |
| 实现BoundaryConditionExtractor | 开发 | 待执行 |
| 实现CacheManager（含清理策略） | 开发 | 待执行 |
| 实现测试配置注入功能 | 开发 | 待执行 |
| 开始开发 | 开发 | 待产品确认后 |

---

## 七、参考文档

| 文档 | 版本 | 说明 |
|------|------|------|
| PRODUCT_REQUIREMENTS.md | v2.0 | 产品需求文档 |
| 需求澄清_RFC-2026-01-27-001_v2数据策略.md | v2.0 | 核心设计决策 |
| IMPLEMENTATION_HANDOFF.md | v1.0 | 开发交接文档 |
| 详细设计_TD-2026-01-27-001.md | v1.0 | 待更新 |

---

**创建日期**: 2026-01-27  
**评审人**: 产品经理  
**更新**: 2026-01-27（开发已回复所有确认事项）  
**状态**: ✅ **评审通过，待开发执行**
