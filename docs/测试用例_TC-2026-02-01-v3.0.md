# 金融案件证据集生成系统 v3.0 - 测试用例

**文档编号**: TC-2026-02-01-v3.0
**版本**: v1.0
**日期**: 2026-02-01
**基于需求**: PRD-2026-02-01-v3.0
**基于设计**: TD-2026-02-01-v3.0
**状态**: 待评审

---

## 一、测试范围

| 模块 | 测试内容 | 测试类型 |
|------|---------|---------|
| F2.1 CaseAnalyzer | 案情分析逻辑 | 单元测试 |
| F2.2 ClaimExtractor | 诉求提取逻辑 | 单元测试 |
| F2.3 EvidencePlanner | 证据规划逻辑 | 单元测试 |
| F2.4 EvidenceCollector | 证据收集逻辑 | 单元测试 |
| F2.5 EvidenceListCreator | 证据列表创建 | 单元测试 |
| F2.6 LitigationComplaintGenerator | 起诉状生成 | 单元测试 |
| F2.7-F2.10 DocumentGenerator | 文档生成 | 单元测试 |
| F2.11 EvidenceIndexGenerator | 证据索引生成 | 单元测试 |
| 全流程 | 端到端测试 | 集成测试 |

---

## 二、核心规则测试

### 2.1 脱敏标记隔离测试

| 用例ID | 测试场景 | 预期结果 |
|--------|---------|---------|
| TC-v3.0-001 | EvidenceList只包含真实信息 | 不出现"某某公司"、"XX"等脱敏标记 |
| TC-v3.0-002 | LLM Prompt只传入真实名称 | Prompt中不使用脱敏标记 |
| TC-v3.0-003 | 生成证据中不使用脱敏标记 | 证据文本中不出现脱敏标记 |

### 2.2 要素驱动测试

| 用例ID | 测试场景 | 预期结果 |
|--------|---------|---------|
| TC-v3.0-004 | CaseAnalyzer从判决书提取要素 | 要素必须从判决书提取 |
| TC-v3.0-005 | EvidenceListCreator从CaseData提取 | 证据列表必须从案情数据提取 |
| TC-v3.0-006 | EvidenceGenerator根据EvidenceList生成 | LLM只负责生成，不负责提取 |

### 2.3 附件规划测试

| 用例ID | 测试场景 | 预期结果 |
|--------|---------|---------|
| TC-v3.0-007 | F2.3规划附件形式 | 合同类证据必须规划附件形式 |
| TC-v3.0-008 | 附件数据来自案情数据 | 附件数据不应该是LLM编造 |

---

## 三、功能模块测试

### 3.1 F2.1 CaseAnalyzer 测试

```python
# tests/unit/test_case_analyzer.py

class TestCaseAnalyzer:
    def test_extract_parties(self, sample_judgment):
        """测试当事人信息提取"""
        analyzer = CaseAnalyzer()
        case_data = analyzer.analyze(sample_judgment)
        
        assert case_data.plaintiff.name == "东方金融租赁有限公司"
        assert case_data.defendant.name == "南昌宏昌商业零售有限公司"
        assert case_data.plaintiff.credit_code is not None
    
    def test_extract_contract_info(self, sample_judgment):
        """测试合同信息提取"""
        analyzer = CaseAnalyzer()
        case_data = analyzer.analyze(sample_judgment)
        
        assert case_data.contract.type == CaseType.FINANCING_LEASE
        assert case_data.contract.amount == 150000000
        assert case_data.contract.signing_date == datetime(2021, 2, 24)
```

### 3.2 F2.2 ClaimExtractor 测试

```python
# tests/unit/test_claim_extractor.py

class TestClaimExtractor:
    def test_extract_principal_claim(self, sample_judgment):
        """测试本金诉求提取"""
        extractor = ClaimExtractor()
        claims = extractor.extract(sample_judgment)
        
        principal = next((c for c in claims.claims if c.type == "本金"), None)
        assert principal is not None
        assert principal.amount == 150000000
    
    def test_extract_interest_claim(self, sample_judgment):
        """测试利息诉求提取"""
        extractor = ClaimExtractor()
        claims = extractor.extract(sample_judgment)
        
        interest = next((c for c in claims.claims if c.type == "利息"), None)
        assert interest is not None
```

### 3.3 F2.3 EvidencePlanner 测试

```python
# tests/unit/test_evidence_planner.py

class TestEvidencePlanner:
    def test_plan_evidence_for_claim(self, case_data, claim_list):
        """测试根据诉求规划证据"""
        planner = EvidencePlanner()
        requirements = planner.plan(case_data, claim_list)
        
        assert len(requirements.requirements) > 0
        assert any(r.type == "合同类" for r in requirements.requirements)
    
    def test_plan_attachments(self, case_data, claim_list):
        """测试附件规划"""
        planner = EvidencePlanner()
        requirements = planner.plan(case_data, claim_list)
        
        for req in requirements.requirements:
            if req.type == "合同类":
                assert req.attachment is not None
                assert req.attachment.form in ["独立文件", "正文包含"]
```

### 3.4 F2.5 EvidenceListCreator 测试 ← 核心

```python
# tests/unit/test_evidence_list_creator.py

class TestEvidenceListCreator:
    def test_extract_key_info_from_case_data(self, case_data, collection, requirements):
        """测试从案情数据提取关键信息"""
        creator = EvidenceListCreator()
        evidence_list = creator.create(case_data, collection, requirements)
        
        for item in evidence_list.items:
            # 关键信息必须来自CaseData
            assert "某某" not in str(item.key_info.values())
            assert len(item.key_info) > 0
    
    def test_no_deanonymization_in_evidence_list(self, case_data, collection, requirements):
        """测试证据列表不包含脱敏标记"""
        creator = EvidenceListCreator()
        evidence_list = creator.create(case_data, collection, requirements)
        
        for item in evidence_list.items:
            prompt_context = item.to_prompt_context()
            assert "某某" not in prompt_context
            assert "XX" not in prompt_context
            assert "X月X日" not in prompt_context
    
    def test_real_names_in_evidence_list(self, case_data, collection, requirements):
        """测试证据列表使用真实名称"""
        creator = EvidenceListCreator()
        evidence_list = creator.create(case_data, collection, requirements)
        
        for item in evidence_list.items:
            if "出租人" in item.key_info:
                assert item.key_info["出租人"] == case_data.plaintiff.name
            if "承租人" in item.key_info:
                assert item.key_info["承租人"] == case_data.defendant.name
```

### 3.5 F2.6 LitigationComplaintGenerator 测试

```python
# tests/unit/test_litigation_complaint_generator.py

class TestLitigationComplaintGenerator:
    def test_generate_litigation(self, case_data, claim_list, evidence_list):
        """测试起诉状生成"""
        generator = LitigationComplaintGenerator()
        litigation = generator.generate(case_data, claim_list, evidence_list)
        
        assert "民事起诉状" in litigation
        assert case_data.plaintiff.name in litigation
        assert case_data.defendant.name in litigation
        assert "诉讼请求" in litigation
        assert "事实与理由" in litigation
    
    def test_litigation_no_placeholder(self, case_data, claim_list, evidence_list):
        """测试起诉状不包含脱敏标记"""
        generator = LitigationComplaintGenerator()
        litigation = generator.generate(case_data, claim_list, evidence_list)
        
        assert "某某" not in litigation
        assert "XX" not in litigation
```

### 3.6 F2.11 EvidenceIndexGenerator 测试

```python
# tests/unit/test_evidence_index_generator.py

class TestEvidenceIndexGenerator:
    def test_generate_index(self, evidence_list):
        """测试证据索引生成"""
        generator = EvidenceIndexGenerator()
        index = generator.generate(evidence_list)
        
        assert index.total_count == len(evidence_list.items)
        assert len(index.items) == len(evidence_list.items)
        assert index.items[0].number == 1
    
    def test_index_contains_claim_mapping(self, evidence_list):
        """测试证据索引包含诉求映射"""
        generator = EvidenceIndexGenerator()
        index = generator.generate(evidence_list)
        
        for item in index.items:
            assert len(item.claims_supported) > 0
```

---

## 四、集成测试

### 4.1 完整流程测试

```python
# tests/integration/test_v3_full_pipeline.py

class TestV3FullPipeline:
    def test_complete_workflow(self, judgment_path, expected_output_dir):
        """
        完整流程测试
        
        验证：
        1. 判决书解析正确
        2. 证据列表创建正确（无脱敏标记）
        3. 证据生成正确（使用真实名称）
        4. PDF输出正确
        """
        # 1. 执行完整流程
        result = run_complete(judgment_path, output_dir)
        
        # 2. 验证输出存在
        assert (result.output_dir / "case_data.json").exists()
        assert (result.output_dir / "evidence_list.json").exists()
        assert (result.output_dir / "evidence_set.pdf").exists()
        
        # 3. 验证脱敏标记不存在
        self._check_no_deanonymization(result.output_dir)
        
        # 4. 验证数据一致性
        self._check_data_consistency(result.output_dir)
    
    def _check_no_deanonymization(self, output_dir):
        """检查输出中无脱敏标记"""
        for txt_file in output_dir.glob("*.txt"):
            content = txt_file.read_text(encoding="utf-8")
            assert "某某" not in content, f"{txt_file.name} 包含脱敏标记"
            assert "XX" not in content, f"{txt_file.name} 包含脱敏标记"
            assert "X月X日" not in content, f"{txt_file.name} 包含脱敏标记"
    
    def _check_data_consistency(self, output_dir):
        """检查数据一致性"""
        case_data = json.load((output_dir / "case_data.json").open())
        
        for txt_file in output_dir.glob("*.txt"):
            content = txt_file.read_text(encoding="utf-8")
            assert case_data["plaintiff"]["name"] in content
            assert case_data["defendant"]["name"] in content
```

---

## 五、质量标准测试

### 5.1 脱敏标记检查

| 用例ID | 测试场景 | 通过标准 |
|--------|---------|---------|
| TC-v3.0-101 | 检查所有输出文件 | 不包含"某某" |
| TC-v3.0-102 | 检查所有输出文件 | 不包含"XX"、"XXX" |
| TC-v3.0-103 | 检查所有输出文件 | 不包含"某年某月某日" |

### 5.2 数据一致性检查

| 用例ID | 测试场景 | 通过标准 |
|--------|---------|---------|
| TC-v3.0-104 | 原告名称一致性 | 所有证据中原告名称一致 |
| TC-v3.0-105 | 被告名称一致性 | 所有证据中被告名称一致 |
| TC-v3.0-106 | 金额一致性 | 合同金额与附件金额一致 |

---

## 六、验收标准

| 验收项 | 标准 |
|--------|------|
| 覆盖率 | 核心模块 >=90%，整体 >=80% |
| 脱敏标记 | 零容忍，一票否决 |
| 数据一致性 | 金额、名称、日期必须一致 |

---

**文档版本**: v1.0
**创建日期**: 2026-02-01
**状态**: 待评审
