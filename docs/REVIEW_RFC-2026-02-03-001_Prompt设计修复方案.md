# RFC-2026-02-003: Prompt设计修复方案 - 评审意见

**文档编号**: REVIEW-RFC-2026-02-003
**版本**: v1.0.0
**日期**: 2026-02-03
**评审人**: Agent1（产品经理）
**评审状态**: 通过（需修改后实施）

---

## 一、RFC总体评价

### 1.1 优点

| 方面 | 评价 |
|------|------|
| 问题定位 | ✅ 准确识别了PRD v3.0的三个核心原则 |
| 修改方案 | ✅ 三个方法（`_build_party_info_section`、`_assemble_prompt`、`_get_default_prompt`）修改方向正确 |
| 代码示例 | ✅ 提供了清晰的修改前后对比，便于实施 |
| 验收标准 | ✅ 明确了"100%真实公司名"和"0个占位符"的量化标准 |

### 1.2 总体结论

**评审结论**: 通过，但需补充角色映射逻辑后再实施

Agent2对问题的理解准确，修改方案方向正确。但在当事人角色标签处理方面存在遗漏，需要补充相关逻辑后才能开始实施。

---

## 二、RFC详细评审意见

### 2.1 已通过的部分

#### 修改1: `_build_party_party_info_section` 方法 ✅ 通过

```python
# 修改方向正确
# 移除脱敏标识前缀，直接展示真实公司名称
# 将 "- 某某公司5（公司）：上海金信融资租赁有限公司"
# 改为 "甲方（出租人）：上海金信融资租赁有限公司"
```

**评审意见**: 方向正确，建议在实施时注意处理公司简称的引用关系。

#### 修改2: `_assemble_prompt` 方法 ✅ 通过

```python
# 修改方向正确
# 移除"🚨 强制要求禁止占位符"部分
# 直接拼接真实信息，让LLM自然使用
```

**评审意见**: 符合PRD v3.0原则。删除"禁止使用"这类负面约束是正确做法。

#### 修改3: `_get_default_prompt` 方法 ✅ 通过（方向正确，需补充角色）

**评审意见**: 移除XXX模板、改为自然语言描述是正确的。但当前代码未处理当事人角色标签，需要补充。

---

### 2.2 需要补充的部分

#### 问题: 缺少当事人角色标签映射

当前RFC只考虑了"甲方（出租人）"，但证据可能涉及多种角色：

| 证据类型 | 甲方角色 | 乙方角色 |
|----------|----------|----------|
| 转让合同 | 转让方 | 受让方 |
| 租赁合同 | 出租人 | 承租人 |
| 抵押合同 | 抵押权人 | 抵押人 |
| 质押合同 | 质权人 | 出质人 |
| 保证合同 | 债权人 | 保证人 |
| 公证书 | 申请人 | - |

**建议修改**:

```python
def _get_role_labels(self, evidence_type: str, party_index: int = 0) -> tuple:
    """
    根据证据类型和当事人索引返回角色标签

    Args:
        evidence_type: 证据类型（合同、文书、登记、凭证）
        party_index: 当事人索引（0=甲方/第一方，1=乙方/第二方）

    Returns:
        tuple: (甲方标签, 乙方标签)，若无乙方则返回("", "")
    """
    role_map = {
        "合同": {
            "transfer": ("甲方（转让方）", "乙方（受让方）"),
            "lease": ("甲方（出租人）", "乙方（承租人）"),
            "mortgage": ("甲方（抵押权人）", "乙方（抵押人）"),
            "pledge": ("甲方（质权人）", "乙方（出质人）"),
            "guarantee": ("债权人", "保证人"),
        },
        "文书": {
            "notarization": ("申请人", None),
            "certificate": ("权利人", "义务人"),
        },
        "登记": {
            "mortgage": ("抵押权人", "抵押人"),
            "pledge": ("质权人", "出质人"),
        },
        "凭证": {
            "payment": ("付款人", "收款人"),
            "invoice": ("销售方", "购买方"),
        }
    }

    # 根据证据类型选择默认映射
    default_map = role_map.get("合同", {})
    transfer_labels = default_map.get("transfer", ("甲方", "乙方"))

    evidence_role_map = role_map.get(evidence_type, {})
    labels = evidence_role_map.get(evidence_type, transfer_labels)

    if party_index == 0:
        return labels[0] if labels else "甲方"
    elif party_index == 1:
        return labels[1] if labels and len(labels) > 1 else "乙方"
    else:
        return f"丙方{party_index - 1}"
```

**建议在RFC中补充此逻辑的修改方案**。

---

## 三、基于人工对话经验的问题模式分析

### 3.1 对话记录概述

用户（产品经理）与元宝进行了4个独立会话，用于生成和分析金融案件卷宗：

| 会话 | 任务 | 迭代次数 | 主要问题 |
|------|------|----------|----------|
| 1 | 生成完整卷宗 | 1 | 包含脱敏信息（某某公司） |
| 2 | 反脱敏处理 | 1 | 按方案执行，替换为真实名称 |
| 3 | 重新整理分组 | 1 | 发现证据分组与起诉书不一致 |
| 4 | 分析计算诉讼请求 | **至少4轮** | 计算逻辑反复出错 |

### 3.2 问题模式清单

从对话记录中识别出的LLM问题模式：

| 问题类型 | 表现 | 对话中的案例 | 严重程度 |
|----------|------|--------------|----------|
| **计算错误** | 数字计算结果与事实不符 | 第12期本金错误引用为1.1亿而非1796万 | 🔴 严重 |
| **逻辑混乱** | 混淆不同概念 | "剩余本金"与"全部未付租金"概念不清 | 🔴 严重 |
| **自我矛盾** | 前文与后文不一致 | 前说2100万，后说1.14亿 | 🔴 严重 |
| **偷懒/概要化** | 只给概要不給完整内容 | 用户批评"还是偷懒了"、"一个字都不要改" | 🟡 中等 |
| **数据引用错误** | 错误引用证据编号或数值 | 错误引用证据5-1的计算明细 | 🔴 严重 |
| **强行解释** | 明知矛盾还强行解释 | "两个数字都对" | 🟡 中等 |
| **遗漏细节** | 缺少必要的计算过程 | 诉讼请求金额计算过程跳跃 | 🟡 中等 |

### 3.3 关键教训

#### 教训1: 计算任务高风险

在会话4中，用户反复追问4轮才得到正确的诉讼请求金额：

```
第1轮: 21,627,514.69元（错误）
第2轮: 114,407,846.34元（仍有问题）
第3轮: 解释"两个数字都对"（混乱）
第4轮: 最终确认1.14亿（正确）
```

**结论**: 涉及数字计算的任务，LLM出错率极高，不能信任原始计算结果。

#### 教训2: 需要验证机制

对话中暴露的问题：
- 用户必须反复追问才能发现错误
- LLM不会主动承认"我算错了"
- LLM会试图用复杂的解释来掩盖错误

**结论**: 必须设计验证机制，不能依赖LLM的自我纠错能力。

#### 教训3: 分离计算与生成

当前对话中，LLM同时负责：
- 生成合同文本
- 执行数字计算
- 解释计算逻辑

这导致：
- 计算错误会污染文本生成
- 无法区分错误来源
- 调试困难

**结论**: 应该分离计算逻辑和文本生成，让LLM只负责生成，计算用代码实现。

#### 教训4: 明确验收标准的重要性

用户批评"还是偷懒了"后，元宝才给出完整内容。这说明：
- LLM倾向于给出概要而非完整内容
- 必须明确定义"完整"的标准
- 需要提供清单让LLM逐项确认

### 3.4 对我们软件的设计启示

| 问题模式 | 表现 | 设计对策 |
|----------|------|----------|
| 计算错误 | 数字计算结果与事实不符 | **分离计算逻辑**: 用Python代码执行计算，LLM只生成计算公式和文本 |
| 数据引用错误 | 错误引用证据编号或数值 | **结构化输出**: LLM输出JSON格式，人工或代码验证字段完整性 |
| 逻辑混乱 | 混淆不同概念 | **分步验证**: 每一步都输出中间结果供人工校验 |
| 偷懒/概要化 | 只给概要不給完整内容 | **明确验收标准**: 提供字段清单，让LLM逐项确认并标记完成状态 |
| 自我矛盾 | 前文与后文不一致 | **一致性检查**: 自动比对前后输出的数据一致性 |
| 强行解释 | 明知矛盾还强行解释 | **设置否定权限**: 允许用户标记"此步骤有误"，强制重新生成 |

---

## 四、修改建议

### 4.1 必须修改的部分

#### 修改1: 补充角色标签映射逻辑

**位置**: `evidence_file_generator.py`

**建议内容**: 实现`_get_role_labels`方法，根据证据类型动态生成当事人角色标签。

#### 修改2: 支持多个当事人

**位置**: `_build_party_info_section`方法

**建议内容**: 当前代码只处理两个当事人，需要扩展为支持N个当事人。

### 4.2 建议修改的部分

#### 修改3: 添加计算验证层（可选）

**位置**: 系统架构

**建议内容**: 在当前版本中暂不实施，但在架构规划中预留"计算验证层"的位置。

**设计方向**:
```
当前架构:
  LLM -> Prompt -> 生成文本 -> 保存

建议架构（未来）:
  LLM -> Prompt -> 生成文本
              -> 生成计算公式（JSON）
              -> Python代码执行计算
              -> 验证结果一致性
              -> 保存
```

### 4.3 建议在RFC中补充的内容

#### 补充1: 角色标签映射表

```python
# 证据类型 -> 角色标签映射
EVIDENCE_TYPE_ROLE_MAP = {
    "合同": {
        "transfer": ("转让方", "受让方"),
        "lease": ("出租人", "承租人"),
        "mortgage": ("抵押权人", "抵押人"),
        "pledge": ("质权人", "出质人"),
        "guarantee": ("债权人", "保证人"),
    },
    "文书": {
        "notarization": ("申请人", None),
        "certificate": ("权利人", "义务人"),
    },
    "登记": {
        "mortgage": ("抵押权人", "抵押人"),
        "pledge": ("质权人", "出质人"),
    },
    "凭证": {
        "payment": ("付款人", "收款人"),
        "invoice": ("销售方", "购买方"),
    }
}
```

#### 补充2: 验收标准细化

| 验收项 | 验收标准 | 验证方法 |
|--------|----------|----------|
| 公司名真实性 | 100%使用真实公司名 | grep搜索"某某"、"某公司"，结果数=0 |
| 地址真实性 | 0个"某某路某某号" | grep搜索地址类占位符，结果数=0 |
| 金额准确性 | 与阶段0数据一致 | 代码比对关键金额 |
| 格式规范性 | 符合证据类型标准 | 人工抽检 |
| 角色标签正确性 | 根据证据类型使用正确标签 | 人工抽检 |

---

## 五、验收标准

### 5.1 功能验收

| 验收项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 公司名真实性 | 100%使用真实公司名 | grep搜索"某某"、"某公司"、"X4"等，结果数=0 |
| 地址真实性 | 0个"某某路某某号"类占位符 | grep搜索地址类占位符，结果数=0 |
| 金额准确性 | 与阶段0数据(0.4_key_numbers.json)一致 | 编写Python脚本比对 |
| 日期准确性 | 与阶段0数据(0.3_transaction_reconstruction.json)一致 | 编写Python脚本比对 |
| 角色标签正确性 | 根据证据类型使用正确的角色标签 | 人工抽检5个不同类型证据 |

### 5.2 测试用例

| 测试编号 | 测试内容 | 预期结果 |
|----------|----------|----------|
| TC-001 | 生成《转让合同》，检查甲方/乙方标签 | 甲方标签="转让方"，乙方标签="受让方" |
| TC-002 | 生成《租赁合同》，检查甲方/乙方标签 | 甲方标签="出租人"，乙方标签="承租人" |
| TC-003 | 生成《公证书》，检查申请人标签 | 申请人标签正确 |
| TC-004 | 检查生成的合同中无"某某公司" | 结果数=0 |
| TC-005 | 检查生成的合同中无"某某路某某号" | 结果数=0 |

### 5.3 回归测试

| 测试范围 | 测试内容 |
|----------|----------|
| 全部证据类型 | 合同、文书、登记、凭证各抽检1-2个 |
| 全部证据组 | 证据组1-9各抽检1个证据 |
| 交叉验证 | 检查同一案件在不同证据中的一致性 |

---

## 六、时间估计修订

| 任务 | 估计时间 | 说明 |
|------|----------|------|
| 补充角色映射逻辑 | 1小时 | 实现`_get_role_labels`方法 |
| 修改`_build_party_info_section` | 1小时 | 支持N个当事人 |
| 修改`_get_default_prompt` | 0.5小时 | 移除XXX，使用自然语言 |
| 测试验证 | 1.5小时 | 执行TC-001至TC-005 |
| 回归测试 | 1小时 | 全量证据抽检 |
| **总计** | **5小时** | 较原RFC增加1小时（角色映射） |

---

## 七、参考文档

| 文档 | 路径 |
|------|------|
| Agent2 RFC | `docs/RFC-2026-02-03-001_Prompt设计修复方案.md` |
| Agent1反馈 | `state/feedback_to_agent2_prompt_issue.md` |
| PRD v3.0 | `docs/需求文档_PRD-2026-02-01-v3.0.md` |
| 人工对话记录 | 4个元宝对话（见用户提供） |

---

## 八、评审记录

| 评审人 | 评审日期 | 评审结果 | 评审意见 |
|--------|----------|----------|----------|
| Agent1 | 2026-02-03 | ✅ 通过（需修改） | 见本文档 |
| Agent2 | 待实施 | - | - |

---

**评审人**: Agent1（产品经理）
**日期**: 2026-02-03
**版本**: v1.0.0
