# 问题记录

**目的**: 记录问题和解决方法，避免重复踩坑  
**更新规则**: 每次解决问题后立即记录  
**版本**: v1.2  
**最后更新**: 2026-01-29

---

## 记录模板

```markdown
## [YYYY-MM-DD] 问题标题

**版本**: vX.X（首次出现或修复的版本）
**状态**: 已解决/待解决

### 问题描述
- 简要描述问题

### 涉及版本
- 首次出现：vX.X
- 解决版本：vX.X（如果已解决）

### 涉及代码
- 文件路径:行号
- 例如: `src/utils/data_generator.py:42`

### 根本原因
- 为什么会发生

### 解决方法
- 如何解决的

### 预防措施
- 如何避免再次发生

### 相关文档
- 相关代码/配置/文档链接
```

---

## 2026-01

### [2026-01-27] LLM生成证据的问题

**版本**: v2.0  
**状态**: 已解决

**涉及版本**
- 首次出现：v1.0
- 解决版本：v2.0

**问题描述**
- 开发不清楚证据应该由LLM生成，而不是程序生成
- 开发试图用DataGenerator生成证据内容

**涉及代码**
- `src/services/evidence_file_generator.py`
- `src/utils/data_generator.py`

**根本原因**
- 需求文档没有明确写"证据由LLM生成"
- 三层数据逻辑没有清晰传达

**解决方法**
- 在需求文档核心设计原则中明确：证据由LLM生成
- DataGenerator只生成详细数据（设备名称、银行账号），不生成证据内容

**预防措施**
- 需求文档必须包含"核心设计原则"章节
- 核心设计原则必须回答"核心流程由什么生成"

---

### [2026-01-27] 老版本功能丢失

**版本**: v2.0  
**状态**: 已解决

**涉及版本**
- 首次出现：v2.0设计阶段
- 解决版本：v2.0

**问题描述**
- 开发的新设计只实现了DataGenerator + EvidenceRenderer
- 遗漏了Stage 1/2/3的证据生成流程

**涉及代码**
- `src/services/stage0/`
- `src/services/stage1/`
- `src/services/stage2/`
- `src/services/stage3/`

**根本原因**
- 评审时只看了新设计，没对照老版本功能
- 开发交接清单没有逐项确认保留功能

**解决方法**
- 创建功能清单，标注"保留"和"新增"
- 开发交接必须逐项签字确认

**预防措施**
- 开发交接清单必须有功能清单对照表
- 评审必须对照功能清单检查

---

### [2026-01-27] Markdown表格未渲染

**版本**: v1.0 → v2.0  
**状态**: 已解决

**涉及版本**
- 首次出现：v1.0
- 解决版本：v2.0

**问题描述**
- LLM生成Markdown格式表格（`| 项目 | 内容 |`）
- PDF中直接显示Markdown源代码，未渲染为真实表格

**涉及代码**
- `src/services/evidence_file_generator.py`
- `src/utils/pdf_generator.py`
- `prompts/stage1/1.2_证据包生成.md`

**根本原因**
- Prompt没有禁止LLM使用Markdown表格
- PDF生成器没有解析Markdown表格

**解决方法**
- Prompt中明确：禁止使用Markdown表格格式
- 表格数据通过JSON传递
- EvidenceRenderer实现render_table()渲染真实PDF表格

**预防措施**
- 涉及表格的需求必须明确格式要求
- Prompt必须明确禁止不期望的格式

---

## 2026-01（续）- 从BUG_FIX_LOG合并

### [2026-01-28] Stage0运行超时导致数据不完整

**版本**: v2.0  
**状态**: 已修复，需要优化超时设置

**涉及版本**
- 首次出现：v2.0
- 解决版本：v2.0

**问题描述**
- `run_full_regeneration.py` 运行10分钟后超时终止
- `outputs/stage0/` 目录缺少部分产物文件
- 0.4_key_numbers.json 中缺少租赁物清单数据

**涉及代码**
- `run_full_regeneration.py` line 182-191: 文件加载逻辑期望中文文件名

**根本原因**
- LLM API调用耗时较长（每个子任务约30-90秒）
- 总共5个子任务，总耗时超过10分钟
- 超时设置600秒不足以完成全部任务

**解决方法**
```python
# 分段运行，先完成Stage0
python3 run_full_regeneration.py --stages 0 --no-pdf

# 修复文件命名不匹配问题
cp outputs/stage0/0.1_structured_extraction.json outputs/stage0/0.1_结构化提取.json
```

**预防措施**
- 优化超时设置
- 根据证据类型设置不同的超时时间
- 简单证据30秒，复杂证据120秒

---

### [2026-01-28] _clean_placeholders 函数类型错误

**版本**: v2.0  
**状态**: 已解决

**问题描述**
```
ValueError: Unknown format code 'f' for object of type 'str'
```

**涉及代码**
- `src/services/evidence_file_generator.py` line 363-395

**根本原因**
- LLM返回的JSON数据中，某些字段的"数值"是字符串类型
- 代码使用 `f"{value:,.2f}"` 格式化，但value是字符串

**解决方法**
```python
def safe_float(val):
    if isinstance(val, (int, float)):
        return float(val)
    if isinstance(val, str):
        try:
            return float(val.replace(',', '').replace('，', ''))
        except:
            return None
    return None
```

**预防措施**
- 添加数据类型测试
- 测试字符串类型的数值处理

---

### [2026-01-28] 租赁物清单数据缺失

**版本**: v2.0  
**状态**: 已解决（部分）

**问题描述**
- `0.4_key_numbers.json` 中缺少 `租赁物清单` 字段
- PDF附件中的设备清单表格无数据

**涉及代码**
- `outputs/stage0/0.4_key_numbers.json`

**根本原因**
- LLM从判决书提取关键数字时，判决书通常不包含详细的设备清单
- Stage0的0.4子任务只提取判决书中明确提到的金额

**解决方法**
手动补充设备清单数据，并在提示词中要求LLM根据合同金额合理编造设备清单。

**预防措施**
- 改进提示词：要求LLM生成完整的设备清单
- 明确要求设备金额合计等于合同金额

---

### [2026-01-28] 证据文件生成不完整（LLM超时）

**版本**: v2.0  
**状态**: 已解决

**问题描述**
- Stage1只生成了部分证据文件
- 11个证据中只有8个生成

**涉及代码**
- `src/services/evidence_file_generator.py` line 39-106
- `src/services/evidence_file_generator.py` line 108-160

**根本原因**
- `EvidenceFileGenerator.generate_all_evidence_files()` 调用LLM生成每个证据
- 部分LLM调用超时导致中断

**解决方法**
重新调用LLM生成缺失的证据，设置更长的超时时间。

**预防措施**
- 添加证据完整性测试
- 测试所有规划证据都已生成

---

### [2026-01-28] 设备清单合计金额与合同金额不一致

**版本**: v2.0  
**状态**: 待解决（仍有数据不一致）

**问题描述**
- 设备清单合计: 100,000,000元 / 125,000,000元
- 合同转让价格: 150,000,000元

**涉及代码**
- `outputs/stage0/0.4_key_numbers.json`

**根本原因**
- 初始填充的设备金额与合同金额不匹配
- LLM生成的设备金额未严格校验合计值

**解决方法**
调整设备金额使其合计等于1.5亿：
```python
data['租赁物清单'] = [
    {'序号': 1, '名称': '多联机中央空调系统', '评估价值': 45000000},
    {'序号': 2, '名称': '冷水机组', '评估价值': 25000000},
    # ...
]
```

**预防措施**
- 添加数据一致性测试
- 测试设备清单合计与合同金额一致
- 在生成PDF前验证数据一致性

---

## 2026-01-29 新增问题

### [2026-01-29] 入口脚本设计缺陷 - 无法生成完整卷宗

**版本**: v2.0.1  
**状态**: 待解决

**问题描述**
- 用户无法使用单一命令生成完整卷宗
- `python3 run_complete.py` 只运行Stage 0，然后尝试生成PDF
- 但PDF生成需要Stage 1生成的证据文件（evidence_index.json）
- 导致PDF生成失败

**涉及代码**
- `run_complete.py` 第452-455行：
```python
if not args.stage0 and not args.stage1:
    logger.info("\n生成PDF...")
    run_pdf_generation()
```

**逻辑矛盾**
```
默认流程: Stage 0 → PDF
          ↓
    PDF需要: evidence_index.json
          ↓
    evidence_index.json 由 Stage 1 生成
          ↓
    但默认流程不运行 Stage 1
          ↓
    结果: PDF生成失败
```

**涉及版本**
- 首次出现：v2.0.1
- 解决版本：待定

**根本原因**
- 入口脚本的默认行为设计不合理
- 没有"完整流程"选项，需要手动分步执行

**建议修复方案**
方案A: 添加 `--all` 参数
```python
parser.add_argument('--all', action='store_true', help='完整流程 (Stage0 → Stage1 → PDF)')
```

方案B: 修改默认行为为完整流程

**用户影响**
| 用户期望 | 实际行为 |
|----------|----------|
| 一个命令生成全部 | 需要手动分步执行 |
| 无需了解内部逻辑 | 需要知道 `--stage0`、`--stage1` 区别 |
| 自动化程度高 | 需要多次调用不同命令 |

**预防措施**
- 入口脚本必须有"完整流程"参数
- 文档必须明确说明不同参数的行为

---

### [2026-01-29] 租赁物金额与合同金额不一致

**版本**: v2.0  
**状态**: 待解决（重复出现）

**问题描述**
- 租赁物清单合计: 125,000,000元
- 合同金额: 150,000,000元
- 差额: 25,000,000元

**涉及代码**
- `outputs/stage0/0.4_key_numbers.json`

**涉及版本**
- 首次出现：2026-01-28（已记录）
- 再次出现：2026-01-29

**根本原因**
- LLM生成的设备金额未严格校验合计值
- 部分设备评估价值为null（缺失数据）
- 缺少数据一致性校验机制

**当前数据示例**
```
设备清单:
1. 多联机中央空调系统: 45,000,000元
2. 冷水机组: 25,000,000元
3. 电梯设备: 20,000,000元
4. 配电变压器: 20,000,000元
5. 消防水泵: 15,000,000元
6. 监控系统: (缺失)
7. 商场照明设备: (缺失)
8. 其他附属设施: (缺失)

合计: 125,000,000元 ❌
期望: 150,000,000元
```

**预防措施**
- 在LLM提示词中明确要求：设备金额合计必须等于合同金额
- 添加后验校验：生成后检查合计值，不一致则重新生成
- 在fix_key_numbers()函数中添加自动修复逻辑

---

### [2026-01-29] 部分设备评估价值缺失

**版本**: v2.0  
**状态**: 待解决

**问题描述**
- 0.4_key_numbers.json 中部分设备的"评估价值"字段为null
- 导致设备金额统计不完整

**涉及代码**
- `outputs/stage0/0.4_key_numbers.json`

**涉及版本**
- 首次出现：2026-01-29

**根本原因**
- LLM生成的JSON数据中，部分数值字段为null
- 缺少数据完整性校验

**当前数据**
```
设备6 监控系统: 评估价值 = null
设备7 商场照明设备: 评估价值 = null
设备8 其他附属设施: 评估价值 = null
```

**预防措施**
- 改进提示词：要求每个设备必须有明确的金额
- 添加数据校验：验证所有金额字段非空
- 在数据加载时自动填充默认值

---

### [2026-01-29] analysis_results.json 路径问题

**版本**: v2.0  
**状态**: 轻微问题（功能正常）

**问题描述**
- 代码期望文件路径: `outputs/stage0/analysis_results.json`
- 实际文件路径: `outputs/analysis_results.json`

**涉及代码**
- Stage0服务保存逻辑

**涉及版本**
- 首次出现：v2.0

**根本原因**
- 路径配置与实际保存路径不一致

**影响**
- 测试报告脚本无法找到文件
- 但不影响系统正常运行

**预防措施**
- 统一文件路径规范
- 在配置文件中定义路径常量

---

## 应该添加的自动化测试

以下场景应该由自动化测试覆盖：

1. **数据类型测试**
   ```python
   def test_clean_placeholders_with_string_numbers():
       """测试字符串类型的数值处理"""
       pass
   ```

2. **文件命名一致性测试**
   ```python
   def test_stage0_file_naming():
       """测试Stage0产物文件名一致性"""
       pass
   ```

3. **数据一致性测试**
   ```python
   def test_equipment_total_matches_contract():
       """测试设备清单合计与合同金额一致"""
       pass
   ```

4. **证据完整性测试**
   ```python
   def test_all_evidence_files_generated():
       """测试所有规划证据都已生成"""
       pass
   ```

5. **入口脚本测试**
   ```python
   def test_complete_pipeline_all_option():
       """测试 --all 参数能生成完整卷宗"""
       pass
   ```

---

---

## 核心教训总结（2026-02-01新增）

### Lesson-001: 不要泄露脱敏标记

**问题**: PromptBuilder将脱敏标记暴露给LLM

**教训**:
- LLM是忠实的执行者，告诉它什么它就生成什么
- Prompt中不应出现任何脱敏标记（某某公司、某某设备等）
- 只提供真实名称和真实数据
- 合同类证据应使用"甲方/乙方"格式，而非"某某公司5（公司）：XXX"

**示例对比**:
```markdown
# 错误
- 某某公司5（公司）：东方金融租赁有限公司

# 正确
【甲方（出租人）】
名称：东方金融租赁有限公司
```

---

### Lesson-002: 证据规划必须完整

**问题**: 证据规划只规划主要证据，遗漏附件

**教训**:
- 证据规划必须包含：主证据 + 所有附件
- 必须明确附件是"独立文件"还是"正文包含"
- 必须提供附件所需的所有数据
- 合同类证据应在规划时就确定租赁物清单等附件的形式

**正确规划格式**:
```json
{
  "证据名称": "《融资租赁合同》",
  "附件": [
    {
      "附件名称": "租赁物清单",
      "类型": "表格",
      "生成方式": "独立文件",
      "数据来源": "0.4_key_numbers.租赁物清单"
    }
  ]
}
```

---

### Lesson-003: Prompt要明确具体

**问题**: Prompt中的格式要求不够明确

**教训**:
- 合同类证据：使用"甲方/乙方"格式
- 不要用"某某公司5（公司）：XXX"
- 明确告诉LLM每个部分应该怎么写
- 包含附件说明和附件数据

---

## 问题统计

| 状态 | 数量 | 说明 |
|------|------|------|
| 已解决 | 8 | 已记录并解决的问题 |
| 待解决 | 6 | 今天新增/重复出现的问题 |
| 总计 | 14 | 累计问题数 |

**待解决问题清单**
1. 入口脚本设计缺陷 - 无法生成完整卷宗 🔴
2. 租赁物金额与合同金额不一致 🔴
3. 部分设备评估价值缺失 🟡
4. analysis_results.json 路径问题 🟢
5. ARCH-001: PromptBuilder泄露脱敏标记 🔴
6. ARCH-002: 证据规划不完整，遗漏附件数据 🔴

---

**创建日期**: 2026-01-27  
**最后更新**: 2026-02-01  
**版本**: v1.3
