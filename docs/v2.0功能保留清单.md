# v2.0 需求：功能保留清单

**日期**: 2026-01-27  
**目的**: 明确老版本功能必须保留，问题必须解决

---

## 核心设计原则（开发必须先读）

### 1. 证据由LLM生成（必须保留）

**v2.0不改变的核心**：所有证据内容（起诉状、合同、证据包等）**必须由LLM生成**，不是程序自动生成。

```
LLM生成流程（必须保留）：
  判决书 → Stage 0（LLM提取结构化数据）
         → Stage 1（LLM生成起诉状+证据包）
         → Stage 2（LLM生成答辩状+被告证据）
         → Stage 3（LLM生成庭审笔录+判决书脱敏）
         → PDF渲染
```

**v2.0增强的是数据准备环节**：
- DataGenerator：自动生成设备名称、银行账号（详细数据）
- DynamicPromptBuilder：在Prompt中注入反脱敏上下文
- EvidenceRenderer：改进PDF表格渲染

### 2. 三层数据逻辑（必须理解）

| 层级 | 数据 | 来源 | 例子 | 是否需要真实数据 |
|------|------|------|------|-----------------|
| **边界条件** | 合同金额、日期 | 从判决书提取 | 1.5亿、2021-02-24 | ✅ 需要 |
| **详细数据** | 设备名称、银行账号 | 自动生成 | "VRV空调"、1502... | ❌ 不需要 |

**关键区别**：
- 边界条件：必须从判决书来，不能编造
- 详细数据：只要合理就行，可以用模板随机生成

### 3. DataGenerator不做的事

| ❌ DataGenerator不生成 | 原因 |
|-----------------------|------|
| 不生成证据内容 | 证据由LLM生成 |
| 不生成合同文本 | 合同由LLM生成 |
| 不生成起诉状/答辩状 | 文书由LLM生成 |

| ✅ DataGenerator只生成 | 用途 |
|------------------------|------|
| 设备名称、规格型号 | 传给LLM作为参考数据 |
| 银行账号 | 传给LLM作为参考数据 |
| 租赁物清单JSON | 传给LLM或直接用于PDF |

---

## 一、必须保留的功能（一个都不能少）

### Stage 0 - 5个产物 ✅ 必须保留

| 序号 | 产物文件 | 功能说明 | 状态 |
|------|---------|---------|------|
| 1 | `0.1_结构化提取.md` | 从判决书提取案件基本信息 | 保留 |
| 2 | `0.2_脱敏替换策划.md` | 公司Profile库、人物Profile库、替换映射表 | 保留 |
| 3 | `0.3_交易结构重构.md` | 理解交易结构（租赁关系、借贷关系等） | 保留 |
| 4 | `0.4_关键数字提取.md` | 合同金额、租金计划、租赁物清单 | 保留 |
| 5 | `0.5_证据归属规划.md` | 规划8个证据组、证据归属（原告/被告） | 保留 |

### Stage 1 - 3个产物 ✅ 必须保留

| 序号 | 产物文件 | 功能说明 | 状态 |
|------|---------|---------|------|
| 1 | `1.1_起诉状生成.md` | 生成民事起诉状 | 保留 |
| 2 | `1.2_证据包生成.md` | 生成8个原告证据组 | 保留 |
| 3 | `1.3_程序文件生成.md` | 生成程序性文件 | 保留 |

### Stage 2 - 3个产物 ✅ 必须保留

| 序号 | 产物文件 | 功能说明 | 状态 |
|------|---------|---------|------|
| 1 | `2.1_答辩状生成.md` | 生成民事答辩状 | 保留 |
| 2 | `2.2_证据包生成.md` | 生成被告证据包 | 保留 |
| 3 | `2.3_程序文件生成.md` | 生成被告程序文件 | 保留 |

### Stage 3 - 2个产物 ✅ 必须保留

| 序号 | 产物文件 | 功能说明 | 状态 |
|------|---------|---------|------|
| 1 | `3.1_庭审笔录生成.md` | 生成庭审笔录 | 保留 |
| 2 | `3.2_判决书脱敏替换.md` | 判决书脱敏处理 | 保留 |

### PDF生成 ✅ 必须保留

| 功能 | 说明 | 状态 |
|------|------|------|
| 完整卷宗PDF | 包含封面、目录、原告包、被告包、法院包 | 保留 |
| 智能分页 | 每份证据另起一页 | 保留 |
| 页码连续 | 页码统一管理 | 保留 |

### 质量检查 ✅ 必须保留

| 功能 | 说明 | 状态 |
|------|------|------|
| 质量报告 | 每个生成产物附带质量报告 | 保留 |

---

## 二、必须解决的问题（v2.0改进）

### 问题1: 反脱敏不彻底 ❌ 必须解决

**症状**: LLM自己创造新的脱敏模式（如"张伟某"、"长江某"）

**解决方案**: RFC定义的"生成时提供上下文"原则
- 反脱敏信息在Prompt中一次性提供
- 不要"生成后替换"，而是"生成时注入"

### 问题2: 租赁物/抵押物清单数据遗漏 ❌ 必须解决

**症状**: 0.4_key_numbers.json中经常缺少租赁物清单

**解决方案**: DataGenerator自动生成
- 设备名称从模板库随机选择
- 规格型号自动生成
- 评估价值按总金额分配

### 问题3: 数据不一致 ❌ 必须解决

**症状**: 合同金额≠租金计划总和

**解决方案**: 统一的边界条件来源
- 所有数据从边界条件计算
- 边界条件必须来自判决书

### 问题4: 同一判决书多次运行数据不同 ❌ 必须解决

**症状**: 每次运行生成的设备名称、银行账号都不同

**解决方案**: 按判决书缓存
- 同一判决书只生成一次数据
- 后续运行复用缓存

### 问题5: Markdown表格未渲染 ❌ 必须解决

**症状**: 
- LLM生成Markdown格式表格（如 `| 项目 | 内容 |`）
- PDF中直接显示Markdown源代码，未渲染为真实表格
- 影响：律师信息表、保险信息表、送达地址确认书等

**解决方案**:

| 方案 | 说明 | 优先级 |
|------|------|--------|
| 禁止Markdown表格 | Prompt中明确：`证据内容中禁止使用 | 格式` | P0 |
| 表格数据JSON传递 | 表格数据通过0.4_key_numbers.json传递 | P0 |
| PDF渲染真实表格 | EvidenceRenderer.render_table()渲染PDF表格 | P0 |

**修改要求**：

1. **修改Prompt 1.2 第83-87行**：
```markdown
### 步骤7: 生成表格类文件
- **重要**: 证据内容中**禁止使用Markdown表格格式**（如 `| 项目 | 内容 |`）
- 表格数据通过JSON格式提供，包含所有行列数据
- 格式示例：
  ```json
  {
    "表格标题": "租金支付计划表",
    "表头": ["期数", "应付日期", "租金金额", "支付状态"],
    "数据行": [[1, "2021-05-24", "19,455,520.96", "已付"], ...]
  }
  ```
```

2. **修改Prompt 0.4**：
```markdown
## 输出要求
...
"租赁物清单": [
  {
    "序号": 1,
    "名称": "多联机中央空调系统",
    "规格型号": "VRV VIII代",
    "数量": "10套",
    "存放地点": "南昌市红谷滩区",
    "评估价值": 50000000
  }
],
"抵押物清单": [...],
"租金支付计划": [...]
```

3. **EvidenceRenderer必须实现render_table()**：
```python
def render_table(self, title: str, headers: List[str], rows: List[List[str]]) -> List[PDFElement]:
    """
    渲染真正的PDF表格（不是Markdown）
    - 使用reportlab Table
    - 灰底表头
    - 斑马纹
    """
```

---

## 三、v2.0新增组件（改进实现方式）

### 新增: DataGenerator

**目的**: 解决数据生成问题

| 功能 | 说明 |
|------|------|
| 边界条件提取 | 从判决书提取合同金额、利率、日期等 |
| 设备清单生成 | 从模板库生成设备名称、规格型号 |
| 租金计划计算 | 根据边界条件计算每期租金 |
| 按判决书缓存 | 同一判决书复用数据 |

### 新增: DynamicPromptBuilder

**目的**: 解决反脱敏问题

| 功能 | 说明 |
|------|------|
| 上下文注入 | 反脱敏信息在Prompt中一次性提供 |
| 变量替换 | Prompt模板中的变量自动替换 |

### 新增: EvidenceRenderer

**目的**: 改进PDF渲染

| 功能 | 说明 |
|------|------|
| render_contract() | 合同格式渲染 |
| render_table() | 表格格式渲染 |

---

## 四、架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      判决书输入                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Stage 0 (5个产物) - 必须保留                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 0.1结构化提取 | 0.2脱敏策划 | 0.3交易重构           │   │
│  │ 0.4关键数字  | 0.5证据规划                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  新增: DataGenerator                                        │
│  - 边界条件自动提取                                          │
│  - 设备清单自动生成                                          │
│  - 按判决书缓存                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  新增: DynamicPromptBuilder                                 │
│  - 反脱敏上下文注入                                          │
│  - Prompt变量替换                                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Stage 1 (3个产物) - 必须保留                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1.1起诉状生成 | 1.2证据包生成 | 1.3程序文件生成     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Stage 2 (3个产物) - 必须保留                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2.1答辩状生成 | 2.2证据包生成 | 2.3程序文件生成     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Stage 3 (2个产物) - 必须保留                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3.1庭审笔录生成 | 3.2判决书脱敏                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  新增: EvidenceRenderer                                     │
│  - render_contract() | render_table() | 智能分页           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  输出                                                       │
│  - 完整卷宗PDF（含质量报告）                                 │
│  - 所有中间产物（0.1~3.2）                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、开发任务清单

### 必须保留的代码/配置

| 序号 | 文件/目录 | 说明 |
|------|----------|------|
| 1 | `prompts/stage0/` | 5个Stage 0 prompt（LLM提取结构化数据） |
| 2 | `prompts/stage1/` | 3个Stage 1 prompt（LLM生成起诉状+证据包） |
| 3 | `prompts/stage2/` | 3个Stage 2 prompt（LLM生成答辩状+被告证据） |
| 4 | `prompts/stage3/` | 2个Stage 3 prompt（LLM生成庭审笔录+脱敏） |
| 5 | `src/services/stage0/` | Stage 0服务（调用LLM） |
| 6 | `src/services/stage1/` | Stage 1服务（调用LLM生成证据） |
| 7 | `src/services/stage2/` | Stage 2服务（调用LLM生成证据） |
| 8 | `src/services/stage3/` | Stage 3服务（调用LLM） |
| 9 | `src/services/evidence_file_generator.py` | 证据文件生成器（**调用LLM生成证据内容**） |
| 10 | `src/utils/pdf_generator.py` | PDF生成器 |
| 11 | `src/utils/pdf_generator_simple.py` | 简化版PDF生成器 |

### 必须新增的代码

| 序号 | 组件 | 说明 | 职责范围 |
|------|------|------|---------|
| 1 | `src/utils/data_generator.py` | DataGenerator | 生成详细数据（设备名称、银行账号）<br>**不生成证据内容** |
| 2 | `src/utils/dynamic_prompt_builder.py` | DynamicPromptBuilder | 在Prompt中注入反脱敏上下文 |
| 3 | `src/utils/evidence_renderer.py` | EvidenceRenderer | 渲染PDF合同和表格 |
| 4 | `config/template_libraries/` | 模板库 | 设备名称、地址等模板 |

**重要说明**：
- **DataGenerator只生成详细数据**（设备名称、银行账号）
- **证据内容（合同文本、起诉状等）必须由LLM生成**
- DataGenerator的输出是传给LLM的参考数据，不是最终产物

### 必须解决的问题

| 序号 | 问题 | 解决方案 | 优先级 |
|------|------|---------|--------|
| 1 | 反脱敏不彻底 | DynamicPromptBuilder注入上下文 | P0 |
| 2 | 数据遗漏 | DataGenerator自动生成 | P0 |
| 3 | 数据不一致 | 统一边界条件来源 | P0 |
| 4 | 多次运行数据不同 | 按判决书缓存 | P0 |
| 5 | **Markdown表格未渲染** | **禁止Markdown + JSON传递 + render_table()** | **P0** |

---

## 六、验收标准

### 功能保留验证

- [ ] Stage 0产物完整生成（0.1~0.5）
- [ ] Stage 1产物完整生成（起诉状、8个证据组、程序文件）
- [ ] Stage 2产物完整生成（答辩状、被告证据、程序文件）
- [ ] Stage 3产物完整生成（庭审笔录、脱敏判决书）
- [ ] 完整卷宗PDF生成
- [ ] 每个产物附带质量报告

### 问题解决验证

- [ ] 反脱敏信息在Prompt中一次性提供
- [ ] 设备清单自动生成（不使用"某某"占位符）
- [ ] 同一判决书多次运行数据一致
- [ ] 合同金额 = 租金计划总和

---

**创建日期**: 2026-01-27  
**状态**: 待开发确认
