# 金融案件证据集生成系统 v3.0 - 详细设计文档

**文档编号**: TD-2026-02-01-v3.0
**版本**: v3.0.0
**日期**: 2026-02-02
**基于需求**: PRD-2026-02-01-v3.0
**状态**: 待评审

---

## 一、文档概述

### 1.1 文档目的

本文档为金融案件证据集生成系统v3.0的详细设计文档，旨在为开发人员提供完整的技术实现方案。基于已评审通过的产品需求文档（PRD-2026-02-01-v3.0）和需求澄清RFC（RFC-2026-02-002），本文档详细描述系统架构、数据模型、模块接口、配置设计和实现方案。

### 1.2 文档范围

本文档涵盖以下内容：系统整体架构设计、数据流设计、核心数据模型定义、模块职责划分与接口设计、配置文件规范、错误处理策略以及测试策略。文档内容与PRD保持一致，不引入额外的功能范围，仅对PRD中描述的功能进行技术实现层面的细化。

### 1.3 依赖文档

本文档依赖于以下已批准文档：产品需求文档PRD-2026-02-01-v3.0定义了功能范围和业务规则；需求澄清RFC-2026-02-002明确了证据编造规则、附件形式映射、AttachmentInfo数据结构、两种生成模式定位以及模块间数据传递规则。这些文档的签署版本构成本设计文档的输入依据。

---

## 二、核心架构原则

### 2.1 v3.0核心原则

| 原则编号 | 原则名称 | 说明 |
|----------|----------|------|
| **P1** | 脱敏标记隔离 | 案情数据（真实信息）→ 证据列表（真实信息）→ LLM Prompt（真实信息），整个链路不出现脱敏标记 |
| **P2** | 要素驱动 | 系统负责从判决书提取要素，内容生成由LLM完成 |
| **P3** | 附件规划 | F2.3必须规划附件形式（独立文件/正文包含/不需附件） |
| **P4** | 数据契约 | 证据列表结构化输出，每份证据有关键信息字段 |

### 2.2 RFC规则澄清

以下规则经Agent1和Agent2评审确认（RFC-2026-02-002）：

**证据编造规则**：生产环境不允许编造，缺失证据则跳过；测试环境从配置文件加载预设数据。

**证据类型与附件形式映射**：合同类证据的附件形式为独立文件，需要生成租赁物清单等；凭证类证据的附件形式为正文包含或不需，金额直接写在凭证中；文书类证据的附件形式为不需，原文引用；附件类证据的附件形式为独立文件。

**模块间数据传递规则**：所有模块从CaseData获取信息，不直接访问判决书。F2.1输出CaseData，后续模块只读不写。

**两种生成模式定位**：generate_from_judgment用于生产环境主流程，从判决书开始执行完整流程；generate_from_data用于测试和调试，接受已有CaseData对象，跳过F2.1和F2.2。

---

## 三、系统架构设计

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用层                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  main.py                                    # 统一入口                        │
│  ├── --input PATH                          # 输入判决书路径                   │
│  ├── --output PATH                         # 输出PDF路径                     │
│  ├── --verify                              # 仅验证模式                      │
│  └── --config PATH                         # 配置文件路径                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心处理层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     CaseAnalyzer                                     │    │
│  │  (F2.1 案情分析)                                                     │    │
│  │                                                                      │    │
│  │  - parse_judgment()            解析判决书PDF/文本                    │    │
│  │  - analyze_contract()          分析合同签订情况                      │    │
│  │  - analyze_performance()       分析合同履行情况                      │    │
│  │  - analyze_breach()            分析违约事实                          │    │
│  │  - extract_facts()             提取法院认定的事实                    │    │
│  │                                                                      │    │
│  │  输出：CaseData（案情基本数据集）                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     ClaimExtractor                                    │    │
│  │  (F2.2 诉求提取)                                                     │    │
│  │                                                                      │    │
│  │  - extract_principal()           提取本金诉求                        │    │
│  │  - extract_interest()            提取利息诉求                        │    │
│  │  - extract_penalty()             提取违约金诉求                      │    │
│  │  - extract_other()               提取其他诉求                        │    │
│  │                                                                      │    │
│  │  输出：ClaimList（诉求列表）                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidencePlanner                                   │    │
│  │  (F2.3 证据规划)                                                     │    │
│  │                                                                      │    │
│  │  - plan_evidence_for_claim()     根据诉求规划证据                    │    │
│  │  - determine_evidence_types()    确定证据类型                        │    │
│  │  - plan_attachments()            规划附件形式                        │    │
│  │                                                                      │    │
│  │  输出：EvidenceRequirements（证据需求清单）                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceCollector                                 │    │
│  │  (F2.4 证据收集)                                                     │    │
│  │                                                                      │    │
│  │  - extract_from_judgment()        从判决书提取证据                   │    │
│  │  - identify_missing()             识别缺失的证据                     │    │
│  │  - fabricate_evidence()           编造缺失证据（按RFC规则）          │    │
│  │                                                                      │    │
│  │  输出：EvidenceCollection（完整证据列表）                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceListCreator                               │    │
│  │  (F2.5 证据列表创建) ← 核心                                          │    │
│  │                                                                      │    │
│  │  - extract_key_info()            从案情数据提取证据关键信息          │    │
│  │  - map_claim_support()           标注支撑的诉求                      │    │
│  │  - structure_evidence()          结构化输出证据列表                  │    │
│  │                                                                      │    │
│  │  输出：EvidenceList（证据列表）                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     DocumentGenerator                                 │    │
│  │  (F2.6 起诉状生成 + F2.7-F2.10 证据生成)                             │    │
│  │                                                                      │    │
│  │  - generate_litigation()         生成起诉状                          │    │
│  │  - generate_contracts()          生成合同类证据                      │    │
│  │  - generate_vouchers()           生成凭证类证据                      │    │
│  │  - generate_documents()          生成文书类证据                     │    │
│  │  - generate_attachments()        生成附件                            │    │
│  │                                                                      │    │
│  │  输出：GeneratedDocuments（生成的所有文档）                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceIndexGenerator                            │    │
│  │  (F2.11 证据索引生成)                                                │    │
│  │                                                                      │    │
│  │  - build_index()                 构建证据索引                        │    │
│  │  - map_evidence_claim()          证据与诉求对应关系                  │    │
│  │                                                                      │    │
│  │  输出：EvidenceIndex（证据索引）                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     PDFGenerator                                      │    │
│  │  (F3 PDF输出)                                                        │    │
│  │                                                                      │    │
│  │  - render_document()             渲染文档到PDF                       │    │
│  │  - render_table()                渲染表格                            │    │
│  │  - paginate()                    分页处理                            │    │
│  │  - generate_toc()                生成目录                            │    │
│  │                                                                      │    │
│  │  输出：EvidenceSet.pdf（证据集PDF）                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     LLMClient                                         │    │
│  │                                                                      │    │
│  │  - complete()                    LLM补全请求                         │    │
│  │  - validate_response()           验证响应                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     QualityValidator                                   │    │
│  │                                                                      │    │
│  │  - check_deanonymization()       脱敏标记检查                        │    │
│  │  - check_consistency()           数据一致性检查                      │    │
│  │  - check_completeness()          证据完整性检查                      │    │
│  │  - check_format()                格式规范检查                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  outputs/                                # 输出                             │
│  ├── case_data.json                      # 案情基本数据集                    │
│  ├── claim_list.json                     # 诉求列表                         │
│  ├── evidence_collection.json            # 完整证据列表                     │
│  ├── evidence_list.json                  # 证据列表（核心输出）             │
│  ├── generated_evidence/                 # 生成的证据文本                   │
│  │   ├── 001_融资租赁合同.txt                                       │
│  │   ├── 002_租赁物清单.txt                                         │
│  │   └── ...                                                      │
│  ├── litigation_complaint.txt            # 起诉状                           │
│  ├── evidence_index.json                 # 证据索引                         │
│  └── evidence_set.pdf                    # 最终输出PDF                      │
│                                                                              │
│  config/                                # 配置                             │
│  ├── case_types/                        # 案件类型配置                      │
│  │   ├── financing_lease.json        # 融资租赁案件配置                  │
│  │   ├── loan.json                   # 金融借款案件配置                  │
│  │   └── factoring.json              # 保理合同案件配置                  │
│  ├── evidence_templates/                # 证据模板配置                      │
│  │   ├── contract_template.md        # 合同模板                          │
│  │   └── table_template.md           # 表格模板                          │
│  └── template_libraries/                # 模板库                           │
│       ├── company_names.json            # 公司名称库                       │
│       ├── equipment_names.json          # 设备名称库                       │
│       └── locations.json                # 地点库                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 输入阶段                                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  原始判决书文件（PDF/文本）                                                   │
│      ↓                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ CaseAnalyzer (F2.1)                                                   │  │
│  │  - parse_judgment()              提取当事人、金额、日期等              │  │
│  │  - analyze_contract()            分析合同签订情况                      │  │
│  │  - analyze_performance()         分析合同履行情况                      │  │
│  │  - analyze_breach()              分析违约事实                          │  │
│  │  - extract_facts()               提取法院认定的事实                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  CaseData（案情基本数据集）                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 诉求提取阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ ClaimExtractor (F2.2)                                                 │  │
│  │  - extract_principal()            提取本金诉求                        │  │
│  │  - extract_interest()             提取利息诉求                        │  │
│  │  - extract_penalty()              提取违约金诉求                      │  │
│  │  - extract_other()                提取其他诉求                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  ClaimList（诉求列表）                                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据规划阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidencePlanner (F2.3)                                                │  │
│  │  - plan_evidence_for_claim()       根据诉求规划证据                    │  │
│  │  - determine_evidence_types()      确定证据类型                        │  │
│  │  - plan_attachments()              规划附件形式                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceRequirements（证据需求清单）                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据收集阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceCollector (F2.4)                                              │  │
│  │  - extract_from_judgment()         从判决书提取证据                    │  │
│  │  - identify_missing()              识别缺失的证据                      │  │
│  │  - fabricate_evidence()            自行编造缺失证据（按RFC规则）      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceCollection（完整证据列表）                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据列表创建阶段 ← 核心                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceListCreator (F2.5) ← 核心                                     │  │
│  │                                                                      │  │
│  │  关键：从CaseData（案情基本数据集）提取每份证据的关键信息              │  │
│  │  关键：证据列表只包含真实信息，不包含脱敏标记                          │  │
│  │                                                                      │  │
│  │  - extract_key_info()            从CaseData提取证据关键信息           │  │
│  │  - map_claim_support()           标注支撑的诉求                       │  │
│  │  - structure_evidence()          结构化输出证据列表                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceList（证据列表） ← LLM生成证据的依据                                │
│                                                                              │
│  核心规则：EvidenceList只包含真实信息，LLM直接使用这些信息生成证据          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据生成阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ DocumentGenerator (F2.6-F2.10)                                        │  │
│  │                                                                      │  │
│  │  输入：EvidenceList（只包含真实信息）                                 │  │
│  │  输出：GeneratedEvidence（包含真实信息的证据文本）                    │  │
│  │                                                                      │  │
│  │  关键：Prompt中只使用真实名称，不使用脱敏标记                         │  │
│  │                                                                      │  │
│  │  示例Prompt：                                                         │  │
│  │  ──────────────────────────────────────────────────────────────────  │  │
│  │  任务：生成融资租赁合同                                               │  │
│  │                                                                       │  │
│  │  当事人：                                                            │  │
│  │  - 出租人：东方金融租赁有限公司                                      │  │
│  │  - 承租人：南昌宏昌商业零售有限公司                                  │  │
│  │                                                                       │  │
│  │  合同要素：                                                          │  │
│  │  - 租赁物：详见附件1租赁物清单                                       │  │
│  │  - 租金总额：人民币壹亿伍仟万元整                                    │  │
│  │  - 租期：24个月                                                      │  │
│  │                                                                       │  │
│  │  要求：符合中国法律对融资租赁合同的要求                              │  │
│  │  ──────────────────────────────────────────────────────────────────  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  GeneratedEvidence（生成的证据文本）                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 文档生成 + 索引生成                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceIndexGenerator (F2.11)                                        │  │
│  │  - build_index()                  构建证据索引                        │  │
│  │  - map_evidence_claim()           证据与诉求对应关系                  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ PDF输出 + 质量验证                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ PDFGenerator (F3)                                                      │  │
│  │  - render_document()            渲染文档到PDF                         │  │
│  │  - render_table()               渲染表格                              │  │
│  │  - paginate()                   分页处理                              │  │
│  │  - generate_toc()               生成目录                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ QualityValidator                                                        │  │
│  │  - check_deanonymization()      脱敏标记检查                          │  │
│  │  - check_consistency()          数据一致性检查                        │  │
│  │  - check_completeness()         证据完整性检查                        │  │
│  │  - check_format()               格式规范检查                          │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceSet.pdf（证据集PDF）                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、数据模型设计

### 4.1 核心数据类定义

```python
from dataclasses import dataclass, field
from typing import Optional, List, Dict, Any
from datetime import datetime
from enum import Enum


class CaseType(Enum):
    FINANCING_LEASE = "融资租赁"
    BANK_LOAN = "金融借款"
    FACTORING = "保理"
    GUARANTEE = "担保"
    CIVIL_LOAN = "民间借贷"


class EvidenceType(Enum):
    CONTRACT = "合同"
    VOUCHER = "凭证"
    DOCUMENT = "文书"
    ATTACHMENT = "附件"


class AttachmentForm(Enum):
    INDEPENDENT_FILE = "独立文件"
    INCLUDED_IN_BODY = "正文包含"
    NOT_REQUIRED = "不需"


class EvidenceSource(Enum):
    JUDGMENT = "判决书提取"
    GENERATED = "自行编造"


@dataclass
class PartyInfo:
    name: str
    role: str
    id_number: Optional[str] = None
    address: Optional[str] = None
    legal_representative: Optional[str] = None
    contact: Optional[str] = None


@dataclass
class ContractParty:
    company_name: str
    unified_social_credit_code: str
    address: str
    legal_representative: str
    bank_account: Optional[str] = None
    role: str


@dataclass
class SubjectMatter:
    type: str
    description: str
    quantity: Optional[int] = None
    unit: Optional[str] = None
    unit_price: Optional[float] = None
    total_value: float


@dataclass
class AmountDetails:
    contract_amount: float
    paid_amount: float
    remaining_amount: float
    interest_amount: Optional[float] = None
    penalty_amount: Optional[float] = None
    litigation_cost: Optional[float] = None


@dataclass
class DateInfo:
    contract_date: datetime
    performance_date: Optional[datetime] = None
    default_date: Optional[datetime] = None
    lawsuit_date: Optional[datetime] = None
    judgment_date: Optional[datetime] = None


@dataclass
class CaseData:
    case_type: CaseType
    case_number: str
    court_name: str
    plaintiffs: List[PartyInfo]
    defendants: List[PartyInfo]
    contract_parties: List[ContractParty]
    subject_matter: SubjectMatter
    amount_details: AmountDetails
    date_info: DateInfo
    default_description: Optional[str] = None
    court_finding: Optional[str] = None
    raw_text: str = ""


@dataclass
class Claim:
    type: str
    amount: float
    description: Optional[str] = None


@dataclass
class ClaimList:
    claims: List[Claim]
    total_amount: float
    interest_rate: Optional[float] = None
    penalty_rate: Optional[float] = None


@dataclass
class AttachmentInfo:
    type: str
    source: str
    form: AttachmentForm
    data: Optional[Dict[str, Any]] = None


@dataclass
class EvidenceRequirement:
    name: str
    type: EvidenceType
    facts_to_prove: List[str]
    claims_supported: List[str]
    required_fields: List[str]
    attachment: Optional[AttachmentInfo] = None


@dataclass
class EvidenceRequirements:
    requirements: List[EvidenceRequirement]
    case_type: CaseType


@dataclass
class EvidenceItem:
    name: str
    type: EvidenceType
    source: EvidenceSource
    is_fabricated: bool = False
    source_evidence_id: Optional[str] = None
    generation_config: Optional[Dict[str, Any]] = None


@dataclass
class EvidenceCollection:
    items: List[EvidenceItem]
    from_judgment: List[str] = field(default_factory=list)
    fabricated: List[str] = field(default_factory=list)


@dataclass
class EvidenceKeyInfo:
    field_name: str
    field_value: Any
    source: str
    is_required: bool = True


@dataclass
class EvidenceListItem:
    evidence_id: str
    evidence_type: EvidenceType
    evidence_name: str
    target_claims: List[str]
    key_info: List[EvidenceKeyInfo]
    attachments: List[AttachmentInfo] = field(default_factory=list)
    generation_prompt: Optional[str] = None


@dataclass
class EvidenceList:
    case_type: CaseType
    items: List[EvidenceListItem]
    total_count: int


@dataclass
class GeneratedEvidence:
    filename: str
    content: str
    evidence_type: str


@dataclass
class EvidenceIndexItem:
    number: int
    name: str
    type: str
    purpose: str
    claims_supported: List[str]


@dataclass
class EvidenceIndex:
    items: List[EvidenceIndexItem]
    total_count: int
```

### 4.2 数据传递规则

根据RFC-2026-02-002-Q5，所有模块间的数据传递遵循以下规则：

F2.1输出的CaseData包含所有从判决书提取的信息，作为后续所有模块的唯一数据来源。后续模块（ClaimExtractor、EvidencePlanner、EvidenceCollector、EvidenceListCreator）均从CaseData获取信息，不直接访问判决书文本。模块间的数据传递通过上述数据类的实例进行，确保类型安全和数据完整性。

---

## 五、模块详细设计

### 5.1 F2.1 案情分析模块（CaseAnalyzer）

#### 5.1.1 模块职责

CaseAnalyzer模块负责从判决书文本中提取案件的基本信息，生成CaseData对象。该模块是整个系统的数据入口，其输出质量直接影响后续所有模块的执行效果。模块需要准确识别并提取当事人信息、签约主体信息、合同类型、标的物描述、标的金额、日期信息以及违约事实等内容。

#### 5.1.2 接口定义

```python
from abc import ABC, abstractmethod
from typing import Optional

class ICaseAnalyzer(ABC):
    @abstractmethod
    def analyze(self, judgment_text: str) -> CaseData:
        pass

class CaseAnalyzer(ICaseAnalyzer):
    def __init__(self, llm_client: Optional[Any] = None):
        self.llm_client = llm_client
    
    def analyze(self, judgment_text: str) -> CaseData:
        pass
```

### 5.2 F2.2 诉求提取模块（ClaimExtractor）

#### 5.2.1 模块职责

ClaimExtractor模块负责从判决书中提取原告的诉讼请求，包括本金诉求、利息诉求、违约金诉求和其他诉求。该模块需要准确识别诉求类型和金额，并支持多诉求的并行提取。

#### 5.2.2 接口定义

```python
class IClaimExtractor(ABC):
    @abstractmethod
    def extract(self, judgment_text: str) -> ClaimList:
        pass

class ClaimExtractor(IClaimExtractor):
    def __init__(self):
        self.rules = self._load_rules()
    
    def extract(self, judgment_text: str) -> ClaimList:
        pass
```

### 5.3 F2.3 证据规划模块（EvidencePlanner）

#### 5.3.1 模块职责

EvidencePlanner模块负责根据诉求列表和案件类型规划需要的证据，生成EvidenceRequirements对象。该模块是连接案情分析与证据生成的关键桥梁，需要根据RFC-2026-02-002-Q2定义的证据类型与附件形式映射规则进行规划。

#### 5.3.2 证据规划规则

根据案件类型，定义默认证据规划规则如下：

融资租赁案件的证据规划包括：融资租赁合同（证据类型为合同，支撑诉求为本金、租金）、付款凭证（证据类型为凭证，支撑诉求为已付款项）、公证书（证据类型为文书，支撑诉求为权利证明）、租赁物清单（证据类型为附件，支撑诉求为标的明细）、租金支付计划（证据类型为附件，支撑诉求为还款明细）。

金融借款案件的证据规划包括：借款合同（证据类型为合同，支撑诉求为本金、利息）、银行流水（证据类型为凭证，支撑诉求为已付款项、还款记录）、还款计划（证据类型为附件，支撑诉求为还款明细）、担保合同（证据类型为合同，支撑诉求为担保责任）。

#### 5.3.3 附件规划规则

根据RFC-2026-02-002-Q2，证据类型与附件形式的映射规则如下：

合同类证据的附件形式为独立文件，需要生成租赁物清单、还款计划等独立附件；凭证类证据的附件形式为正文包含或不需，金额直接写在凭证正文中；文书类证据的附件形式为不需，原文引用判决书中的文书内容；附件类证据的附件形式为独立文件，附件本身就是独立文件。

#### 5.3.4 接口定义

```python
class IEvidencePlanner(ABC):
    @abstractmethod
    def plan(self, claims: ClaimList, case_data: CaseData) -> EvidenceRequirements:
        pass

class EvidencePlanner(IEvidencePlanner):
    def __init__(self, config: Any):
        self.config = config
    
    def plan(self, claims: ClaimList, case_data: CaseData) -> EvidenceRequirements:
        pass
```

### 5.4 F2.4 证据收集模块（EvidenceCollector）

#### 5.4.1 模块职责

EvidenceCollector模块负责从判决书证据认定部分提取原告提供的证据，并对照证据需求识别缺失的证据。对于缺失但支撑诉求必须的证据，模块根据RFC-2026-02-002-Q1定义的规则进行处理：生产环境不允许编造，缺失证据则跳过；测试环境从配置文件加载预设数据。

#### 5.4.2 证据编造规则

根据RFC-2026-02-002-Q1，证据编造规则如下：

可编造的数据包括：设备名称、型号、数量等可根据案件类型从配置文件加载的设备信息；附件表格中的明细数据，如租赁物清单中的设备明细。

不可编造的数据包括：当事人信息，必须来自CaseData；金额数据，必须来自CaseData或ClaimList；日期数据，必须来自CaseData。

编造数据的来源优先级为：配置文件优先，其次为模板生成，最后才允许LLM有限编造（仅限设备名称等可配置项）。

#### 5.4.3 接口定义

```python
class IEvidenceCollector(ABC):
    @abstractmethod
    def collect(
        self, 
        evidence_requirements: EvidenceRequirements,
        case_data: CaseData,
        judgment_text: str,
        environment: str = "production"
    ) -> EvidenceCollection:
        pass

class EvidenceCollector(IEvidenceCollector):
    def __init__(self, config: Any):
        self.config = config
    
    def collect(
        self, 
        evidence_requirements: EvidenceRequirements,
        case_data: CaseData,
        judgment_text: str,
        environment: str = "production"
    ) -> EvidenceCollection:
        pass
```

### 5.5 F2.5 证据列表创建模块（EvidenceListCreator）

#### 5.5.1 模块职责

EvidenceListCreator模块是系统的核心模块之一，负责从CaseData中提取每份证据需要的关键信息，生成EvidenceList对象。该模块是数据绑定的关键环节，确保LLM生成证据时能够获得准确的关键信息。

#### 5.5.2 关键信息提取规则

不同证据类型需要的关键信息不同，根据PRD和RFC定义以下规则：

合同类证据的关键信息包括：当事人信息（出租人、承租人名称）、合同标的物描述、合同价款条款（金额、支付方式）、签订日期、合同签署栏信息。这些信息必须从CaseData中提取，不能由LLM自行编造。

凭证类证据的关键信息包括：金额、收付款方名称、交易日期、交易摘要或用途。这些信息必须从CaseData中提取，对于测试环境可从配置文件加载。

文书类证据的关键信息包括：文书类型、发证机关、关键内容摘要、发证日期。这些信息可从判决书证据认定部分提取。

附件类证据的关键信息包括：附件类型、数据来源、生成方式（独立文件或正文包含）、附件数据。

#### 5.5.3 接口定义

```python
class IEvidenceListCreator(ABC):
    @abstractmethod
    def create(
        self, 
        evidence_collection: EvidenceCollection,
        case_data: CaseData
    ) -> EvidenceList:
        pass

class EvidenceListCreator(IEvidenceListCreator):
    def __init__(self, config: Any):
        self.config = config
    
    def create(
        self, 
        evidence_collection: EvidenceCollection,
        case_data: CaseData
    ) -> EvidenceList:
        pass
```

### 5.6 F2.6-F2.10 文档生成模块（DocumentGenerator）

#### 5.6.1 模块职责

DocumentGenerator系列模块负责根据EvidenceList生成具体的文档内容，包括起诉状（F2.6）、合同（F2.7）、凭证（F2.8）、文书（F2.9）和附件（F2.10）。这些模块调用LLM进行内容生成。

#### 5.6.2 接口定义

```python
class ILitigationComplaintGenerator(ABC):
    @abstractmethod
    def generate(
        self, 
        case_data: CaseData,
        claims: ClaimList,
        evidence_list: EvidenceList
    ) -> str:
        pass

class IContractGenerator(ABC):
    @abstractmethod
    def generate(self, evidence_item: EvidenceListItem, case_data: CaseData) -> str:
        pass

class IVoucherGenerator(ABC):
    @abstractmethod
    def generate(self, evidence_item: EvidenceListItem, case_data: CaseData) -> str:
        pass

class IDocumentGenerator(ABC):
    @abstractmethod
    def generate(self, evidence_item: EvidenceListItem, case_data: CaseData) -> str:
        pass

class IAttachmentGenerator(ABC):
    @abstractmethod
    def generate(
        self, 
        attachment_info: AttachmentInfo, 
        case_data: CaseData
    ) -> str:
        pass
```

### 5.7 F2.11 证据索引生成模块（EvidenceIndexGenerator）

#### 5.7.1 模块职责

EvidenceIndexGenerator模块负责生成证据索引，便于法官查阅和引用证据。证据索引按证据组分类，列出每个证据的名称、类型、证明目的，以及证据与诉求的对应关系。

#### 5.7.2 接口定义

```python
class IEvidenceIndexGenerator(ABC):
    @abstractmethod
    def generate(self, evidence_list: EvidenceList) -> str:
        pass

class EvidenceIndexGenerator(IEvidenceIndexGenerator):
    def generate(self, evidence_list: EvidenceList) -> str:
        pass
```

### 5.8 F3 PDF生成模块（PDFGenerator）

#### 5.8.1 模块职责

PDFGenerator模块负责将所有文档内容渲染为符合法院标准的PDF格式。该模块是系统的最终输出模块，需要正确处理文本渲染、表格渲染、分页和文件打包。

#### 5.8.2 分页规则

根据业务要求，分页规则如下：起诉状必须单独成页，作为证据集的第一页；证据索引必须单独成页，作为证据集的第二页；每份证据必须独立成页，不允许跨页分割；每份附件必须独立成页；当内容超过一页时，在页面底部添加"续"标记。

#### 5.8.3 接口定义

```python
from io import BytesIO

class IPDFGenerator(ABC):
    @abstractmethod
    def generate(
        self,
        complaint: str,
        evidence_texts: Dict[str, str],
        evidence_index: str,
        output_path: Optional[str] = None
    ) -> BytesIO:
        pass

class PDFGenerator(IPDFGenerator):
    def __init__(self, config: Any):
        self.config = config
    
    def generate(
        self,
        complaint: str,
        evidence_texts: Dict[str, str],
        evidence_index: str,
        output_path: Optional[str] = None
    ) -> BytesIO:
        pass
```

---

## 六、配置文件设计

### 6.1 案件类型配置

案件类型配置文件位于config/case_types/目录，JSON格式定义每个案件类型的默认证据规划规则：

```json
{
  "financing_lease": {
    "name": "融资租赁纠纷",
    "evidence_types": [
      {
        "type": "CONTRACT",
        "name": "融资租赁合同",
        "required_fields": ["出租人", "承租人", "租赁物", "租金总额", "租期", "签订日期"],
        "has_attachment": true,
        "attachment_types": ["租赁物清单"]
      },
      {
        "type": "VOUCHER",
        "name": "付款凭证",
        "required_fields": ["付款方", "收款方", "金额", "日期"],
        "has_attachment": false
      },
      {
        "type": "DOCUMENT",
        "name": "公证书",
        "required_fields": ["文书类型", "发证机关", "日期"],
        "has_attachment": false
      }
    ]
  }
}
```

### 6.2 证据模板配置

证据模板配置文件位于config/evidence_templates/目录，定义各类证据的模板和字段映射。

### 6.3 可编造数据配置

可编造数据配置文件用于测试环境，从配置文件加载预设的设备名称、银行名称等信息：

```json
{
  "equipment_names": [
    "数控机床", "注塑机", "印刷机", "变压器", "发电机"
  ],
  "equipment_models": [
    "XK-1000", "ZS-500", "YS-200", "BY-50A", "FD-1000"
  ],
  "bank_names": [
    "中国工商银行", "中国建设银行", "中国银行", "交通银行"
  ]
}
```

---

## 七、LLM客户端设计

### 7.1 LLMClient职责

LLMClient模块负责封装与大语言模型的交互，包括Prompt构建、请求发送、响应解析和错误处理。该模块是系统与LLM之间的抽象层，便于后续替换不同的LLM提供商。

### 7.2 Prompt构建策略

根据v3.0核心原则，Prompt构建遵循以下策略：

脱敏标记隔离原则：Prompt中只使用真实名称，不使用脱敏标记。关键信息从CaseData直接获取，嵌入Prompt时不做任何脱敏处理。

要素驱动原则：Prompt中告知LLM需要生成什么，而非如何生成。例如，告诉LLM"生成一份融资租赁合同，包含以下当事人信息"，而非详细描述合同的结构和条款。

简洁指令原则：Prompt应简洁明了，避免冗长的背景描述。直接列出需要的信息，让LLM基于这些信息生成内容。

### 7.3 接口定义

```python
from abc import ABC, abstractmethod

class ILLMClient(ABC):
    @abstractmethod
    def complete(
        self, 
        prompt: str, 
        system_prompt: Optional[str] = None,
        temperature: float = 0.3,
        max_tokens: int = 4096
    ) -> str:
        pass
    
    @abstractmethod
    def generate(
        self, 
        prompt: str,
        context: Optional[Dict[str, Any]] = None
    ) -> str:
        pass

class LLMClient(ILLMClient):
    def __init__(self, api_key: str, model: str = "gpt-4"):
        self.api_key = api_key
        self.model = model
    
    def complete(
        self, 
        prompt: str, 
        system_prompt: Optional[str] = None,
        temperature: float = 0.3,
        max_tokens: int = 4096
    ) -> str:
        pass
    
    def generate(
        self, 
        prompt: str,
        context: Optional[Dict[str, Any]] = None
    ) -> str:
        pass
```

---

## 八、错误处理策略

### 8.1 错误分类

系统错误分为四类：输入错误指判决书无法解析、格式不支持等输入相关错误；处理错误指模块处理过程中的业务逻辑错误，如信息提取失败、数据验证失败等；LLM错误指调用大语言模型时发生的错误，如API超时、内容不符合要求等；输出错误指PDF生成过程中的错误，如渲染失败、文件写入失败等。

### 8.2 异常定义

```python
class CaseGeneratorError(Exception):
    def __init__(self, message: str, module: str, details: Optional[Dict] = None):
        self.message = message
        self.module = module
        self.details = details or {}
        super().__init__(self.message)

class InputError(CaseGeneratorError):
    pass

class ProcessingError(CaseGeneratorError):
    pass

class LLMError(CaseGeneratorError):
    pass

class OutputError(CaseGeneratorError):
    pass

class MissingEvidenceError(ProcessingError):
    pass

class ValidationError(ProcessingError):
    pass
```

### 8.3 错误处理原则

根据RFC-2026-02-002-Q1，证据收集遵循以下原则：生产环境中缺失证据不允许编造，应记录警告并跳过该证据；测试环境中缺失证据从配置文件加载，配置文件不存在时记录错误。

模块处理过程中的错误处理遵循以下原则：可恢复错误应尝试重试，如LLM调用超时；不可恢复错误应记录详细日志，抛出异常供上层处理；数据验证失败应提供详细的验证报告，指出失败原因。

---

## 九、测试策略

### 9.1 测试分层

系统采用三层测试策略：单元测试针对每个模块的独立功能进行测试，确保模块行为正确；集成测试针对模块间的交互进行测试，确保数据流正确；端到端测试针对完整流程进行测试，确保系统输出符合预期。

### 9.2 单元测试覆盖要求

根据PRD和测试计划，单元测试覆盖要求如下：

CaseAnalyzer模块测试覆盖：合同类型识别准确率100%、金额提取准确率100%、日期提取准确率100%、当事人信息提取准确率100%。

ClaimExtractor模块测试覆盖：诉求类型识别准确率100%、诉求金额提取准确率100%、多诉求并行提取正确性100%。

EvidencePlanner模块测试覆盖：证据规划规则应用正确性100%、附件规划规则应用正确性100%、证据与诉求映射正确性100%。

EvidenceListCreator模块测试覆盖：关键信息提取正确性100%、数据绑定正确性100%、必填字段验证正确性100%。

DocumentGenerator系列模块测试覆盖：合同生成内容正确性100%、凭证生成内容正确性100%、附件表格渲染正确性100%。

PDFGenerator模块测试覆盖：文本渲染正确性100%、表格渲染正确性100%、分页正确性100%、输出文件完整性100%。

---

## 十、项目状态与签署

### 10.1 文档状态

| 项目 | 状态 | 日期 | 签署人 |
|------|------|------|--------|
| PRD评审 | 已通过 | 2026-02-01 | Agent1 |
| RFC-2026-02-002 | 已批准 | 2026-02-02 | 双方 |
| 详细设计 | 待评审 | - | - |
| 开发实现 | 待开始 | - | - |
| 测试通过 | 待开始 | - | - |
| 部署上线 | 待开始 | - | - |

### 10.2 待办事项

当前待办事项包括：本文档需要Agent1评审并签署；评审通过后开始开发实现；开发完成后编写并通过单元测试；进行集成测试和端到端测试；测试通过后部署上线。

---

**文档版本**: v3.0.0
**创建日期**: 2026-02-02
**创建人**: Agent2 (开发)
**状态**: 待评审
