# 金融案件证据集生成系统 v3.0 - 概要设计

**文档编号**: TD-2026-02-01-v3.0
**版本**: v3.0.0
**状态**: 初稿
**日期**: 2026-02-01
**基于需求**: PRD-2026-02-01-v3.0

---

## 一、文档说明

### 1.1 文档目的

基于需求文档(PRD-2026-02-01-v3.0)，定义系统技术实现方案。

### 1.2 设计原则

| 原则 | 说明 |
|------|------|
| 模块化 | 各Stage独立，可单独运行 |
| 可配置 | 证据类型、模板、数据源均可配置 |
| 可测试 | 每个模块可独立测试 |
| 可扩展 | 新增功能不改核心代码 |

---

## 二、系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                   EvidenceGenerator                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Pipeline Controller               │   │
│  │  Stage 0 → Stage 1 → Stage 1.5 → Stage 2 → Stage 2.5│   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Output Manager                    │   │
│  │  - 文件保存                                         │   │
│  │  - 索引更新                                         │   │
│  │  - 质量报告                                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块结构

```
src/
├── pipeline/                    # 流程控制器
│   ├── __init__.py
│   ├── stage_controller.py      # 阶段调度
│   └── output_manager.py        # 输出管理
│
├── stage0/                      # Stage 0: 数据理解
│   ├── structured_extractor.py  # 结构化提取
│   ├── anonymization_planner.py # 脱敏策划
│   ├── transaction_reconstructor.py # 交易重构
│   ├── key_number_extractor.py # 关键数字
│   └── evidence_planner.py     # 证据规划
│
├── stage1/                      # Stage 1: 证据生成
│   ├── complaint_generator.py   # 起诉状生成
│   ├── evidence_generator.py    # 证据生成（主模块）
│   └── template_engine.py       # 模板引擎
│
├── stage1_5/                    # Stage 1.5: 后处理
│   ├── placeholder_detector.py  # 占位符检测
│   ├── data_filler.py          # 数据填充
│   └── integrity_validator.py   # 完整性校验
│
├── stage2/                      # Stage 2: PDF渲染
│   ├── contract_renderer.py     # 合同渲染
│   ├── table_renderer.py        # 表格渲染
│   ├── pagination_controller.py # 分页控制
│   └── pdf_generator.py         # PDF生成
│
├── stage2_5/                    # Stage 2.5: 质量验证
│   ├── quality_validator.py     # 质量验证
│   └── report_generator.py      # 报告生成
│
├── config/                      # 配置模块
│   ├── case_config.py           # 案件类型配置
│   ├── evidence_config.py       # 证据类型配置
│   └── placeholder_rules.py     # 占位符规则
│
├── utils/                       # 工具模块
│   ├── llm_client.py            # LLM客户端
│   ├── prompt_builder.py        # Prompt构建器
│   ├── data_generator.py        # 数据生成器
│   └── file_utils.py            # 文件工具
│
└── __init__.py
```

---

## 三、核心模块设计

### 3.1 Pipeline Controller

**职责**: 协调各Stage执行，管理数据流

```python
class PipelineController:
    def __init__(self, config: PipelineConfig):
        self.config = config
        self.stages = []
        self.output_manager = OutputManager()
    
    def run(self, judgment_path: str) -> PipelineResult:
        """执行完整流程"""
        # 1. 加载判决书
        judgment = self._load_judgment(judgment_path)
        
        # 2. 依次执行各Stage
        data = None
        for stage in self.stages:
            data = stage.run(data)
            if not data.is_valid:
                return PipelineResult(skipped)
        
        # 3. 生成质量报告
        report = self.output_manager.generate_report(data)
        
        return PipelineResult(data, report)
```

### 3.2 Stage 0: 数据理解

**职责**: 从判决书提取结构化信息

```python
class Stage0:
    def run(self, judgment: Judgment) -> Stage0Data:
        return Stage0Data(
            structured=self._extract_structure(judgment),
            anonymization=self._plan_anonymization(judgment),
            transaction=self._reconstruct_transaction(judgment),
            key_numbers=self._extract_numbers(judgment),
            evidence_planning=self._plan_evidence(judgment)
        )
```

**输出**:
- `0.1_structured_extraction.json`
- `0.2_anonymization_plan.json`
- `0.3_transaction_reconstruction.json`
- `0.4_key_numbers.json`
- `0.5_evidence_planning.json`

### 3.3 Stage 1: 证据生成

**职责**: 生成所有证据材料

```python
class Stage1:
    def run(self, stage0_data: Stage0Data) -> Stage1Data:
        evidence_list = []
        
        # 1. 生成起诉状
        complaint = self._generate_complaint(stage0_data)
        evidence_list.append(complaint)
        
        # 2. 生成证据
        for evidence_plan in stage0_data.evidence_planning:
            evidence = self._generate_evidence(evidence_plan, stage0_data)
            evidence_list.append(evidence)
        
        return Stage1Data(
            complaint=complaint,
            evidence_list=evidence_list,
            evidence_index=self._build_index(evidence_list)
        )
```

### 3.4 Stage 1.5: 后处理

**职责**: 清理占位符，填充数据

```python
class Stage1_5:
    def __init__(self, rules: PlaceholderRules):
        self.detector = PlaceholderDetector(rules)
        self.filler = DataFiller(rules)
        self.validator = IntegrityValidator(rules)
    
    def run(self, stage1_data: Stage1Data) -> Stage1Data:
        # 1. 检测占位符
        issues = self.detector.detect(stage1_data)
        
        # 2. 填充数据
        for evidence in stage1_data.evidence_list:
            evidence.content = self.filler.fill(evidence.content, issues)
        
        # 3. 校验完整性
        validation = self.validator.validate(stage1_data)
        
        return Stage1Data(
            evidence_list=stage1_data.evidence_list,
            issues=issues,
            validation=validation
        )
```

### 3.5 Stage 2: PDF渲染

**职责**: 生成PDF文件

```python
class Stage2:
    def __init__(self):
        self.contract_renderer = ContractRenderer()
        self.table_renderer = TableRenderer()
        self.pagination = PaginationController()
        self.pdf_generator = PDFGenerator()
    
    def run(self, stage1_5_data: Stage1Data) -> PDFResult:
        elements = []
        
        # 1. 渲染起诉状
        elements.extend(self.contract_renderer.render(stage1_5_data.complaint))
        
        # 2. 渲染证据
        for evidence in stage1_5_data.evidence_list:
            if evidence.type == "合同":
                elements.extend(self.contract_renderer.render(evidence))
            else:
                elements.extend(self.table_renderer.render(evidence))
        
        # 3. 分页
        pages = self.pagination.paginate(elements)
        
        # 4. 生成PDF
        pdf_path = self.pdf_generator.generate(pages)
        
        return PDFResult(pdf_path=pdf_path, page_count=len(pages))
```

### 3.6 Stage 2.5: 质量验证

**职责**: 验证输出质量

```python
class Stage2_5:
    def run(self, stage2_result: PDFResult, 
            stage1_5_data: Stage1Data) -> QualityReport:
        checks = [
            PlaceholderCheck(stage1_5_data.issues),
            IntegrityCheck(stage1_5_data.validation),
            ConsistencyCheck(stage1_5_data),
            FormatCheck(stage2_result)
        ]
        
        results = [check.run() for check in checks]
        
        return QualityReport(
            overall_score=self._calculate_score(results),
            details=results,
            recommendations=self._generate_recommendations(results)
        )
```

---

## 四、数据模型

### 4.1 核心数据结构

```python
@dataclass
class Stage0Data:
    structured: StructuredExtraction
    anonymization: AnonymizationPlan
    transaction: TransactionReconstruction
    key_numbers: KeyNumbers
    evidence_planning: EvidencePlanning

@dataclass
class Stage1Data:
    complaint: Evidence
    evidence_list: List[Evidence]
    evidence_index: EvidenceIndex

@dataclass
class Evidence:
    id: str
    name: str
    type: EvidenceType  # 合同/凭证/文书
    content: str
    attachments: List[str]

@dataclass
class EvidenceIndex:
    total_count: int
    group_count: int
    evidence_list: List[EvidenceMeta]
```

### 4.2 配置模型

```python
@dataclass
class CaseConfig:
    case_type: str
    evidence_types: List[EvidenceTypeConfig]
    templates: TemplateConfig

@dataclass
class EvidenceTypeConfig:
    type: str
    template: str
    attachments: List[str]
    format_rules: FormatRules

@dataclass
class PlaceholderRules:
    patterns: List[PlaceholderPattern]
    replacements: Dict[str, ReplacementRule]
```

---

## 五、接口设计

### 5.1 入口接口

```python
# 方式1: 命令行
python3 -m src run --judgment <path> --output <dir>

# 方式2: API
from src.pipeline import PipelineController

controller = PipelineController(config)
result = controller.run("path/to/judgment.pdf")
```

### 5.2 配置文件接口

```python
# 加载案件配置
config = CaseConfig.load("config/case_types/financing_lease.json")

# 加载占位符规则
rules = PlaceholderRules.load("config/placeholder_rules.json")

# 加载模板
templates = TemplateConfig.load("config/templates/")
```

### 5.3 内部接口

```python
# Stage接口
class Stage:
    def run(self, input_data: Any) -> StageOutput:
        ...

# 数据流接口
class DataBus:
    def get(self, stage: int, key: str) -> Any:
        ...
    
    def set(self, stage: int, key: str, value: Any):
        ...
```

---

## 六、关键技术

### 6.1 LLM集成

```python
class LLMClient:
    def __init__(self, provider: str = "siliconflow"):
        self.provider = provider
    
    def generate(self, prompt: str, **kwargs) -> str:
        if self.provider == "siliconflow":
            return self._call_siliconflow(prompt, **kwargs)
        elif self.provider == "openai":
            return self._call_openai(prompt, **kwargs)
```

### 6.2 PDF生成

使用ReportLab或PyMuPDF:
```python
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas

class PDFGenerator:
    def generate(self, elements: List[PDFElement]) -> str:
        c = canvas.Canvas(self.output_path, pagesize=A4)
        for element in elements:
            element.render(c)
        c.save()
        return self.output_path
```

### 6.3 多模态质量检测（v3.0新增）

```python
class MultimodalQA:
    def __init__(self, api_key: str):
        self.model = "Qwen/Qwen-VL-Max"
        self.api_url = "https://api.siliconflow.cn/v1/chat/completions"
    
    def analyze_layout(self, pdf_path: str) -> LayoutAnalysis:
        # 1. PDF转图片
        image = self._pdf_to_image(pdf_path)
        
        # 2. 调用视觉模型
        response = self._call_vision_model(image, ANALYZE_LAYOUT_PROMPT)
        
        # 3. 解析结果
        return self._parse_response(response)
```

---

## 七、测试策略

### 7.1 测试分层

| 层级 | 测试对象 | 工具 |
|------|---------|------|
| 单元测试 | 核心函数/类 | pytest |
| 集成测试 | Stage模块 | pytest |
| 系统测试 | 完整流程 | pytest + real LLM |
| E2E测试 | PDF质量 | pdftotext + 多模态 |

### 7.2 测试用例

| 用例ID | 测试场景 | 预期结果 |
|--------|---------|---------|
| UT-001 | 占位符检测 | 检测到所有脱敏标记 |
| UT-002 | 数据填充 | 正确填充所有占位符 |
| UT-003 | 表格渲染 | 生成符合格式的表格 |
| IT-001 | Stage 0执行 | 生成5个JSON文件 |
| IT-002 | Stage 1执行 | 生成24个证据 |
| ST-001 | 完整流程 | 生成PDF，通过质量检查 |

---

## 八、部署架构

### 8.1 部署方式

```bash
# 本地运行
python3 -m src run --judgment <path>

# Docker部署
docker build -t evidence-generator .
docker run -v $(pwd)/data:/app/data evidence-generator
```

### 8.2 依赖

```
Python 3.9+
├── reportlab>=4.0
├── pymupdf>=1.23
├── openai>=1.0
├── requests>=2.31
└── pyyaml>=6.0
```

---

## 九、附录

### 9.1 数据流图

```
判决书 PDF
    ↓
Stage 0 (LLM提取)
    ├── 0.1_structured_extraction.json
    ├── 0.2_anonymization_plan.json
    ├── 0.3_transaction_reconstruction.json
    ├── 0.4_key_numbers.json
    └── 0.5_evidence_planning.json
    ↓
Stage 1 (LLM生成 + 模板填充)
    ├── 民事起诉状.txt
    ├── evidence_index.json
    └── evidence/
    ↓
Stage 1.5 (后处理)
    ├── 占位符检测与清理
    └── 数据填充
    ↓
Stage 2 (PDF渲染)
    ├── 合同/表格渲染
    └── 分页
    ↓
Stage 2.5 (质量验证)
    └── quality_report.json
    ↓
证据集 PDF
```

### 9.2 相关文档

| 文档 | 说明 |
|------|------|
| [需求文档](需求文档_PRD-2026-02-01-v3.0.md) | 产品需求定义 |
| [测试方案](TEST_PLAN.md) | 测试计划 |

---

**文档版本**: v3.0.0
**创建日期**: 2026-02-01
**最后更新**: 2026-02-01
