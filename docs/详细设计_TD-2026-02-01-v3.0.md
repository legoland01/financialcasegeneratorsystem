# 金融案件证据集生成系统 v3.0 - 详细设计方案

**文档编号**: TD-2026-02-01-v3.0
**版本**: v1.0
**日期**: 2026-02-01
**基于需求**: PRD-2026-02-01-v3.0
**状态**: 待评审

---

## 一、核心架构原则

| 原则 | 说明 |
|------|------|
| **P1 脱敏标记隔离** | 案情数据（真实信息）→ 证据列表（真实信息）→ LLM Prompt（真实信息），整个链路不出现脱敏标记 |
| **P2 要素驱动** | 系统负责从判决书提取要素，内容生成由LLM完成 |
| **P3 附件规划** | F2.3必须规划附件形式（独立文件/正文包含/不需附件） |
| **P4 数据契约** | 证据列表结构化输出，每份证据有关键信息字段 |

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用层                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  main.py                                    # 统一入口                        │
│  ├── --input PATH                          # 输入判决书路径                   │
│  ├── --output PATH                         # 输出PDF路径                     │
│  ├── --verify                              # 仅验证模式                      │
│  └── --config PATH                         # 配置文件路径                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心处理层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     CaseAnalyzer                                     │    │
│  │  (F2.1 案情分析)                                                     │    │
│  │                                                                      │    │
│  │  - parse_judgment()            解析判决书PDF/文本                    │    │
│  │  - analyze_contract()          分析合同签订情况                      │    │
│  │  - analyze_performance()       分析合同履行情况                      │    │
│  │  - analyze_breach()            分析违约事实                          │    │
│  │  - extract_facts()             提取法院认定的事实                    │    │
│  │                                                                      │    │
│  │  输出：CaseData（案情基本数据集）                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     ClaimExtractor                                    │    │
│  │  (F2.2 诉求提取)                                                     │    │
│  │                                                                      │    │
│  │  - extract_principal()           提取本金诉求                        │    │
│  │  - extract_interest()            提取利息诉求                        │    │
│  │  - extract_penalty()             提取违约金诉求                      │    │
│  │  - extract_other()               提取其他诉求                        │    │
│  │                                                                      │    │
│  │  输出：ClaimList（诉求列表）                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidencePlanner                                   │    │
│  │  (F2.3 证据规划)                                                     │    │
│  │                                                                      │    │
│  │  - plan_evidence_for_claim()     根据诉求规划证据                    │    │
│  │  - determine_evidence_types()    确定证据类型                        │    │
│  │  - plan_attachments()            规划附件形式                        │    │
│  │                                                                      │    │
│  │  输出：EvidenceRequirements（证据需求清单）                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceCollector                                 │    │
│  │  (F2.4 证据收集)                                                     │    │
│  │                                                                      │    │
│  │  - extract_from_judgment()        从判决书提取证据                   │    │
│  │  - identify_missing()             识别缺失的证据                     │    │
│  │  - fabricate_evidence()           自行编造缺失证据（测试场景）       │    │
│  │                                                                      │    │
│  │  输出：EvidenceCollection（完整证据列表）                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceListCreator                               │    │
│  │  (F2.5 证据列表创建) ← 核心                                          │    │
│  │                                                                      │    │
│  │  - extract_key_info()            从案情数据提取证据关键信息          │    │
│  │  - map_claim_support()           标注支撑的诉求                      │    │
│  │  - structure_evidence()          结构化输出证据列表                  │    │
│  │                                                                      │    │
│  │  输出：EvidenceList（证据列表）                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceGenerator                                 │    │
│  │  (LLM生成证据)                                                       │    │
│  │                                                                      │    │
│  │  - build_prompt()                构建证据生成Prompt                  │    │
│  │  - generate_by_llm()             调用LLM生成证据                    │    │
│  │  - parse_output()                解析LLM输出                        │    │
│  │                                                                      │    │
│  │  输出：GeneratedEvidence（生成的证据文本）                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     DocumentGenerator                                 │    │
│  │  (F2.6 起诉状生成 + F2.7-F2.10 证据生成)                             │    │
│  │                                                                      │    │
│  │  - generate_litigation()         生成起诉状                          │    │
│  │  - generate_contracts()          生成合同类证据                      │    │
│  │  - generate_vouchers()           生成凭证类证据                      │    │
│  │  - generate_documents()          生成文书类证据                     │    │
│  │  - generate_attachments()        生成附件                            │    │
│  │                                                                      │    │
│  │  输出：GeneratedDocuments（生成的所有文档）                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     EvidenceIndexGenerator                            │    │
│  │  (F2.11 证据索引生成)                                                │    │
│  │                                                                      │    │
│  │  - build_index()                 构建证据索引                        │    │
│  │  - map_evidence_claim()          证据与诉求对应关系                  │    │
│  │                                                                      │    │
│  │  输出：EvidenceIndex（证据索引）                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ↓                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     PDFGenerator                                      │    │
│  │  (F3 PDF输出)                                                        │    │
│  │                                                                      │    │
│  │  - render_document()             渲染文档到PDF                       │    │
│  │  - render_table()                渲染表格                            │    │
│  │  - paginate()                    分页处理                            │    │
│  │  - generate_toc()                生成目录                            │    │
│  │                                                                      │    │
│  │  输出：EvidenceSet.pdf（证据集PDF）                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     LLMClient                                         │    │
│  │                                                                      │    │
│  │  - complete()                    LLM补全请求                         │    │
│  │  - embed()                       嵌入向量                            │    │
│  │  - validate_response()           验证响应                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     QualityValidator                                   │    │
│  │                                                                      │    │
│  │  - check_deanonymization()       脱敏标记检查                        │    │
│  │  - check_consistency()           数据一致性检查                      │    │
│  │  - check_completeness()          证据完整性检查                      │    │
│  │  - check_format()                格式规范检查                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  outputs/                                                                    │
│  ├── case_data.json                  # 案情基本数据集                       │
│  ├── claim_list.json                 # 诉求列表                            │
│  ├── evidence_requirements.json      # 证据需求清单                        │
│  ├── evidence_collection.json        # 完整证据列表                        │
│  ├── evidence_list.json              # 证据列表（核心输出）                │
│  ├── generated_evidence/             # 生成的证据文本                      │
│  │   ├── 001_融资租赁合同.txt                                        │
│  │   ├── 002_租赁物清单.txt                                          │
│  │   └── ...                                                          │
│  ├── litigation_complaint.txt        # 起诉状                              │
│  ├── evidence_index.json             # 证据索引                            │
│  └── evidence_set.pdf                # 最终输出PDF                         │
│                                                                              │
│  config/                                # 配置                             │
│  ├── case_types/                                                             │
│  │   ├── financing_lease.json        # 融资租赁案件配置                   │
│  │   ├── loan.json                   # 金融借款案件配置                   │
│  │   └── factoring.json              # 保理合同案件配置                   │
│  └── prompts/                           # LLM Prompt模板                   │
│       ├── analyze_case.txt            # 案情分析Prompt                    │
│       ├── extract_claim.txt           # 诉求提取Prompt                    │
│       ├── plan_evidence.txt           # 证据规划Prompt                    │
│       └── generate_evidence.txt       # 证据生成Prompt                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 输入阶段                                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  原始判决书文件（PDF/文本）                                                   │
│      ↓                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ CaseAnalyzer (F2.1)                                                   │  │
│  │  - parse_judgment()              提取当事人、金额、日期等              │  │
│  │  - analyze_contract()            分析合同签订情况                      │  │
│  │  - analyze_performance()         分析合同履行情况                      │  │
│  │  - analyze_breach()              分析违约事实                          │  │
│  │  - extract_facts()               提取法院认定的事实                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  CaseData（案情基本数据集）                                                   │
│  {                                                                         │
│    "parties": {                                                             │
│      "plaintiff": {"name": "...", "address": "...", "legal_representative": "..."}, │
│      "defendant": {"name": "...", "address": "...", "legal_representative": "..."}  │
│    },                                                                        │
│    "contract": {                                                             │
│      "type": "融资租赁合同",                                                 │
│      "subject": "...",                                                      │
│      "amount": 150000000,                                                   │
│      "signing_date": "2021-02-24",                                          │
│      "performance": {...},                                                  │
│      "breach": {...}                                                        │
│    }                                                                         │
│  }                                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 诉求提取阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ ClaimExtractor (F2.2)                                                 │  │
│  │  - extract_principal()            提取本金诉求                        │  │
│  │  - extract_interest()             提取利息诉求                        │  │
│  │  - extract_penalty()              提取违约金诉求                      │  │
│  │  - extract_other()                提取其他诉求                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  ClaimList（诉求列表）                                                        │
│  {                                                                         │
│    "principal": 150000000,                                                  │
│    "interest": 5000000,                                                     │
│    "penalty": 2000000,                                                      │
│    "other": {"litigation_cost": 50000}                                      │
│  }                                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据规划阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidencePlanner (F2.3)                                                │  │
│  │  - plan_evidence_for_claim()       根据诉求规划证据                    │  │
│  │  - determine_evidence_types()      确定证据类型                        │  │
│  │  - plan_attachments()              规划附件形式                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceRequirements（证据需求清单）                                         │
│  {                                                                         │
│    "claims": [                                                              │
│      {"claim": "本金", "facts": [...], "evidence_needed": [...]}            │
│    ],                                                                       │
│    "evidence_types": [                                                      │
│      {"type": "合同类", "attachment_form": "独立文件"}                      │
│    ]                                                                        │
│  }                                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据收集阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceCollector (F2.4)                                              │  │
│  │  - extract_from_judgment()         从判决书提取证据                    │  │
│  │  - identify_missing()              识别缺失的证据                      │  │
│  │  - fabricate_evidence()            自行编造缺失证据                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceCollection（完整证据列表）                                           │
│  {                                                                         │
│    "evidence_items": [                                                      │
│      {"name": "融资租赁合同", "source": "判决书", "fabricated": false},     │
│      {"name": "付款凭证", "source": "判决书", "fabricated": false},         │
│      {"name": "租赁物清单", "source": "fabricated", "fabricated": true}     │
│    ]                                                                        │
│  }                                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据列表创建阶段 ← 核心                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceListCreator (F2.5) ← 核心                                     │  │
│  │                                                                      │  │
│  │  关键：从CaseData（案情基本数据集）提取每份证据的关键信息              │  │
│  │  关键：证据列表只包含真实信息，不包含脱敏标记                          │  │
│  │                                                                      │  │
│  │  - extract_key_info()            从CaseData提取证据关键信息           │  │
│  │  - map_claim_support()           标注支撑的诉求                       │  │
│  │  - structure_evidence()          结构化输出证据列表                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceList（证据列表） ← LLM生成证据的依据                                │
│  {                                                                         │
│    "evidence_items": [                                                      │
│      {                                                                      │
│        "name": "融资租赁合同",                                              │
│        "type": "合同类",                                                    │
│        "key_info": {                                                        │
│          "lessor": "东方金融租赁有限公司",                                  │
│          "lessee": "南昌宏昌商业零售有限公司",                              │
│          "subject": "多联机中央空调系统",                                   │
│          "amount": 150000000,                                               │
│          "signing_date": "2021-02-24"                                       │
│        },                                                                   │
│        "supports_claims": ["本金", "租金"],                                 │
│        "attachment": {                                                      │
│          "type": "租赁物清单",                                              │
│          "form": "独立文件"                                                 │
│        }                                                                    │
│      }                                                                      │
│    ]                                                                        │
│  }                                                                          │
│                                                                              │
│  核心规则：EvidenceList只包含真实信息，LLM直接使用这些信息生成证据          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 证据生成阶段                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceGenerator                                                        │  │
│  │                                                                      │  │
│  │  输入：EvidenceList（只包含真实信息）                                  │  │
│  │  输出：GeneratedEvidence（包含真实信息的证据文本）                     │  │
│  │                                                                      │  │
│  │  关键：Prompt中只使用真实名称，不使用脱敏标记                          │  │
│  │                                                                      │  │
│  │  示例Prompt：                                                          │  │
│  │  ──────────────────────────────────────────────────────────────────   │  │
│  │  任务：生成融资租赁合同                                                │  │
│  │                                                                      │  │
│  │  当事人：                                                             │  │
│  │  - 出租人：东方金融租赁有限公司                                       │  │
│  │  - 承租人：南昌宏昌商业零售有限公司                                   │  │
│  │                                                                      │  │
│  │  合同要素：                                                           │  │
│  │  - 租赁物：详见附件1租赁物清单                                        │  │
│  │  - 租金总额：人民币壹亿伍仟万元整                                     │  │
│  │  - 租期：24个月                                                       │  │
│  │                                                                      │  │
│  │  要求：符合中国法律对融资租赁合同的要求                               │  │
│  │  ──────────────────────────────────────────────────────────────────   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  GeneratedEvidence（生成的证据文本）                                         │
│  {                                                                         │
│    "001_融资租赁合同.txt": "合同编号：...\n出租人：东方金融租赁有限公司...", │
│    "002_租赁物清单.txt": "序号 | 设备名称 | 规格型号 | 数量 | 评估价值...",  │
│    ...                                                                      │
│  }                                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 文档生成 + 索引生成                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ DocumentGenerator (F2.6-F2.10)                                        │  │
│  │  - generate_litigation()         生成起诉状                            │  │
│  │  - generate_contracts()          生成合同类证据                        │  │
│  │  - generate_vouchers()           生成凭证类证据                        │  │
│  │  - generate_documents()          生成文书类证据                       │  │
│  │  - generate_attachments()        生成附件                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    ↓                                         │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ EvidenceIndexGenerator (F2.11)                                        │  │
│  │  - build_index()                  构建证据索引                         │  │
│  │  - map_evidence_claim()           证据与诉求对应关系                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  GeneratedDocuments + EvidenceIndex                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ PDF输出 + 质量验证                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ PDFGenerator (F3)                                                      │  │
│  │  - render_document()            渲染文档到PDF                          │  │
│  │  - render_table()               渲染表格                               │  │
│  │  - paginate()                   分页处理                               │  │
│  │  - generate_toc()               生成目录                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ QualityValidator                                                        │  │
│  │  - check_deanonymization()      脱敏标记检查                           │  │
│  │  - check_consistency()          数据一致性检查                         │  │
│  │  - check_completeness()         证据完整性检查                         │  │
│  │  - check_format()               格式规范检查                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│      ↓                                                                        │
│  EvidenceSet.pdf（证据集PDF）                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心数据模型

### 3.1 数据模型定义

```python
from dataclasses import dataclass, field
from typing import List, Optional, Dict, Any
from datetime import datetime
from enum import Enum


class CaseType(Enum):
    FINANCING_LEASE = "融资租赁"
    LOAN = "金融借款"
    FACTORING = "保理"
    GUARANTEE = "担保"


@dataclass
class Party:
    name: str
    credit_code: str
    address: str
    legal_representative: str
    bank_account: Optional[str] = None


@dataclass
class ContractInfo:
    type: CaseType
    subject: str
    amount: float
    signing_date: datetime
    performance_date: Optional[datetime] = None
    term_months: Optional[int] = None


@dataclass
class BreachInfo:
    breach_date: Optional[datetime] = None
    breach_amount: Optional[float] = None
    breach_description: Optional[str] = None


@dataclass
class CaseData:
    """案情基本数据集 - F2.1输出"""
    plaintiff: Party
    defendant: Party
    guarantor: Optional[Party] = None
    contract: ContractInfo = None
    paid_amount: Optional[float] = None
    remaining_amount: Optional[float] = None
    breach: Optional[BreachInfo] = None
    attachments: Dict[str, List[Dict[str, Any]]] = field(default_factory=dict)
    judgment_path: Optional[str] = None
    extracted_at: Optional[datetime] = None


@dataclass
class Claim:
    type: str
    amount: float
    description: Optional[str] = None


@dataclass
class ClaimList:
    claims: List[Claim]
    litigation_cost: Optional[float] = None
    attorney_fee: Optional[float] = None


@dataclass
class AttachmentPlan:
    type: str
    form: str
    source: str


@dataclass
class EvidenceRequirement:
    name: str
    type: str
    facts_to_prove: List[str]
    claims_supported: List[str]
    attachment: Optional[AttachmentPlan] = None


@dataclass
class EvidenceRequirements:
    requirements: List[EvidenceRequirement]
    case_type: CaseType


@dataclass
class EvidenceItem:
    name: str
    type: str
    source: str
    fabricated: bool = False
    fabricated_note: Optional[str] = None


@dataclass
class EvidenceCollection:
    items: List[EvidenceItem]
    from_judgment: List[str] = field(default_factory=list)
    fabricated: List[str] = field(default_factory=list)


@dataclass
class AttachmentInfo:
    type: str
    source: str
    form: str
    data: Optional[Dict[str, Any]] = None


@dataclass
class EvidenceListItem:
    """证据列表项 - F2.5输出 ← 核心"""
    name: str
    type: str
    key_info: Dict[str, Any]
    claims_supported: List[str]
    attachment: Optional[AttachmentInfo] = None

    def to_prompt_context(self) -> str:
        lines = [f"证据名称：{self.name}", f"证据类型：{self.type}", ""]
        lines.append("关键信息：")
        for key, value in self.key_info.items():
            lines.append(f"  - {key}：{value}")
        if self.attachment:
            lines.append("")
            lines.append(f"附件：{self.attachment.type}")
            if self.attachment.data:
                lines.append("附件数据：")
                for key, value in self.attachment.data.items():
                    lines.append(f"  - {key}：{value}")
        return "\n".join(lines)


@dataclass
class EvidenceList:
    """证据列表 - F2.5输出 ← 核心输出"""
    items: List[EvidenceListItem]
    case_type: CaseType

    def to_llm_prompt(self) -> str:
        sections = ["=== 证据列表 ===", ""]
        for i, item in enumerate(self.items, 1):
            sections.append(f"【证据{i}】")
            sections.append(item.to_prompt_context())
            sections.append("")
        return "\n".join(sections)


@dataclass
class GeneratedEvidence:
    filename: str
    content: str
    evidence_type: str


@dataclass
class EvidenceIndexItem:
    number: int
    name: str
    type: str
    purpose: str
    claims_supported: List[str]


@dataclass
class EvidenceIndex:
    items: List[EvidenceIndexItem]
    total_count: int
```

---

## 四、核心组件设计

### 4.1 CaseAnalyzer（案情分析）

```python
from abc import ABC, abstractmethod
from pathlib import Path
from typing import Optional
import re
from datetime import datetime


class JudgmentParser(ABC):
    @abstractmethod
    def parse(self, judgment_path: Path) -> str:
        pass


class PDFJudgmentParser(JudgmentParser):
    def __init__(self, pdf_engine: str = "pdfplumber"):
        self.pdf_engine = pdf_engine

    def parse(self, judgment_path: Path) -> str:
        if self.pdf_engine == "pdfplumber":
            import pdfplumber
            text_parts = []
            with pdfplumber.open(judgment_path) as pdf:
                for page in pdf.pages:
                    text = page.extract_text()
                    if text:
                        text_parts.append(text)
            return "\n".join(text_parts)
        elif self.pdf_engine == "pypdf":
            from pypdf import PdfReader
            reader = PdfReader(judgment_path)
            return "\n".join(page.extract_text() or "" for page in reader.pages)
        else:
            raise ValueError(f"不支持的PDF引擎：{self.pdf_engine}")


class TextJudgmentParser(JudgmentParser):
    def parse(self, judgment_path: Path) -> str:
        return judgment_path.read_text(encoding="utf-8")


class CaseAnalyzer:
    """案情分析器 - F2.1"""

    def __init__(
        self,
        llm_client: Optional["LLMClient"] = None,
        parser: Optional[JudgmentParser] = None
    ):
        self.llm_client = llm_client
        self.parser = parser or PDFJudgmentParser()

    def analyze(self, judgment_path: Path) -> CaseData:
        judgment_text = self.parser.parse(judgment_path)
        parties = self._extract_parties(judgment_text)
        contract = self._analyze_contract(judgment_text)
        performance = self._analyze_performance(judgment_text)
        breach = self._analyze_breach(judgment_text)

        return CaseData(
            plaintiff=parties["plaintiff"],
            defendant=parties["defendant"],
            guarantor=parties.get("guarantor"),
            contract=contract,
            paid_amount=performance.get("paid_amount"),
            remaining_amount=performance.get("remaining_amount"),
            breach=breach,
            judgment_path=str(judgment_path)
        )

    def _extract_parties(self, text: str) -> dict:
        if self.llm_client:
            return self._extract_parties_by_llm(text)
        return self._extract_parties_by_regex(text)

    def _extract_parties_by_llm(self, text: str) -> dict:
        prompt = f"""
# 任务：从判决书中提取当事人信息

请从以下判决书文本中提取原告、被告、担保人的详细信息，以JSON格式输出。

## 提取要求
1. 只提取判决书中明确列出的信息
2. 如果某项信息判决书没有提及，标记为null
3. 公司名称必须是全称

## 判决书文本
{text}

## 输出格式
```json
{{
  "plaintiff": {{
    "name": "公司全称",
    "credit_code": "统一社会信用代码",
    "address": "注册地址",
    "legal_representative": "法定代表人姓名",
    "bank_account": "银行账户（可选）"
  }},
  "defendant": {{...}},
  "guarantor": null
}}
```
"""
        import json
        response = self.llm_client.complete(prompt)
        json_match = re.search(r'```json\s*\n(.+?)\n```', response, re.DOTALL)
        if json_match:
            return json.loads(json_match.group(1))
        json_match = re.search(r'\{.+\}', response, re.DOTALL)
        if json_match:
            return json.loads(json_match.group(0))
        raise ValueError("无法解析当事人信息")

    def _extract_parties_by_regex(self, text: str) -> dict:
        raise NotImplementedError("正则表达式提取待实现")

    def _analyze_contract(self, text: str) -> ContractInfo:
        return ContractInfo(
            type=self._extract_contract_type(text),
            subject=self._extract_subject(text),
            amount=self._extract_amount(text),
            signing_date=self._extract_date(text),
            term_months=self._extract_term(text)
        )

    def _extract_contract_type(self, text: str) -> CaseType:
        if "融资租赁" in text:
            return CaseType.FINANCING_LEASE
        elif "借款" in text:
            return CaseType.LOAN
        elif "保理" in text:
            return CaseType.FACTORING
        elif "担保" in text:
            return CaseType.GUARANTEE
        return CaseType.FINANCING_LEASE

    def _extract_amount(self, text: str) -> float:
        patterns = [r'人民币([\d,]+)\s*元', r'([\d,]+)\s*元']
        for pattern in patterns:
            match = re.search(pattern, text)
            if match:
                return float(match.group(1).replace(',', ''))
        return 0.0

    def _extract_date(self, text: str) -> datetime:
        pattern = r'(\d{4})年(\d{1,2})月(\d{1,2})日'
        match = re.search(pattern, text)
        if match:
            return datetime(int(match.group(1)), int(match.group(2)), int(match.group(3)))
        return datetime.now()

    def _extract_term(self, text: str) -> Optional[int]:
        match = re.search(r'(\d+)\s*个月', text)
        return int(match.group(1)) if match else None

    def _extract_subject(self, text: str) -> str:
        return "设备/货物"

    def _analyze_performance(self, text: str) -> dict:
        return {"paid_amount": None, "remaining_amount": None}

    def _analyze_breach(self, text: str) -> Optional[BreachInfo]:
        return None
```

### 4.2 ClaimExtractor（诉求提取）

```python
class ClaimExtractor:
    """诉求提取器 - F2.2"""

    def __init__(self, llm_client: Optional["LLMClient"] = None):
        self.llm_client = llm_client

    def extract(self, judgment_path: Path) -> ClaimList:
        text = judgment_path.read_text(encoding="utf-8")
        if self.llm_client:
            return self._extract_by_llm(text)
        return self._extract_by_regex(text)

    def _extract_by_llm(self, text: str) -> ClaimList:
        import json
        prompt = f"""
# 任务：从判决书中提取原告诉求

请从以下判决书文本中提取原告的诉讼请求，以JSON格式输出。

## 判决书文本
{text}

## 输出格式
```json
{{
  "claims": [
    {{"type": "本金", "amount": 150000000, "description": "请求判令被告支付欠款本金"}},
    {{"type": "利息", "amount": 5000000, "description": "请求判令被告支付欠款利息"}},
    {{"type": "违约金", "amount": 2000000, "description": "请求判令被告支付违约金"}}
  ],
  "litigation_cost": 50000,
  "attorney_fee": null
}}
```
"""
        response = self.llm_client.complete(prompt)
        import re
        json_match = re.search(r'```json\s*\n(.+?)\n```', response, re.DOTALL)
        if json_match:
            data = json.loads(json_match.group(1))
        else:
            json_match = re.search(r'\{.+\}', response, re.DOTALL)
            data = json.loads(json_match.group(0))

        claims = [Claim(**c) for c in data.get("claims", [])]
        return ClaimList(claims=claims, litigation_cost=data.get("litigation_cost"))

    def _extract_by_regex(self, text: str) -> ClaimList:
        return ClaimList(claims=[])
```

### 4.3 EvidencePlanner（证据规划）

```python
from typing import List


class EvidencePlanner:
    """证据规划器 - F2.3"""

    def __init__(self, config_loader: "ConfigLoader"):
        self.config_loader = config_loader

    def plan(
        self,
        case_data: CaseData,
        claim_list: ClaimList
    ) -> EvidenceRequirements:
        evidence_types = self._get_evidence_types(case_data.contract.type)
        requirements = []

        for claim in claim_list.claims:
            requirements.extend(self._plan_evidence_for_claim(claim, case_data.contract.type))

        for req in requirements:
            req.attachment = self._plan_attachment(req, case_data.contract.type)

        return EvidenceRequirements(requirements=requirements, case_type=case_data.contract.type)

    def _get_evidence_types(self, case_type: CaseType) -> List[str]:
        config = self.config_loader.load_case_type_config(case_type)
        return config.get("evidence_types", [])

    def _plan_evidence_for_claim(
        self,
        claim: Claim,
        case_type: CaseType
    ) -> List[EvidenceRequirement]:
        requirements = []
        if case_type == CaseType.FINANCING_LEASE:
            if claim.type in ["本金", "租金"]:
                requirements.append(EvidenceRequirement(
                    name="融资租赁合同",
                    type="合同类",
                    facts_to_prove=["合同关系成立", "合同金额"],
                    claims_supported=[claim.type]
                ))
                requirements.append(EvidenceRequirement(
                    name="付款凭证",
                    type="凭证类",
                    facts_to_prove=["已付款金额"],
                    claims_supported=[claim.type]
                ))
        return requirements

    def _plan_attachment(
        self,
        requirement: EvidenceRequirement,
        case_type: CaseType
    ) -> Optional[AttachmentPlan]:
        if requirement.type == "合同类":
            if case_type == CaseType.FINANCING_LEASE:
                return AttachmentPlan(type="租赁物清单", form="独立文件", source="案情数据")
            elif case_type == CaseType.LOAN:
                return AttachmentPlan(type="还款计划", form="正文包含", source="案情数据")
        return None
```

### 4.4 EvidenceCollector（证据收集）

```python
from typing import List


class EvidenceCollector:
    """证据收集器 - F2.4"""

    def __init__(self, llm_client: Optional["LLMClient"] = None):
        self.llm_client = llm_client

    def collect(
        self,
        judgment_path: Path,
        requirements: EvidenceRequirements
    ) -> EvidenceCollection:
        from_judgment = self._extract_from_judgment(judgment_path)
        missing = self._identify_missing(requirements, from_judgment)
        fabricated = self._fabricate_missing(missing, requirements)
        all_items = from_judgment + fabricated

        return EvidenceCollection(
            items=all_items,
            from_judgment=[item.name for item in from_judgment],
            fabricated=[item.name for item in fabricated]
        )

    def _extract_from_judgment(self, judgment_path: Path) -> List[EvidenceItem]:
        text = judgment_path.read_text(encoding="utf-8")
        if self.llm_client:
            return self._extract_by_llm(text)
        return self._extract_by_regex(text)

    def _extract_by_llm(self, text: str) -> List[EvidenceItem]:
        import json
        import re
        prompt = f"""
# 任务：从判决书中提取原告提交的证据

请从以下判决书文本中提取原告提交的证据列表，以JSON格式输出。

## 判决书文本
{text}

## 输出格式
```json
[
  {{"name": "融资租赁合同", "type": "合同类"}},
  {{"name": "付款凭证", "type": "凭证类"}}
]
```
"""
        response = self.llm_client.complete(prompt)
        json_match = re.search(r'```json\s*\n(.+?)\n```', response, re.DOTALL)
        if json_match:
            data = json.loads(json_match.group(1))
        else:
            json_match = re.search(r'\[.+\]', response, re.DOTALL)
            data = json.loads(json_match.group(0))

        return [
            EvidenceItem(name=item["name"], type=item["type"], source="判决书提取", fabricated=False)
            for item in data
        ]

    def _extract_by_regex(self, text: str) -> List[EvidenceItem]:
        return []

    def _identify_missing(
        self,
        requirements: EvidenceRequirements,
        from_judgment: List[EvidenceItem]
    ) -> List[str]:
        judgment_evidence_names = {item.name for item in from_judgment}
        required_evidence_names = {req.name for req in requirements.requirements}
        return list(required_evidence_names - judgment_evidence_names)

    def _fabricate_missing(
        self,
        missing: List[str],
        requirements: EvidenceRequirements
    ) -> List[EvidenceItem]:
        return [
            EvidenceItem(
                name=name,
                type="附件类",
                source="自行编造",
                fabricated=True,
                fabricated_note="根据案件类型配置自动生成"
            )
            for name in missing
        ]
```

### 4.5 EvidenceListCreator（证据列表创建）← 核心

```python
class EvidenceListCreator:
    """证据列表创建器 - F2.5 ← 核心"""

    def create(
        self,
        case_data: CaseData,
        collection: EvidenceCollection,
        requirements: EvidenceRequirements
    ) -> EvidenceList:
        items = []

        for item in collection.items:
            key_info = self._extract_key_info(item, case_data)
            claims_supported = self._get_claims_supported(item, requirements)
            attachment = self._get_attachment(item, case_data, requirements)

            evidence_list_item = EvidenceListItem(
                name=item.name,
                type=item.type,
                key_info=key_info,
                claims_supported=claims_supported,
                attachment=attachment
            )
            items.append(evidence_list_item)

        return EvidenceList(items=items, case_type=case_data.contract.type)

    def _extract_key_info(
        self,
        item: EvidenceItem,
        case_data: CaseData
    ) -> Dict[str, Any]:
        key_info = {}

        if item.type == "合同类":
            key_info = {
                "出租人": case_data.plaintiff.name,
                "承租人": case_data.defendant.name,
                "标的物": case_data.contract.subject,
                "合同金额": f"{case_data.contract.amount:,.0f}元",
                "签订日期": case_data.contract.signing_date.strftime("%Y年%m月%d日"),
                "租期": f"{case_data.contract.term_months}个月" if case_data.contract.term_months else None
            }
        elif item.type == "凭证类":
            key_info = {
                "付款方": case_data.plaintiff.name,
                "收款方": case_data.defendant.name,
                "金额": f"{case_data.contract.amount:,.0f}元",
                "日期": case_data.contract.signing_date.strftime("%Y年%m月%d日")
            }
        elif item.type == "附件类":
            if "租赁物" in item.name:
                key_info = {"租赁物清单": case_data.attachments.get("租赁物清单", [])}

        return key_info

    def _get_claims_supported(
        self,
        item: EvidenceItem,
        requirements: EvidenceRequirements
    ) -> List[str]:
        for req in requirements.requirements:
            if req.name == item.name:
                return req.claims_supported
        return []

    def _get_attachment(
        self,
        item: EvidenceItem,
        case_data: CaseData,
        requirements: EvidenceRequirements
    ) -> Optional[AttachmentInfo]:
        for req in requirements.requirements:
            if req.name == item.name and req.attachment:
                return AttachmentInfo(
                    type=req.attachment.type,
                    source=req.attachment.source,
                    form=req.attachment.form
                )
        return None
```

### 4.6 EvidenceGenerator（证据生成）

```python
class EvidenceGenerator:
    """证据生成器 - LLM生成证据"""

    def __init__(self, llm_client: "LLMClient", template_loader: "TemplateLoader"):
        self.llm_client = llm_client
        self.template_loader = template_loader

    def generate(
        self,
        evidence_list: EvidenceList,
        output_dir: Path
    ) -> List[GeneratedEvidence]:
        generated = []

        for i, item in enumerate(evidence_list.items, 1):
            prompt = self._build_evidence_prompt(item, evidence_list.case_type)
            content = self.llm_client.complete(prompt)

            filename = f"{i:03d}_{item.name}.txt"
            (output_dir / filename).write_text(content, encoding="utf-8")

            generated.append(GeneratedEvidence(
                filename=filename,
                content=content,
                evidence_type=item.type
            ))

        return generated

    def _build_evidence_prompt(
        self,
        item: EvidenceListItem,
        case_type: CaseType
    ) -> str:
        template = self.template_loader.load_evidence_template(item.type, case_type)
        context = item.to_prompt_context()

        return f"""
{template}

## 证据关键信息
{context}

## 要求
1. 只使用上述关键信息中的真实名称，不要使用"某某公司"等脱敏标记
2. 证据内容必须符合中国法律对相应类型证据的要求
3. 金额使用中文大写
4. 日期使用中文格式
5. 输出纯文本，使用换行符分隔段落
"""
```

### 4.7 LitigationComplaintGenerator（起诉状生成）← F2.6

```python
class LitigationComplaintGenerator:
    """起诉状生成器 - F2.6"""

    def generate(
        self,
        case_data: CaseData,
        claim_list: ClaimList,
        evidence_list: EvidenceList
    ) -> str:
        sections = []
        sections.append(self._generate_header(case_data))
        sections.append(self._generate_parties(case_data))
        sections.append(self._generate_claims(claim_list))
        sections.append(self._generate_facts(case_data))
        sections.append(self._generate_evidence_list(evidence_list))
        sections.append(self._generate_footer(case_data))
        return "\n".join(sections)

    def _generate_header(self, case_data: CaseData) -> str:
        return "民事起诉状"

    def _generate_parties(self, case_data: CaseData) -> str:
        lines = []
        lines.append("原告：")
        lines.append(f"名称：{case_data.plaintiff.name}")
        lines.append(f"住所地：{case_data.plaintiff.address}")
        lines.append(f"法定代表人：{case_data.plaintiff.legal_representative}")
        lines.append("")
        lines.append("被告：")
        lines.append(f"名称：{case_data.defendant.name}")
        lines.append(f"住所地：{case_data.defendant.address}")
        lines.append(f"法定代表人：{case_data.defendant.legal_representative}")
        return "\n".join(lines)

    def _generate_claims(self, claim_list: ClaimList) -> str:
        lines = ["诉讼请求：", ""]
        for i, claim in enumerate(claim_list.claims, 1):
            if claim.type == "本金":
                lines.append(f"{i}. 请求判令被告向原告支付欠款本金人民币{claim.amount:,.0f}元")
            elif claim.type == "利息":
                lines.append(f"{i}. 请求判令被告向原告支付欠款利息人民币{claim.amount:,.0f}元")
        return "\n".join(lines)

    def _generate_facts(self, case_data: CaseData) -> str:
        lines = ["事实与理由：", ""]
        lines.append("一、合同签订情况")
        lines.append(f"原告与被告于{case_data.contract.signing_date.strftime('%Y年%m月%d日')}签订《{case_data.contract.type.value}》。")
        lines.append(f"合同金额为人民币{case_data.contract.amount:,.0f}元。")
        lines.append("")
        if case_data.breach:
            lines.append("二、被告违约事实")
            lines.append(f"被告于{case_data.breach.breach_date.strftime('%Y年%m月%d日')}起未按约定履行付款义务。")
        return "\n".join(lines)

    def _generate_evidence_list(self, evidence_list: EvidenceList) -> str:
        lines = ["证据清单：", ""]
        for i, item in enumerate(evidence_list.items, 1):
            lines.append(f"{i}. {item.name}（{item.type}）")
        return "\n".join(lines)

    def _generate_footer(self, case_data: CaseData) -> str:
        return "\n".join(["", "此致", "上海市浦东新区人民法院", "", "起诉人（盖章）：", "", "日期：____年__月__日"])
```

### 4.8 DocumentGenerator（文档生成）← F2.7-F2.10

```python
class DocumentGenerator:
    """文档生成器 - F2.7-F2.10"""

    def generate_contract(self, evidence_item: EvidenceListItem, case_data: CaseData) -> str:
        key_info = evidence_item.key_info
        lines = ["合同", ""]
        lines.append("甲方（出租人）：")
        lines.append(f"名称：{key_info.get('出租人', case_data.plaintiff.name)}")
        lines.append(f"住所地：{case_data.plaintiff.address}")
        lines.append("")
        lines.append("乙方（承租人）：")
        lines.append(f"名称：{key_info.get('承租人', case_data.defendant.name)}")
        lines.append(f"住所地：{case_data.defendant.address}")
        lines.append("")
        lines.append(f"鉴于：甲乙双方于{key_info.get('签订日期', case_data.contract.signing_date.strftime('%Y年%m月%d日'))}签订《融资租赁合同》。")
        lines.append("")
        lines.append("第一条 租赁物")
        if evidence_item.attachment and evidence_item.attachment.form == "独立文件":
            lines.append(f"租赁物为详见附件1《{evidence_item.attachment.type}》所列设备。")
        else:
            lines.append(f"租赁物为{key_info.get('标的物', case_data.contract.subject)}。")
        lines.append("")
        lines.append("第二条 租金及支付方式")
        lines.append(f"租金总额为人民币{key_info.get('合同金额', case_data.contract.amount):,.0f}元。")
        lines.append("")
        lines.append("甲方（盖章）：                    乙方（盖章）：")
        lines.append(f"签订日期：{key_info.get('签订日期', case_data.contract.signing_date.strftime('%Y年%m月%d日'))}")
        return "\n".join(lines)

    def generate_voucher(self, evidence_item: EvidenceListItem, case_data: CaseData) -> str:
        key_info = evidence_item.key_info
        lines = ["付款凭证", ""]
        lines.append(f"付款方名称：{key_info.get('付款方', case_data.plaintiff.name)}")
        lines.append(f"收款方名称：{key_info.get('收款方', case_data.defendant.name)}")
        lines.append(f"金额：人民币{key_info.get('金额', case_data.contract.amount):,.0f}元")
        lines.append(f"日期：{key_info.get('日期', case_data.contract.signing_date.strftime('%Y年%m月%d日'))}")
        return "\n".join(lines)

    def generate_attachment(self, evidence_item: EvidenceListItem, case_data: CaseData) -> str:
        lines = [evidence_item.attachment.type, ""]
        if evidence_item.attachment.type == "租赁物清单":
            lines.append("| 序号 | 设备名称 | 规格型号 | 数量 | 评估价值 |")
            lines.append("|------|----------|----------|------|----------|")
            lease_items = case_data.attachments.get("租赁物清单", [])
            for i, item in enumerate(lease_items, 1):
                lines.append(f"| {i} | {item.get('设备名称', '')} | {item.get('规格型号', '')} | {item.get('数量', '')} | {item.get('评估价值', 0):,.0f} |")
        return "\n".join(lines)
```

### 4.9 EvidenceIndexGenerator（证据索引生成）← F2.11

```python
@dataclass
class EvidenceIndexItem:
    number: int
    name: str
    type: str
    purpose: str
    claims_supported: List[str]


@dataclass
class EvidenceIndex:
    items: List[EvidenceIndexItem]
    total_count: int

    def to_text(self) -> str:
        lines = ["证据清单", "", f"证据总数：{self.total_count}", ""]
        for item in self.items:
            lines.append(f"证据{item.number}：{item.name}")
            lines.append(f"  类型：{item.type}")
            lines.append(f"  证明目的：{item.purpose}")
            lines.append(f"  支撑诉求：{', '.join(item.claims_supported)}")
        return "\n".join(lines)


class EvidenceIndexGenerator:
    """证据索引生成器 - F2.11"""

    def generate(self, evidence_list: EvidenceList) -> EvidenceIndex:
        items = []
        for i, item in enumerate(evidence_list.items, 1):
            items.append(EvidenceIndexItem(
                number=i,
                name=item.name,
                type=item.type,
                purpose=self._get_purpose(item),
                claims_supported=item.claims_supported
            ))
        return EvidenceIndex(items=items, total_count=len(items))

    def _get_purpose(self, item: EvidenceListItem) -> str:
        purpose_map = {
            "合同类": "证明合同关系成立及合同内容",
            "凭证类": "证明资金往来事实",
            "文书类": "证明相关权利或事实",
            "附件类": "证明标的物明细或还款计划"
        }
        return purpose_map.get(item.type, "证明相关事实")
```

### 4.10 LLMClient（LLM客户端）

```python
import os
import time
import requests
from typing import Optional


class LLMClient:
    """LLM客户端"""

    def __init__(
        self,
        api_key: str = None,
        base_url: str = None,
        model: str = "gpt-4",
        timeout: int = 120,
        max_retries: int = 3
    ):
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        self.base_url = base_url or os.getenv("OPENAI_BASE_URL", "https://api.openai.com/v1")
        self.model = model
        self.timeout = timeout
        self.max_retries = max_retries

    def complete(
        self,
        prompt: str,
        system_prompt: Optional[str] = None,
        temperature: float = 0.1
    ) -> str:
        messages = []
        if system_prompt:
            messages.append({"role": "system", "content": system_prompt})
        messages.append({"role": "user", "content": prompt})

        for attempt in range(self.max_retries):
            try:
                response = self._call_api(messages, temperature)
                return response
            except Exception as e:
                if attempt < self.max_retries - 1:
                    time.sleep(2 ** attempt)
                    continue
                raise RuntimeError(f"LLM调用失败，已重试{self.max_retries}次")

    def _call_api(self, messages: list, temperature: float) -> str:
        if not self.api_key:
            raise ValueError("未配置API Key")

        headers = {"Authorization": f"Bearer {self.api_key}", "Content-Type": "application/json"}
        payload = {"model": self.model, "messages": messages, "temperature": temperature, "max_tokens": 8192}

        response = requests.post(
            f"{self.base_url}/chat/completions",
            headers=headers,
            json=payload,
            timeout=self.timeout
        )
        response.raise_for_status()
        return response.json()["choices"][0]["message"]["content"]
```

### 4.8 QualityValidator（质量验证器）

```python
import re
from pathlib import Path
from typing import List, Tuple


class QualityValidator:
    """质量验证器"""

    def __init__(self):
        self.deanonymization_patterns = [
            r"某某", r"XX", r"XXX", r"某年某月某日", r"X月X日", r"\?{3,}"
        ]

    def validate_all(
        self,
        output_dir: Path,
        case_data: CaseData
    ) -> Tuple[bool, List[str]]:
        issues = []
        issues.extend(self._check_deanonymization(output_dir))
        issues.extend(self._check_consistency(output_dir, case_data))
        issues.extend(self._check_completeness(output_dir))
        issues.extend(self._check_format(output_dir))
        return len(issues) == 0, issues

    def _check_deanonymization(self, output_dir: Path) -> List[str]:
        issues = []
        for txt_file in output_dir.glob("*.txt"):
            content = txt_file.read_text(encoding="utf-8")
            for pattern in self.deanonymization_patterns:
                if re.search(pattern, content):
                    issues.append(f"[脱敏] {txt_file.name} 包含脱敏标记：{pattern}")
                    break
        return issues

    def _check_consistency(
        self,
        output_dir: Path,
        case_data: CaseData
    ) -> List[str]:
        issues = []
        for txt_file in output_dir.glob("*.txt"):
            content = txt_file.read_text(encoding="utf-8")
            if case_data.plaintiff.name not in content:
                issues.append(f"[一致性] {txt_file.name} 缺少原告名称")
            if case_data.defendant.name not in content:
                issues.append(f"[一致性] {txt_file.name} 缺少被告名称")
        return issues

    def _check_completeness(self, output_dir: Path) -> List[str]:
        issues = []
        required_files = ["001_融资租赁合同.txt", "002_租赁物清单.txt"]
        for required in required_files:
            if not (output_dir / required).exists():
                issues.append(f"[完整性] 缺少必要文件：{required}")
        return issues

    def _check_format(self, output_dir: Path) -> List[str]:
        issues = []
        for txt_file in output_dir.glob("*.txt"):
            content = txt_file.read_text(encoding="utf-8")
            if content and not content.endswith("\n"):
                issues.append(f"[格式] {txt_file.name} 未以换行结尾")
        return issues
```

### 4.9 PDFGenerator（PDF生成器）

```python
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import mm
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak
from reportlab.lib.enums import TA_CENTER, TA_LEFT


class PDFGenerator:
    """PDF生成器 - F3"""

    def __init__(self, output_path: Path):
        self.output_path = output_path
        self.styles = self._setup_styles()

    def _setup_styles(self):
        styles = getSampleStyleSheet()
        styles.add(ParagraphStyle(name="ChineseTitle", parent=styles["Heading1"],
            fontSize=18, leading=24, spaceAfter=20, alignment=TA_CENTER))
        styles.add(ParagraphStyle(name="ChineseBody", parent=styles["Normal"],
            fontSize=12, leading=20, spaceAfter=12, alignment=TA_LEFT))
        styles.add(ParagraphStyle(name="EvidenceTitle", parent=styles["Heading2"],
            fontSize=14, leading=20, spaceBefore=20, spaceAfter=12, alignment=TA_LEFT))
        return styles

    def generate(
        self,
        evidence_dir: Path,
        litigation_path: Path,
        index_path: Path
    ):
        doc = SimpleDocTemplate(str(self.output_path), pagesize=A4,
            rightMargin=25*mm, leftMargin=25*mm, topMargin=25*mm, bottomMargin=25*mm)
        story = []

        self._add_litigation(story, litigation_path)

        for evidence_file in sorted(evidence_dir.glob("*.txt")):
            self._add_evidence(story, evidence_file)

        self._add_index(story, index_path)
        doc.build(story)

    def _add_litigation(self, story: list, path: Path):
        story.append(Paragraph("民事起诉状", self.styles["ChineseTitle"]))
        story.append(Spacer(1, 20*mm))
        content = path.read_text(encoding="utf-8")
        for paragraph in content.split("\n"):
            if paragraph.strip():
                story.append(Paragraph(paragraph, self.styles["ChineseBody"]))
        story.append(PageBreak())

    def _add_evidence(self, story: list, path: Path):
        title = path.stem.split("_", 1)[-1]
        story.append(Paragraph(f"证据{path.stem.split('_')[0]}：{title}", self.styles["EvidenceTitle"]))
        story.append(Spacer(1, 10*mm))
        content = path.read_text(encoding="utf-8")
        for paragraph in content.split("\n"):
            if paragraph.strip():
                story.append(Paragraph(paragraph, self.styles["ChineseBody"]))
        story.append(PageBreak())

    def _add_index(self, story: list, path: Path):
        story.append(Paragraph("证据清单", self.styles["EvidenceTitle"]))
        story.append(Spacer(1, 10*mm))
        content = path.read_text(encoding="utf-8")
        for paragraph in content.split("\n"):
            if paragraph.strip():
                story.append(Paragraph(paragraph, self.styles["ChineseBody"]))
```

---

## 五、入口设计

### 5.1 统一入口 main.py

```python
#!/usr/bin/env python3
"""
金融案件证据集生成系统 v3.0
"""

import argparse
import sys
from pathlib import Path
from datetime import datetime


def main():
    parser = argparse.ArgumentParser(description="金融案件证据集生成系统 v3.0")
    parser.add_argument("--input", "-i", required=True, help="输入判决书文件路径")
    parser.add_argument("--output", "-o", required=True, help="输出PDF文件路径")
    parser.add_argument("--verify", action="store_true", help="仅验证模式")
    parser.add_argument("--skip-validation", action="store_true", help="跳过质量验证")

    args = parser.parse_args()
    input_path = Path(args.input)
    output_path = Path(args.output)

    if not input_path.exists():
        print(f"错误：输入文件不存在：{input_path}")
        sys.exit(1)

    output_path.parent.mkdir(parents=True, exist_ok=True)
    run_evidence_generation(input_path, output_path, args.skip_validation)


def run_evidence_generation(
    input_path: Path,
    output_path: Path,
    skip_validation: bool = False
):
    from core.case_analyzer import CaseAnalyzer
    from core.claim_extractor import ClaimExtractor
    from core.evidence_planner import EvidencePlanner
    from core.evidence_collector import EvidenceCollector
    from core.evidence_list_creator import EvidenceListCreator
    from core.evidence_generator import EvidenceGenerator
    from core.llm_client import LLMClient
    from core.quality_validator import QualityValidator
    from core.pdf_generator import PDFGenerator

    print("=" * 60)
    print("金融案件证据集生成系统 v3.0")
    print("=" * 60)

    llm_client = LLMClient()
    output_dir = output_path.parent / f"evidence_set_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    output_dir.mkdir(exist_ok=True)
    evidence_dir = output_dir / "evidence"
    evidence_dir.mkdir(exist_ok=True)

    try:
        print("[1/8] 案情分析...")
        case_analyzer = CaseAnalyzer(llm_client=llm_client)
        case_data = case_analyzer.analyze(input_path)

        print("[2/8] 诉求提取...")
        claim_extractor = ClaimExtractor(llm_client=llm_client)
        claim_list = claim_extractor.extract(input_path)

        print("[3/8] 证据规划...")
        evidence_planner = EvidencePlanner()
        evidence_requirements = evidence_planner.plan(case_data, claim_list)

        print("[4/8] 证据收集...")
        evidence_collector = EvidenceCollector(llm_client=llm_client)
        evidence_collection = evidence_collector.collect(input_path, evidence_requirements)

        print("[5/8] 证据列表创建（核心）...")
        evidence_list_creator = EvidenceListCreator()
        evidence_list = evidence_list_creator.create(case_data, evidence_collection, evidence_requirements)

        print("[6/8] LLM生成证据...")
        evidence_generator = EvidenceGenerator(llm_client, None)
        evidence_generator.generate(evidence_list, evidence_dir)

        print("[7/8] 生成起诉状和证据索引...")
        litigation_path = evidence_dir.parent / "litigation_complaint.txt"
        index_path = evidence_dir.parent / "evidence_index.txt"

        print("[8/8] 生成PDF...")
        pdf_generator = PDFGenerator(output_path)
        pdf_generator.generate(evidence_dir, litigation_path, index_path)

        if not skip_validation:
            print("-" * 60)
            print("质量验证...")
            validator = QualityValidator()
            passed, issues = validator.validate_all(evidence_dir, case_data)
            if issues:
                for issue in issues:
                    print(f"  - {issue}")
            print("✓ 质量验证通过" if passed else "警告：质量验证未通过")

        print("-" * 60)
        print(f"输出文件：{output_path}")
        print("=" * 60)

    except Exception as e:
        print(f"错误：{e}")
        raise


if __name__ == "__main__":
    main()
```

---

## 六、项目结构

```
financial_case_generator/
├── main.py                           # 统一入口
├── requirements.txt                  # 依赖
│
├── core/                             # 核心模块
│   ├── __init__.py
│   ├── case_analyzer.py              # F2.1 案情分析
│   ├── claim_extractor.py            # F2.2 诉求提取
│   ├── evidence_planner.py           # F2.3 证据规划
│   ├── evidence_collector.py         # F2.4 证据收集
│   ├── evidence_list_creator.py      # F2.5 证据列表创建 ← 核心
│   ├── evidence_generator.py         # LLM生成证据
│   ├── llm_client.py                 # LLM客户端
│   ├── quality_validator.py          # 质量验证
│   └── pdf_generator.py              # F3 PDF输出
│
├── models/                           # 数据模型
│   ├── __init__.py
│   └── data_models.py                # CaseData, Claim, EvidenceList等
│
├── config/                           # 配置
│   ├── case_types/
│   │   ├── financing_lease.json
│   │   ├── loan.json
│   │   └── factoring.json
│   └── prompts/
│       └── templates.txt
│
└── outputs/                          # 输出目录
    └── .gitkeep
```

---

## 七、验收标准

| 验收项 | 标准 |
|--------|------|
| 输入支持 | 系统能够识别并读取PDF格式的判决书文件 |
| 输出完整 | 系统输出包含民事起诉状和所有证据材料 |
| 格式正确 | 系统输出为符合法院标准的PDF文件 |
| 无脱敏标记 | 证据材料中不允许出现"某某公司"等脱敏标记 |
| 内容准确 | 证据内容与判决书记载的事实保持一致 |

---

**文档版本**: v1.0
**创建日期**: 2026-02-01
**最后更新**: 2026-02-01
