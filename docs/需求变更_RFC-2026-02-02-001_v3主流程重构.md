# 需求变更请求 - v3.0主流程重构

**变更编号**: RFC-2026-02-02-001
**日期**: 2026-02-02
**发起人**: Agent1
**变更类型**: 架构重构

---

## 一、变更背景

### 1.1 问题描述

2026-02-02测试发现：
- v3.0黑盒测试（使用mock数据）全部通过
- 但真实LLM生成流程（run_complete.py）仍使用v2.x架构
- 真实PDF存在脱敏标记问题（"某某设备"等24处）

**根本原因**：v3.0设计已完成，但**未集成到主流程**。

### 1.2 v3.0当前状态

| 里程碑 | 状态 |
|--------|------|
| PRD | ✅ 已签署 |
| TD | ✅ 已签署 |
| 开发 | ✅ 已完成（14个单元测试通过） |
| 测试 | ⏳ 待签署 |
| 部署 | ⏳ 待定 |

**问题**：v3.0的F2.x模块、EvidenceList、CaseData等设计已完成，但：
- 未集成到run_complete.py
- 主流程仍使用v2.x的Stage0/Stage1/Stage2/Stage3
- 真实生成仍存在脱敏问题

---

## 二、变更内容

### 2.1 核心变更

**将v3.0设计完全集成到主流程，废弃v2.x架构。**

| 方面 | v2.x（废弃） | v3.0（重构后） |
|------|-------------|---------------|
| 主入口 | run_complete.py | 新设计 |
| 数据流 | Stage0→Stage1→Stage2→Stage3 | 案情分析→证据列表→LLM生成→PDF输出 |
| 证据生成 | 程序+LLM混合 | 纯LLM生成 |
| 脱敏处理 | 事后清理 | 源头隔离 |
| Prompt模板 | prompts/stage*/ | 新模板目录 |

### 2.2 需废弃的组件

| 组件 | 文件 | 替代方案 |
|------|------|---------|
| 主入口 | run_complete.py | 新建v3主入口 |
| Stage服务 | src/services/stage0/, stage1/ | 使用F2.x模块 |
| 阶段产物 | outputs/stage0/, stage1/ | 新输出目录 |
| Prompt模板 | prompts/stage0/, stage1/, stage2/, stage3/ | 新模板目录 |

### 2.3 需新增的组件

| 组件 | 说明 |
|------|------|
| v3_main.py |主入口 |
| F2.1 Case 新Analyzer | 案情分析 |
| F2.2 ClaimExtractor | 诉求提取 |
| F2.3 EvidencePlanner | 证据规划 |
| F2.4 EvidenceCollector | 证据收集 |
| F2.5 EvidenceListCreator | 证据列表创建 |
| v3_prompts/ | 新Prompt模板目录 |

---

## 三、验收标准

### 3.1 功能验收

| 验收项 | 标准 |
|--------|------|
| 输入 | 判决书PDF |
| 输出 | 证据集PDF |
| 流程 | 单一命令触发完整流程 |
| 证据质量 | 无脱敏标记（"某某设备"、"若干台"等） |

### 3.2 质量验收

| 验收项 | 标准 |
|--------|------|
| 无脱敏标记 | 证据中不允许出现脱敏标记 |
| 内容准确 | 证据内容与判决书一致 |
| 格式规范 | 符合法院标准 |

---

## 四、影响范围

### 4.1 需修改的文档

| 文档 | 修改内容 |
|------|---------|
| PRD-2026-02-01-v3.0 | 添加主流程重构说明 |
| TD-2026-02-01-v3.0 | 添加v3主入口设计 |
| 测试用例 | 添加真实LLM生成测试 |

### 4.2 需重新签署的里程碑

| 里程碑 | 当前状态 | 处理方式 |
|--------|---------|---------|
| 需求 | approved | 无需重新签署（变更记录已保存） |
| 设计 | approved | 需更新TD后重新签署 |
| 开发 | completed | 集成开发完成后签署 |
| 测试 | pending | 新增测试后签署 |

### 4.3 预计工作量

| 任务 | 工作量 |
|------|-------|
| 设计v3主入口 | 0.5天 |
| 开发v3主入口 | 1天 |
| 集成F2.x模块 | 1天 |
| 废弃v2.x代码 | 0.5天 |
| 测试验证 | 1天 |
| **总计** | **4天** |

---

## 五、决策项

| 项 | 选项 |
|------|------|
| 是否批准此变更？ | ✅ 批准 / ❌ 拒绝 |
| 是否废弃v2.x代码？ | ✅ 废弃 / ❌ 保留 |
| 新主入口命名？ | v3_main.py / generate.py / 其他 |
| 输出目录？ | outputs_v3/ / outputs/（覆盖） |

---

## 六、行动计划

| 步骤 | 行动项 | 负责人 |
|------|--------|--------|
| 1 | 评审此RFC | Agent1 + Agent2 |
| 2 | 更新TD（添加v3主入口设计） | Agent2 |
| 3 | 签署TD | Agent1 |
| 4 | 开发v3主入口 | Agent2 |
| 5 | 集成F2.x模块 | Agent2 |
| 6 | 废弃v2.x代码 | Agent2 |
| 7 | 执行测试 | Agent1 |
| 8 | 签署测试 | Agent1 |

---

**创建日期**: 2026-02-02
**版本**: v1.0
**状态**: 待评审
