# 金融案件证据集生成系统 - 产品需求文档

**文档版本**: v2.1  
**状态**: 有效  
**创建日期**: 2024-01-27  
**最后更新**: 2026-01-28

---

## 一、文档演进历史

| 版本 | 日期 | 主要变更 |
|------|------|---------|
| [v1.0](v1_history/PRODUCT_REQUIREMENTS_v1.0.md) | 2024-01-26 | 初始版本，特定案件设计 |
| v2.0 | 2024-01-27 | 通用框架设计，完全自动化 |
| **v2.1** | **2026-01-28** | **更新验证命令、修正日期错误、添加AI开发模式说明** |

> 详细变更记录请查看 [CHANGELOG.md](CHANGELOG.md)

---

## 二、系统概述

### 2.1 设计目标

自动生成符合中国法院要求的**通用金融案件**证据集PDF文档。

### 2.2 核心设计理念

```
判决书 → 诉求 → 合同 → 附件 → 证据集
              ↓
        完全自动生成
```

### 2.3 设计原则

| 原则 | 说明 |
|------|------|
| 通用化 | 支持各类金融案件（融资租赁、借贷、担保等） |
| 配置驱动 | 案件类型、证据模板、字段映射均可配置 |
| 自动化 | 所有数据自动生成，无需人工准备 |
| 可扩展 | 新证据类型只需添加配置，不改核心代码 |

---

## 三、系统架构

### 3.1 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                    EvidenceGenerator                            │
│                                                                 │
│  ├── render_contract(title, content) → PDF元素列表             │
│  │   用途：融资租赁合同、抵押合同                               │
│                                                                 │
│  ├── render_table(title, headers, rows) → PDF元素列表          │
│  │   用途：租赁物清单、租金支付计划、抵押物清单                 │
│                                                                 │
│  └── 扩展接口（以后实现）                                       │
│      ├── render_certificate() 证书格式                          │
│      ├── render_voucher() 凭证格式                              │
│      └── render_court_doc() 法院文书格式                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    DataGenerator                                 │
│                                                                 │
│  ├── template_libraries/ 公司名称、设备名称、地址等模板库       │
│  ├── data_fields_schema.json 所有字段类型与生成规则             │
│  └── anonymization_plan.json 反脱敏映射表                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 数据流

```
原始材料（判决书）
    ↓
Stage 0: 理解交易结构
    ├── 提取诉讼请求
    ├── 确定需要的合同类型
    └── 生成合同上下文
    ↓
Stage 1: 生成证据
    ├── 生成合同正文
    ├── 根据合同类型确定需要的附件
    └── 自动生成附件数据（模板+计算）
    ↓
Stage 2: 渲染PDF
    ├── 合同格式渲染器
    ├── 表格格式渲染器
    └── 智能分页控制器
    ↓
输出: 完整证据集.pdf
```

---

## 四、核心功能

### 4.1 合同渲染（render_contract）

**功能**: 渲染合同类证据

**输入**:
```python
{
  "title": "融资租赁合同（售后回租）",
  "contract_no": "FL-202102-001",
  "parties": [
    {"role": "甲方", "name": "东方国际融资租赁有限公司", "credit_code": "...", "representative": "...", "address": "..."},
    {"role": "乙方", "name": "江西昌盛商业管理有限公司", "credit_code": "...", "representative": "...", "address": "..."}
  ],
  "content": "第一条 定义与解释\n1.1 '租赁物'指...\n..."
}
```

**输出**:
- 合同标题（居中18号黑体）
- 合同编号
- 当事人信息
- 正文（分段渲染，12号宋体）
- 签署栏

### 4.2 表格渲染（render_table）

**功能**: 渲染表格类证据（租赁物清单、租金计划、抵押物清单）

**输入**:
```python
{
  "title": "租赁物清单",
  "headers": ["序号", "设备名称", "规格型号", "数量", "存放地点", "评估价值"],
  "rows": [
    ["1", "多联机中央空调系统", "VRV VIII代", "10套", "鸿泰广场", "50000000元"],
    ["2", "电梯设备", "GECS-II", "4台", "鸿泰广场", "30000000元"]
  ]
}
```

**输出**:
- 表格标题（14号黑体）
- 表格（10号宋体，表头灰底，斑马纹）

---

## 五、证据类型与格式映射

### 5.1 当前实现（v2.0）

| 证据类型 | 格式 | 状态 |
|---------|------|------|
| 融资租赁合同 | 合同格式 | ✅ |
| 租赁物清单 | 表格格式 | ✅ |
| 租金支付计划 | 表格格式 | ✅ |

### 5.2 以后扩展（预留接口）

| 证据类型 | 格式 | 状态 |
|---------|------|------|
| 抵押合同 | 合同格式 | 🔲 |
| 抵押物清单 | 表格格式 | 🔲 |
| 不动产权证 | 证书格式 | 🔲 |
| 银行流水 | 凭证格式 | 🔲 |
| 发票 | 凭证格式 | 🔲 |
| 法院文书 | 文书格式 | 🔲 |

---

## 六、数据准备系统

### 6.1 数据缓存策略（按判决书）

**核心原则**: 同一判决书只生成一次数据，后续运行复用

| 场景 | 行为 |
|------|------|
| 同一判决书首次运行 | 生成完整数据并缓存 |
| 同一判决书后续运行 | 读取缓存数据（保持一致） |
| 不同判决书 | 生成新的数据配置 |
| 缓存数据有缺漏 | 补充缺失数据 |

**缓存机制**:
- 以判决书文件路径（或其哈希值）作为缓存键
- 缓存内容包括：边界条件、自动生成的设备清单、银行账号等
- 提供"强制刷新"选项用于重新生成

### 6.1 反脱敏库结构

```json
{
  "公司Profile库": {
    "某某公司5": {
      "公司名称": "东方国际融资租赁有限公司",
      "信用代码": "91310000MA1FL3L123",
      "法定代表人": "周明远",
      "注册地址": "中国（上海）自由贸易试验区世纪大道100号"
    }
  },
  "人物Profile库": {
    "张某": {"姓名": "张伟", "身份证": "360102..."}
  }
}
```

### 6.2 模板库

| 类型 | 模板 |
|------|------|
| 公司名称 | 长江某有限公司、华鑫某集团、昌盛某企业 |
| 设备名称 | 多联机中央空调系统、电梯设备、消防控制系统 |
| 地址 | 江西省南昌市红谷滩区XX路XX号 |

### 6.3 数据生成规则

| 字段 | 生成方式 | 示例 |
|------|---------|------|
| 银行账号 | 随机19位数字 | 1502211009... |
| 证件号码 | 随机18位 | 91360121MA... |
| 金额 | 随机范围 | 50000000元 |
| 日期 | 基准日+偏移 | 2021-02-24 |
| 利率 | 随机4-8% | 6.10% |

---

## 七、Prompt设计原则

### 7.1 生成时提供上下文

不是"生成后替换"，而是"生成时提供完整上下文"：

```markdown
# 任务：生成融资租赁合同

## 当事人信息 - 必须使用以下真实信息
**甲方（出租人）**：
- 公司名称：东方国际融资租赁有限公司
- 统一社会信用代码：91310000MA1FL3L123
- 法定代表人：周明远
- 注册地址：中国（上海）自由贸易试验区世纪大道100号

**乙方（承租人）**：...
```

### 7.2 避免LLM创造新模式

在Prompt中明确要求：
- "必须使用上述真实信息"
- "不要使用'某某公司'等占位符"
- "不要自己编造金额、日期"

---

## 八、PDF格式规范

### 8.1 分页规则

| 元素 | 要求 |
|------|------|
| 每份证据 | 必须另起一页 |
| 封面（可选） | 不计页码或标"I" |
| 目录（可选） | 页码从1开始 |
| 页码位置 | 统一（底部居中） |

### 8.2 字体规范

| 类型 | 字号 | 字体 |
|------|------|------|
| 合同标题 | 18 | SimHei |
| 合同正文 | 12 | SimSun |
| 表格标题 | 14 | SimHei |
| 表格内容 | 10 | SimSun |
| 表头背景 | - | 浅灰 |

### 8.3 表格样式

- 表头背景：浅灰（#D3D3D3）
- 斑马纹：偶数行浅灰
- 边框：黑色0.5pt
- 对齐：居中

---

## 九、当前实现范围

### 9.1 核心功能（v2.0必须实现）

| 组件 | 功能 | 优先级 |
|------|------|--------|
| DataGenerator | 数据自动生成 | P0 |
| DynamicPromptBuilder | 动态Prompt构建 | P0 |
| EvidenceRenderer.render_contract | 合同渲染 | P0 |
| EvidenceRenderer.render_table | 表格渲染 | P0 |
| SmartPaginator | 智能分页 | P0 |

### 9.2 测试范围

| 测试类型 | 内容 |
|---------|------|
| 单元测试 | 数据生成器、Prompt构建器 |
| 集成测试 | 完整流程测试 |
| Regression测试 | 核心功能回归 |

---

## 十、输入输出

### 10.1 输入格式

```json
{
  "case_info": {
    "case_number": "(2024)沪74民初721号"
  },
  "contracts": [
    {
      "type": "融资租赁合同",
      "data": {...}
    }
  ],
  "attachments": [
    {
      "type": "租赁物清单",
      "data": {...}
    }
  ]
}
```

### 10.2 输出结构

```
outputs/
├── 完整测试卷宗.pdf
├── 证据索引.json
└── 证据文件/
    ├── E001_融资租赁合同.txt
    ├── E002_租赁物清单.txt
    └── E003_租金支付计划.txt
```

---

## 十一、配置文档

### 11.1 配置文件结构

```
config/
├── evidence_format_schema.json   # 证据格式定义
├── data_fields_schema.json       # 字段类型定义
└── template_libraries/           # 模板库
    ├── company_names.json
    ├── equipment_names.json
    └── locations.json
```

### 11.2 案件类型配置

```json
// config/case_types/financing_lease.json
{
  "case_type": "融资租赁纠纷",
  "required_contracts": [
    {"type": "融资租赁合同", "attachments": ["租赁物清单", "租金支付计划"]}
  ]
}
```

---

## 十二、附录

### 12.1 相关文档

| 文档 | 说明 |
|------|------|
| [TEST_PLAN.md](TEST_PLAN.md) | 测试方案 |
| [开发规范.md](开发规范.md) | 通用开发规范 |
| [开发交接清单.md](../开发交接清单.md) | 开发交接checklist（含详细技术需求） |
| [问题记录.md](问题记录.md) | 问题记录（Bug修复日志） |
| [需求变更记录.md](需求变更记录.md) | 需求变更记录 |
| [CHANGELOG.md](CHANGELOG.md) | 变更日志 |
| [详细设计_TD-2026-01-27-001.md](详细设计_TD-2026-01-27-001.md) | 详细设计文档 |
| [详细设计评审_TD-2026-01-27-001.md](详细设计评审_TD-2026-01-27-001.md) | 设计评审记录 |
| [v1历史文档](v1_history/) | 之前版本 |

### 12.2 验证命令

```bash
# 完整运行
python3 run_complete.py --all --judgment <path_to_judgment>

# 分阶段运行
python3 run_complete.py --stage0 --judgment <path>
python3 run_complete.py --stage1 --judgment <path>
python3 run_complete.py --stage2 --judgment <path>
python3 run_complete.py --stage3 --judgment <path>

# 验证输出质量
python3 validate_outputs.py outputs/

# 检查数据生成
python3 -c "from src.utils.data_generator import DataGenerator; ..."
```

---

**文档版本**: v2.1  
**状态**: 有效  
**创建日期**: 2024-01-27  
**最后更新**: 2026-01-28
