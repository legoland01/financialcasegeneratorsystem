# 金融案件证据集生成系统 - 产品需求文档

**文档版本**: v2.2  
**状态**: 有效  
**创建日期**: 2024-01-27  
**最后更新**: 2026-01-31

---

## 一、文档演进历史

| 版本 | 日期 | 主要变更 |
|------|------|---------|
| [v1.0](v1_history/PRODUCT_REQUIREMENTS_v1.0.md) | 2024-01-26 | 初始版本，特定案件设计 |
| v2.0 | 2024-01-27 | 通用框架设计，完全自动化 |
| **v2.1** | **2026-01-28** | **更新验证命令、修正日期错误、添加AI开发模式说明** |
| **v2.2** | **2026-01-31** | **添加占位符后处理、证据质量保障、ID生成规范** |

> 详细变更记录请查看 [CHANGELOG.md](CHANGELOG.md)

---

## 二、系统概述

### 2.1 设计目标

自动生成符合中国法院要求的**通用金融案件**证据集PDF文档。

### 2.2 核心设计理念

```
判决书 → 诉求 → 合同 → 附件 → 证据集
              ↓
        完全自动生成
```

### 2.3 设计原则

| 原则 | 说明 |
|------|------|
| 通用化 | 支持各类金融案件（融资租赁、借贷、担保等） |
| 配置驱动 | 案件类型、证据模板、字段映射均可配置 |
| 自动化 | 所有数据自动生成，无需人工准备 |
| 可扩展 | 新证据类型只需添加配置，不改核心代码 |

---

## 三、系统架构

### 3.1 架构图（v2.2 更新）

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                    EvidenceGenerator                            │
│                                                                 │
│  ├── render_contract(title, content) → PDF元素列表             │
│  │   用途：融资租赁合同、抵押合同                               │
│                                                                 │
│  ├── render_table(title, headers, rows) → PDF元素列表          │
│  │   用途：租赁物清单、租金支付计划、抵押物清单                 │
│                                                                 │
│  ├── post_process_evidence() → 占位符清理与替换                │
│  │   用途：清理LLM生成的占位符、确保数据完整性                 │
│                                                                 │
│  └── validate_evidence_quality() → 质量验证                    │
│      用途：验证证据内容完整性、脱敏标记、ID唯一性              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                    DataGenerator                                 │
│                                                                 │
│  ├── template_libraries/ 公司名称、设备名称、地址等模板库       │
│  ├── data_fields_schema.json 所有字段类型与生成规则             │
│  ├── anonymization_plan.json 反脱敏映射表                       │
│  └── placeholder_rules.json 占位符识别与替换规则                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 数据流（v2.2 更新）

```
原始材料（判决书）
    ↓
Stage 0: 理解交易结构
    ├── 提取诉讼请求
    ├── 确定需要的合同类型
    └── 生成合同上下文
    ↓
Stage 1: 生成证据
    ├── 生成合同正文
    ├── 根据合同类型确定需要的附件
    └── 自动生成附件数据（模板+计算）
    ↓
Stage 1.5: 占位符后处理 [新增]
    ├── 识别占位符模式（X、某某、空白字段等）
    ├── 从key_numbers.json自动填充数值
    ├── 从反脱敏库填充名称和代码
    └── 验证所有必需字段已填充
    ↓
Stage 2: 渲染PDF
    ├── 合同格式渲染器
    ├── 表格格式渲染器
    └── 智能分页控制器
    ↓
Stage 2.5: 质量验证 [新增]
    ├── 验证脱敏标记已清除
    ├── 验证证据ID唯一性
    ├── 验证文件内容完整性
    └── 输出验证报告
    ↓
输出: 完整证据集.pdf
```

---

## 四、核心功能（v2.2 新增）

### 4.3 占位符后处理（post_process_evidence）

**功能**: 清理LLM生成的占位符，确保证据内容完整可用

**占位符识别模式**:
| 模式 | 示例 | 处理方式 |
|------|------|---------|
| 单X字符 | `X年月日`、`人民币X元` | 从key_numbers.json或计算生成 |
| 多X字符 | `XXX`、`XXXX` | 根据字段类型生成随机值 |
| 某某模式 | `某某公司`、`张某某` | 从反脱敏库映射真实名称 |
| 空白字段 | `统一社会信用代码：`后无内容 | 从公司Profile库填充 |
| 占位符标签 | `【五】`、`<=N>` | 根据业务逻辑计算或查表 |

**处理流程**:
```python
def post_process_evidence(evidence_text: str, stage0_data: dict) -> str:
    # 1. 加载全局数据
    key_numbers = load_key_numbers(stage0_data)
    anonymization_map = load_anonymization_map()
    company_profiles = load_company_profiles()
    
    # 2. 识别占位符
    placeholders = identify_placeholders(evidence_text)
    
    # 3. 批量替换
    for placeholder in placeholders:
        replacement = find_replacement(
            placeholder, 
            key_numbers, 
            anonymization_map,
            company_profiles
        )
        evidence_text = evidence_text.replace(placeholder, replacement)
    
    # 4. 验证完整性
    if not validate_completeness(evidence_text):
        raise ValueError(f"证据完整性验证失败: {evidence_text[:100]}...")
    
    return evidence_text
```

### 4.4 证据质量验证（validate_evidence_quality）

**验证项目**:
| 验证项 | 检查内容 | 失败处理 |
|--------|---------|---------|
| 脱敏标记检查 | 不含 `某某`、`某公司`、`<=N>` 等 | ❌ 失败，阻止生成PDF |
| 完整性检查 | 所有必需字段有值 | ❌ 失败，阻止生成PDF |
| ID唯一性检查 | evidence_index中ID不重复 | ⚠️ 警告，记录但不阻止 |
| 金额一致性检查 | 合同金额与租赁物清单合计一致 | ❌ 失败，阻止生成PDF |
| 日期逻辑检查 | 日期格式正确、时序合理 | ⚠️ 警告，记录但不阻止 |

---

## 五、证据类型与格式映射

### 5.1 当前实现（v2.2 更新）

| 证据类型 | 格式 | 状态 | 后处理要求 |
|---------|------|------|-----------|
| 融资租赁合同 | 合同格式 | ✅ | 必须填充所有当事人信息 |
| 租赁物清单 | 表格格式 | ✅ | 必须填充所有设备信息 |
| 租金支付计划 | 表格格式 | ✅ | 必须填充所有期数信息 |
| 抵押合同 | 合同格式 | ✅ | 必须填充抵押物信息 |
| 抵押物清单 | 表格格式 | ✅ | 必须填充抵押财产信息 |
| 保证合同 | 合同格式 | ✅ | 必须填充保证人信息 |
| 执行证书 | 文书格式 | ✅ | 必须填充执行标的金额 |
| 银行凭证 | 凭证格式 | ✅ | 必须填充金额和日期 |
| 发票 | 凭证格式 | ✅ | 必须填充金额和税号 |

### 5.2 占位符规则配置

```json
// config/placeholder_rules.json
{
  "date_patterns": [
    {"pattern": "X年月日", "format": "从key_numbers['合同签订日期']推导"},
    {"pattern": "YYYY年MM月DD日", "format": "直接使用key_numbers日期"}
  ],
  "amount_patterns": [
    {"pattern": "人民币X元", "source": "key_numbers['合同金额']"},
    {"pattern": "人民币壹亿伍仟万元整", "format": "数字转大写"}
  ],
  "name_patterns": [
    {"pattern": "某某公司5", "source": "anonymization_map['某某公司5']"},
    {"pattern": "某某公司1", "source": "anonymization_map['某某公司1']"}
  ],
  "code_patterns": [
    {"pattern": "统一社会信用代码：", "source": "company_profile['credit_code']"},
    {"pattern": "合同编号：", "source": "key_numbers['合同编号']"}
  ]
}
```

---

## 六、数据准备系统

### 6.1 数据缓存策略（按判决书）

**核心原则**: 同一判决书只生成一次数据，后续运行复用

| 场景 | 行为 |
|------|------|
| 同一判决书首次运行 | 生成完整数据并缓存 |
| 同一判决书后续运行 | 读取缓存数据（保持一致） |
| 不同判决书 | 生成新的数据配置 |
| 缓存数据有缺漏 | 补充缺失数据 |

**缓存机制**:
- 以判决书文件路径（或其哈希值）作为缓存键
- 缓存内容包括：边界条件、自动生成的设备清单、银行账号等
- 提供"强制刷新"选项用于重新生成

### 6.2 反脱敏库结构（v2.2 增强）

```json
{
  "公司Profile库": {
    "某某公司5": {
      "公司名称": "东方国际融资租赁有限公司",
      "信用代码": "91310000MA1FL3L123",
      "法定代表人": "周明远",
      "注册地址": "中国（上海）自由贸易试验区世纪大道100号",
      "开户银行": "中国工商银行上海市浦东分行",
      "银行账号": "1001234567890123456"
    },
    "某某公司1": {
      "公司名称": "江西昌盛商业管理有限公司",
      "信用代码": "91360121MA1XXXXXXX",
      "法定代表人": "李明",
      "注册地址": "江西省南昌市红谷滩区XX路XX号"
    },
    "某某公司2": {
      "公司名称": "江西恒信房地产开发有限公司",
      "信用代码": "91360100MA1XXXXXXX",
      "法定代表人": "张伟"
    }
  },
  "人物Profile库": {
    "张某": {"姓名": "张伟", "身份证": "36010219800101XXXX"},
    "李某某": {"姓名": "李明", "身份证": "36010219750101XXXX"}
  }
}
```

### 6.3 关键数据源（key_numbers.json）

**v2.2 必须包含的字段**:

```json
{
  "合同基础金额": {
    "原合同金额": {"数值": 150000000, "单位": "元", "大写": "壹亿伍仟万元整"},
    "租金总额": {"数值": 160623496.08, "单位": "元"}
  },
  "租赁物清单": [
    {"序号": 1, "名称": "多联机中央空调系统", "评估价值": 50000000},
    {"序号": 2, "名称": "电梯设备", "评估价值": 30000000}
  ],
  "抵押物清单": [
    {"序号": 1, "名称": "商业房产", "评估价值": 100000000}
  ],
  "租金支付计划": [
    {"期数": 1, "应付日期": "2021-05-26", "租金金额": 6692645.67},
    {"期数": 2, "应付日期": "2021-08-26", "租金金额": 6692645.67}
  ],
  "合同签订日期": "2021-02-24",
  "租赁开始日期": "2021-02-26",
  "租赁结束日期": "2024-02-24",
  "年利率": {"数值": 6.10, "单位": "%"}
}
```

---

## 七、Prompt设计原则

### 7.1 生成时提供上下文

不是"生成后替换"，而是"生成时提供完整上下文"：

```markdown
# 任务：生成融资租赁合同

## 当事人信息 - 必须使用以下真实信息，**禁止使用占位符**
**甲方（出租人）**：
- 公司名称：东方国际融资租赁有限公司
- 统一社会信用代码：91310000MA1FL3L123
- 法定代表人：周明远
- 注册地址：中国（上海）自由贸易试验区世纪大道100号

**乙方（承租人）**：江西昌盛商业管理有限公司
- 统一社会信用代码：91360121MA1XXXXXXX
- 法定代表人：李明
- 注册地址：江西省南昌市红谷滩区XX路XX号

## 合同关键信息 - 必须填入实际数值
- 租赁物转让价款：人民币壹亿伍仟万元整（¥150,000,000.00）
- 租赁期限：自2021年2月26日起至2024年2月24日止（共36个月）
- 租金总额：人民币160,623,496.08元
- 年利率：6.10%
```

### 7.2 避免LLM创造新模式（v2.2 强调）

在Prompt中**必须**明确要求：
- "必须使用上述真实信息，禁止使用'某某公司'、'X'等占位符"
- "不要自己编造金额、日期、编号"
- "所有金额必须使用具体数值，不得使用'若干'、'若干元'等模糊表达"
- "日期格式统一为'YYYY年MM月DD日'"

### 7.3 Prompt质量检查点

```markdown
## Prompt自检清单
- [ ] 是否提供了所有当事人的完整信息？
- [ ] 是否提供了所有金额的具体数值？
- [ ] 是否提供了所有日期的具体时间？
- [ ] 是否明确禁止使用占位符？
- [ ] 是否提供了反脱敏映射示例？
- [ ] 是否明确了合同编号规则？
```

---

## 七、Prompt构建策略（v2.2 新增）

### 7.1 问题背景

黑盒测试发现：仅靠Prompt指令禁止占位符无效，LLM仍持续生成`某某公司`、`X4`等占位符。

**根因分析**：
- LLM难以从JSON格式的Profile库中正确提取并使用具体名称
- 需要在Prompt构建阶段就**直接列出**所有必须使用的具体信息

### 7.2 策略原则

**核心原则**：不是"生成后替换"，而是"生成时提供完整上下文"

```
原始数据 → 对象提取 → Prompt构建 → LLM生成
                    ↓
          直接列出具体名称和金额
```

### 7.3 Prompt构建流程

```
Step 1: 分析目标内容类型（合同/文书/凭证）
        ↓
Step 2: 从证据信息中提取涉及的对象（公司、人、时间、金额）
        ↓
Step 3: 从Profile库中查找每个对象的完整信息
        ↓
Step 4: 直接列出具体信息（禁止LLM自行查找）
        ↓
Step 5: 明确禁止占位符
        ↓
Step 6: 生成证据
```

### 7.4 对象提取规则

#### 7.4.1 公司对象提取

```python
def extract_involved_companies(evidence: Dict, profiles: Dict) -> List[Dict]:
    """
    从证据信息中提取涉及的公司列表
    
    Args:
        evidence: 证据信息（含"涉及方"字段）
        profiles: Profile库（含"公司Profile库"）
    
    Returns:
        涉及的公司完整信息列表
    """
    involved_markers = evidence.get("关键数据提示", {}).get("涉及方", [])
    company_profiles = profiles.get("公司Profile库", {})
    
    result = []
    for marker in involved_markers:
        # 从脱敏标识查找真实公司信息
        for key, company in company_profiles.items():
            if company.get("原脱敏标识") == marker:
                result.append({
                    "角色": marker,  # 如"出租人"、"承租人"
                    "公司名称": company["公司名称"],
                    "信用代码": company.get("信用代码", ""),
                    "法定代表人": company.get("法定代表人", ""),
                    "地址": company.get("注册地址", ""),
                })
                break
    return result
```

#### 7.4.2 金额对象提取

```python
def extract_amount_info(evidence: Dict, key_numbers: Dict) -> Dict:
    """
    从证据和关键金额清单中提取涉及金额
    
    Returns:
        金额信息字典，包含数值和大写金额
    """
    amount_info = evidence.get("关键数据提示", {}).get("涉及金额", {})
    if amount_info:
        return amount_info
    
    # 如果证据未指定，从key_numbers中查找
    return {
        "数值": key_numbers.get("合同基础金额", {}).get("原合同金额", {}).get("数值", 0),
        "单位": "元",
        "大写": "人民币壹亿伍仟万元整"
    }
```

### 7.5 Prompt模板结构

#### 7.5.1 必需部分

```markdown
# 任务：生成[证据类型]

## 🚨 强制要求
生成内容时必须使用以下具体信息，禁止使用任何占位符。

## 【必须使用的具体信息】

### 公司信息
- 甲方（出租人）：[公司名称]
  统一社会信用代码：[代码]
  法定代表人：[姓名]
  地址：[地址]

- 乙方（承租人）：[公司名称]
  ...

### 金额信息
涉及金额：人民币[大写金额]（¥[数值]）

### 日期信息
合同签订日期：[YYYY年MM月DD日]

## 证据信息
...

## 关键金额
...

## 交易时间线
...

请严格按照上述具体信息生成，禁止使用"某某"、"某公司"、"X"、"人民币X元"等占位符。
```

### 7.6 Prompt构建器接口设计

| 方法 | 输入 | 输出 | 说明 |
|------|------|------|------|
| `build_evidence_prompt()` | evidence, evidence_type | str | 构建证据生成的Prompt |
| `_extract_involved_companies()` | evidence, profiles | List[Dict] | 提取涉及的公司 |
| `_extract_amount_info()` | evidence, key_numbers | Dict | 提取金额信息 |
| `_build_party_info_section()` | companies | str | 构建当事人信息部分 |
| `_assemble_prompt()` | base_prompt, party_info, amount, evidence | str | 组装完整Prompt |

### 7.7 验收标准（Prompt构建策略）

| 验收项 | 标准 |
|--------|------|
| Prompt包含具体公司名称 | 100%覆盖 |
| Prompt包含具体金额 | 100%覆盖 |
| Prompt包含具体日期 | 100%覆盖 |
| 无占位符残留 | ≥95%通过 |

---

## 八、PDF格式规范

### 8.1 分页规则

| 元素 | 要求 |
|------|------|
| 每份证据 | 必须另起一页 |
| 封面（可选） | 不计页码或标"I" |
| 目录（可选） | 页码从1开始 |
| 页码位置 | 统一（底部居中） |

### 8.2 字体规范

| 类型 | 字号 | 字体 |
|------|------|------|
| 合同标题 | 18 | SimHei |
| 合同正文 | 12 | SimSun |
| 表格标题 | 14 | SimHei |
| 表格内容 | 10 | SimSun |
| 表头背景 | - | 浅灰 |

### 8.3 表格样式

- 表头背景：浅灰（#D3D3D3）
- 斑马纹：偶数行浅灰
- 边框：黑色0.5pt
- 对齐：居中

---

## 九、质量保障体系（v2.2 新增）

### 9.1 证据质量等级

| 等级 | 定义 | 要求 |
|------|------|------|
| P0-可用 | 内容完整，无占位符 | 可用于生产环境 |
| P1-基本可用 | 内容基本完整，有少量非关键占位符 | 需人工检查 |
| P2-不可用 | 有关键占位符或数据不一致 | 禁止生成PDF |

### 9.2 质量验证命令

```bash
# 完整运行（含质量验证）
python3 run_complete.py

# 仅验证模式
python3 run_complete.py --verify

# 强制重新生成
python3 run_complete.py --force-regenerate

# 生成后检查占位符
python3 -c "from src.utils.placeholder_checker import check_placeholders; ..."

# 检查证据ID唯一性
python3 -c "from src.utils.id_validator import validate_evidence_ids; ..."
```

### 9.3 质量报告模板

```json
{
  "report_time": "2026-01-31 20:49:42",
  "evidence_count": 33,
  "quality_summary": {
    "passed": 3,
    "failed": 30,
    "pass_rate": "9%"
  },
  "issues": [
    {
      "type": "placeholder_detected",
      "file": "证据组4_E005_执行证书.txt",
      "pattern": "X年月日",
      "count": 5
    },
    {
      "type": "duplicate_id",
      "id": "E003",
      "files": ["证据组2_E003", "证据组3_E003"]
    }
  ],
  "recommendation": "当前系统不可用于生产环境，需修复占位符问题"
}
```

---

## 十、当前实现范围

### 10.1 核心功能（v2.2 更新）

| 组件 | 功能 | 优先级 | 状态 |
|------|------|--------|------|
| DataGenerator | 数据自动生成 | P0 | ✅ |
| DynamicPromptBuilder | 动态Prompt构建 | P0 | ✅ |
| EvidenceRenderer.render_contract | 合同渲染 | P0 | ✅ |
| EvidenceRenderer.render_table | 表格渲染 | P0 | ✅ |
| SmartPaginator | 智能分页 | P0 | ✅ |
| PostProcessor | 占位符后处理 | P0 | 🔲 待实现 |
| QualityValidator | 质量验证 | P0 | 🔲 待实现 |
| EvidenceIDGenerator | ID生成器 | P1 | 🔲 待实现 |

### 10.2 待实现功能（v2.2）

#### P0 - 占位符后处理系统
- 占位符模式识别引擎
- 自动替换规则引擎
- 完整性验证器
- 预期工时: 3天

#### P0 - 质量验证系统
- 脱敏标记检查
- ID唯一性检查
- 金额一致性检查
- 预期工时: 2天

#### P1 - ID生成器
- 基于证据类型生成唯一ID
- 避免重复ID
- 支持手动指定ID范围
- 预期工时: 1天

### 10.3 测试范围

| 测试类型 | 内容 |
|---------|------|
| 单元测试 | 数据生成器、Prompt构建器、后处理器 |
| 集成测试 | 完整流程测试 |
| Regression测试 | 核心功能回归 |
| 质量测试 | 占位符检测、ID唯一性、完整性 |

---

## 十一、输入输出

### 11.1 输入格式

```json
{
  "case_info": {
    "case_number": "(2024)沪74民初721号"
  },
  "contracts": [
    {
      "type": "融资租赁合同",
      "data": {...}
    }
  ],
  "attachments": [
    {
      "type": "租赁物清单",
      "data": {...}
    }
  ]
}
```

### 11.2 输出结构

```
outputs/
├── 完整测试卷宗.pdf
├── 证据索引.json
└── 证据文件/
    ├── E001_融资租赁合同.txt
    ├── E002_租赁物清单.txt
    └── E003_租金支付计划.txt
```

### 11.3 质量验证输出

```
outputs_complete/
├── 完整测试卷宗.pdf
├── 原告起诉包/
│   ├── 民事起诉状.txt
│   ├── evidence_index.json
│   └── key_numbers.json
├── 法院审理包/
└── quality_report.json          [新增] 质量验证报告
```

---

## 十二、配置文档

### 12.1 配置文件结构

```
config/
├── evidence_format_schema.json   # 证据格式定义
├── data_fields_schema.json       # 字段类型定义
├── placeholder_rules.json        # 占位符规则定义 [新增]
└── template_libraries/           # 模板库
    ├── company_names.json
    ├── equipment_names.json
    └── locations.json
```

### 12.2 案件类型配置

```json
// config/case_types/financing_lease.json
{
  "case_type": "融资租赁纠纷",
  "required_contracts": [
    {"type": "融资租赁合同", "attachments": ["租赁物清单", "租金支付计划"]},
    {"type": "抵押合同", "attachments": ["抵押物清单"]},
    {"type": "保证合同", "attachments": []}
  ],
  "required_vouchers": [
    "银行付款凭证",
    "保证金支付凭证",
    "咨询服务费支付凭证"
  ],
  "placeholder_mappings": {
    "某某公司5": "东方国际融资租赁有限公司",
    "某某公司1": "江西昌盛商业管理有限公司"
  }
}
```

---

## 十三、问题修复记录（v2.2 新增）

### 13.1 黑盒测试发现问题（2026-01-31 22:11 Agent1产品经理测试）

| 问题ID | 问题描述 | 严重程度 | 解决方案 | 状态 |
|--------|---------|---------|---------|------|
| BUG-001 | KeyError: '证据归属规划表' - stage1_service.py:120 | **严重** | 修复数据解析健壮性 | 已修复 |
| BUG-002 | 0.5子任务输出格式异常，JSON被包装在raw_response中 | **中等** | 修复JSON解析器 | 已修复 |
| QB-001 | 执行证书存在大量占位符（X年月日、人民币X元） | 严重 | 后处理器自动填充 | 待实现 |
| QB-002 | 融资租赁合同缺少当事人信息 | 严重 | 完善Prompt上下文 | 待实现 |
| QB-003 | 租金支付记录金额格式错误 | 中等 | 后处理器格式化 | 待实现 |
| QB-004 | 证据ID重复（多个E003、E004） | 中等 | 重新设计ID生成器 | 待实现 |
| QB-005 | PDF存在脱敏标记 | 严重 | 后处理+二次验证 | 待实现 |
| BUG-003 | PDF渲染字体缺失问题 | 中等 | 修复字体配置 | 已修复 |
| BUG-004 | 证据编号重复生成 | 中等 | 重构ID生成器 | 已修复 |

### 13.2 修复计划

| 优先级 | 任务 | 负责人 | 预计完成 |
|--------|------|--------|---------|
| P0 | 实现占位符后处理器 | 待分配 | 2026-02-05 |
| P0 | 完善Prompt模板（强制填充信息） | 待分配 | 2026-02-03 |
| P0 | 实现质量验证系统 | 待分配 | 2026-02-07 |
| P1 | 重构证据ID生成器 | 待分配 | 2026-02-10 |
| P1 | 添加二次脱敏检查 | 待分配 | 2026-02-12 |

---

## 十四、附录

### 14.1 相关文档

| 文档 | 说明 |
|------|------|
| [TEST_PLAN.md](TEST_PLAN.md) | 测试方案 |
| [开发规范.md](开发规范.md) | 通用开发规范 |
| [开发交接清单.md](../开发交接清单.md) | 开发交接checklist（含详细技术需求） |
| [问题记录.md](问题记录.md) | 问题记录（Bug修复日志） |
| [需求变更记录.md](需求变更记录.md) | 需求变更记录 |
| [CHANGELOG.md](CHANGELOG.md) | 变更日志 |
| [详细设计_TD-2026-01-27-001.md](详细设计_TD-2026-01-27-001.md) | 详细设计文档 |
| [详细设计评审_TD-2026-01-27-001.md](详细设计评审_TD-2026-01-27-001.md) | 设计评审记录 |
| [v1历史文档](v1_history/) | 之前版本 |

### 14.2 验证命令

```bash
# 完整运行
python3 run_complete.py

# 分阶段运行
python3 run_complete.py --stage0 --judgment <path>
python3 run_complete.py --stage1 --judgment <path>
python3 run_complete.py --stage2 --judgment <path>
python3 run_complete.py --stage3 --judgment <path>

# 验证输出质量
python3 run_complete.py --verify

# 检查数据生成
python3 -c "from src.utils.data_generator import DataGenerator; ..."

# 占位符检查（待实现）
python3 -c "from src.utils.placeholder_checker import check_placeholders; ..."
```

---

**文档版本**: v2.2  
**状态**: 有效  
**创建日期**: 2024-01-27  
**最后更新**: 2026-01-31

---

## 一、文档演进历史

| 版本 | 日期 | 主要变更 |
|------|------|---------|
| [v1.0](v1_history/PRODUCT_REQUIREMENTS_v1.0.md) | 2024-01-26 | 初始版本，特定案件设计 |
| v2.0 | 2024-01-27 | 通用框架设计，完全自动化 |
| **v2.1** | **2026-01-28** | **更新验证命令、修正日期错误、添加AI开发模式说明** |

> 详细变更记录请查看 [CHANGELOG.md](CHANGELOG.md)

---

## 二、系统概述

### 2.1 设计目标

自动生成符合中国法院要求的**通用金融案件**证据集PDF文档。

### 2.2 核心设计理念

```
判决书 → 诉求 → 合同 → 附件 → 证据集
              ↓
        完全自动生成
```

### 2.3 设计原则

| 原则 | 说明 |
|------|------|
| 通用化 | 支持各类金融案件（融资租赁、借贷、担保等） |
| 配置驱动 | 案件类型、证据模板、字段映射均可配置 |
| 自动化 | 所有数据自动生成，无需人工准备 |
| 可扩展 | 新证据类型只需添加配置，不改核心代码 |

---

## 三、系统架构

### 3.1 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                    EvidenceGenerator                            │
│                                                                 │
│  ├── render_contract(title, content) → PDF元素列表             │
│  │   用途：融资租赁合同、抵押合同                               │
│                                                                 │
│  ├── render_table(title, headers, rows) → PDF元素列表          │
│  │   用途：租赁物清单、租金支付计划、抵押物清单                 │
│                                                                 │
│  └── 扩展接口（以后实现）                                       │
│      ├── render_certificate() 证书格式                          │
│      ├── render_voucher() 凭证格式                              │
│      └── render_court_doc() 法院文书格式                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    DataGenerator                                 │
│                                                                 │
│  ├── template_libraries/ 公司名称、设备名称、地址等模板库       │
│  ├── data_fields_schema.json 所有字段类型与生成规则             │
│  └── anonymization_plan.json 反脱敏映射表                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 数据流

```
原始材料（判决书）
    ↓
Stage 0: 理解交易结构
    ├── 提取诉讼请求
    ├── 确定需要的合同类型
    └── 生成合同上下文
    ↓
Stage 1: 生成证据
    ├── 生成合同正文
    ├── 根据合同类型确定需要的附件
    └── 自动生成附件数据（模板+计算）
    ↓
Stage 2: 渲染PDF
    ├── 合同格式渲染器
    ├── 表格格式渲染器
    └── 智能分页控制器
    ↓
输出: 完整证据集.pdf
```

---

## 四、核心功能

### 4.1 合同渲染（render_contract）

**功能**: 渲染合同类证据

**输入**:
```python
{
  "title": "融资租赁合同（售后回租）",
  "contract_no": "FL-202102-001",
  "parties": [
    {"role": "甲方", "name": "东方国际融资租赁有限公司", "credit_code": "...", "representative": "...", "address": "..."},
    {"role": "乙方", "name": "江西昌盛商业管理有限公司", "credit_code": "...", "representative": "...", "address": "..."}
  ],
  "content": "第一条 定义与解释\n1.1 '租赁物'指...\n..."
}
```

**输出**:
- 合同标题（居中18号黑体）
- 合同编号
- 当事人信息
- 正文（分段渲染，12号宋体）
- 签署栏

### 4.2 表格渲染（render_table）

**功能**: 渲染表格类证据（租赁物清单、租金计划、抵押物清单）

**输入**:
```python
{
  "title": "租赁物清单",
  "headers": ["序号", "设备名称", "规格型号", "数量", "存放地点", "评估价值"],
  "rows": [
    ["1", "多联机中央空调系统", "VRV VIII代", "10套", "鸿泰广场", "50000000元"],
    ["2", "电梯设备", "GECS-II", "4台", "鸿泰广场", "30000000元"]
  ]
}
```

**输出**:
- 表格标题（14号黑体）
- 表格（10号宋体，表头灰底，斑马纹）

---

## 五、证据类型与格式映射

### 5.1 当前实现（v2.0）

| 证据类型 | 格式 | 状态 |
|---------|------|------|
| 融资租赁合同 | 合同格式 | ✅ |
| 租赁物清单 | 表格格式 | ✅ |
| 租金支付计划 | 表格格式 | ✅ |

### 5.2 以后扩展（预留接口）

| 证据类型 | 格式 | 状态 |
|---------|------|------|
| 抵押合同 | 合同格式 | 🔲 |
| 抵押物清单 | 表格格式 | 🔲 |
| 不动产权证 | 证书格式 | 🔲 |
| 银行流水 | 凭证格式 | 🔲 |
| 发票 | 凭证格式 | 🔲 |
| 法院文书 | 文书格式 | 🔲 |

---

## 六、数据准备系统

### 6.1 数据缓存策略（按判决书）

**核心原则**: 同一判决书只生成一次数据，后续运行复用

| 场景 | 行为 |
|------|------|
| 同一判决书首次运行 | 生成完整数据并缓存 |
| 同一判决书后续运行 | 读取缓存数据（保持一致） |
| 不同判决书 | 生成新的数据配置 |
| 缓存数据有缺漏 | 补充缺失数据 |

**缓存机制**:
- 以判决书文件路径（或其哈希值）作为缓存键
- 缓存内容包括：边界条件、自动生成的设备清单、银行账号等
- 提供"强制刷新"选项用于重新生成

### 6.1 反脱敏库结构

```json
{
  "公司Profile库": {
    "某某公司5": {
      "公司名称": "东方国际融资租赁有限公司",
      "信用代码": "91310000MA1FL3L123",
      "法定代表人": "周明远",
      "注册地址": "中国（上海）自由贸易试验区世纪大道100号"
    }
  },
  "人物Profile库": {
    "张某": {"姓名": "张伟", "身份证": "360102..."}
  }
}
```

### 6.2 模板库

| 类型 | 模板 |
|------|------|
| 公司名称 | 长江某有限公司、华鑫某集团、昌盛某企业 |
| 设备名称 | 多联机中央空调系统、电梯设备、消防控制系统 |
| 地址 | 江西省南昌市红谷滩区XX路XX号 |

### 6.3 数据生成规则

| 字段 | 生成方式 | 示例 |
|------|---------|------|
| 银行账号 | 随机19位数字 | 1502211009... |
| 证件号码 | 随机18位 | 91360121MA... |
| 金额 | 随机范围 | 50000000元 |
| 日期 | 基准日+偏移 | 2021-02-24 |
| 利率 | 随机4-8% | 6.10% |

---

## 七、Prompt设计原则

### 7.1 生成时提供上下文

不是"生成后替换"，而是"生成时提供完整上下文"：

```markdown
# 任务：生成融资租赁合同

## 当事人信息 - 必须使用以下真实信息
**甲方（出租人）**：
- 公司名称：东方国际融资租赁有限公司
- 统一社会信用代码：91310000MA1FL3L123
- 法定代表人：周明远
- 注册地址：中国（上海）自由贸易试验区世纪大道100号

**乙方（承租人）**：...
```

### 7.2 避免LLM创造新模式

在Prompt中明确要求：
- "必须使用上述真实信息"
- "不要使用'某某公司'等占位符"
- "不要自己编造金额、日期"

---

## 八、PDF格式规范

### 8.1 分页规则

| 元素 | 要求 |
|------|------|
| 每份证据 | 必须另起一页 |
| 封面（可选） | 不计页码或标"I" |
| 目录（可选） | 页码从1开始 |
| 页码位置 | 统一（底部居中） |

### 8.2 字体规范

| 类型 | 字号 | 字体 |
|------|------|------|
| 合同标题 | 18 | SimHei |
| 合同正文 | 12 | SimSun |
| 表格标题 | 14 | SimHei |
| 表格内容 | 10 | SimSun |
| 表头背景 | - | 浅灰 |

### 8.3 表格样式

- 表头背景：浅灰（#D3D3D3）
- 斑马纹：偶数行浅灰
- 边框：黑色0.5pt
- 对齐：居中

---

## 九、当前实现范围

### 9.1 核心功能（v2.0必须实现）

| 组件 | 功能 | 优先级 |
|------|------|--------|
| DataGenerator | 数据自动生成 | P0 |
| DynamicPromptBuilder | 动态Prompt构建 | P0 |
| EvidenceRenderer.render_contract | 合同渲染 | P0 |
| EvidenceRenderer.render_table | 表格渲染 | P0 |
| SmartPaginator | 智能分页 | P0 |

### 9.2 测试范围

| 测试类型 | 内容 |
|---------|------|
| 单元测试 | 数据生成器、Prompt构建器 |
| 集成测试 | 完整流程测试 |
| Regression测试 | 核心功能回归 |

---

## 十、输入输出

### 10.1 输入格式

```json
{
  "case_info": {
    "case_number": "(2024)沪74民初721号"
  },
  "contracts": [
    {
      "type": "融资租赁合同",
      "data": {...}
    }
  ],
  "attachments": [
    {
      "type": "租赁物清单",
      "data": {...}
    }
  ]
}
```

### 10.2 输出结构

```
outputs/
├── 完整测试卷宗.pdf
├── 证据索引.json
└── 证据文件/
    ├── E001_融资租赁合同.txt
    ├── E002_租赁物清单.txt
    └── E003_租金支付计划.txt
```

---

## 十一、配置文档

### 11.1 配置文件结构

```
config/
├── evidence_format_schema.json   # 证据格式定义
├── data_fields_schema.json       # 字段类型定义
└── template_libraries/           # 模板库
    ├── company_names.json
    ├── equipment_names.json
    └── locations.json
```

### 11.2 案件类型配置

```json
// config/case_types/financing_lease.json
{
  "case_type": "融资租赁纠纷",
  "required_contracts": [
    {"type": "融资租赁合同", "attachments": ["租赁物清单", "租金支付计划"]}
  ]
}
```

---

## 十三、多模态质量检测（v2.3 新增）

### 13.1 背景与目标

**问题描述**：PDF生成存在布局质量问题，需要多模态模型检测：

| 问题类型 | 示例 | 当前检测方法 |
|---------|------|-------------|
| 文本问题 | 某某设备、若干台 | pdftotext + 正则 ✅ |
| **布局问题** | 留白、回车、表格、编号断裂 | **需要多模态** ❌ |

**用户反馈的布局问题**：
1. 条款后有过长留白
2. 回车没有正确放置
3. 括号后错误添加回车
4. 条款编号断裂（第4条后直接跟1.1）

### 13.2 功能需求

| 需求编号 | 功能描述 | 优先级 |
|---------|---------|--------|
| MR-001 | 使用Qwen-VL-Max分析PDF布局 | P0 |
| MR-002 | 检测条款编号连续性 | P0 |
| MR-003 | 检测异常留白 | P1 |
| MR-004 | 检测回车位置正确性 | P1 |
| MR-005 | 检测表格格式 | P1 |

### 13.3 技术方案

#### 13.3.1 技术选型

| 组件 | 选择 | 理由 |
|------|------|------|
| 多模态模型 | Qwen-VL-Max | SiliconFlow可用，效果好 |
| PDF处理 | PyMuPDF | 支持PDF转图片 |
| API | SiliconFlow | 用户指定 |

#### 13.3.2 接口设计

```python
class MultimodalQA:
    def __init__(self, api_key: str = None):
        """初始化多模态检测器"""
        
    def analyze_pdf_layout(self, pdf_path: str) -> Dict:
        """
        分析PDF布局质量
        
        Returns:
        {
            "success": True,
            "analysis": {...},
            "issues": [
                {
                    "type": "clause_numbering/layout/whitespace/line_break",
                    "severity": "high/medium/low",
                    "description": "问题描述",
                    "location": "位置"
                }
            ]
        }
        """
```

### 13.4 测试用例

| 用例编号 | 测试场景 | 预期结果 |
|---------|---------|---------|
| TC-MV-001 | 检测条款编号断裂 | 发现并报告问题 |
| TC-MV-002 | 检测异常留白 | 发现并报告问题 |
| TC-MV-003 | 检测回车位置 | 发现并报告问题 |
| TC-MV-004 | 检测表格格式 | 发现并报告问题 |

### 13.5 运行方式

```bash
# 环境变量设置
export SILICONFLOW_API_KEY="your-api-key"
export MULTIMODAL_TEST=1

# 运行多模态测试
python3 -m pytest tests/blackbox/test_pdf_quality.py::TestPDFLayoutQuality -v
```

### 13.6 验收标准

- [ ] 能检测到用户反馈的条款编号断裂问题
- [ ] 能检测到异常留白
- [ ] 能检测到回车位置错误
- [ ] 单次分析 < 30秒
- [ ] API成本 < ¥0.05/次

### 13.7 依赖

| 依赖 | 版本 | 说明 |
|------|------|------|
| PyMuPDF | latest | PDF转图片 |
| requests | latest | HTTP客户端 |

---

## 十四、附录

### 13.1 相关文档

| 文档 | 说明 |
|------|------|
| [TEST_PLAN.md](TEST_PLAN.md) | 测试方案 |
| [开发规范.md](开发规范.md) | 通用开发规范 |
| [开发交接清单.md](../开发交接清单.md) | 开发交接checklist（含详细技术需求） |
| [问题记录.md](问题记录.md) | 问题记录（Bug修复日志） |
| [需求变更记录.md](需求变更记录.md) | 需求变更记录 |
| [CHANGELOG.md](CHANGELOG.md) | 变更日志 |
| [详细设计_TD-2026-01-27-001.md](详细设计_TD-2026-01-27-001.md) | 详细设计文档 |
| [详细设计评审_TD-2026-01-27-001.md](详细设计评审_TD-2026-01-27-001.md) | 设计评审记录 |
| [v1历史文档](v1_history/) | 之前版本 |

### 13.2 验证命令

```bash
# 完整运行
python3 run_complete.py --all --judgment <path_to_judgment>

# 分阶段运行
python3 run_complete.py --stage0 --judgment <path>
python3 run_complete.py --stage1 --judgment <path>
python3 run_complete.py --stage2 --judgment <path>
python3 run_complete.py --stage3 --judgment <path>

# 验证输出质量
python3 validate_outputs.py outputs/

# 检查数据生成
python3 -c "from src.utils.data_generator import DataGenerator; ..."
```

---

**文档版本**: v2.1  
**状态**: 有效  
**创建日期**: 2024-01-27  
**最后更新**: 2026-01-28
