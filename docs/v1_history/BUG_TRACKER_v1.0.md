# 金融案件PDF生成系统 - Bug追踪清单

## 一、Bug统计概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           通用框架Bug追踪清单                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【已修复Bug】                                                                │
│  ┌──────┬────────────────────────────┬────────┬─────────┐                  │
│  │ BUG- │ 描述                      │ 严重性 │ 状态    │                  │
│  ├──────┼────────────────────────────┼────────┼─────────┤                  │
│  │ 001  │ 公司脱敏名称未替换          │ 🔴 高  │ ✅ 已修复 │                  │
│  │ 010  │ LLM创造脱敏模式            │ 🔴 高  │ ✅ 已修复 │                  │
│  │ 011  │ 证据文件无换行符            │ 🟡 中  │ ✅ 已修复 │                  │
│  │ 012  │ "某地址"异常模式            │ 🟡 中  │ ✅ 已修复 │                  │
│  │      │                            │        │         │                  │
│  └──────┴────────────────────────────┴────────┴─────────┘                  │
│                                                                              │
│  【待修复Bug】                                                                │
│  ┌──────┬────────────────────────────┬────────┬─────────┐                  │
│  │ BUG- │ 描述                      │ 严重性 │ 状态    │                  │
│  ├──────┼────────────────────────────┼────────┼─────────┤                  │
│  │ 002  │ 特定字段未使用             │ 🔴 高  │ 待修复  │                  │
│  │ 003  │ Markdown表格残留           │ 🔴 高  │ 待修复  │                  │
│  │ 004  │ 数据计算错误               │ 🔴 高  │ 待修复  │                  │
│  │ 005  │ 合同模板不完整             │ 🔴 高  │ 待修复  │                  │
│  │ 006  │ 内容污染残留               │ 🔴 高  │ 待修复  │                  │
│  │      │                            │        │         │                  │
│  └──────┴────────────────────────────┴────────┴─────────┘                  │
│                                                                              │
│  【数据问题】                                                                 │
│  ┌──────┬────────────────────────────┬────────┬─────────┐                  │
│  │ DATA │ 描述                      │ 严重性 │ 状态    │                  │
│  ├──────┼────────────────────────────┼────────┼─────────┤                  │
│  │ 001  │ 租赁物清单数据缺失          │ 🔴 高  │ 待补充  │                  │
│  │ 002  │ 抵押物清单数据缺失          │ 🔴 高  │ 待补充  │                  │
│  │ 003  │ 租金支付计划不完整          │ 🟡 中  │ 待补充  │                  │
│  └──────┴────────────────────────────┴────────┴─────────┘                  │
│                                                                              │
│  【统计】                                                                    │
│  总计: 10个问题                                                              │
│  已修复: 4个 (40%)                                                           │
│  待修复: 3个 (30%)                                                           │
│  待补充数据: 3个 (30%)                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 二、问题根因分析

```
┌─────────────────────────────────────────────────────────────────┐
│                    问题根因分析                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【类别1：通用性问题】50%                                        │
│  ├── 框架硬编码特定案件类型                                      │
│  ├── 模板使用硬编码字段值                                        │
│  ├── 脱敏规则不灵活                                             │
│  └── 计算逻辑不通用                                             │
│                                                                 │
│  【类别2：净化问题】50%                                          │
│  ├── LLM响应前缀残留                                            │
│  ├── 质检报告混入正文                                           │
│  ├── 证明目的混入正文                                           │
│  └── 内部备注未替换                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 三、详细Bug描述

### BUG-001: 脱敏替换不完整

**严重性**: 🔴 高  
**状态**: 待修复  
**模块**: processors/deanonymizer/

**问题描述**:
脱敏替换逻辑不够通用，无法处理所有案件类型中的脱敏标记。

**通用性要求**:
```
当前问题:
❌ 只处理"某某公司X"格式
❌ 不处理LLM创造的新脱敏模式

期望结果:
✓ 支持可配置的脱敏模式
✓ 支持自定义映射表
✓ 支持增强反脱敏（处理LLM创造的模式）
```

**修复方案**:
1. 创建 `EnhancedDeanonymizer` 类
2. 支持可配置的脱敏规则（正则表达式）
3. 支持自定义映射表加载
4. 添加LLM创造模式的自动识别

**测试用例**:
```python
def test_configurable_anonymization(self):
    """测试可配置的脱敏规则"""
    rules = {
        "company_patterns": ["某某公司\\d*", "长江某.*", "华鑫某.*"],
        "person_patterns": ["张某\\d*", "李某某"],
        "custom_mapping": {
            "某某公司5": "测试公司A",
            "某某公司1": "测试公司B"
        }
    }
    
    text = "某某公司5与长江某有限公司签订协议"
    result = processor.process(text, rules)
    
    # 应该清理所有脱敏标记
    assert "某某公司" not in result
    assert "长江某" not in result
```

---

### BUG-002: 特定字段未使用

**严重性**: 🔴 高  
**状态**: 待修复  
**模块**: core/、templates/

**问题描述**:
框架硬编码特定字段名，导致无法处理不同案件类型的不同字段。

**通用性要求**:
```
当前问题:
❌ 硬编码"租赁物清单"
❌ 硬编码"抵押物清单"  
❌ 硬编码"租金计划"

期望结果:
✓ 字段名从配置文件读取
✓ 支持自定义字段映射
✓ 支持动态字段验证
```

**修复方案**:
1. 创建通用的字段映射系统
2. 字段名从配置文件的 `field_mappings` 读取
3. 支持自定义验证规则

**配置示例**:
```json
{
  "evidence_templates": [
    {
      "template_id": "contract",
      "field_mappings": {
        "amount": "data.contract_amount",
        "date": "data.contract_date",
        "parties": "data.involved_parties",
        "equipment_list": "data.equipment",  // 不同案件用不同字段名
        "collateral_list": "data.collateral"
      }
    }
  ]
}
```

---

### BUG-003: Markdown表格残留

**严重性**: 🔴 高  
**状态**: 待修复  
**模块**: processors/table_parser/

**问题描述**:
Markdown表格未被正确解析为PDF Table对象。

**通用性要求**:
```
当前问题:
❌ PDF中有36处Markdown表格符号
❌ 表格未被渲染为PDF对象

期望结果:
✓ 识别并解析所有Markdown表格
✓ 将表格转换为PDF Table对象
✓ 支持多种表格格式
```

**修复方案**:
1. 重写 `MarkdownTableParser` 类
2. 支持表格检测和占位符替换
3. 在PDF生成时将占位符转换为Table对象

**测试用例**:
```python
def test_table_parsing_universal(self):
    """测试通用表格解析"""
    parser = MarkdownTableParser()
    
    # 不同格式的表格
    tables = [
        "| A | B |\n|---|---|\n| 1 | 2 |",  # 标准Markdown
        "| A | B |\n| C | D |",              # 无表头
        "A | B\n- | -\n1 | 2",               # 无分隔行
    ]
    
    for table in tables:
        clean_text, parsed_tables = parser.parse(table)
        assert "|" not in clean_text
        assert len(parsed_tables) == 1
```

---

### BUG-004: 数据计算错误

**严重性**: 🔴 高  
**状态**: 待修复  
**模块**: processors/calculator/

**问题描述**:
计算逻辑硬编码，无法适应不同案件类型。

**通用性要求**:
```
当前问题:
❌ 租金计算器只支持特定格式
❌ 利息计算器硬编码
❌ 违约金计算器缺失

期望结果:
✓ 创建插件化的计算器系统
✓ 支持多种计算方法配置
✓ 可添加自定义计算器
```

**修复方案**:
1. 创建 `CalculatorPlugin` 基类
2. 实现多种计算器：租金、利息、违约金
3. 从配置文件加载计算规则

**配置示例**:
```json
{
  "calculation_rules": {
    "rent": {
      "method": "equal_installment",
      "frequency": "monthly",
      "default_periods": 12
    },
    "interest": {
      "method": "daily_rate",
      "default_rate_type": "annual"
    },
    "penalty": {
      "method": "fixed_percentage",
      "default_rate": 0.05
    }
  }
}
```

---

### BUG-005: 合同模板不完整

**严重性**: 🔴 高  
**状态**: 待修复  
**模块**: templates/

**问题描述**:
合同模板硬编码特定条款，无法适应不同案件类型。

**通用性要求**:
```
当前问题:
❌ 只有第1-5条，缺少后续条款
❌ 条款内容针对特定案件类型

期望结果:
✓ 创建通用合同模板库
✓ 条款从模板库读取
✓ 支持自定义条款
```

**修复方案**:
1. 创建模板库系统 `templates/contracts/`
2. 条款作为独立模块 `templates/clauses/`
3. 从配置文件加载所需条款

**配置示例**:
```json
{
  "evidence_templates": [
    {
      "template_id": "contract",
      "required_clauses": [
        "定义与解释",
        "标的",      // 通用条款
        "价款",      // 通用条款
        "交付",      // 通用条款
        "违约责任",  // 通用条款
        "争议解决"   // 通用条款
      ]
    }
  ]
}
```

---

### BUG-006: 内容污染残留

**严重性**: 🔴 高  
**状态**: 待修复  
**模块**: processors/content_cleaner/

**问题描述**:
LLM生成的文本中包含测试/质检反馈内容。

**通用性要求**:
```
当前问题:
❌ LLM响应前缀残留
❌ 质检报告混入正文
❌ 测试标记残留
❌ 证明目的混入正文
❌ 内部备注未替换

期望结果:
✓ 清理所有LLM响应前缀
✓ 清理所有质检报告
✓ 清理所有测试标记
✓ 分离元数据到配置文件
✓ 替换所有内部备注
```

**修复方案**:
1. 创建 `ContentCleaner` 类
2. 实现多个净化处理器：
   - `LLMPrefixCleaner` - 清理LLM响应前缀
   - `QCReportCleaner` - 清理质检报告
   - `TestMarkerCleaner` - 清理测试标记
   - `InternalNoteCleaner` - 清理内部备注
3. 元数据分离到配置文件

**测试用例**:
```python
def test_all_contamination_removed(self):
    """测试所有污染内容被清理"""
    cleaner = ContentCleaner()
    
    text = """好的，作为专业的法律文书生成助手，我将根据您提供的输入参数，生成第1证据组的完整证据包。

【测试】这是测试数据

数据一致性验证报告
结论： 证据组1生成完毕

证明目的： 证明XXX

合同正文内容...
（此处填写日期）

附件：租赁物清单
"""
    cleaned, report = cleaner.clean(text)
    
    # 验证所有污染内容被清理
    assert "好的，作为" not in cleaned
    assert "【测试】" not in cleaned
    assert "数据一致性验证报告" not in cleaned
    assert "证明目的：" not in cleaned
    assert "（此处填写" not in cleaned
    
    # 验证正文内容保留
    assert "合同正文内容" in cleaned
    assert "附件：租赁物清单" in cleaned
```

---

## 四、修复优先级

| 优先级 | Bug ID | 描述 | 预计工时 | 依赖 |
|-------|--------|------|---------|------|
| P0 | BUG-006 | 内容污染残留 | 8小时 | 无 |
| P0 | BUG-003 | Markdown表格残留 | 8小时 | 无 |
| P0 | BUG-001 | 脱敏替换不完整 | 12小时 | 无 |
| P1 | BUG-002 | 特定字段未使用 | 16小时 | 配置系统 |
| P1 | BUG-004 | 数据计算错误 | 12小时 | 插件系统 |
| P1 | BUG-005 | 合同模板不完整 | 24小时 | 模板系统 |

## 五、通用性验证检查

### 5.1 框架通用性检查

```
□ 检查: 代码中无硬编码的特定案件类型
  验证命令: grep -r "融资租赁\|某某公司5\|多联机中央空调" src/ --include="*.py"
  预期: 0 matches

□ 检查: 配置系统正常工作
  验证命令: 运行 test_config_loader.py
  预期: 所有测试通过

□ 检查: 插件系统正常工作  
  验证命令: 运行 test_plugin_loading.py
  预期: 所有测试通过

□ 检查: 模板可配置
  验证命令: 运行 test_template_engine.py
  预期: 所有测试通过
```

### 5.2 内容净化检查

```
□ BUG-006: 内容污染残留
  - 验证: grep "好的，作为专业的法律文书生成助手" outputs/*.pdf
  - 预期: 0 matches
  
□ BUG-006: 质检报告
  - 验证: grep "数据一致性验证报告" outputs/*.pdf
  - 预期: 0 matches
  
□ BUG-006: 测试标记
  - 验证: grep "【测试】" outputs/*.pdf
  - 预期: 0 matches
  
□ BUG-006: 证明目的混入
  - 验证: grep "证明目的：" outputs/*.pdf
  - 预期: 0 matches
  
□ BUG-006: 内部备注
  - 验证: grep "（此处填写" outputs/*.pdf
  - 预期: 0 matches
```

### 5.3 PDF分页检查（新增）

```
□ 分页正确性
  - 验证: 每份证据另起一页
    方法: 人工检查PDF或运行分页测试
    预期: 每份证据从新页面开始
  
□ 页码连续性
  - 验证: 页码1,2,3,...连续无跳跃
    方法: 人工检查PDF页码
    预期: 页码连续
  
□ 封面/目录页码（如果启用）
  - 验证: 封面不计页码或标记为"I"
    方法: 检查封面页码
    预期: 封面页码正确
  
  - 验证: 目录页码与实际一致
    方法: 对比目录中页码与实际页面编号
    预期: 一致

□ 页码位置统一
  - 验证: 所有页面页码位置一致
    方法: 人工检查
    预期: 统一在底部居中或右下角
```

---

## 六、开发规范要求

### 6.1 代码规范

```python
# 正确示例 - 使用配置
def generate_evidence(self, config, data):
    template_id = config["evidence_templates"][0]["template_id"]
    field_mappings = config["evidence_templates"][0]["field_mappings"]
    
    amount = self._get_field_value(data, field_mappings["amount"])
    # ...

# 错误示例 - 硬编码
def generate_evidence(self, data):
    amount = data["rental_amount"]  # 字段名硬编码
    # ...
```

### 6.2 配置规范

```json
// 正确示例 - 通用配置
{
  "case_type": "通用金融纠纷",
  "field_mappings": {
    "amount": "data.amount",
    "date": "data.date"
  }
}

// 错误示例 - 特定配置
{
  "case_type": "融资租赁",
  "rental_amount": "data.rental_amount"  // 字段名特定
}
```

---

## 七、Bug复盘模板

```markdown
================================================================================
                          Bug复盘报告
================================================================================

Bug ID: ________
严重程度: P0 / P1 / P2 / P3
发现时间: ________
修复时间: ________

一、Bug描述
【详细描述问题现象】

二、影响范围
【影响哪些功能、哪些用户】

三、根因分析
【为什么会出现这个Bug】
重点分析是否违反了通用性设计原则

四、临时解决方案
【紧急修复措施】

五、永久解决方案
【彻底修复方案】
说明如何保证通用性

六、预防措施
【如何防止类似Bug再次出现】
说明如何加强通用性检查

七、改进建议
【流程、工具、测试等方面的改进建议】

填写人: ____________
================================================================================
```

---

## 八、发布检查清单

```
================================================================================
                         版本发布检查清单
================================================================================

【通用性检查】
□ 代码中无硬编码的特定案件类型
□ 配置系统正常工作
□ 插件系统正常工作
□ 模板可配置

【回归测试通过】
□ 单元测试 100% 通过
  - 包括分页测试
  - 包括内容净化测试

【分页检查】 ← 新增
□ 每份证据另起一页
  验证: 人工检查PDF
  预期: 每份证据从新页面开始

□ 页码连续
  验证: 人工检查PDF
  预期: 页码1,2,3,...连续

□ 封面/目录页码正确（如果启用）
  验证: 人工检查
  预期: 封面不计页码或标记为"I"，目录页码与实际一致

□ 页码位置统一
  验证: 人工检查
  预期: 所有页面页码位置一致

【内容净化通过】
□ 集成测试 100% 通过
□ Regression测试 100% 通过
□ E2E测试 100% 通过

【内容净化通过】
□ 无LLM响应前缀残留
□ 无质检报告残留
□ 无测试标记残留
□ 无证明目的混入
□ 无内部备注残留

【文档更新】
□ API文档已更新
□ 配置文档已更新
□ 模板开发文档已更新
□ 插件开发文档已更新

检查人: ____________
检查日期: ____________
批准人: ____________
================================================================================
```

---

## 九、已修复Bug详情（2026-01-27）

### BUG-011: 证据文件无换行符

**严重性**: 🟡 中  
**状态**: ✅ 已修复  
**发现日期**: 2026-01-27  
**修复日期**: 2026-01-27  
**模块**: `src/services/evidence_file_generator.py`

**问题描述**:
LLM生成的证据内容没有换行符，导致PDF显示为连续的长文本。

**示例**:
```
修复前: 【甲方（转让方/出租人）】名称：某某公司5统一社会信用代码：...
修复后:
【甲方（转让方/出租人）】
名称：上海国金融资租赁有限公司
统一社会信用代码：91310120MA1H
法定代表人：张伟
```

**修复方案**:
1. 在`evidence_file_generator.py`中添加`_ensure_line_breaks()`方法
2. 在字段标签（统一社会信用代码：、法定代表人：等）之间添加换行
3. 在章节标题【xxx】后添加换行

**修复代码**:
```python
def _ensure_line_breaks(self, text: str) -> str:
    """确保关键位置有换行符"""
    # 在【章节标题】后添加换行
    text = re.sub(r'【([^】]+)】([^\n])', r'【\1】\n\2', text)
    
    # 在连续字段标签之间添加换行
    field_labels = ['统一社会信用代码：', '法定代表人：', '地址：', ...]
    for label in field_labels:
        escaped_label = re.escape(label)
        text = re.sub(r'([^\n])(' + escaped_label + r')', r'\1\n\2', text)
    
    return text
```

**验证结果**:
- PDF总行数: 2691行（之前是连续文本）
- 字段标签换行: ✅ 正常
- 章节标题换行: ✅ 正常

---

### BUG-012: "某地址"异常模式

**严重性**: 🟡 中  
**状态**: ✅ 已修复  
**发现日期**: 2026-01-27  
**修复日期**: 2026-01-27  
**模块**: `src/utils/pdf_generator_simple.py`

**问题描述**:
LLM生成的文本中包含"某地址"这样的异常模式，如：
```
深圳华新科技集团有限公司）某地址：上海市浦东新区路号室
```

**修复方案**:
在`_enhanced_deanonymize()`方法中添加清理逻辑：
```python
# 模式7: 清理LLM生成的异常模式
text = re.sub(r'）某地址：', '）地址：', text)
text = re.sub(r'某地址：', '地址：', text)
text = re.sub(r'某某区', '', text)
```

**验证结果**:
- "某地址"出现次数: 0处（之前是4处）
- "某某区"出现次数: 0处（之前是1处）

---

## 十、数据问题跟踪

### DATA-001: 租赁物清单数据缺失

**严重性**: 🔴 高  
**状态**: 待补充  
**模块**: `outputs/stage0/0.4_key_numbers.json`

**问题描述**:
测试报告TR-2026-01-27提到应有5项租赁物清单数据，但实际文件中没有此数据。

**预期数据**:
```json
{
  "租赁物清单": [
    {"序号": 1, "名称": "多联机中央空调系统", "规格型号": "VRV VIII代", "数量": "10套", "存放地点": "南昌市红谷滩区", "评估价值": 50000000},
    {"序号": 2, "名称": "电梯设备", "规格型号": "GECS-II", "数量": "4台", "存放地点": "南昌市红谷滩区", "评估价值": 30000000}
  ]
}
```

**影响**:
- PDF中显示"附件一：租赁物清单（略）"
- 无法生成完整的租赁物清单表格

---

### DATA-002: 抵押物清单数据缺失

**严重性**: 🔴 高  
**状态**: 待补充  
**模块**: `outputs/stage0/0.4_key_numbers.json`

**问题描述**:
测试报告TR-2026-01-27提到应有1项抵押物清单数据，但实际文件中没有此数据。

**预期数据**:
```json
{
  "抵押物清单": [
    {"序号": 1, "名称": "南昌市XX广场商业房产", "不动产权证号": "赣（2021）南昌市不动产权第XXXXXX号", "地址": "江西省南昌市红谷滩区XX路XX号", "建筑面积": "5200㎡", "评估价值": 104000000, "所有人": "某某公司1"}
  ]
}
```

**影响**:
- PDF中显示"附件一：抵押物清单（略）"
- 无法生成完整的抵押物清单表格

---

### DATA-003: 租金支付计划不完整

**严重性**: 🟡 中  
**状态**: 待补充  
**模块**: `outputs/stage0/0.4_key_numbers.json`

**问题描述**:
租金支付计划只有3期数据，缺少第4-12期数据。

**当前状态**:
- 已有: 第1-3期（2期已付，1期未付）
- 缺少: 第4-12期

**影响**:
- 租金支付计划表格不完整
- 无法展示完整的还款计划

---

**文档版本**: 2.2  
**创建日期**: 2024-01-27  
**最后更新**: 2026-01-27

**更新记录**:
- v2.2: 新增BUG-011、BUG-012（已修复）、DATA-001、DATA-002、DATA-003
- v2.1: 新增5.3 PDF分页检查、发布检查清单分页要求
- v2.0: 通用框架版本
