# Gitee CI/CD 自动化测试配置指南

**目的**: 开发推送代码后，自动运行测试并通知  
**最后更新**: 2026-01-29

---

## 一、准备工作（只需做一次）

### 步骤1: 确保代码在Gitee上

1. 打开 Gitee: https://gitee.com
2. 登录你的账号
3. 创建仓库或确保代码已推送到Gitee

### 步骤2: 配置API密钥（必须）

1. 在Gitee打开你的仓库
2. 点击 **设置** → **安全设置** → **仓库密钥**
3. 点击 **添加密钥**
4. 配置以下密钥：

| 密钥名称 | 值 |
|----------|-----|
| `OPENAI_API_KEY` | `sk-fjephnssumhgkxhakpxlfrqayiuckkyogvwkchqutqolqilk` |
| `OPENAI_API_BASE` | `https://api.siliconflow.cn/v1` |
| `OPENAI_MODEL` | `deepseek-ai/DeepSeek-V3.2` |

5. 点击 **确定** 保存

### 步骤3: 创建测试报告目录

```bash
# 在项目根目录执行
cd /path/to/your/project
mkdir -p docs/test_reports
```

---

## 二、启用自动化测试（只需做一次）

### 步骤1: 推送配置文件

我已经创建了配置文件 `.gitee/workflows/test.yml`，你需要推送它到Gitee：

```bash
cd /path/to/your/project
git add .
git commit -m "feat: 添加Gitee自动化测试配置"
git push
```

### 步骤2: 在Gitee启用流水线

1. 打开 Gitee 仓库页面
2. 点击 **CI/CD** → **流水线**
3. 如果看到"启用流水线"按钮，点击启用
4. 刷新页面，应该能看到流水线列表

### 步骤3: 手动触发一次测试（验证配置）

1. 在流水线页面，点击 **运行流水线**
2. 选择分支（main 或 master）
3. 点击 **确定**
4. 等待测试完成（可能需要10-20分钟）
5. 查看测试日志和结果

---

## 三、日常使用流程

### 开发修改代码后

```bash
# 修改代码后
git add .
git commit -m "fix: 修复了xxx问题"
git push
```

**自动发生**:
1. Gitee 检测到代码推送
2. 自动运行流水线（测试）
3. 测试完成后，测试报告保存在 `docs/测试报告_*.md`
4. 可以在 Gitee 流水线页面查看结果

### 查看测试结果

1. 打开 Gitee 仓库
2. 点击 **CI/CD** → **流水线**
3. 点击最新的流水线记录
4. 查看 **日志** 和 **产物**

### 下载测试报告

1. 在流水线页面，找到最新记录
2. 点击 **产物** 标签
3. 下载 `test-report` 压缩包
4. 解压后查看 `docs/测试报告_*.md`

---

## 四、配置说明

### 配置文件位置

```
项目根目录/
├── .gitee/
│   └── workflows/
│       └── test.yml    ← 这个文件已创建好
└── docs/
    └── test_reports/   ← 需要手动创建
```

### 触发条件

| 事件 | 是否触发测试 |
|------|--------------|
| `git push` 到 main/master | ✅ 自动触发 |
| 创建 Pull Request | ✅ 自动触发 |
| 手动点击"运行流水线" | ✅ 手动触发 |

### 流水线包含的步骤

1. 克隆代码
2. 安装Python环境
3. 安装依赖（loguru, PyPDF2, reportlab）
4. 运行完整测试 (`python3 run_complete.py --all`)
5. 生成测试报告
6. 上传报告（保留30天）

---

## 五、测试报告位置

测试完成后，报告保存在两个地方：

| 位置 | 说明 |
|------|------|
| Gitee 流水线产物 | 可下载zip文件 |
| 项目 docs 目录 | `docs/测试报告_TR-YYYY-MM-DD_HH-MM-SS.md` |

查看所有测试报告：
```bash
ls -la docs/测试报告_TR-*.md
```

---

## 六、常见问题

### Q1: 流水线运行失败？

**可能原因**:
- API密钥配置错误
- 网络问题导致LLM调用失败
- 代码有语法错误

**解决**:
1. 打开流水线日志查看具体错误
2. 检查 API Key 是否正确配置
3. 修复代码后重新推送

### Q2: 流水线没有自动触发？

**可能原因**:
- 流水线未启用
- 分支名称不是 main/master

**解决**:
1. 进入 CI/CD → 流水线
2. 点击"启用流水线"
3. 确保推送到正确的分支

### Q3: 测试报告生成失败？

**解决**:
1. 检查项目是否有 `docs/test_reports` 目录
2. 检查是否有权限写入
3. 查看流水线日志中的错误信息

### Q4: 如何添加企业微信/钉钉通知？

Gitee 本身支持Webhook，可以对接企业微信/钉钉机器人：

1. 进入 **仓库设置** → **WebHooks**
2. 添加Webhook URL
3. 选择触发条件（流水线状态变更）
4. 保存

---

## 七、通知配置（可选）

### Gitee 内置通知

- 流水线失败时会自动发送**站内消息**
- 可以在 Gitee **消息中心**查看

### 配置邮件通知

1. Gitee **设置** → **邮件通知**
2. 开启"流水线状态变更通知"
3. 保存

### 配置企业微信/钉钉（高级）

需要管理员在 Gitee 企业版中配置，普通用户可跳过。

---

## 八、后续优化（可选）

| 功能 | 说明 |
|------|------|
| 测试报告可视化 | 使用 GitHub Pages 展示HTML报告 |
| 失败自动通知 | 邮件/企业微信/钉钉 |
| 历史趋势图 | 展示每次测试的成功率变化 |
| 定时测试 | 每天自动运行一次 |

---

## 九、技术支持

如果遇到问题：

1. 查看 Gitee 流水线日志
2. 检查 API Key 配置
3. 确认代码无语法错误
4. 联系开发团队

---

**创建日期**: 2026-01-29  
**版本**: v1.0
