# 自动验证系统更新日志

**更新日期**: 2026-01-28
**更新版本**: v2.0.4

---

## 一、更新理由

### 1.1 用户反馈

在开发过程中，用户指出：
> "你本身当然可以调用LLM来对内容作出评判，只要测试用例里面写清楚判断的标准。所以你的理由我不认可。"

这指出了系统的根本问题：**缺乏自测试能力**。

### 1.2 问题分析

之前的系统存在以下问题：

| 问题类型 | 之前的表现 | 应该的表现 |
|---------|-----------|-----------|
| 脱敏标记检查 | 等用户发现 | 系统自动检查并报告 |
| 数据一致性 | 等用户发现 | 系统自动验证 |
| Markdown表格 | 等用户发现 | 系统自动检测 |
| 证据完整性 | 等用户发现 | 系统自动检查 |

### 1.3 设计原则

基于用户反馈，我们确立了新的设计原则：

1. **AI可以验证AI** - 我可以调用LLM来验证生成的内容
2. **自动化优先** - 问题应该在生成过程中自动发现，而不是依赖用户反馈
3. **验证即服务** - 验证功能应该嵌入到主流程中，也可以独立运行

---

## 二、要解决的问题

### 2.1 已修复的问题

| 问题ID | 问题描述 | 严重程度 |
|--------|---------|---------|
| V-001 | 脱敏标记（某某、某某公司等）未检测 | 🔴 高 |
| V-002 | 数据不一致（设备清单金额 vs 合同金额）未检测 | 🔴 高 |
| V-003 | Markdown表格格式未检测 | 🟡 中 |
| V-004 | 证据文件完整性未检查 | 🟡 中 |
| V-005 | 证据内容质量未检查（长度、日期、金额） | 🟡 中 |

### 2.2 验证检查项

#### 2.2.1 脱敏标记检查

```python
placeholders = [
    "某某",
    "某某公司",
    "某某律师事务所",
    "某某公证处",
    "XXXX",
    "XXXXXXXX",
    "长江某",
    "华鑫某",
]
```

#### 2.2.2 数据一致性检查

```python
# 设备清单合计应该等于合同金额
equipment_total = sum(item.get("评估价值", 0) for item in rental)
contract_amount = key_numbers.get("合同基础金额", {}).get("原合同金额", {}).get("数值", 0)
```

---

## 三、具体做的变动

### 3.1 新增文件

#### 3.1.1 `src/utils/validator.py`

**目的**: 提供通用的质量验证功能

**主要类**:

```python
class QualityValidator:
    """质量验证器 - 自动检查生成内容的质量"""

    def __init__(self, llm_client=None):
        self.issues: List[Dict] = []
        self.warnings: List[str] = []

    def check_de_anonymization(self, text: str) -> bool
    def check_markdown_format(self, text: str) -> bool
    def check_equipment_list(self, key_numbers: Dict) -> bool
    def check_evidence_completeness(self, evidence_dir: Path, expected_count: int) -> bool
    def check_all_evidence(self, evidence_dir: Path) -> Dict
```

#### 3.1.2 `validate_outputs.py`

**目的**: 提供独立的验证脚本，可独立运行

```bash
# 独立运行完整验证
python3 validate_outputs.py
```

#### 3.1.3 `run_complete.py`

**目的**: 统一入口脚本，整合所有功能

```bash
# 完整流程（生成+验证）
python3 run_complete.py

# 仅验证
python3 run_complete.py --verify

# 分步执行
python3 run_complete.py --stage0  # 仅Stage0
python3 run_complete.py --stage1  # Stage0 + Stage1
```

---

## 四、使用方式

### 4.1 统一入口

```bash
# 完整流程（生成+自动验证）
python3 run_complete.py

# 仅验证
python3 run_complete.py --verify

# 分步执行
python3 run_complete.py --stage0  # 仅Stage0
python3 run_complete.py --stage1  # Stage0 + Stage1
```

### 4.2 API调用

```python
from src.utils.validator import QualityValidator, validate_pdf

# 验证PDF
pdf_result = validate_pdf(Path("outputs/完整测试卷宗.pdf"))
if not pdf_result["passed"]:
    for check in pdf_result["checks"]:
        if not check["passed"]:
            print(f"❌ {check['name']}: {check['detail']}")

# 验证证据
validator = QualityValidator()
results = validator.check_all_evidence(Path("outputs/stage1/evidence"))
print(f"证据通过率: {results['passed_ratio']}")
```

---

## 五、v2.0.2 更新 - 统一入口脚本

### 5.1 更新理由

**用户反馈**:
> "我还需要在你生成以后专门运行一个验证脚本？这不该是你在生成以后自动做的验证吗？"

**问题分析**:
- 之前有多个入口脚本，用户需要记住不同的命令
- 验证是独立的步骤，需要手动运行
- 用户体验差，容易混淆

### 5.2 解决方案

创建统一入口脚本 `run_complete.py`，整合所有功能：
- 一个入口搞定所有操作
- 生成后自动验证
- 支持灵活的分步执行

### 5.3 功能对比

| 功能 | 之前 | 现在 |
|------|------|------|
| 完整流程 | `run_full_regeneration.py` | `run_complete.py` |
| PDF生成 | `generate_pdf.py` | `run_complete.py`（自动） |
| 验证 | `validate_outputs.py` | `run_complete.py`（自动） |
| 分步执行 | 不支持 | `--stage0`, `--stage1` |

---

## 六、待办清单

### 6.1 文档更新

- [x] 更新README.md
- [x] 更新v2.0完整测试清单.md
- [x] 更新详细设计_TD-2026-01-27-001.md (v1.1)
- [x] 更新DEVELOPMENT.md

### 6.2 代码改进

- [x] 统一所有入口为 `run_complete.py`
- [ ] 添加 `--output` 参数指定输出目录
- [ ] 添加 `--quiet` 安静模式
- [x] 添加废弃脚本警告（run_full_regeneration.py, generate_pdf.py）

### 6.3 测试覆盖

- [ ] 添加单元测试
- [ ] 添加集成测试

---

## 八、v2.0.3 更新 - 证据文件换行问题修复

### 8.1 问题描述

**用户反馈**:
> "我就取一段：[Paste甲方是经批准设立的融资租赁公司...没有做任何回车？"

**问题分析**:
- LLM生成的证据文件缺少必要的换行
- 合同条款（"1.1"、"2.1"等）之间没有换行
- 公证书的不同部分没有换行
- 报告的不同章节（"一、"、"二、"等）没有换行

### 8.2 问题原因

1. **LLM生成问题**: LLM有时会生成连续文本，不添加必要的换行
2. **Markdown清理**: 清理markdown格式时误删了换行
3. **后处理缺失**: 没有专门的后处理步骤确保换行正确
4. **提示词缺失**: 提示词中没有明确要求正确的换行格式

### 8.3 解决方案

#### 8.3.1 即时修复（事后处理）
创建批量修复脚本，对所有证据文件进行换行修复。

#### 8.3.2 根本修复（修改提示词）
修改 `prompts/stage1/1.2_证据包生成.md`，在提示词中明确要求正确的换行格式：

```markdown
## 换行要求（极其重要）

**合同类文件**:
- 标题与正文之间必须有换行
- "鉴于条款"后必须有换行
- "鉴于1"、"鉴于2"各条之间必须有换行
- "第一条"、"第二条"等各条之间必须有换行
- "1.1"、"1.2"等小条款之间必须有换行
- "签署栏"前必须有换行

**公证书**:
- "公证事项"前必须有换行
- "甲方（"、"乙方（"信息块之间必须有换行
- "依据上述事实，兹证明"前必须有换行
```

### 8.4 修复结果

| 修复前 | 修复后 |
|--------|--------|
| 9个文件有换行问题 | 0个文件有问题 |
| 合同条款连在一起 | 每个条款独立段落 |
| 公证书内容连续 | 各部分清晰分隔 |

### 8.5 验证标准

- 合同条款之间必须有换行
- 公证书各部分必须有换行
- 报告的正文段落可以连续（这是正常的报告格式）
- 连续300字符以上无换行且包含条款编号的视为问题

### 8.6 预防措施

**修改后的提示词**会在生成时就要求正确的格式，从源头解决问题：
- 明确列出每种文档类型的换行规则
- 提供正确/错误格式的对比示例
- 在"执行指令"中强调换行要求

---

## 九、v2.0.4 更新 - 验证程序增强

### 9.1 问题描述

**用户反馈**:
> "为什么你的验证程序原先发现不了这个问题？"

**问题分析**:
原验证程序有两个问题：
1. 阈值150字符太短，正常的报告段落也会触发
2. 没有理解文档结构的能力，不知道哪些地方应该换行

### 9.2 解决方案

#### 9.2.1 调整验证阈值
将判断标准从150字符调整为300字符，避免正常的报告段落误报。

#### 9.2.2 添加文档结构理解
```python
def has_issue(file_path):
    for match in re.finditer(r'.{300,}', content):
        if '\n' not in match.group():
            # 只对包含条款编号模式的段落报错
            if re.search(r'\d+\.\s*[甲乙丙丁]', match.group()):
                return True
            if re.search(r'第\d+条', match.group()):
                return True
            if '鉴于条款' in match.group() and '1.' in match.group():
                return True
    return False
```

### 9.3 核心教训

**验证应该理解文档结构**，而不是简单地检查字符串长度。

---

**记录人**: OpenCode AI Assistant
**最后更新**: 2026-01-28
