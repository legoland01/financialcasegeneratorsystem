# RFC-2026-02-003: Prompt设计修复方案

**文档编号**: RFC-2026-02-003
**版本**: v1.1.0
**日期**: 2026-02-03
**状态**: 已更新（根据Agent1评审意见）

---

## 一、问题背景

### 1.1 问题来源

根据Agent1的反馈文档 `state/feedback_to_agent2_prompt_issue.md`，Agent2在开发中违反了PRD v3.0的Prompt设计原则。

### 1.2 PRD v3.0核心原则

| 原则 | 说明 |
|------|------|
| 只给具体信息 | 直接列出真实名称，不展示脱敏标识 |
| 不给模板格式 | 用自然语言描述，不提供XXX占位符 |
| 不强调禁止占位符 | 因为根本不应该出现 |

### 1.3 当前问题

| 位置 | 问题代码 | 违背原则 |
|------|----------|----------|
| `_build_party_info_section` | `某某公司5（公司）：上海金信` | 只给具体信息 |
| `_assemble_prompt` | `🚨 强制要求：禁止使用XXX` | 不强调禁止 |
| `_get_default_prompt` | `名称：XXX 法定代表人：XXX` | 不给模板格式 |

---

## 二、修改方案

### 2.1 修改文件列表

| 文件 | 修改内容 |
|------|----------|
| `src/services/evidence_file_generator.py` | 修改4个方法 + 新增角色映射表 |

### 2.0 新增：角色标签映射表

**新增位置**: `evidence_file_generator.py` 顶部（常量定义区）

```python
# ========== 新增内容 ==========
EVIDENCE_TYPE_ROLE_MAP = {
    "合同": {
        "transfer": ("甲方（转让方）", "乙方（受让方）"),
        "lease": ("甲方（出租人）", "乙方（承租人）"),
        "mortgage": ("甲方（抵押权人）", "乙方（抵押人）"),
        "pledge": ("甲方（质权人）", "乙方（出质人）"),
        "guarantee": ("债权人", "保证人"),
    },
    "文书": {
        "notarization": ("申请人", None),
        "certificate": ("权利人", "义务人"),
    },
    "登记": {
        "mortgage": ("抵押权人", "抵押人"),
        "pledge": ("质权人", "出质人"),
    },
    "凭证": {
        "payment": ("付款人", "收款人"),
        "invoice": ("销售方", "购买方"),
    }
}

PARTY_LABELS = ["甲方", "乙方", "丙方", "丁方", "戊方"]
```

### 2.1 新增：`_get_role_labels` 方法

**新增位置**: `EvidenceFileGenerator` 类中

```python
def _get_role_labels(self, evidence_type: str, sub_type: str = None) -> tuple:
    """
    根据证据类型和子类型返回角色标签

    Args:
        evidence_type: 证据类型（合同、文书、登记、凭证）
        sub_type: 子类型（transfer/lease/mortgage等）

    Returns:
        tuple: (甲方标签, 乙方标签)，若无乙方则返回(甲方标签, None)
    """
    role_map = EVIDENCE_TYPE_ROLE_MAP.get(evidence_type, {})

    if sub_type and sub_type in role_map:
        return role_map[sub_type]

    # 默认取第一个子类型的映射
    if role_map:
        first_subtype = list(role_map.keys())[0]
        return role_map[first_subtype]

    # 无映射时使用通用标签
    return ("甲方", "乙方")
```

### 2.2 修改1: `_build_party_info_section` 方法

**位置**: `evidence_file_generator.py:372-400`

```python
# ========== 修改前 ==========
def _build_party_info_section(self, parties):
    section_lines = ["### 当事人信息"]
    for party in parties:
        role = party.get("role", "当事人")        # 某某公司5
        name = party.get("party_name", "未知")
        type_label = "机构" if party_type == "institution" else "公司"
        section_lines.append(f"- {role}（{type_label}）：{name}")  # ❌ 某某公司5（公司）：上海金信
    return "\n".join(section_lines)

# ========== 修改后 ==========
def _build_party_info_section(
    self,
    parties: List[Dict[str, str]],
    evidence_type: str = "合同",
    sub_type: str = None
) -> str:
    """
    构建当事人信息部分 - 只给具体信息，不给脱敏标识
    支持N个当事人，根据证据类型使用正确的角色标签
    """
    if not parties:
        return ""

    section_lines = []
    party_labels = PARTY_LABELS

    # 获取角色标签
    if evidence_type and sub_type:
        role_labels = self._get_role_labels(evidence_type, sub_type)
    elif evidence_type:
        role_labels = self._get_role_labels(evidence_type)
    else:
        role_labels = ("甲方", "乙方")

    for idx, party in enumerate(parties):
        name = party.get("party_name", "未知")
        code = party.get("credit_code", "")
        legal = party.get("legal_representative", "")
        address = party.get("address", "")

        # 根据索引选择角色标签
        if idx < len(role_labels):
            role_label = role_labels[idx]
        elif idx < len(party_labels):
            role_label = party_labels[idx]
        else:
            role_label = f"当事方{idx + 1}"

        # 直接列出公司信息，不加脱敏标识前缀
        section_lines.append(f"{role_label}：{name}")
        if code:
            section_lines.append(f"统一社会信用代码：{code}")
        if legal:
            section_lines.append(f"法定代表人：{legal}")
        if address:
            section_lines.append(f"地址：{address}")
        section_lines.append("")

    return "\n".join(section_lines)
```

**修改效果**:
| 方面 | 修改前 | 修改后 |
|------|--------|--------|
| 格式 | `某某公司5（公司）：上海金信` | `甲方（出租人）：上海金信` |
| 脱敏标识 | 展示（某某公司5） | 移除 |
| 真实性 | 混合 | 直接真实 |
| 当事人 | 固定2个 | 支持N个 |
| 角色标签 | 固定"甲方/乙方" | 根据证据类型动态 |

---

### 2.3 修改2: `_assemble_prompt` 方法

**位置**: `evidence_file_generator.py:402-436`

```python
# ========== 修改前 ==========
def _assemble_prompt(self, base_prompt, party_info, amount_info, date_info, evidence):
    mandatory_info = ["## 【必须使用的具体信息】\n"]
    # ... 拼接金额、日期 ...
    mandatory_info.append("## 🚨 强制要求")              # ❌ 强调禁止
    mandatory_info.append("**禁止**使用以下占位符：")
    mandatory_info.append("- '某某公司'、'某公司'")
    mandatory_info.append("- '某某'、'某'")
    mandatory_info.append("- 'X4'、'X5'等数字占位符")
    # ...
    return f"{base_prompt}\n\n{mandatory_section}"

# ========== 修改后 ==========
def _assemble_prompt(
    self,
    base_prompt: str,
    party_info: str,
    amount_info: Dict[str, Any],
    date_info: Optional[str],
    evidence: Dict[str, Any]
) -> str:
    """
    组装完整Prompt - 不强调禁止占位符，让LLM直接使用真实信息
    """
    mandatory_info = []

    mandatory_info.append(party_info)
    mandatory_info.append("")
    mandatory_info.append(f"涉及金额：人民币{amount_info['uppercase']}（¥{amount_info['amount']:,.2f}）")
    mandatory_info.append("")

    if date_info:
        mandatory_info.append(f"日期：{date_info}")
        mandatory_info.append("")

    mandatory_section = "\n".join(mandatory_info)

    # 不添加"强制要求禁止占位符"部分
    return f"{base_prompt}\n\n{mandatory_section}"
```

**修改效果**:
| 方面 | 修改前 | 修改后 |
|------|--------|--------|
| 禁止规则 | 大段强调（5行） | 移除 |
| LLM提示 | 反复提醒禁止 | 直接给信息 |
| PRD符合度 | ❌ 违背 | ✅ 符合 |

---

### 2.4 修改3: `_get_default_prompt` 方法

**位置**: `evidence_file_generator.py:846-968`

```python
# ========== 修改前 ==========
def _get_default_prompt(self, evidence):
    prompts = {
        "合同": """合同标准格式
【甲方（转让方/出租人）】
名称：XXX           # ❌ 占位符
统一社会信用代码：XXX
法定代表人：XXX
地址：XXX
...""",
    }

# ========== 修改后 ==========
def _get_default_prompt(self, evidence: Dict[str, Any]) -> str:
    """
    获取默认提示词 - 用自然语言描述，不给占位符模板
    根据证据类型选择合适的Prompt模板
    """
    evidence_type = evidence.get("文件类型", "合同")
    sub_type = evidence.get("合同子类型", None)

    prompts = {
        "合同": """这是一份合同，请根据以下信息生成合同正文。

要求：
- 生成符合法律规范的合同正文
- 包含合同编号
- 包含当事人信息（已提供）
- 包含鉴于条款
- 包含转让标的条款
- 包含转让价款条款
- 包含支付方式条款
- 包含权利义务条款
- 包含违约责任条款
- 包含争议解决条款
- 包含签署栏（包含签订日期）
""",
        "文书": """这是一份文书（如公证书），请根据以下信息生成文书正文。

要求：
- 生成符合法律规范的文书正文
- 包含文书名称
- 包含当事人信息（已提供）
- 包含正文内容
- 包含签署和日期
""",
        "登记": """这是一份登记类证据（如抵押登记证明），请根据以下信息生成。

要求：
- 生成符合登记证明的标准格式
- 包含权利人信息（已提供）
- 包含义务人信息（已提供）
- 包含权利类型
- 包含登记时间
""",
        "凭证": """这是一份凭证（如银行回单），请根据以下信息生成。

要求：
- 生成符合凭证的标准格式
- 包含日期
- 包含收付款人信息（已提供）
- 包含金额（已提供）
- 包含摘要
- 包含凭证号
"""
    }

    return prompts.get(evidence_type, prompts["合同"])
```

**修改效果**:
| 方面 | 修改前 | 修改后 |
|------|--------|--------|
| 模板格式 | `名称：XXX 法定代表人：XXX` | 自然语言描述 |
| 占位符 | 大量XXX | 无占位符 |
| PRD符合度 | ❌ 违背 | ✅ 符合 |

---

### 2.5 修改4: `build_evidence_prompt` 方法

**位置**: `evidence_file_generator.py:438-473`

**修改内容**: 传递证据类型和子类型给`_build_party_info_section`

```python
# ========== 修改后 ==========
def build_evidence_prompt(
    self,
    evidence: Dict[str, Any],
    stage0_data: Dict[str, Any],
    evidence_type: str = "合同"
) -> str:
    """构建证据生成的完整Prompt"""
    logger.info(f"构建证据Prompt: {evidence.get('证据名称', '未知')}")

    profiles = stage0_data.get("0.2_脱敏替换策划",
                   stage0_data.get("0.2_anonymization_plan", {}))
    key_numbers = stage0_data.get("0.4_关键数字清单",
                      stage0_data.get("0.4_key_numbers", {}))

    companies = self._extract_involved_companies(evidence, profiles)
    amount_info = self._extract_amount_info(evidence, key_numbers)
    date_info = self._extract_date_info(evidence)

    # 传递证据类型和子类型
    evidence_file_type = evidence.get("文件类型", "合同")
    evidence_sub_type = evidence.get("合同子类型", None)

    party_info = self._build_party_info_section(
        companies,
        evidence_type=evidence_file_type,
        sub_type=evidence_sub_type
    )

    prompt_path = self.prompt_dir / "stage1" / "1.2.1_单个证据生成.md"
    if prompt_path.exists():
        base_prompt = load_prompt_template(str(prompt_path))
    else:
        base_prompt = self._get_default_prompt(evidence)

    full_prompt = self._assemble_prompt(
        base_prompt=base_prompt,
        party_info=party_info,
        amount_info=amount_info,
        date_info=date_info,
        evidence=evidence
    )

    logger.info(f"证据Prompt构建完成，字符数: {len(full_prompt)}")

    return full_prompt
```

---

## 三、修改前后对比

### 3.1 Prompt对比示例

```
# 修改前（错误）
## 当事人信息
- 某某公司5（公司）：上海金信融资租赁有限公司
  统一社会信用代码：91310000MAXXXX
  法定代表人：张明
  地址：上海市浦东新区某某路某某号

## 🚨 强制要求
禁止使用占位符...


# 修改后（正确）
甲方（出租人）：上海金信融资租赁有限公司
统一社会信用代码：91310000MAXXXX
法定代表人：张明
地址：中国（上海）自由贸易试验区世纪大道100号

涉及金额：人民币壹亿伍仟万元整（¥150,000,000.00）
```

### 3.2 角色标签示例

| 证据类型 | 子类型 | 甲方标签 | 乙方标签 |
|----------|--------|----------|----------|
| 合同 | 转让 | 甲方（转让方） | 乙方（受让方） |
| 合同 | 租赁 | 甲方（出租人） | 乙方（承租人） |
| 合同 | 抵押 | 甲方（抵押权人） | 乙方（抵押人） |
| 文书 | 公证书 | 申请人 | - |
| 登记 | 抵押登记 | 抵押权人 | 抵押人 |
| 凭证 | 付款 | 付款人 | 收款人 |

### 3.3 LLM行为对比

| 方面 | 修改前 | 修改后 |
|------|--------|--------|
| LLM理解 | 看到XXX模板，按模板生成 | 直接使用真实信息 |
| 生成结果 | 占位符、错误信息 | 真实、一致 |
| 需要清理 | 占位符清理、后处理 | 不需要 |
| 角色标签 | 固定"甲方/乙方" | 根据证据类型动态 |

---

## 四、验收标准

### 4.1 功能验收

| 验收项 | 验收标准 | 测试方法 |
|--------|----------|----------|
| 公司名真实性 | 100%使用真实公司名 | grep搜索"某某"、"某公司"，结果数=0 |
| 地址真实性 | 0个"某某路某某号"类占位符 | grep搜索地址类占位符，结果数=0 |
| 金额准确性 | 与阶段0数据一致 | Python脚本比对关键金额 |
| 日期准确性 | 与阶段0数据一致 | Python脚本比对日期 |
| 角色标签正确性 | 根据证据类型使用正确标签 | 人工抽检5个不同类型证据 |

### 4.2 测试用例

| 测试编号 | 测试内容 | 预期结果 |
|----------|----------|----------|
| TC-001 | 生成《转让合同》，检查甲方/乙方标签 | 甲方标签="转让方"，乙方标签="受让方" |
| TC-002 | 生成《租赁合同》，检查甲方/乙方标签 | 甲方标签="出租人"，乙方标签="承租人" |
| TC-003 | 生成《公证书》，检查申请人标签 | 申请人标签正确 |
| TC-004 | 检查生成的合同中无"某某公司" | 结果数=0 |
| TC-005 | 检查生成的合同中无"某某路某某号" | 结果数=0 |
| TC-006 | 检查3方当事人证据的角色标签 | 甲方/乙方/丙方标签正确 |

### 4.3 回归测试

| 测试范围 | 测试内容 |
|----------|----------|
| 全部证据类型 | 合同、文书、登记、凭证各抽检1-2个 |
| 全部证据组 | 证据组1-9各抽检1个证据 |
| 交叉验证 | 检查同一案件在不同证据中的一致性 |

---

## 五、时间估计

| 任务 | 估计时间 | 说明 |
|------|----------|------|
| 补充角色映射表 | 0.5小时 | EVIDENCE_TYPE_ROLE_MAP常量 |
| 实现`_get_role_labels` | 0.5小时 | 新增方法 |
| 修改`_build_party_info_section` | 1小时 | 支持N个当事人+动态角色 |
| 修改`_assemble_prompt` | 0.5小时 | 移除禁止规则 |
| 修改`_get_default_prompt` | 0.5小时 | 移除XXX，使用自然语言 |
| 修改`build_evidence_prompt` | 0.5小时 | 传递证据类型参数 |
| **代码修改小计** | **3.5小时** | - |
| 测试验证（TC-001至TC-006） | 1.5小时 | 执行新测试用例 |
| 回归测试 | 1小时 | 全量证据抽检 |
| **总计** | **6小时** | 较原RFC增加2小时 |

---

## 六、风险评估

### 6.1 可能风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| LLM生成格式不规范 | 格式可能不一致 | 后续优化Prompt描述 |
| 遗漏关键信息 | 证据可能不完整 | 添加验证步骤 |
| 角色映射不完整 | 部分证据类型缺失映射 | 先实现常用类型，后续补充 |

### 6.2 缓解措施

| 措施 | 说明 |
|------|------|
| 自然语言描述 | 明确列出需要包含的条款 |
| 验证步骤 | 添加生成后验证 |
| 渐进式映射 | 先实现合同/文书/登记/凭证4大类 |

---

## 七、参考文档

| 文档 | 路径 |
|------|------|
| Agent1反馈 | `state/feedback_to_agent2_prompt_issue.md` |
| Agent1评审意见 | `docs/REVIEW_RFC-2026-02-03-001_Prompt设计修复方案.md` |
| PRD v3.0 | `docs/需求文档_PRD-2026-02-01-v3.0.md` |
| TD v3.0 | `docs/详细设计_TD-2026-02-01-v3.0.md` |

---

## 八、评审记录

| 评审人 | 评审日期 | 评审结果 | 评审意见 |
|--------|----------|----------|----------|
| Agent1 | 2026-02-03 | ✅ 通过（需修改） | 见评审文档 |
| Agent2 | 2026-02-03 | 已更新 | 根据Agent1意见补充角色映射 |

---

**创建日期**: 2026-02-03
**版本**: v1.1.0
**最后更新**: 2026-02-03
