# 需求变更记录

**日期**: 2026-01-28  
**记录人**: 产品经理

---

## 一、本次改动的背景

在开发v2.0详细设计文档时，发现以下问题：
1. 开发交接清单缺少详细技术需求
2. 开发规范缺少开发交接清单的具体内容要求
3. 问题记录分散在多个文件中
4. 详细设计文档没有在开发交接清单中引用

---

## 二、改动清单

### 2.1 开发规范（docs/开发规范.md）

| 改动 | 说明 |
|------|------|
| 新增2.1节 | 开发交接清单必须包含6个章节 |
| 新增2.2节 | 详细需求必须包含6个内容（功能职责、输入/输出格式、接口定义、处理流程、边界条件） |

### 2.2 开发交接清单（开发交接清单.md）

| 改动 | 说明 |
|------|------|
| 重命名 | 从 `docs/IMPLEMENTATION_HANDOVER.md` 移到根目录并重命名 |
| 新增DataGenerator接口定义 | 4个函数（__init__, generate, _extract_boundary_conditions, _generate_equipment_list, _calculate_rent_schedule） |
| 新增EvidenceRenderer接口定义 | 2个函数（render_contract, render_table） + 格式规范表 |
| 新增DynamicPromptBuilder接口定义 | 1个函数（build_prompt） + Prompt结构示例 |
| 新增参考文档 | 详细设计文档、详细设计评审文档 |

### 2.3 问题记录（docs/问题记录.md）

| 改动 | 说明 |
|------|------|
| 版本更新 | v1.0 → v1.1 |
| 新增内容 | 合并了原 `docs/BUG_FIX_LOG.md` 的5个问题 |
| 新增测试建议 | 4个应该添加的自动化测试 |

### 2.4 删除的文档

| 文档 | 说明 |
|------|------|
| docs/IMPLEMENTATION_HANDOVER.md | 已合并到根目录的 `开发交接清单.md` |
| docs/BUG_FIX_LOG.md | 已合并到 `docs/问题记录.md` |

---

## 需求变更记录 2026-02-01

**日期**: 2026-02-01
**记录人**: Agent1产品经理
**变更类型**: 功能增强

---

### 一、变更背景

黑盒测试发现：LLM生成的证据文件仍包含大量占位符（`某某`、`X4`、`X年月日`等），仅靠Prompt约束无法完全解决。

### 二、变更内容

#### 2.1 Prompt更新（已完成）

| 文件 | 版本 | 更新内容 |
|------|------|---------|
| prompts/stage1/1.1_起诉状生成.md | v1.0.1 | 添加禁止占位符规则 |
| prompts/stage1/1.2_证据包生成.md | v1.0.2 | 添加禁止占位符规则 |
| prompts/stage1/1.3_程序文件生成.md | v1.0.1 | 添加禁止占位符规则 |

#### 2.2 代码实现（待agent2开发）

| 功能 | 优先级 | 描述 |
|------|--------|------|
| 占位符检测器 | P0 | 检测生成内容中的占位符模式 |
| 重试机制 | P0 | 检测到占位符时自动重新生成 |
| 最大重试次数 | P0 | 限制重试次数，避免无限循环 |
| 失败降级 | P1 | 多次失败后记录错误并继续处理 |

### 三、验收标准

1. 证据文件不再包含 `某某`、`某公司`、`X4`、`X年月日` 等占位符
2. 证据验证通过率提升至 80% 以上
3. PDF脱敏检查通过

### 四、影响范围

- src/services/stage1/stage1_service.py
- 新增 src/utils/placeholder_checker.py（占位符检测）
- 新增 src/utils/retry_handler.py（重试机制）

### 五、测试结果

| 测试时间 | 证据数 | 通过数 | 通过率 | 主要问题 |
|---------|--------|--------|--------|---------|
| 2026-02-01 00:16 | 53 | 3 | 5.7% | 占位符未清理 |
| 2026-01-31 23:41 | 45 | 3 | 6.7% | 占位符未清理 |
| 2026-01-31 22:11 | 22 | 11 | 50% | 运行时崩溃 |

---

## 三、当前文档结构

### 3.1 根目录文档

| 文档 | 说明 | 状态 |
|------|------|------|
| DEVELOPMENT.md | 开发规范索引 | ✅ |
| CHANGELOG.md | 版本变更记录 | ✅ |
| PRODUCT_REQUIREMENTS.md | 需求文档 | ✅ |
| 开发交接清单.md | 开发交接checklist（含详细技术需求） | ✅ 新 |
| 开发规范.md | 通用开发规范 | ✅ |
| 详细设计_TD-2026-01-27-001.md | 详细设计 | ✅ |
| 详细设计评审_TD-2026-01-27-001.md | 设计评审 | ✅ |

### 3.2 docs目录文档

| 文档 | 说明 | 状态 |
|------|------|------|
| 开发规范.md | 通用开发规范（副本） | ✅ |
| 问题记录.md | 问题记录（已合并BUG_FIX_LOG） | ✅ 更新 |
| TEST_PLAN.md | 测试计划 | ✅ |
| v2.0功能保留清单.md | 功能需求 | ✅ |
| v2.0完整测试清单.md | 测试清单 | ✅ |
| 需求澄清_RFC-2026-01-27-001_v2数据策略.md | RFC | ✅ |
| 需求文档规范.md | 需求文档模板 | ✅ |
| 需求管理闭环规范.md | 需求管理闭环 | ✅ |

---

## 四、开发交接清单的内容要求

根据更新后的开发规范，开发交接清单必须包含：

### 必须包含的章节

| 序号 | 章节 | 必须包含的内容 |
|------|------|---------------|
| 1 | 核心设计原则确认 | 核心流程、数据层级、组件边界、签字确认 |
| 2 | 功能清单确认 | 保留功能列表、新增功能列表 |
| 3 | 详细需求 | 每个核心组件的：功能职责、输入/输出格式、接口定义、处理流程、边界条件 |
| 4 | 验收标准确认 | 每个功能的验收条件 |
| 5 | 测试要求 | 单元测试、集成测试 |
| 6 | 知识沉淀确认 | 记录规则、位置、格式、签字确认 |
| 7 | 参考文档 | 所有相关文档的引用 |

---

## 五、问题记录的内容要求

根据更新后的开发规范，问题记录必须包含：

### 记录模板

```markdown
## [YYYY-MM-DD] 问题标题

**版本**: vX.X
**状态**: 已解决/待解决

### 问题描述
- 简要描述问题

### 涉及版本
- 首次出现：vX.X
- 解决版本：vX.X

### 涉及代码
- 文件路径:行号

### 根本原因
- 为什么会发生

### 解决方法
- 如何解决的

### 预防措施
- 如何避免再次发生

### 相关文档
- 相关链接
```

### 记录位置

| 类型 | 位置 |
|------|------|
| 项目通用问题 | `docs/问题记录.md` |
| 代码相关问题 | 代码注释中 |
| 设计决策 | 需求文档或设计文档中 |

---

## 六、下一步行动

| 行动项 | 说明 | 负责人 |
|--------|------|--------|
| 开发签字 | 开发阅读开发交接清单并签字 | 开发 |
| 补充详细设计 | 根据开发交接清单补充详细设计 | 开发 |
| 执行测试 | 按照测试要求执行测试 | 开发/产品 |
| 更新问题记录 | 每次解决问题后更新问题记录 | 开发 |

---

**创建日期**: 2026-01-28  
**版本**: v1.0
