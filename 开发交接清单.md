# v2.0 开发交接清单

**文档编号**: IMP-2026-01-27-001  
**版本**: v1.2  
**日期**: 2026-01-28  
**状态**: 待开发确认  
**接收方**: 开发团队

---

> **AI开发模式说明**: 本项目由AI辅助开发，无需人工签字确认。产品经理(AI)与开发者(AI)之间通过文档记录进行协作。

**开发签字**: N/A (AI开发模式)  
**日期**: N/A (AI开发模式)

---

## 一、核心变更（必读）

### 1.1 数据生成策略变更

| 旧策略 | 新策略 |
|--------|--------|
| 每次运行生成新数据 | **同一判决书只生成一次** |
| - | 不同判决书生成新数据 |
| - | 以判决书哈希作为缓存键 |

### 1.2 实施优先级

| 优先级 | 组件 | 说明 |
|--------|------|------|
| P0 | DataGenerator | 数据生成器（含缓存机制） |
| P0 | EvidenceRenderer | 合同渲染 + 表格渲染 |
| P1 | DynamicPromptBuilder | 动态Prompt构建器 |

---

## 二、功能清单确认

| 功能 | 类别 | 开发确认 |
|------|------|---------|
| Stage 0（5个产物） | 保留 | [ ] |
| Stage 1（3个产物） | 保留 | [ ] |
| Stage 2（3个产物） | 保留 | [ ] |
| Stage 3（2个产物） | 保留 | [ ] |
| PDF生成 | 保留 | [ ] |
| DataGenerator | 新增 | [ ] |
| DynamicPromptBuilder | 新增 | [ ] |
| EvidenceRenderer | 新增 | [ ] |
| run_complete.py | 新增 | 统一入口脚本 |
| validate_outputs.py | 新增 | 独立验证脚本 |
| TestConfigInjector | 新增 | 测试配置注入器（错误注入测试） |

### 2.1 入口脚本说明

| 脚本 | 状态 | 说明 |
|------|------|------|
| run_complete.py | ✅ 有效 | 统一入口，支持 --stage0/1/2 --test-config |
| run_full_regeneration.py | ❌ 废弃 | 请使用 run_complete.py |
| generate_pdf.py | ❌ 废弃 | 请使用 run_complete.py --stage2 |
| validate_outputs.py | ✅ 有效 | 独立验证输出文件质量 |

### 2.2 TestConfigInjector 使用说明

| 功能 | 说明 |
|------|------|
| 用途 | 错误注入测试，验证系统容错能力 |
| 实现位置 | src/utils/test_config_injector.py |
| 入口集成 | run_complete.py --test-config 参数 |
| 操作类型 | multiply（乘）、add（加）、replace（替换） |

**使用示例**:
```bash
# 合同金额+10%测试
python3 run_complete.py --test-config='{"enabled": true, "description": "合同金额+10%", "errors": [{"target": "合同基础金额.原合同金额.数值", "operation": "multiply", "value": 1.1}]}'

# 年利率改为8%测试
python3 run_complete.py --test-config='{"enabled": true, "description": "年利率改为8%", "errors": [{"target": "租金安排.年利率.数值", "operation": "replace", "value": 8.0}]}'

# 租金金额+20%测试
python3 run_complete.py --test-config='{"enabled": true, "description": "租金金额+20%", "errors": [{"target": "租金安排.租金总额.数值", "operation": "multiply", "value": 1.2}]}'
```

---

## 三、详细需求

### 3.1 DataGenerator 详细需求

#### 功能职责

根据边界条件自动生成：
- 设备名称、规格型号
- 银行账号、证件号码
- 地址、电话
- 租金支付计划计算

#### 输入格式

```json
{
  "judgment_hash": "abc123...",
  "boundary_conditions": {
    "contract_amount": 150000000,
    "interest_rate": 0.061,
    "signing_date": "2021-02-24",
    "equipment_count": 5,
    "lessor": "某某公司5",
    "lessee": "某某公司1"
  },
  "template_library": {
    "company_names": ["长江某有限公司", "华鑫某集团"],
    "equipment_names": ["多联机中央空调系统", "电梯设备"]
  },
  "force_refresh": false
}
```

#### 输出格式

```json
{
  "judgment_hash": "abc123...",
  "generated_data": {
    "equipment_list": [
      {
        "序号": 1,
        "设备名称": "多联机中央空调系统",
        "规格型号": "VRV VIII代",
        "数量": "10套",
        "评估价值": 50000000
      }
    ],
    "rent_schedule": [...],
    "bank_accounts": {...}
  },
  "cache_timestamp": "2026-01-27T10:00:00Z"
}
```

#### 接口定义

```python
class DataGenerator:
    def __init__(self, cache_dir: str = "cache"):
        """初始化"""
        pass
    
    def generate(self, judgment_path: str, force_refresh: bool = False) -> dict:
        """
        生成详细数据
        
        Args:
            judgment_path: 判决书文件路径
            force_refresh: 是否强制刷新缓存
        Returns:
            生成的详细数据
        """
        pass
    
    def _extract_boundary_conditions(self, judgment_text: str) -> dict:
        """从判决书提取边界条件"""
        pass
    
    def _generate_equipment_list(self, count: int, total_value: int) -> List[dict]:
        """生成设备清单"""
        pass
    
    def _calculate_rent_schedule(self, principal: float, rate: float, periods: int) -> List[dict]:
        """计算租金支付计划"""
        pass
```

#### 缓存机制

```
输入judgment_hash
    ↓
检查缓存文件是否存在（cache/{judgment_hash}.json）
    ↓
┌─────────────────────────────────┐
│ 缓存存在 && !force_refresh      │
│   → 读取并返回缓存数据          │
│                                  │
│ 缓存不存在 || force_refresh      │
│   → 生成新数据                  │
│   → 保存到缓存文件              │
│   → 返回新数据                  │
└─────────────────────────────────┘
```

---

### 3.2 EvidenceRenderer 详细需求

#### 渲染器接口

```python
class EvidenceRenderer:
    def render_contract(title: str, content: str) -> List[PDFElement]:
        """
        渲染合同格式
        
        Args:
            title: 合同标题
            content: 合同内容
        Returns:
            PDF元素列表（可用于SimpleDocTemplate）
        """
    
    def render_table(title: str, headers: List[str], rows: List[List[str]]) -> List[PDFElement]:
        """
        渲染表格格式
        
        Args:
            title: 表格标题
            headers: 表头列表
            rows: 数据行列表
        Returns:
            PDF元素列表
        """
```

#### render_contract 格式规范

| 元素 | 样式 |
|------|------|
| 标题 | 18号黑体，居中 |
| 合同编号 | 12号宋体，左对齐 |
| 当事人信息 | 12号宋体，分组显示 |
| 正文 | 12号宋体，两端对齐 |
| 签署栏 | 12号宋体，左对齐 |

#### render_table 格式规范

| 元素 | 样式 |
|------|------|
| 表格标题 | 14号黑体 |
| 表头 | 10号宋体，灰底 |
| 表格内容 | 10号宋体，斑马纹 |
| 列宽 | 按内容自适应 |
| 对齐 | 居中 |

---

### 3.3 DynamicPromptBuilder 详细需求

#### 功能职责

构建包含完整上下文的Prompt，避免LLM创造新脱敏模式。

#### 接口定义

```python
class DynamicPromptBuilder:
    def __init__(self, template_dir: str = "config/evidence_templates"):
        """初始化"""
        pass
    
    def build_prompt(
        self,
        task_type: str,
        boundary_conditions: dict,
        deanonymization_context: dict,
        template_name: str
    ) -> str:
        """
        构建完整的Prompt
        
        Args:
            task_type: 任务类型 (e.g., "生成融资租赁合同")
            boundary_conditions: 边界条件
            deanonymization_context: 反脱敏上下文
            template_name: 模板文件名
        Returns:
            完整的Prompt字符串
        """
```

#### Prompt结构示例

```markdown
# 任务：生成{证据类型}

## 当事人信息 - 必须使用以下真实信息
**甲方（{role}）**：
- 公司名称：{real_name}
- 统一社会信用代码：{credit_code}
- 法定代表人：{representative}
- 注册地址：{address}

**乙方（{role}）**：...

## 案件关键数据
- 合同金额：{contract_amount}元
- 签订日期：{signing_date}
- 设备数量：{equipment_count}台

## 生成要求
1. 必须使用上述真实信息，不要使用"某某公司"等占位符
2. 不要自己编造金额、日期
3. 严格按照以下模板格式输出
```

---

## 四、验收标准确认

| 验收标准 | 开发确认 |
|---------|---------|
| DataGenerator支持按判决书哈希缓存 | [ ] |
| 同一判决书两次运行返回相同数据 | [ ] |
| 不同判决书生成不同数据 | [ ] |
| EvidenceRenderer实现合同和表格两种格式 | [ ] |
| DynamicPromptBuilder正确注入上下文 | [ ] |
| 所有组件通过单元测试 | [ ] |

---

## 五、测试要求

### 5.1 单元测试

| 组件 | 测试点 |
|------|--------|
| DataGenerator | 设备名称生成、金额计算、缓存命中/失效 |
| EvidenceRenderer | 合同格式渲染、表格渲染 |
| DynamicPromptBuilder | 上下文注入、变量替换 |

### 5.2 集成测试

| 测试场景 | 预期结果 |
|---------|---------|
| 同一判决书运行2次 | 第二次使用缓存数据 |
| 不同判决书 | 各自生成独立数据 |
| 强制刷新 | 重新生成数据 |

---

## 六、知识沉淀确认（强制要求）

我已理解并同意：

1. 每次解决Bug后，必须在 `docs/问题记录.md` 中添加记录
2. 每次做出设计决策，必须在相关文档中记录
3. 不记录 = 没解决，代码合入前必须完成记录

**开发签字**: N/A (AI开发模式)  
**日期**: N/A (AI开发模式)

---

## 七、参考文档

| 文档 | 位置 | 说明 |
|------|------|------|
| 需求澄清RFC | docs/需求澄清_RFC-2026-01-27-001_v2数据策略.md | 核心设计决策 |
| 产品需求 | PRODUCT_REQUIREMENTS.md | 完整需求文档 |
| 测试方案 | docs/TEST_PLAN.md | 测试要求 |
| 开发规范 | docs/开发规范.md | 通用开发规范 |
| **详细设计** | **docs/详细设计_TD-2026-01-27-001.md** | **完整的技术实现方案** |
| **详细设计评审** | **docs/详细设计评审_TD-2026-01-27-001.md** | **设计评审记录** |

---

**创建日期**: 2026-01-27  
**最后更新**: 2026-01-28  
**产品经理**: OpenCode (AI Assistant)
