# 金融案件测试数据生成系统 - 使用手册

## 目录

1. [系统概述](#系统概述)
2. [环境准备](#环境准备)
3. [安装部署](#安装部署)
4. [快速开始](#快速开始)
5. [详细使用指南](#详细使用指南)
6. [API接口说明](#api接口说明)
7. [常见问题](#常见问题)
8. [故障排查](#故障排查)
9. [版本更新](#版本更新)

---

## 系统概述

### 简介

金融案件测试数据生成系统是一个基于大语言模型的自动化工具，用于根据金融案件判决书生成完整的测试卷宗材料。系统支持融资租赁合同纠纷案件，可以生成原告起诉包、被告答辩包和法院审理包。

### 核心功能

- **判决书解析**：自动从判决书中提取关键信息
- **脱敏替换**：将脱敏信息替换为真实感的模拟数据
- **卷宗生成**：自动生成完整的诉讼卷宗文件
- **质量控制**：多层次的质量检查机制
- **API服务**：提供RESTful API接口

### 技术架构

```
FastAPI (Web框架)
    ↓
Stage 0: 判决书解析与全局规划
    ↓
Stage 1: 原告起诉包生成
    ↓
Stage 2: 被告答辩包生成
    ↓
Stage 3: 法院审理包生成
    ↓
完整测试卷宗
```

### 系统要求

- **Python版本**: 3.9+
- **操作系统**: macOS / Linux / Windows
- **内存**: 建议8GB+
- **磁盘**: 建议10GB+（用于存储生成的卷宗）

---

## 环境准备

### 1. 检查Python版本

```bash
python --version
# 或
python3 --version
```

确保Python版本为3.9或更高。

### 2. 获取API密钥

系统使用SiliconFlow API（DeepSeek模型），需要获取API密钥：

1. 访问 https://siliconflow.cn/
2. 注册账号并登录
3. 进入控制台获取API密钥
4. 保存API密钥（格式类似：`sk-xxxxxxxxxxxxxxxxxxxx`）

### 3. 准备判决书文件

准备一份金融案件判决书文本文件（含脱敏信息），建议为Markdown或纯文本格式。

---

## 安装部署

### 方式一：使用虚拟环境（推荐）

#### 1. 创建项目目录

```bash
cd /path/to/your/workspace
git clone <repository-url>  # 如果有git仓库
# 或直接解压项目文件到该目录
cd financial_case_generator_system
```

#### 2. 创建虚拟环境

```bash
# macOS/Linux
python3 -m venv venv

# Windows
python -m venv venv
```

#### 3. 激活虚拟环境

```bash
# macOS/Linux
source venv/bin/activate

# Windows
venv\Scripts\activate
```

#### 4. 安装依赖

```bash
pip install -r requirements.txt
```

#### 5. 验证安装

```bash
python -c "from fastapi import FastAPI; print('FastAPI安装成功')"
python -c "import openai; print('OpenAI SDK安装成功')"
python -c "import pandas; print('pandas安装成功')"
```

### 方式二：使用Docker（推荐生产环境）

#### 1. 构建镜像

```bash
docker build -t financial-case-generator .
```

#### 2. 运行容器

```bash
docker run -d \
  -p 8000:8000 \
  -e OPENAI_API_KEY=your-api-key \
  -e OPENAI_API_BASE=https://api.siliconflow.cn/v1 \
  -v $(pwd)/outputs:/app/outputs \
  -v $(pwd)/inputs:/app/inputs \
  --name case-generator \
  financial-case-generator
```

---

## 快速开始

### 步骤1：配置API密钥

创建 `.env` 文件：

```bash
# .env
OPENAI_API_KEY=sk-fjephnssumhgkxhakpxlfrqayiuckkyogvwkchqutqolqilk
OPENAI_API_BASE=https://api.siliconflow.cn/v1
OPENAI_MODEL=deepseek-ai/DeepSeek-V3.2
```

或者直接修改 `config.py` 文件：

```python
# config.py
OPENAI_API_KEY = "your-api-key"
OPENAI_API_BASE = "https://api.siliconflow.cn/v1"
OPENAI_MODEL = "deepseek-ai/DeepSeek-V3.2"
```

### 步骤2：运行快速测试

```bash
python test_quick.py
```

如果看到类似输出，说明系统正常：

```
2026-01-19 23:45:12 | INFO     | __main__:quick_test:11 - 开始快速测试...
2026-01-19 23:45:13 | INFO     | __main__:quick_test:25 - LLM客户端初始化成功
2026-01-19 23:45:13 | INFO     | __main__:quick_test:26 -   API Base: https://api.siliconflow.cn/v1
2026-01-19 23:45:13 | INFO     | __main__:quick_test:27 -   Model: deepseek-ai/DeepSeek-V3.2
2026-01-19 23:45:13 | INFO     | __main__:quick_test:30 - 发送测试请求...
2026-01-19 23:45:15 | SUCCESS  | __main__:quick_test:33 - LLM响应: 我是DeepSeek，一个由深度求索开发的大型语言模型...
2026-01-19 23:45:15 | SUCCESS  | __main__:quick_test:34 - 快速测试通过！
```

### 步骤3：使用真实判决书测试

```bash
python test_with_judgment.py
```

按照提示输入判决书文件路径，系统会自动生成测试卷宗。

---

## 详细使用指南

### 使用方式一：Python脚本

#### 1. 使用完整测试脚本

```bash
python test_full.py
```

#### 2. 自定义使用示例

创建 `custom_test.py`：

```python
from pathlib import Path
from src.services import Stage0Service, Stage1Service, Stage2Service, Stage3Service
from src.utils import LLMClient
import json

# 初始化LLM客户端
llm_client = LLMClient(
    api_key="your-api-key",
    model="deepseek-ai/DeepSeek-V3.2",
    api_base="https://api.siliconflow.cn/v1"
)

# 读取判决书
judgment_file = Path("inputs/judgment.txt")
judgment_text = judgment_file.read_text(encoding="utf-8")

# 执行阶段0
print("开始执行阶段0...")
stage0_service = Stage0Service(llm_client=llm_client)
stage0_result = stage0_service.execute_all(judgment_text)

# 保存阶段0结果
output_dir = Path("outputs/custom_test")
output_dir.mkdir(exist_ok=True)
with open(output_dir / "stage0_result.json", "w", encoding="utf-8") as f:
    json.dump(stage0_result, f, ensure_ascii=False, indent=2)

print(f"阶段0完成，结果已保存到 {output_dir / 'stage0_result.json'}")

# 执行阶段1（如需要）
print("开始执行阶段1...")
stage1_service = Stage1Service(llm_client=llm_client)
stage1_result = stage1_service.execute_all(stage0_result, output_dir)

print(f"阶段1完成，结果已保存到 {output_dir}")

# 执行阶段2（如需要）
print("开始执行阶段2...")
stage2_service = Stage2Service(llm_client=llm_client)
stage2_result = stage2_service.execute_all(stage0_result, output_dir)

print(f"阶段2完成，结果已保存到 {output_dir}")

# 执行阶段3（如需要）
print("开始执行阶段3...")
stage3_service = Stage3Service(llm_client=llm_client)
stage3_result = stage3_service.execute_all(stage0_result, stage1_result, stage2_result, output_dir)

print(f"阶段3完成，结果已保存到 {output_dir}")

print("=" * 50)
print("所有阶段执行完成！")
print(f"输出目录: {output_dir}")
```

运行：

```bash
python custom_test.py
```

### 使用方式二：API服务

#### 1. 启动API服务

```bash
# 方式1：使用uvicorn
uvicorn src.api.app:app --reload --host 0.0.0.0 --port 8000

# 方式2：使用python脚本
python -m uvicorn src.api.app:app --reload --host 0.0.0.0 --port 8000
```

#### 2. 访问API文档

启动后，在浏览器中访问：

```
http://localhost:8000/docs
```

您将看到Swagger UI，可以交互式地测试API。

#### 3. 使用curl调用API

**生成案件数据**：

```bash
curl -X POST "http://localhost:8000/api/v1/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "judgment_text": "(2024)沪74民初721号\n原告：某某公司1...",
    "stages": ["0", "1", "2", "3"]
  }'
```

**查询任务状态**：

```bash
curl -X GET "http://localhost:8000/api/v1/status/{task_id}"
```

**下载生成结果**：

```bash
curl -X GET "http://localhost:8000/api/v1/download/{task_id}" --output result.zip
```

#### 4. 使用Python调用API

```python
import requests
import time

# API基础URL
BASE_URL = "http://localhost:8000/api/v1"

# 生成案件数据
def generate_case_data(judgment_text, stages=["0", "1", "2", "3"]):
    response = requests.post(
        f"{BASE_URL}/generate",
        json={
            "judgment_text": judgment_text,
            "stages": stages
        }
    )
    return response.json()

# 查询任务状态
def get_task_status(task_id):
    response = requests.get(f"{BASE_URL}/status/{task_id}")
    return response.json()

# 下载结果
def download_result(task_id, output_path="result.zip"):
    response = requests.get(f"{BASE_URL}/download/{task_id}")
    with open(output_path, "wb") as f:
        f.write(response.content)

# 使用示例
judgment_text = Path("inputs/judgment.txt").read_text(encoding="utf-8")

# 提交任务
result = generate_case_data(judgment_text)
task_id = result["task_id"]
print(f"任务ID: {task_id}")

# 轮询任务状态
while True:
    status = get_task_status(task_id)
    print(f"状态: {status['status']}, 当前阶段: {status['current_stage']}")

    if status["status"] == "completed":
        print("任务完成！")
        break
    elif status["status"] == "failed":
        print(f"任务失败: {status['error']}")
        break

    time.sleep(5)

# 下载结果
download_result(task_id, "result.zip")
print("结果已下载到 result.zip")
```

### 使用方式三：Docker容器

```bash
# 1. 构建镜像
docker build -t financial-case-generator .

# 2. 运行容器
docker run -d \
  -p 8000:8000 \
  -e OPENAI_API_KEY=your-api-key \
  -e OPENAI_API_BASE=https://api.siliconflow.cn/v1 \
  -v $(pwd)/outputs:/app/outputs \
  -v $(pwd)/inputs:/app/inputs \
  --name case-generator \
  financial-case-generator

# 3. 查看日志
docker logs -f case-generator

# 4. 访问API文档
# 浏览器打开 http://localhost:8000/docs
```

---

## API接口说明

### 1. 提交生成任务

**接口**: `POST /api/v1/generate`

**请求参数**:

```json
{
  "judgment_text": "string",  // 判决书文本
  "stages": ["0", "1", "2", "3"],  // 可选，默认全部阶段
  "api_key": "string"  // 可选，如果不提供则使用默认配置
}
```

**响应**:

```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "message": "任务已提交，正在处理中"
}
```

**示例**:

```bash
curl -X POST "http://localhost:8000/api/v1/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "judgment_text": "(2024)沪74民初721号\n原告：某某公司1...",
    "stages": ["0", "1"]
  }'
```

### 2. 查询任务状态

**接口**: `GET /api/v1/status/{task_id}`

**响应**:

```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",  // pending, processing, completed, failed
  "stages_completed": ["0"],
  "current_stage": "1",
  "error": null
}
```

**状态说明**:
- `pending`: 任务已提交，等待处理
- `processing`: 任务处理中
- `completed`: 任务完成
- `failed`: 任务失败

**示例**:

```bash
curl -X GET "http://localhost:8000/api/v1/status/550e8400-e29b-41d4-a716-446655440000"
```

### 3. 下载生成结果

**接口**: `GET /api/v1/download/{task_id}`

**响应**: ZIP文件，包含生成的所有卷宗文件

**示例**:

```bash
curl -X GET "http://localhost:8000/api/v1/download/550e8400-e29b-41d4-a716-446655440000" \
  --output result.zip
```

### 4. 获取系统信息

**接口**: `GET /`

**响应**:

```json
{
  "message": "金融案件测试数据生成系统",
  "version": "1.0.0-alpha",
  "docs": "/docs"
}
```

**示例**:

```bash
curl -X GET "http://localhost:8000/"
```

---

## 常见问题

### Q1: API密钥在哪里配置？

**A**: 有三种配置方式：

1. 环境变量（推荐）：
   ```bash
   export OPENAI_API_KEY=your-api-key
   ```

2. `.env` 文件：
   ```
   OPENAI_API_KEY=your-api-key
   ```

3. `config.py` 文件：
   ```python
   OPENAI_API_KEY = "your-api-key"
   ```

### Q2: 系统支持哪些类型的案件？

**A**: 当前版本仅支持融资租赁合同纠纷案件。后续版本计划扩展到：
- 借款合同纠纷
- 信用卡纠纷
- 保证合同纠纷
- 其他金融案件

### Q3: 生成一个案件需要多长时间？

**A**: 取决于以下因素：
- 判决书长度：通常1-3页需要5-10分钟，10页以上需要15-30分钟
- 执行阶段：只执行阶段0最快，全部阶段需要更长时间
- API响应速度：取决于LLM API的响应时间

### Q4: 生成的卷宗包含哪些文件？

**A**: 根据执行阶段不同，生成的文件包括：

**阶段0**:
- 结构化提取结果（JSON）
- Profile库（JSON）
- 交易结构图（JSON）
- 关键数字清单（JSON）
- 证据归属规划表（JSON）

**阶段1**（原告起诉包）:
- 民事起诉状
- 原告证据包（合同、凭证、登记证明等）
- 原告程序性文件（授权委托书、保全申请等）

**阶段2**（被告答辩包）:
- 民事答辩状
- 被告证据包（支持抗辩的证据）
- 被告程序性文件（答辩人身份证明等）

**阶段3**（法院审理包）:
- 庭审笔录
- 脱敏替换后的判决书

### Q5: 如何查看生成日志？

**A**: 日志文件位于 `logs/` 目录：

```bash
# 查看最新日志
tail -f logs/app_2026-01-19.log

# 查看所有日志
ls -la logs/
```

### Q6: 可以只执行部分阶段吗？

**A**: 可以！在API请求中指定 `stages` 参数：

```json
{
  "judgment_text": "...",
  "stages": ["0", "1"]  // 只执行阶段0和阶段1
}
```

或在Python脚本中：

```python
stage0_service = Stage0Service(llm_client=llm_client)
stage0_result = stage0_service.execute_all(judgment_text)

stage1_service = Stage1Service(llm_client=llm_client)
stage1_result = stage1_service.execute_all(stage0_result, output_dir)

# 不执行阶段2和阶段3
```

### Q7: 如何提高生成质量？

**A**:
1. 确保判决书文本完整、清晰
2. 使用API提供的详细内容版本（如有的话）
3. 检查并优化提示词
4. 多次测试，选择最佳结果
5. 参考生成的质量报告，针对性优化

### Q8: 系统支持批量处理吗？

**A**: 当前版本需要逐个案件处理。可以通过脚本循环调用API实现批量处理：

```python
judgment_files = Path("inputs").glob("*.txt")

for judgment_file in judgment_files:
    judgment_text = judgment_file.read_text(encoding="utf-8")
    result = generate_case_data(judgment_text)
    # 等待任务完成...
```

### Q9: 生成的数据可以商用吗？

**A**: 生成的数据仅用于内部测试和开发目的，不得用于任何商业用途。生成的所有人物、公司、地址等信息均为虚构的模拟数据，不代表真实实体。

### Q10: 如何反馈问题或建议？

**A**: 请通过以下方式反馈：
1. 创建GitHub Issue（如果有仓库）
2. 联系项目负责人
3. 记录详细的错误日志和复现步骤

---

## 故障排查

### 问题1: ModuleNotFoundError: No module named 'xxx'

**原因**: 依赖包未安装

**解决方案**:

```bash
pip install -r requirements.txt
```

或单独安装缺失的包：

```bash
pip install xxx
```

### 问题2: API请求失败：Connection Error

**原因**: 网络连接问题或API服务不可用

**解决方案**:

1. 检查网络连接
2. 检查API密钥是否正确
3. 检查API Base URL是否正确
4. 尝试手动访问API网站测试连通性

```bash
curl https://api.siliconflow.cn/v1
```

### 问题3: LLM生成超时

**原因**: API响应时间过长或Token限制

**解决方案**:

1. 检查API服务状态
2. 减少输入文本长度
3. 增加超时时间配置（修改 `config.py`）

### 问题4: 生成的JSON格式错误

**原因**: LLM输出格式不符合预期

**解决方案**:

1. 检查提示词是否正确
2. 重新运行生成任务
3. 查看日志中的原始输出
4. 手动修正JSON格式

### 问题5: 端口被占用（8000端口）

**原因**: 8000端口已被其他程序占用

**解决方案**:

```bash
# 方式1：使用其他端口
uvicorn src.api.app:app --reload --port 8001

# 方式2：停止占用8000端口的程序
# 查找占用端口的进程
lsof -i :8000  # macOS/Linux
netstat -ano | findstr :8000  # Windows

# 杀死进程
kill -9 PID  # macOS/Linux
taskkill /PID PID /F  # Windows
```

### 问题6: Docker容器无法启动

**原因**: Docker未安装或配置错误

**解决方案**:

```bash
# 检查Docker是否安装
docker --version

# 检查Docker服务状态
docker ps

# 重新构建镜像
docker build --no-cache -t financial-case-generator .
```

### 问题7: 生成的卷宗文件乱码

**原因**: 文件编码问题

**解决方案**:

确保使用UTF-8编码读取和写入文件：

```python
# 读取
with open("input.txt", "r", encoding="utf-8") as f:
    text = f.read()

# 写入
with open("output.txt", "w", encoding="utf-8") as f:
    f.write(text)
```

### 问题8: 内存不足

**原因**: 处理大文件或并发任务时内存不足

**解决方案**:

1. 减少并发任务数
2. 增加系统内存
3. 分阶段处理，不要一次性执行所有阶段
4. 清理临时文件

### 问题9: 提示词加载失败

**原因**: 提示词文件路径错误或文件不存在

**解决方案**:

```bash
# 检查提示词文件是否存在
ls -la prompts/

# 检查文件内容是否正确
cat prompts/stage0/0.1_结构化提取.md

# 检查config.py中的路径配置
cat config.py | grep PROMPT_DIR
```

### 问题10: 质量检查失败

**原因**: 生成的数据不满足质量要求

**解决方案**:

1. 查看质量检查报告（`outputs/quality_report.md`）
2. 根据报告中的问题针对性优化
3. 重新运行生成任务
4. 如果是提示词问题，优化提示词

---

## 版本更新

### 当前版本: v1.0.0-alpha

**发布日期**: 2026-01-19

**主要功能**:
- ✅ 完整的三阶段生成流程
- ✅ FastAPI RESTful API
- ✅ SiliconFlow API集成（DeepSeek模型）
- ✅ 融资租赁案件支持
- ✅ 质量控制框架
- ✅ Docker支持

**已知限制**:
- ⚠️ 仅支持融资租赁案件
- ⚠️ 需要API密钥配置
- ⚠️ 生成速度受API响应影响

### 更新日志

详细的更新日志请查看 [CHANGELOG.md](CHANGELOG.md)

### 版本路线图

**v1.1.0-alpha** (计划中):
- [ ] 支持借款合同纠纷
- [ ] 优化提示词质量
- [ ] 增加批量处理功能

**v1.2.0-alpha** (计划中):
- [ ] 支持更多案件类型
- [ ] 增加Web前端界面
- [ ] 优化生成速度

**v2.0.0-beta** (计划中):
- [ ] 完整的案件类型支持
- [ ] 自动化质量控制
- [ ] 生产环境部署

---

## 附录

### A. 项目目录结构

```
financial_case_generator_system/
├── README.md                    # 项目说明
├── VERSION                     # 版本号
├── CHANGELOG.md                # 变更日志
├── requirements.txt             # 依赖列表
├── config.py                   # 配置文件
├── Dockerfile                  # Docker配置
├── .env.example                # 环境变量示例
├── .gitignore                 # Git忽略文件
├── src/                       # 源代码
│   ├── api/                   # API层
│   │   ├── __init__.py
│   │   └── app.py             # FastAPI应用
│   ├── models/                # 数据模型
│   │   ├── __init__.py
│   │   └── stage0_models.py   # 阶段0模型
│   ├── services/              # 业务逻辑
│   │   ├── __init__.py
│   │   ├── stage0/
│   │   │   ├── __init__.py
│   │   │   └── stage0_service.py
│   │   ├── stage1/
│   │   │   ├── __init__.py
│   │   │   └── stage1_service.py
│   │   ├── stage2/
│   │   │   ├── __init__.py
│   │   │   └── stage2_service.py
│   │   └── stage3/
│   │       ├── __init__.py
│   │       └── stage3_service.py
│   └── utils/                 # 工具函数
│       ├── __init__.py
│       ├── helpers.py         # 辅助函数
│       ├── llm.py            # LLM客户端
│       └── quality.py         # 质量控制
├── prompts/                   # 提示词模板
│   ├── stage0/
│   ├── stage1/
│   ├── stage2/
│   └── stage3/
├── schemas/                   # 数据模型Schema
│   ├── stage0_output_schema.json
│   ├── profile_library_schema.json
│   └── evidence_planning_schema.json
├── inputs/                    # 输入文件
│   └── judgment.txt          # 示例判决书
├── outputs/                   # 输出文件
├── logs/                      # 日志文件
├── tests/                     # 测试文件
├── venv/                      # 虚拟环境（忽略）
└── test_*.py                  # 测试脚本
    ├── test_quick.py
    ├── test_with_judgment.py
    └── test_full.py
```

### B. 配置参数说明

#### config.py 主要配置项

```python
# API配置
API_HOST = "0.0.0.0"           # API监听地址
API_PORT = 8000                 # API监听端口

# LLM配置
OPENAI_API_KEY = ""             # API密钥（必须配置）
OPENAI_MODEL = "gpt-4"         # 模型名称
OPENAI_API_BASE = ""           # API基础URL（可选）

# 路径配置
PROMPT_DIR = "prompts"          # 提示词目录
SCHEMA_DIR = "schemas"          # Schema目录
OUTPUT_DIR = "outputs"          # 输出目录
INPUT_DIR = "inputs"            # 输入目录
LOG_DIR = "logs"               # 日志目录
```

### C. 联系方式

- **项目负责人**: [待填写]
- **技术负责人**: [待填写]
- **邮箱**: [待填写]
- **GitHub**: [待填写]

---

**文档版本**: v1.0.0-alpha
**最后更新**: 2026-01-19
**维护者**: 项目开发团队
