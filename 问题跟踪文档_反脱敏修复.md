# 问题跟踪文档：反脱敏模块修复

**文档版本**: v1.0  
**创建日期**: 2026-01-26  
**问题类型**: 设计缺陷 / 架构问题  
**优先级**: P0 - 高优先级

---

## 一、问题概述

### 1.1 问题描述

生成的PDF文件（`完整测试卷宗_简化版.pdf`）中存在大量占位符：
- "（此处填写XXX）" 6处
- "【填写XXX】" 9处
- "XXX" 占位符 69处
- "具体金额" 占位符 5处

**标准答案集.pdf** 同样存在问题：
- JSON格式错误（Python字典直接输出）
- 关键数据缺失（"计算基数: 未知"）

### 1.2 影响范围

| 组件 | 影响 | 严重程度 |
|------|------|---------|
| 证据文件生成 | 证据内容不完整 | 🔴 严重 |
| PDF卷宗生成 | PDF包含占位符 | 🔴 严重 |
| 标准答案集 | JSON格式错误 | 🟡 中等 |
| 证据文件复用 | 证据文件需二次处理 | 🟡 中等 |

---

## 二、根本原因分析

### 2.1 问题根源

**反脱敏模块被"绕过"**

证据生成器（`evidence_file_generator.py`）在保存文件前**没有执行反脱敏**，导致占位符被直接写入证据文件。PDF生成器虽然有反脱敏能力，但此时占位符已存在于源文件中。

```
错误的数据流：
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│  LLM生成证据内容     │ ──→ │  清理Markdown格式   │ ──→ │  直接保存文件       │
│  (含脱敏名称)        │     │                     │     │  (❌ 缺少反脱敏)    │
└─────────────────────┘     └─────────────────────┘     └─────────────────────┘
                                                                    ↓
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│  读取证据文件       │ ──→ │  反脱敏处理         │ ──→ │  生成PDF           │
│  (含占位符)         │     │  (✅ 已有)          │     │  (显示占位符)       │
└─────────────────────┘     └─────────────────────┘     └─────────────────────┘
```

**正确的数据流**：
```
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│  LLM生成证据内容     │ ──→ │  清理Markdown格式   │ ──→ │  反脱敏处理         │
│  (含脱敏名称)        │     │                     │     │  (✅ 必须执行)      │
└─────────────────────┘     └─────────────────────┘     └─────────────────────┘
                                                                    ↓
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│  保存证据文件       │ ──→ │  读取证据文件       │ ──→ │  生成PDF           │
│  (含真实名称)        │     │  (含真实名称)        │     │  (显示真实名称)      │
└─────────────────────┘     └─────────────────────┘     └─────────────────────┘
```

### 2.2 现有代码分析

#### 2.2.1 PDF生成器（已有反脱敏）

**文件**: `src/utils/pdf_generator.py`

```python
def deanonymize_text(self, text: str) -> str:
    """将脱敏名称替换为真实名称"""
    anonymization_map = self._load_anonymization_map()
    deanonymized = text
    for placeholder, real_name in anonymization_map.items():
        deanonymized = deanonymized.replace(placeholder, real_name)
    return deanonymized

def add_paragraph(self, text, style_name='ChineseBody'):
    clean_text = self._clean_text(text)
    deanonymized = self.deanonymize_text(clean_text)  # ✅ 已有调用
    paragraph = Paragraph(deanonymized, self.styles[style_name])
    self.doc.add(paragraph)
```

**状态**: ✅ 反脱敏功能已实现，PDF生成时正确调用

#### 2.2.2 证据生成器（缺少反脱敏）

**文件**: `src/services/evidence_file_generator.py`

```python
def _generate_evidence_file(self, evidence, stage0_data, group_dir):
    # ... 省略：加载提示词、构建提示词、调用LLM ...

    # 5. 清理Markdown
    clean_response = self._clean_markdown(response)

    # 6. 直接保存（❌ 没有反脱敏！）
    file_path.write_text(clean_response, encoding='utf-8')
```

**状态**: ❌ 缺少反脱敏步骤

### 2.3 数据流问题

**当前问题**：
1. 阶段0生成的脱敏映射表 `0.2_anonymization_plan.json` 包含完整的映射关系
2. 证据生成器接收 `stage0_data`，但未使用其中的脱敏映射
3. PDF生成器在生成PDF时尝试反脱敏，但源文件已含占位符

**数据传递路径**：
```
stage0_data
├── 0.1_structured_extraction.json  # 案件结构化信息
├── 0.2_anonymization_plan.json     # 脱敏映射表 ✅
├── 0.3_transaction_structure.json  # 交易结构
├── 0.4_key_numbers.json            # 关键数字
└── 0.5_evidence_planning.json      # 证据归属规划
```

---

## 三、修复方案设计

### 3.1 设计原则

1. **源头修复**：在证据生成阶段执行反脱敏，而非在PDF生成阶段补救
2. **最小改动**：复用现有的反脱敏逻辑，避免重复代码
3. **一致性**：确保所有生成器使用相同的反脱敏逻辑
4. **可测试**：添加验证步骤，确保反脱敏正确执行

### 3.2 修复策略

#### 3.2.1 策略A：在证据生成器添加反脱敏（推荐）

**优点**：
- 证据文件本身正确，可直接复用
- 符合"源头修复"原则
- 修改范围最小

**缺点**：
- 需要修改证据生成器

**修改文件**：
- `src/services/evidence_file_generator.py`

#### 3.2.2 策略B：创建统一的反脱敏服务

**优点**：
- 集中管理反脱敏逻辑
- 便于维护和测试

**缺点**：
- 修改范围较大
- 需要重构代码

**修改文件**：
- 新建 `src/services/deanonymization_service.py`
- 修改 `evidence_file_generator.py`
- 修改 `pdf_generator.py`

**推荐**：策略A（最小改动原则）

### 3.3 详细设计

#### 3.3.1 反脱敏服务接口设计

```python
from typing import Dict, Any

class DeanonymizationService:
    """反脱敏服务"""
    
    def __init__(self, anonymization_map: Dict[str, str]):
        """
        初始化反脱敏服务
        
        Args:
            anonymization_map: 脱敏映射表 {placeholder: real_name}
        """
        self.anonymization_map = anonymization_map
    
    def deanonymize_text(self, text: str) -> str:
        """将脱敏名称替换为真实名称"""
        deanonymized = text
        for placeholder, real_name in self.anonymization_map.items():
            deanonymized = deanonymized.replace(placeholder, real_name)
        return deanonymized
    
    def deanonymize_dict(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """递归处理字典中的所有字符串值"""
        ...
```

#### 3.3.2 证据生成器修改设计

**修改位置**: `src/services/evidence_file_generator.py`

**修改前**:
```python
def _generate_evidence_file(self, evidence, stage0_data, group_dir):
    # ... 生成证据 ...
    
    # 清理并保存
    clean_response = self._clean_markdown(response)
    file_path.write_text(clean_response, encoding='utf-8')
```

**修改后**:
```python
def _generate_evidence_file(self, evidence, stage0_data, group_dir):
    # ... 生成证据 ...
    
    # 清理
    clean_response = self._clean_markdown(response)
    
    # 反脱敏（新增）
    anonymization_plan = stage0_data.get("0.2_anonymization_plan", {})
    anonymization_map = self._build_anonymization_map(anonymization_plan)
    deanonymized_response = self._deanonymize_text(clean_response, anonymization_map)
    
    # 保存
    file_path.write_text(deanonymized_response, encoding='utf-8')

def _build_anonymization_map(self, anonymization_plan: Dict) -> Dict[str, str]:
    """构建反脱敏映射表"""
    anonymization_map = {}
    
    # 处理公司名称映射
    for item in anonymization_plan.get("companies", []):
        if item.get("anonymized"):
            anonymization_map[item["anonymized"]] = item["real_name"]
    
    # 处理人物名称映射
    for item in anonymization_plan.get("persons", []):
        if item.get("anonymized"):
            anonymization_map[item["anonymized"]] = item["real_name"]
    
    # 处理机构名称映射
    for item in anonymization_plan.get("organizations", []):
        if item.get("anonymized"):
            anonymization_map[item["anonymized"]] = item["real_name"]
    
    return anonymization_map

def _deanonymize_text(self, text: str, anonymization_map: Dict[str, str]) -> str:
    """将脱敏名称替换为真实名称"""
    deanonymized = text
    for placeholder, real_name in anonymization_map.items():
        deanonymized = deanonymized.replace(placeholder, real_name)
    return deanonymized
```

#### 3.3.3 统一反脱敏工具类

**新建文件**: `src/utils/deanonymizer.py`

```python
from typing import Dict, Any, Optional


class Deanonymizer:
    """统一的反脱敏工具类"""
    
    def __init__(self, anonymization_map: Optional[Dict[str, str]] = None):
        """
        初始化反脱敏工具类
        
        Args:
            anonymization_map: 脱敏映射表 {placeholder: real_name}
        """
        self.anonymization_map = anonymization_map or {}
    
    def load_from_stage0(self, stage0_data: Dict[str, Any]) -> "Deanonymizer":
        """从阶段0数据加载脱敏映射"""
        anonymization_plan = stage0_data.get("0.2_anonymization_plan", {})
        anonymization_map = {}
        
        # 公司
        for item in anonymization_plan.get("companies", []):
            if item.get("anonymized"):
                anonymization_map[item["anonymized"]] = item["real_name"]
        
        # 人物
        for item in anonymization_plan.get("persons", []):
            if item.get("anonymized"):
                anonymization_map[item["anonymized"]] = item["real_name"]
        
        # 机构
        for item in anonymization_plan.get("organizations", []):
            if item.get("anonymized"):
                anonymization_map[item["anonymized"]] = item["real_name"]
        
        self.anonymization_map = anonymization_map
        return self
    
    def deanonymize_text(self, text: str) -> str:
        """将脱敏名称替换为真实名称"""
        deanonymized = text
        for placeholder, real_name in self.anonymization_map.items():
            deanonymized = deanonymized.replace(placeholder, real_name)
        return deanonymized
    
    def deanonymize_dict(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """递归处理字典中的所有字符串值"""
        ...
```

---

## 四、代码修改规范

### 4.1 修改清单

| 文件 | 修改类型 | 修改内容 |
|------|---------|---------|
| `src/utils/deanonymizer.py` | 新建 | 统一的反脱敏工具类 |
| `src/services/evidence_file_generator.py` | 修改 | 添加反脱敏步骤 |
| `src/utils/pdf_generator.py` | 可选 | 使用统一的Deanonymizer |
| `src/utils/pdf_generator_simple.py` | 可选 | 使用统一的Deanonymizer |

### 4.2 修改优先级

| 优先级 | 文件 | 修改内容 |
|--------|------|---------|
| P0 | `src/services/evidence_file_generator.py` | 添加反脱敏步骤 |
| P1 | `src/utils/deanonymizer.py` | 创建统一工具类 |
| P2 | `src/utils/pdf_generator.py` | 重构为使用Deanonymizer |
| P2 | `src/utils/pdf_generator_simple.py` | 重构为使用Deanonymizer |

### 4.3 测试验证清单

- [ ] 验证证据文件不包含占位符
- [ ] 验证PDF文件显示真实名称
- [ ] 验证标准答案集JSON格式正确
- [ ] 验证关键计算数据显示正确值
- [ ] 验证脱敏映射表正确使用

---

## 五、风险评估

### 5.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 反脱敏覆盖不全 | 中 | 高 | 全面测试所有占位符 |
| 新引入bug | 低 | 中 | 最小改动原则 |
| 性能影响 | 低 | 低 | 批量替换 |

### 5.2 兼容性风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 现有数据格式变化 | 低 | 修复后重新生成 |
| API接口变化 | 无 | 向后兼容 |

---

## 六、时间估算

| 任务 | 预估时间 | 依赖 |
|------|---------|------|
| 创建Deanonymizer工具类 | 1小时 | 无 |
| 修改证据生成器 | 1小时 | Deanonymizer |
| 重构PDF生成器 | 2小时 | Deanonymizer |
| 测试验证 | 2小时 | 所有修改 |
| **总计** | **6小时** | - |

---

## 七、附录

### A. 相关文件

| 文件 | 路径 | 说明 |
|------|------|------|
| 脱敏映射表 | `outputs/stage0/0.2_anonymization_plan.json` | 完整的脱敏映射 |
| 证据生成器 | `src/services/evidence_file_generator.py` | 待修改 |
| PDF生成器 | `src/utils/pdf_generator.py` | 参考实现 |
| 测试方案 | `PDF格式检查测试方案.md` | 测试指南 |

### B. 占位符清单

| 占位符类型 | 数量 | 示例 |
|-----------|------|------|
| （此处填写XXX） | 6 | （此处填写被告名称） |
| 【填写XXX】 | 9 | 【填写具体金额】 |
| XXX | 69 | 某某公司5、周某等 |
| 具体金额 | 5 | 具体金额人民币XXX元 |

### C. 脱敏映射表示例

```json
{
  "companies": [
    {
      "real_name": "上海富隆融资租赁有限公司",
      "anonymized": "某某公司5"
    },
    {
      "real_name": "南昌昌茂商业管理有限公司",
      "anonymized": "某某公司1"
    }
  ],
  "persons": [
    {
      "real_name": "周文斌",
      "anonymized": "周某"
    },
    {
      "real_name": "左明轩",
      "anonymized": "左某"
    }
  ],
  "organizations": [
    {
      "real_name": "上海嘉华律师事务所",
      "anonymized": "某某律师事务所"
    },
    {
      "real_name": "上海中诚公证处",
      "anonymized": "某某公证处"
    }
  ]
}
```

---

**文档状态**: 草稿  
**下一步**: 评审后执行代码修改
